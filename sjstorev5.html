<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SJ STORE</title>
  <!-- Google Fonts - Roboto as Helvetica alternative -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" type="image/png">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Firebase v12.3.0 Modular -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, updateDoc, deleteDoc, query, where, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
      authDomain: "sj-one.firebaseapp.com",
      projectId: "sj-one",
      storageBucket: "sj-one.appspot.com",
      messagingSenderId: "426335553508",
      appId: "1:426335553508:web:248f76772f6f78419ca9f1",
      measurementId: "G-YQTVZQWXGB"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();
    document.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("product-list");
      const sliderContainer = document.getElementById("slider-container");
      const loginBtn = document.getElementById("login-btn");
      const profilePic = document.getElementById("profile-pic");
      const dropdownMenu = document.getElementById("dropdown-menu");
      const logoutOption = document.getElementById("logout-option");
      const sellNowOption = document.getElementById("sell-now-option");
      const settingsOption = document.getElementById("settings-option");
      const chatBtn = document.getElementById("chat-btn");
      const adminPanel = document.getElementById("admin-panel");
      const addProductForm = document.getElementById("add-product-form");
      const addSliderForm = document.getElementById("add-slider-form");
      const sliderList = document.getElementById("slider-list");
      const searchInput = document.getElementById("search-input");
      const cartIcon = document.getElementById("cart-icon");
      const cartCount = document.getElementById("cart-count");
      const cartModal = document.getElementById("cart-modal");
      const cartList = document.getElementById("cart-list");
      const cartTotal = document.getElementById("cart-total");
      const payNowBtn = document.getElementById("pay-now-btn");
      const closeModal = document.getElementById("close-modal");
      const sellModal = document.getElementById("sell-modal");
      const sellProductForm = document.getElementById("sell-product-form");
      const closeSellModal = document.getElementById("close-sell-modal");
      const paymentModal = document.getElementById("payment-modal");
      const paymentForm = document.getElementById("payment-form");
      const closePaymentModal = document.getElementById("close-payment-modal");
      const categoryCards = document.querySelectorAll(".category-card");
      const titleH1 = document.querySelector("h1");
      let currentUser = null;
      let isSeller = false;
      let products = [];
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      let currentCategory = ""; 
      let userData = { currency: 'DH', language: 'English', role: 'buyer', balance: 0 };
      let exchangeRates = {
        DH: 1
      };
      const translations = {
        English: {
          title: 'SJ STORE',
          searchPlaceholder: 'Search products...',
          orderNow: 'Order Now',
          contactWhatsApp: 'ðŸ“ž Contact via WhatsApp',
          addToCart: 'Add to Cart',
          noProducts: 'No products found.',
          cartTitle: 'My Cart',
          cartEmpty: 'Your cart is empty.',
          cartTotal: 'Total',
          payNow: 'Pay Now',
          paymentTitle: 'Payment Details',
          fullName: 'Full Name',
          whatsappPhone: 'WhatsApp Phone Number',
          address: 'Delivery Address',
          paymentMethod: 'Payment Method',
          cod: 'Cash on Delivery (COD)',
          online: 'Online Payment',
          submitPayment: 'Submit Payment',
          close: 'Close',
          sellTitle: 'Sell a Product',
          productTitle: 'Product Title',
          productPrice: 'Price (DH)',
          productDes: 'WhatsApp Phone Number',
          productOrderUrl: 'Order URL (optional)',
          selectCategory: 'Select Category',
          addProduct: 'Add Product',
          adminPanel: 'Seller Control Panel',
          addProductHeader: 'Add Product',
          addSliderHeader: 'Add Slider Item',
          currentSliders: 'Current Sliders',
          delete: 'Delete',
          edit: 'Edit',
          chat: 'Chat',
          login: 'Login',
          sellNow: 'Sell Now',
          settings: 'Settings',
          logout: 'Logout'
        },
        // French and Arabic translations omitted for brevity, assume same as original
      };
      async function fetchExchangeRates() {
        // same as original
      }
      function applyLanguage(lang) {
        // same as original
      }
      function getConvertedPrice(price, currency) {
        // same as original
      }
      function getCurrencySymbol(currency) {
        // same as original
      }
      function updateCartCount() {
        cartCount.textContent = cart.reduce((sum, item) => sum + item.qty, 0);
      }
      updateCartCount();
      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
          loginBtn.style.display = "none";
          profilePic.src = user.photoURL || "https://via.placeholder.com/40";
          profilePic.style.display = "block";
          profilePic.title = user.displayName || "User";
          const userRef = doc(db, `users/${user.uid}`);
          onSnapshot(userRef, async (snap) => {
            if (!snap.exists()) {
              const role = user.email === "simo.jibou@gmail.com" ? "seller" : "buyer";
              await setDoc(userRef, { role, balance: 0, currency: 'DH', language: 'English' });
            }
            userData = snap.data() || { currency: 'DH', language: 'English', role: 'buyer', balance: 0 };
            isSeller = userData.role === "seller";
            adminPanel.style.display = isSeller ? "block" : "none";
            sellNowOption.style.display = isSeller ? "block" : "none";
            if (isSeller) loadAdminSliders();
            applyLanguage(userData.language);
            renderProducts(searchInput.value, currentCategory);
          });
        } else {
          // same as original
        }
        renderProducts();
      });
      fetchExchangeRates().then(() => {
        renderProducts(searchInput.value, currentCategory);
        renderCart();
      });
      // Event listeners for login, profile, logout, sell, settings, chat, modals - same as original
      onSnapshot(collection(db, "products"), (snapshot) => {
        products = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
        renderProducts(searchInput.value, currentCategory);
      });
      function renderProducts(filter = "", category = "") {
        // same as original, but update product.userId to product.sellerId if renamed, but keep userId for compatibility
        // In add to cart:
        // Find if exists
        const addBtn = div.querySelector(".add-to-cart-btn");
        addBtn.addEventListener("click", () => {
          const existing = cart.find(c => c.id === product.id);
          if (existing) {
            existing.qty += 1;
          } else {
            cart.push({...product, qty: 1});
          }
          localStorage.setItem("cart", JSON.stringify(cart));
          updateCartCount();
          alert("Added to cart!");
        });
        // Edit and delete for sellers - update to updateDoc, deleteDoc
        if (isSeller) {
          // ... editBtn.addEventListener("click", () => {
          // prompt and updateDoc(doc(db, "products", product.id), newData)
          // }
          // deleteBtn.addEventListener("click", () => deleteDoc(doc(db, "products", product.id)))
        }
      }
      // Search and category listeners - same
      // Slider - change to onSnapshot(collection(db, "Sliders")) , same logic
      // loadAdminSliders - onSnapshot, deleteDoc
      // uploadFile - same
      addProductForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentUser || !isSeller) return;
        // get values
        const photoUrl = await uploadFile(photoFile, `products/${currentUser.uid}/${Date.now()}_${photoFile.name}`);
        await addDoc(collection(db, "products"), {
          title, price, des, orderUrl, photo: photoUrl, sellerId: currentUser.uid, category
        });
        // reset
      });
      // sellProductForm similar
      // editProduct - prompt, updateDoc
      // deleteProduct - deleteDoc
      // addSliderForm - addDoc
      // cartIcon, renderCart updated for qty
      function renderCart() {
        // ... cart.forEach((item) => {
        // convertedPrice = getConvertedPrice(item.price, userData.currency) * item.qty
        // total += convertedPrice
        // div.innerHTML = ... <p>${item.title} x ${item.qty} - ${convertedPrice.toFixed(2)} ${symbol}</p>
        // remove btn: cart = cart.filter(c => c !== item) if qty >1, or decrease
        // but for simple, remove all for that item
        // }
      }
      payNowBtn.addEventListener("click", () => {
        // same
      });
      paymentForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentUser) return;
        // group by sellerId
        const ordersBySeller = {};
        cart.forEach(item => {
          const sellerId = item.sellerId || item.userId; // compat
          if (!ordersBySeller[sellerId]) ordersBySeller[sellerId] = [];
          ordersBySeller[sellerId].push(item);
        });
        for (const sellerId in ordersBySeller) {
          const items = ordersBySeller[sellerId];
          const productMap = {};
          let total = 0;
          items.forEach(item => {
            const pid = item.id;
            if (!productMap[pid]) productMap[pid] = {productId: pid, name: item.title, price: item.price, qty: 0};
            productMap[pid].qty += item.qty || 1;
            total += parseFloat(item.price) * (item.qty || 1);
          });
          const products = Object.values(productMap);
          await addDoc(collection(db, "orders"), {
            buyerId: currentUser.uid,
            sellerId,
            products,
            totalAmount: total,
            status: "pending",
            createdAt: serverTimestamp(),
            buyerName: currentUser.displayName || "",
            fullName,
            whatsappPhone,
            address,
            paymentMethod
          });
        }
        cart = [];
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
        paymentModal.style.display = "none";
        alert("Orders submitted successfully!");
      });
      // PWA and SW - same
    });
  </script>
  <!-- Style same as original -->
</head>
<body>
  <!-- HTML structure same as original -->
</body>
</html>
