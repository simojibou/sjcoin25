<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SJ COIN - مهام يومية مع نظام تحقق</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f0f5; padding:20px; }
    .task { background: #fff; margin-bottom:15px; padding:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    button { padding: 8px 15px; background: #4caf50; border: none; border-radius: 5px; color: white; cursor: pointer; }
    button:disabled { background: gray; cursor: default; }
  </style>
</head>
<body>

<h1>مهام SJ COIN اليومية</h1>

<div id="tasks"></div>

<script>
  // ---- Firebase Config: ضع بيانات مشروعك هنا ----
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
  };
  
  // ---- تهيئة Firebase ----
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // مثال: معرف المستخدم (في التطبيق الحقيقي يجب جلبه من تسجيل دخول المستخدم)
  const userId = "user_123";

  // بيانات المهام اليومية ثابتة هنا (يمكن تحميلها من قاعدة بيانات أيضاً)
  const dailyTasks = {
    daily1: { name: "متابعة إنستغرام", reward: 1000, link: "https://instagram.com/simo.jibou" },
    daily2: { name: "مشاهدة يوتيوب", reward: 1000, link: "https://youtube.com/@simojibou" },
    daily3: { name: "تنزيل", reward: 1500, link: "https://example.com/download" },
    daily4: { name: "لعب SJ Hero", reward: 2000, link: "https://play.google.com/store/apps/details?id=com.gamehero.sj" },
    daily5: { name: "زيارة SJ Store", reward: 2000, link: "https://play.google.com/store/apps/details?id=com.sj.store" }
  };

  const tasksContainer = document.getElementById("tasks");

  // جلب حالة مهام المستخدم من Firestore
  async function getUserTasks() {
    const userDoc = await db.collection("users").doc(userId).get();
    if (!userDoc.exists) {
      return {}; // لا توجد مهام منجزة بعد
    }
    return userDoc.data().dailyTasks || {};
  }

  // تحديث حالة المهمة في Firestore
  async function markTaskDone(taskId, reward) {
    const userRef = db.collection("users").doc(userId);
    const userDoc = await userRef.get();

    let dailyTasksState = {};
    if (userDoc.exists) {
      dailyTasksState = userDoc.data().dailyTasks || {};
    }

    // التحقق هل المهمة منجزة مسبقاً
    if (dailyTasksState[taskId]?.is_rewarded) {
      alert("لقد استلمت مكافأتك لهذه المهمة بالفعل!");
      return;
    }

    // تحديث حالة المهمة
    dailyTasksState[taskId] = { is_rewarded: true };

    await userRef.set({ dailyTasks: dailyTasksState }, { merge: true });

    // إضافة العملات للمستخدم (تحتاج تنفذ وظيفة خاصة بإضافة العملات)
    await addCoinsToUser(reward);

    alert(`مبروك! حصلت على ${reward} عملة SJ`);
    renderTasks(); // إعادة تحديث واجهة المهام
  }

  // دالة وهمية لإضافة العملات، عدّلها حسب نظامك الحقيقي
  async function addCoinsToUser(coins) {
    const userRef = db.collection("users").doc(userId);
    const userDoc = await userRef.get();
    let currentCoins = 0;
    if (userDoc.exists) {
      currentCoins = userDoc.data().coins || 0;
    }
    await userRef.set({ coins: currentCoins + coins }, { merge: true });
  }

  // عرض المهام مع زر التنفيذ
  async function renderTasks() {
    const userTasksState = await getUserTasks();
    tasksContainer.innerHTML = "";

    for (const [taskId, task] of Object.entries(dailyTasks)) {
      const isDone = userTasksState[taskId]?.is_rewarded || false;

      const taskDiv = document.createElement("div");
      taskDiv.classList.add("task");

      taskDiv.innerHTML = `
        <h3>${task.name}</h3>
        <p>المكافأة: ${task.reward} عملة SJ</p>
        <p><a href="${task.link}" target="_blank">اذهب إلى المهمة</a></p>
        <button ${isDone ? "disabled" : ""} id="btn_${taskId}">
          ${isDone ? "تم الحصول على المكافأة" : "لقد أكملت المهمة - احصل على مكافأتك"}
        </button>
      `;

      tasksContainer.appendChild(taskDiv);

      if (!isDone) {
        document.getElementById(`btn_${taskId}`).addEventListener("click", () => {
          markTaskDone(taskId, task.reward);
        });
      }
    }
  }

  renderTasks();

</script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</body>
</html>
