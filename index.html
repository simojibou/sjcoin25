<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>SJ COIN Tap2Earn</title>
  <!-- Ù…Ù†Ø¹ Ø£ÙŠ zoom ØºØ±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- TonConnect UI (unpkg) -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

  <!-- Firebase (compat build for simpler usage with existing code) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore-compat.js"></script>

  <style>
    /* Ø¹Ø§Ù… */
    :root { box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      font-family: "Arial", sans-serif;
      background: url('https://github.com/simojibou/logo/blob/main/logo.PNG?raw=true') center/cover fixed no-repeat;
      color: #fff;
      -webkit-tap-highlight-color: transparent; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù„Ù…Ø¹Ø§Ù† Ø§Ù„Ø£Ø²Ø±Ù‚ */
      touch-action: manipulation; /* Ù…Ù†Ø¹ double-tap zoom Ùˆ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙØ§Ø¹Ù„ */
    }

    /* Ø­Ø§ÙˆÙŠØ© Ù…ØªØ¬Ø§ÙˆØ¨Ø© ÙˆÙ…Ù‚Ø±ÙˆØ¡Ø© Ø¯Ø§Ø®Ù„ WebApp (Ù„Ø§ zoom) */
    .game-container {
      max-width: 460px;
      width: 94%;
      margin: 18px auto;
      background: rgba(0,0,0,0.75);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6), 0 0 12px #ffd70033;
      -webkit-font-smoothing: antialiased;
    }

    h1 {
      margin: 8px 0 12px;
      font-size: 1.25rem;
      color: #ffd700;
      font-weight: 800;
      text-align: center;
    }

    .wallet-profile-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      margin-bottom: 14px;
      flex-wrap: nowrap;
    }

    .profile-pic-small {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 3px solid #ffd700;
      object-fit: cover;
      background-color: #222;
      box-shadow: 0 0 8px #ffd70066;
      -webkit-user-select: none;
      user-select: none;
    }

    #totalBalance {
      font-size: 0.95rem;
      color: #fff486;
      font-weight: 700;
      margin-bottom: 10px;
      text-align: center;
      min-height: 22px;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin: 12px 0;
      font-size: 0.95rem;
      color: #ffd700;
      font-weight: 700;
    }

    .coin-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin: 14px 0;
      cursor: pointer;
      user-select: none;
      font-weight: 800;
      font-size: 1.15rem;
      -webkit-tap-highlight-color: transparent;
      outline: none;
    }

    .coin-display img { width: 40px; height: 40px; border-radius: 50%; }

    .avatar { display:flex; justify-content:center; margin: 12px 0 8px; }
    .avatar img { width: 150px; max-width: 60%; border-radius: 50%; border: 5px solid #ffd700; box-shadow: 0 0 18px #ffd70088; transition: transform .18s ease; }
    .avatar img:active, .avatar img:focus { transform: scale(0.995); }

    .progress-bar { background:#333; height:22px; border-radius:10px; overflow:hidden; margin:10px 0; }
    .progress { height:100%; width:33%; transition: width .35s ease; box-shadow: 0 0 8px #00e67655 inset; }

    .info-text { text-align:center; color:#ddd; font-weight:700; font-size:.95rem; margin-bottom:8px; }

    .tap-button, .button {
      width:100%;
      padding: 12px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 800;
      border: none;
      cursor: pointer;
      display: block;
      -webkit-appearance: none;
      appearance: none;
    }

    .tap-button { background: linear-gradient(#4caf50,#388e3c); color:#fff; margin-top:8px; box-shadow: 0 6px 12px rgba(0,0,0,0.35); }
    .button { background: linear-gradient(#007aff,#005bb5); color:#fff; margin-top:12px; box-shadow: 0 6px 12px rgba(0,0,0,0.35); }

    .tabs { display:flex; gap:8px; margin-top:14px; justify-content:space-between; flex-wrap:wrap; }
    .tabs button { flex:1; min-width:80px; padding:10px; border-radius:10px; background:#222; color:#fff; border:none; font-weight:700; }

    /* Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ outline Ø£Ø²Ø±Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± (fix blue focus) */
    a, button, input, textarea { outline: none; -webkit-tap-highlight-color: transparent; }
    button:active, a:active { opacity: .95; }

    /* ØµØºÙŠØ±Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø§Øª ØµØºÙŠØ±Ø© */
    @media (max-width:420px) {
      .avatar img { width: 44vw; }
      .profile-pic-small { width:46px; height:46px; }
      .coin-display { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="username">Ø¶ÙŠÙ</span> ğŸ‘‹</h1>

    <!-- Total Balance -->
    <div id="totalBalance">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯...</div>

    <!-- Wallet + Profile -->
    <div class="wallet-profile-row">
      <img id="userPic" class="profile-pic-small" src="https://telegram.org/img/t_logo.svg" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
      <!-- TonConnect Ø£Ùˆ Ø²Ø± Ø¨Ø¯ÙŠÙ„ -->
      <div id="ton-connect" class="wallet-button"></div>
    </div>

    <div class="stats">
      <div>ğŸ’° Ù†Ù‚Ø±: +1</div>
      <div>ğŸ” Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©: 15K</div>
      <div>â° ÙƒÙ„ Ø³Ø§Ø¹Ø©: +0</div>
    </div>

    <!-- Coin Display -->
    <div class="coin-display" id="coinCount" onclick="resetBalance()" title="Ø§Ù†Ù‚Ø± Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·">
      <img src="https://github.com/simojibou/logo/blob/main/logo.PNG?raw=true" class="coin-logo" />
      <span id="coinAmount">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>

    <!-- Avatar (tap to earn) -->
    <div class="avatar" onclick="tapToEarn()" title="Ø§Ø¶ØºØ· Ù„ÙƒØ³Ø¨">
      <img src="https://github.com/simojibou/logo/blob/main/logo.PNG?raw=true" alt="SJ Frog Avatar" />
    </div>

    <div class="progress-bar" title="Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©">
      <div class="progress" id="progressBar" style="width:33%"></div>
    </div>

    <div class="info-text">ğŸ“ˆ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: 1/5 (Ù…Ø¨ØªØ¯Ø¦)</div>

    <!-- Tap Button -->
    <button class="tap-button" id="tapBtn" onclick="tapToEarn()">ğŸ‘† Ø§Ø¶ØºØ· Ù„ÙƒØ³Ø¨</button>

    <!-- Buy Button -->
    <button class="button" id="buyBtn" onclick="buyCoin()">ğŸ’¸ Ø´Ø±Ø§Ø¡ 100 SJ</button>

    <!-- Tabs -->
    <div class="tabs">
      <button onclick="navigate('explore')">ğŸ„ Ø§Ø³ØªÙƒØ´Ø§Ù</button>
      <button onclick="navigate('missions')">ğŸ¯ Ù…Ù‡Ø§Ù…</button>
      <button onclick="navigate('friends')">ğŸ‘¥ Ø£ØµØ¯Ù‚Ø§Ø¡</button>
      <button onclick="navigate('bounty')">ğŸ’ Ù…Ù‡Ù…Ø§Øª</button>
    </div>
  </div>

  <script>
    // Telegram WebApp
    const tg = window.Telegram?.WebApp;
    if (tg) {
      try {
        tg.expand();
        tg.ready();
      } catch (e) {
        console.warn("Telegram WebApp methods may not be available yet.", e);
      }
    }

    const user = tg?.initDataUnsafe?.user || {};
    const userId = user?.id ? String(user.id) : null;
    document.getElementById("username").innerText = user?.first_name || "Ø¶ÙŠÙ";

    // ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù…Ù† Telegram Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const userPic = document.getElementById("userPic");
    if (user?.photo_url) {
      userPic.src = user.photo_url;
    }

    // Firebase config - Ø¹Ø¯Ù‘Ù„ Ø¥Ø°Ø§ Ø§Ø­ØªØ¬Øª
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase (compat)
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // TonConnect: Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ø¬Ù‡Ø© TonConnect UI Ø«Ù… Ù†ÙˆÙØ± Ø²Ø± Ø¨Ø¯ÙŠÙ„
    const tonRoot = document.getElementById('ton-connect');

    function createFallbackTonButton() {
      const btn = document.createElement('button');
      btn.className = 'button';
      btn.style.background = 'linear-gradient(#ffb74d,#ff9800)';
      btn.innerText = 'ğŸ”— Connect TON';
      btn.onclick = async () => {
        alert('ÙØªØ­ TonConnect Ø£Ùˆ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ø­ÙØ¸Ø©...');
        // Ø¥Ù† Ø£Ø±Ø¯Øª Ø±Ø¨Ø· TonConnect ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ API Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        // Ù…Ø«Ø§Ù„ Ø¨Ø¯Ø§Ø¦ÙŠ: ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù€ manifest Ø£Ùˆ ØªÙ†ÙÙŠØ° TonConnect UI
        if (window.TonConnectUI) {
          try {
            const tc = new TonConnectUI.TonConnectUI({ manifestUrl: 'https://raw.githubusercontent.com/simojibou/tonconnect/main/tonconnect-manifest.json', buttonRootId: 'ton-connect' });
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø© ØªØ¹Ù…Ù„ ÙØ³ØªÙ†Ø´Ø¦ Ø²Ø±Ù‘Ø§Ù‹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            console.log('TonConnectUI initialized (attempt).');
          } catch (err) {
            console.warn('TonConnectUI initialization failed:', err);
          }
        } else {
          // fallback behavior
          window.open('https://ton.org', '_blank');
        }
      };
      tonRoot.appendChild(btn);
    }

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© TonConnect Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª
    try {
      if (window.TonConnectUI && typeof window.TonConnectUI.TonConnectUI === 'function') {
        // Ø¥Ù†Ø´Ø§Ø¡ TonConnect UI ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù…Ø®ØµØµ
        new window.TonConnectUI.TonConnectUI({
          manifestUrl: 'https://raw.githubusercontent.com/simojibou/tonconnect/main/tonconnect-manifest.json',
          buttonRootId: 'ton-connect'
        });
      } else {
        createFallbackTonButton();
      }
    } catch (e) {
      console.warn('TonConnect setup error:', e);
      createFallbackTonButton();
    }

    // Ø¹Ù…Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    let coins = 0;

    async function loadCoins() {
      if (!userId) {
        document.getElementById("coinAmount").innerText = 'Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Ø§Ù„ØªÙ„Ø¬Ø±Ø§Ù…';
        return;
      }
      try {
        const doc = await db.collection("users").doc(userId).get();
        coins = doc.exists ? (doc.data().coins || 0) : 0;
        updateCoinDisplay();
      } catch (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Øª:", err);
        document.getElementById("coinAmount").innerText = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
      }
    }

    function updateCoinDisplay() {
      document.getElementById("coinAmount").innerText = `${coins.toLocaleString()} SJ COIN`;
    }

    async function tapToEarn() {
      if (!userId) {
        alert("ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„Ø¨ÙˆØª Ø¯Ø§Ø®Ù„ Telegram Ù„ØªØ³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
        return;
      }
      try {
        const userRef = db.collection("users").doc(userId);
        await userRef.set({
          coins: firebase.firestore.FieldValue.increment(1)
        }, { merge: true });
        const doc = await userRef.get();
        coins = doc.exists ? (doc.data().coins || 0) : 0;
        updateCoinDisplay();
        await loadTotalBalance();
      } catch (error) {
        console.error("Error incrementing coins:", error);
      }
    }

    async function resetBalance() {
      if (!userId) {
        coins = 0;
        updateCoinDisplay();
        return;
      }
      try {
        coins = 0;
        await db.collection("users").doc(userId).set({ coins }, { merge: true });
        updateCoinDisplay();
        await loadTotalBalance();
      } catch (err) {
        console.error("Error resetting balance:", err);
      }
    }

    function buyCoin() {
      const purchaseData = {
        action: "buy",
        amount: 100,
        timestamp: Date.now(),
        user: user?.id || null
      };
      // Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨ÙˆØª (Telegram WebApp sendData)
      try {
        tg.sendData(JSON.stringify(purchaseData));
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (tg.MainButton) {
          tg.MainButton.setText("Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø£ÙØ±Ø³Ù„ âœ…");
          tg.MainButton.show();
          setTimeout(() => tg.MainButton.hide(), 1800);
        }
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ 100 SJ. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙˆØª.");
      } catch (e) {
        console.warn("sendData unavailable:", e);
        alert("ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± WebApp. Ø§ÙØªØ­ Ø§Ù„Ø¨ÙˆØª Ù…Ø¨Ø§Ø´Ø±Ø©.");
      }
    }

    async function loadTotalBalance() {
      const totalEl = document.getElementById("totalBalance");
      try {
        const snapshot = await db.collection("users").get();
        let total = 0;
        snapshot.forEach(doc => {
          const val = doc.data().coins || 0;
          total += val;
        });
        totalEl.innerText = `ğŸŒŸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ SJ COIN: ${total.toLocaleString()}`;
      } catch (error) {
        console.error("Error loading total balance:", error);
        totalEl.innerText = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯";
      }
    }

    // ØªÙ†Ù‚Ù„ Ù„Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙƒÙ…Ø§ ØªØ±ÙŠØ¯)
    function navigate(page) {
      // Ø¶Ù…Ù† Telegram WebAppØŒ Ø§Ù„Ø§ÙØ¶Ù„ ÙØªØ­ ØµÙØ­Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆÙŠØ¨ Ø¢Ø¨ Ø£Ùˆ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      // Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ø¹Ø±Ø¶ alert Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
      switch(page) {
        case 'explore': window.location.href = 'earning.html'; break;
        case 'missions': window.location.href = 'sjap.html'; break;
        case 'friends': window.location.href = 'friends.html'; break;
        case 'bounty': window.location.href = 'pys.html'; break;
        default: break;
      }
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    (async function init() {
      await loadCoins();
      await loadTotalBalance();

      // Ø§Ø³ØªØ®Ø¯Ù… MainButton Ù„Ø¹Ø±Ø¶ Ø²Ø± Ù…Ù‡Ù… Ø¯Ø§Ø®Ù„ Telegram (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      try {
        if (tg && tg.MainButton) {
          tg.MainButton.setText("Ø§Ø³ØªØ®Ø¯Ø§Ù… Main Button");
          tg.MainButton.show();
          tg.MainButton.onClick(() => {
            // Ù…Ø«Ø§Ù„: Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ MainButton
            if (userId) {
              tg.sendData(JSON.stringify({ action: 'main_button_clicked', user: userId }));
            } else {
              alert("Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡");
            }
          });
        }
      } catch (e) {
        console.warn("MainButton not available:", e);
      }

      // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù„Ù…Ø³: Ù…Ù†Ø¹ ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
      const tapBtn = document.getElementById('tapBtn');
      tapBtn.addEventListener('touchstart', () => {}, {passive:true});
    })();
  </script>
</body>
</html>
