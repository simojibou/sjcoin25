<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SJ COIN Referral & Affiliate System</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white">

  <!-- Loading Screen -->
  <div id="loading" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="text-center">
      <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-20 h-20 rounded-full mx-auto mb-4 animate-pulse" />
      <p class="text-lg font-medium">Loading...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div id="errorMessage" class="fixed inset-0 bg-red-900/90 flex items-center justify-center z-40" style="display:none;">
    <div class="text-center px-6">
      <p class="text-lg font-medium mb-4">Something went wrong. Please try again.</p>
      <button onclick="location.reload()" class="bg-white text-black px-6 py-2 rounded-lg font-medium">
        Reload
      </button>
    </div>
  </div>

  <main class="max-w-xl mx-auto px-6 py-8 pt-16">
    <div class="text-center mb-8">
      <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-white/20" />
      <h1 class="text-3xl font-bold uppercase bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent mb-2">
        SJ COIN Referral & Affiliate Program
      </h1>
      <p class="text-white/80 font-medium">Invite friends and earn commissions!</p>
    </div>

    <!-- Referral Link Display -->
    <div class="mb-6 p-4 bg-white/10 rounded-xl border border-white/10 break-words">
      <p class="text-xs text-white/60 mb-1">Your referral link:</p>
      <p id="referralDisplay" class="text-sm font-mono text-yellow-300"></p>
    </div>

    <!-- Referral Code Input -->
    <div class="mb-6 p-4 bg-white/10 rounded-xl border border-white/10">
      <p class="text-xs text-white/60 mb-2">أدخل كود الإحالة للحصول على 50 SJ:</p>
      <input id="referralCodeInput" type="text" placeholder="أدخل الكود هنا" class="w-full px-4 py-2 rounded-lg text-black mb-3" />
      <button id="applyReferralBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold">تفعيل الكود</button>
    </div>

    <!-- Buttons -->
    <div class="flex gap-3 mb-8">
      <button id="copyLinkBtn" class="flex-1 bg-white/20 text-white px-6 py-3 rounded-xl font-bold border border-white/20 hover:bg-white/30 transition-all">
        📋 Copy Link
      </button>
      <button id="inviteBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
        👥 Invite Friends
      </button>
    </div>

    <!-- Affiliate Stats -->
    <div id="affiliateStats" class="mb-6 p-4 bg-white/10 rounded-xl border border-white/10 hidden"></div>

    <!-- Bonuses Info -->
    <section id="bonuses" class="mb-6 space-y-4"></section>

    <button id="toggleBonusesBtn" class="mb-6 text-sm text-yellow-400 hover:underline">
      Show more bonuses
    </button>

    <section id="levelBonuses" class="hidden overflow-x-auto rounded-xl border border-white/20 mb-8">
      <table class="w-full text-white text-left text-sm border-collapse">
        <thead class="bg-white/10">
          <tr>
            <th class="px-3 py-3">Level</th>
            <th class="px-3 py-3 text-right">Base Bonus</th>
            <th class="px-3 py-3 text-right">Premium Bonus</th>
          </tr>
        </thead>
        <tbody id="levelBonusesTable"></tbody>
      </table>
    </section>

    <!-- Friends List -->
    <section>
      <h2 id="friendCount" class="text-xl font-semibold mb-3">Your Friends</h2>
      <div id="friendsList" class="space-y-3"></div>
    </section>
  </main>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      setDoc,
      updateDoc,
      increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-lite.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const telegramUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
    const telegramId = telegramUser.id?.toString() || "demo_user";
    const firstName = telegramUser.first_name || "Demo";
    const lastName = telegramUser.last_name || "User";
    const isPremium = telegramUser.is_premium || false;

    const botUrl = "https://t.me/sjcoin25bot";
    const referralLink = `${botUrl}?startapp=ref${telegramId}`;

    const referralCodeInput = document.getElementById("referralCodeInput");
    const applyReferralBtn = document.getElementById("applyReferralBtn");
    const referralDisplay = document.getElementById("referralDisplay");

    async function ensureUserExists() {
      const userRef = doc(db, "users", telegramId);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) {
        await setDoc(userRef, {
          id: telegramId,
          first_name: firstName,
          last_name: lastName,
          referred_by: null,
          balance: 0,
          premium: isPremium,
          referral_count: 0,
          total_earned: 0
        });
      }
    }

    async function applyReferralCode() {
      const code = referralCodeInput.value.trim();
      if (!code || code === telegramId) return alert("كود غير صالح");

      const refUserRef = doc(db, "users", code);
      const refUserSnap = await getDoc(refUserRef);

      if (!refUserSnap.exists()) return alert("الكود غير موجود");

      // منح 50 SJ للطرفين
      await updateDoc(refUserRef, { balance: increment(50) });
      await updateDoc(doc(db, "users", telegramId), { balance: increment(50), referred_by: code });

      alert("تم تفعيل الكود وحصلت على 50 SJ 🎉");
    }

    applyReferralBtn.onclick = applyReferralCode;

    function init() {
      ensureUserExists();
      referralDisplay.textContent = referralLink;
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
