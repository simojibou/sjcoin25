<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Referral System</title>
  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // إعدادات Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // بيانات التليجرام (افتراضية للاختبار)
    const telegramUser = {
      id: "user123",
      first_name: "Test",
      last_name: "User",
      username: "testuser",
      is_premium: false
    };

    const telegramId = telegramUser.id;
    const firstName = telegramUser.first_name;
    const lastName = telegramUser.last_name;
    const isPremium = telegramUser.is_premium;

    let referralConfig = { base: { welcome: 50 } };
    const referralLink = `https://t.me/YOUR_BOT?startapp=${telegramId}`;

    // عرض رابط الإحالة في الصفحة
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("referralLinkText").textContent = referralLink;
    });

    function getReferralCode() {
      const params = new URLSearchParams(window.location.search);
      const startParam = params.get("startapp");
      return startParam || null;
    }

    async function ensureUserExists() {
      try {
        const userRef = doc(db, "users", telegramId);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          const referralCode = getReferralCode();

          const newUser = {
            id: telegramId,
            first_name: firstName,
            last_name: lastName,
            username: telegramUser?.username || "",
            referred_by: referralCode,
            balance: 0,
            premium: isPremium,
            level: { name: "Bronze", level: 1 },
            referral_count: 0,
            total_earned: 0,
            created_at: new Date().toISOString(),
            last_active: new Date().toISOString()
          };

          await setDoc(userRef, newUser);

          if (referralCode && referralCode !== telegramId) {
            // 🎁 بونص للمستخدم الجديد
            await giveJoinBonus(newUser.id);

            // 🎁 بونص للمسوق
            await giveReferralBonus(referralCode);
          }
        } else {
          await updateDoc(userRef, { last_active: new Date().toISOString() });
        }
      } catch (error) {
        console.error("Error ensuring user exists:", error);
      }
    }

    async function giveJoinBonus(userId) {
      try {
        const userRef = doc(db, "users", userId);
        await updateDoc(userRef, {
          balance: increment(referralConfig.base.welcome),
          total_earned: increment(referralConfig.base.welcome)
        });
        console.log(`✅ Join bonus given to ${userId}`);
      } catch (error) {
        console.error("Error giving join bonus:", error);
      }
    }

    async function giveReferralBonus(referrerId) {
      try {
        const referrerRef = doc(db, "users", referrerId);
        await updateDoc(referrerRef, {
          balance: increment(referralConfig.base.welcome),
          total_earned: increment(referralConfig.base.welcome),
          referral_count: increment(1)
        });
        console.log(`✅ Referral bonus given to ${referrerId}`);
      } catch (error) {
        console.error("Error giving referral bonus:", error);
      }
    }

    async function initializeAppData() {
      await ensureUserExists();
      console.log("App initialized ✅");
    }

    initializeAppData();

  </script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4">نظام الإحالة</h1>
  <p>رابط الإحالة الخاص بك:</p>
  <p id="referralLinkText" class="font-mono break-all bg-white p-2 rounded shadow"></p>
</body>
</html>
