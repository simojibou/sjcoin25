<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>SJ COIN - Daily Tasks</title>
<style>
  body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f3f7;
    color: #222;
    padding: 16px;
  }
  header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }
  #back-btn {
    background-color: #1a73e8;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }
  #user-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-grow: 1;
  }
  #user-photo {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    background: #ccc;
  }
  #user-name {
    font-weight: 600;
    font-size: 1.2rem;
  }
  #user-balance {
    font-weight: 700;
    font-size: 1rem;
    color: #2e8b57;
  }
  h2 {
    font-size: 1.3rem;
    margin-bottom: 12px;
  }
  #tasks {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .task {
    background: #fff;
    border-radius: 12px;
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
  }
  .task img {
    width: 56px;
    height: 56px;
    border-radius: 10px;
    object-fit: cover;
  }
  .task-info {
    flex-grow: 1;
  }
  .task-name {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 4px;
  }
  .task-link {
    display: inline-block;
    font-size: 0.9rem;
    margin-bottom: 6px;
    color: #1a73e8;
    text-decoration: none;
  }
  .task-reward {
    font-size: 0.9rem;
    color: #555;
  }
  button.complete-btn {
    background-color: #1a73e8;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    user-select: none;
  }
  button.complete-btn:disabled {
    background-color: #aaa;
    cursor: default;
  }
</style>
</head>
<body>

<header>
  <button id="back-btn">Back</button>
  <div id="user-info">
    <img id="user-photo" src="" alt="User Photo" />
    <div>
      <div id="user-name">Loading user...</div>
      <div>Balance: <span id="user-balance">0</span> SJ Coins</div>
    </div>
  </div>
</header>

<h2>Daily Tasks</h2>
<div id="tasks">Loading tasks...</div>

<!-- Telegram Web App SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
tg.MainButton.text = "Close";
tg.MainButton.onClick(() => tg.close());

const userId = String(tg.initDataUnsafe.user.id);

document.getElementById("back-btn").addEventListener("click", () => {
  // يرجع للصفحة السابقة في المتصفح
  if (window.history.length > 1) {
    window.history.back();
  } else {
    // لو ما في صفحة سابقة، يغلق الميني آب (اختياري)
    tg.close();
  }
});

function renderTasks(tasks, completedTasks) {
  const container = document.getElementById("tasks");
  container.innerHTML = "";
  if (!tasks) {
    container.innerHTML = "<p>No tasks available.</p>";
    return;
  }

  Object.keys(tasks).forEach(key => {
    const task = tasks[key];
    const completed = completedTasks && completedTasks[key] === true;

    let imgSrc = task.image;
    if (!imgSrc.startsWith("http")) {
      imgSrc = "https://yourdomain.com" + imgSrc;
    }

    const taskDiv = document.createElement("div");
    taskDiv.className = "task";

    taskDiv.innerHTML = `
      <img src="${imgSrc}" alt="${task.name}" />
      <div class="task-info">
        <div class="task-name">${task.name}</div>
        <a href="${task.link}" target="_blank" rel="noopener" class="task-link">Go to task</a>
        <div class="task-reward">Reward: ${task.reward_coins} SJ Coins</div>
      </div>
      <button class="complete-btn" ${completed ? "disabled" : ""} data-key="${key}">
        ${completed ? "Completed" : "Complete Task"}
      </button>
    `;

    container.appendChild(taskDiv);
  });
}

function loadUserData() {
  db.ref(`users/${userId}`).once("value").then(userSnap => {
    const user = userSnap.val();

    if (!user) {
      const newUser = {
        balance: 0,
        name: tg.initDataUnsafe.user?.first_name || "New User",
        photo: tg.initDataUnsafe.user?.photo_url || "",
        completedTasks: {}
      };
      db.ref(`users/${userId}`).set(newUser).then(() => {
        loadUserData();
      });
      return;
    }

    document.getElementById("user-name").textContent = user.name || "No Name";
    document.getElementById("user-balance").textContent = user.balance || 0;
    document.getElementById("user-photo").src = user.photo || "https://via.placeholder.com/56";

    db.ref("DailyTasks").once("value").then(tasksSnap => {
      renderTasks(tasksSnap.val(), user.completedTasks);
    });
  });
}

document.getElementById("tasks").addEventListener("click", e => {
  if (e.target.tagName === "BUTTON" && !e.target.disabled) {
    const key = e.target.getAttribute("data-key");
    if (!key) return;

    db.ref(`DailyTasks/${key}`).once("value").then(taskSnap => {
      const reward = taskSnap.val()?.reward_coins || 0;

      db.ref(`users/${userId}/balance`).transaction(balance => (balance || 0) + reward)
        .then(() => {
          return db.ref(`users/${userId}/completedTasks/${key}`).set(true);
        })
        .then(() => {
          alert(`Congrats! You earned ${reward} SJ Coins.`);
          loadUserData();
        })
        .catch(err => alert("Error updating data: " + err.message));
    });
  }
});

const firebaseConfig = {
  apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
  authDomain: "metawarefare-gaming.firebaseapp.com",
  databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
  projectId: "metawarefare-gaming",
  storageBucket: "metawarefare-gaming.appspot.com",
  messagingSenderId: "551352148152",
  appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

loadUserData();
</script>

</body>
</html>
