<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Affiliate System</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const tg = window.Telegram.WebApp;
    tg.ready();

    // Apply Telegram theme
    document.body.style.backgroundColor = tg.themeParams.bg_color || '#f0f2f5';
    document.body.style.color = tg.themeParams.text_color || '#333';
    document.querySelectorAll('button').forEach(btn => {
      btn.style.backgroundColor = tg.themeParams.button_color || '#0088cc';
      btn.style.color = tg.themeParams.button_text_color || '#fff';
    });

    const user = tg.initDataUnsafe.user;
    const botToken = "YOUR_BOT_TOKEN"; // Replace with your Telegram Bot Token
    const botChatId = "@YourBotUsername"; // Replace with your bot's username

    window.addEventListener("load", async () => {
      if (user) {
        await loginOrRegister(user);
        tg.expand(); // Expand the Telegram Mini App
        tg.enableClosingConfirmation(); // Prevent accidental closure
      } else {
        document.getElementById("auth-section").style.display = "block";
      }
      // Initialize Telegram inline buttons
      setupInlineButtons();
    });

    async function loginOrRegister(user) {
      try {
        await signInAnonymously(auth);
        const userRef = doc(db, "users", user.id.toString());
        const snap = await getDoc(userRef);
        const params = new URLSearchParams(window.location.search);
        const referredBy = params.get("ref") || null;

        if (!snap.exists()) {
          const referralCode = generateReferralCode();
          await setDoc(userRef, {
            id: user.id.toString(),
            name: user.first_name + " " + (user.last_name || ""),
            telegram_id: user.id.toString(),
            referral_code: referralCode,
            referred_by: referredBy,
            rank: "Level 1",
            referrals_count: 0,
            subscription_status: "inactive",
            join_date: serverTimestamp(),
            language: tg.initDataUnsafe.language_code || "en"
          });
          if (referredBy) {
            await addDoc(collection(db, "referrals"), {
              referrer_id: referredBy,
              referred_user_id: user.id.toString(),
              timestamp: serverTimestamp()
            });
            // Notify referrer via Telegram bot
            await sendTelegramNotification(referredBy, `ðŸŽ‰ New referral! ${user.first_name} joined using your link!`);
          }
          // Welcome message
          await sendTelegramNotification(user.id, `Welcome to the Affiliate System, ${user.first_name}! Share your referral link to earn rewards.`);
        }

        checkSubscriptionStatus(user.id.toString());
        loadLeaderboard();
      } catch (e) {
        showError(e.message);
      }
    }

    function generateReferralCode() {
      return "REF" + Math.random().toString(36).substr(2, 9).toUpperCase();
    }

    async function checkSubscriptionStatus(userId) {
      const userRef = doc(db, "users", userId);
      const snap = await getDoc(userRef);
      const data = snap.data();
      if (data.subscription_status === "active") {
        document.getElementById("payment-wall").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("missions").style.display = "block";
        document.getElementById("leaderboard").style.display = "block";
        loadDashboard(userId);
        loadMissions(userId);
      } else {
        document.getElementById("payment-wall").style.display = "block";
      }
    }

    async function loadDashboard(userId) {
      const userRef = doc(db, "users", userId);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data();
      const referralLink = `https://t.me/${botChatId}?start=${userData.referral_code}`; // Deep link for Telegram

      document.getElementById("referral-link").textContent = referralLink;
      document.getElementById("referral-link").href = referralLink;
      document.getElementById("referrals-count").textContent = userData.referrals_count;
      document.getElementById("rank").textContent = userData.rank;
      document.getElementById("subscription-status").textContent = userData.subscription_status;
      document.getElementById("earnings").textContent = await calculateEarnings(userId);
      document.getElementById("analytics").textContent = await calculateAnalytics(userId);
      await updateRank(userId, userData.referrals_count);
    }

    async function calculateEarnings(userId) {
      const refQuery = query(collection(db, "referrals"), where("referrer_id", "==", userId));
      const refSnap = await getDocs(refQuery);
      let total = 0;
      for (const docSnap of refSnap.docs) {
        const referredId = docSnap.data().referred_user_id;
        const paymentsQuery = query(collection(db, "payments"), where("user_id", "==", referredId));
        const paymentsSnap = await getDocs(paymentsQuery);
        for (const pay of paymentsSnap.docs) {
          const payment = pay.data();
          const userRef = doc(db, "users", userId);
          const userSnap = await getDoc(userRef);
          const rank = userSnap.data().rank;
          const rate = rank === "Level 3" ? 0.2 : rank === "Level 2" ? 0.1 : 0;
          total += payment.amount * rate;
        }
      }
      return total.toFixed(2);
    }

    async function calculateAnalytics(userId) {
      const refQuery = query(collection(db, "referrals"), where("referrer_id", "==", userId));
      const refSnap = await getDocs(refQuery);
      const totalReferrals = refSnap.size;
      const paidReferrals = await getDocs(query(collection(db, "payments"), where("user_id", "in", refSnap.docs.map(doc => doc.data().referred_user_id))));
      const conversionRate = totalReferrals > 0 ? (paidReferrals.size / totalReferrals * 100).toFixed(2) : 0;
      return `Conversion Rate: ${conversionRate}%`;
    }

    async function updateRank(userId, count) {
      const rank = count >= 10 ? "Level 3" : count >= 5 ? "Level 2" : "Level 1";
      await updateDoc(doc(db, "users", userId), { rank });
      if (rank !== (await getDoc(doc(db, "users", userId))).data().rank) {
        await sendTelegramNotification(userId, `ðŸŽ‰ Congratulations! You've reached ${rank}!`);
      }
    }

    async function sendTelegramNotification(userId, message) {
      try {
        await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: userId,
            text: message,
            parse_mode: "Markdown"
          })
        });
      } catch (e) {
        console.error("Failed to send Telegram notification:", e);
      }
    }

    function setupInlineButtons() {
      tg.MainButton.setText("Share Referral Link").show().onClick(() => {
        const referralLink = document.getElementById("referral-link").textContent;
        tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=Join the Affiliate System and earn rewards!`);
      });
      tg.BackButton.show().onClick(() => {
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("missions").style.display = "block";
        document.getElementById("leaderboard").style.display = "block";
        document.getElementById("payment-wall").style.display = "none";
      });
    }

    window.initiateTelegramStarsPayment = async function () {
      try {
        const response = await fetch("YOUR_CLOUD_FUNCTION_URL/createStarsInvoice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: user.id.toString() })
        });
        const result = await response.json();
        if (result.error) return showError(result.error);
        tg.openTelegramLink(result.invoiceLink);
        tg.showPopup({
          title: "Payment Initiated",
          message: "Please complete the payment in Telegram Stars.",
          buttons: [{ type: "ok" }]
        });
      } catch (e) {
        showError(e.message);
      }
    };

    window.addMission = async function (type) {
      try {
        await addDoc(collection(db, "missions"), {
          user_id: user.id.toString(),
          mission_type: type,
          completed: true,
          points: 10,
          timestamp: serverTimestamp()
        });
        loadMissions(user.id.toString());
        await sendTelegramNotification(user.id, `ðŸŽ‰ Mission "${type}" completed! You earned 10 points.`);
      } catch (e) {
        showError(e.message);
      }
    };

    async function loadMissions(userId) {
      const q = query(collection(db, "missions"), where("user_id", "==", userId));
      const snap = await getDocs(q);
      const list = document.getElementById("mission-list");
      list.innerHTML = "";
      snap.forEach(mission => {
        const li = document.createElement("li");
        li.textContent = `${mission.data().mission_type}: ${mission.data().points} points (${mission.data().completed ? "Completed" : "Pending"})`;
        list.appendChild(li);
      });
    }

    async function loadLeaderboard() {
      const q = query(collection(db, "users"), where("referrals_count", ">", 0));
      const snap = await getDocs(q);
      const list = document.getElementById("leaderboard-list");
      list.innerHTML = "";
      snap.forEach(user => {
        const li = document.createElement("li");
        li.textContent = `${user.data().name}: ${user.data().referrals_count} referrals (${user.data().rank})`;
        list.appendChild(li);
      });
    }

    function showError(msg) {
      tg.showPopup({
        title: "Error",
        message: msg,
        buttons: [{ type: "ok" }]
      });
      document.getElementById("error-message").textContent = msg;
    }

    // Localization support
    const translations = {
      en: {
        welcome: "Welcome to the Affiliate System!",
        dashboard: "Dashboard",
        referrals: "Referrals",
        earnings: "Earnings",
        rank: "Rank",
        subscription: "Subscription Status",
        missions: "Daily Missions",
        leaderboard: "Leaderboard"
      },
      ar: {
        welcome: "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©!",
        dashboard: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…",
        referrals: "Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª",
        earnings: "Ø§Ù„Ø£Ø±Ø¨Ø§Ø­",
        rank: "Ø§Ù„Ø±ØªØ¨Ø©",
        subscription: "Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ",
        missions: "Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©",
        leaderboard: "Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©"
      }
    };

    function applyLanguage(lang) {
      const t = translations[lang] || translations.en;
      document.querySelector("h1").textContent = t.welcome;
      document.querySelector("#dashboard h2").textContent = t.dashboard;
      document.querySelector("#missions h3").textContent = t.missions;
      document.querySelector("#leaderboard h3").textContent = t.leaderboard;
      document.querySelector("#referrals-count").previousElementSibling.textContent = t.referrals + ": ";
      document.querySelector("#earnings").previousElementSibling.textContent = t.earnings + ": $";
      document.querySelector("#rank").previousElementSibling.textContent = t.rank + ": ";
      document.querySelector("#subscription-status").previousElementSibling.textContent = t.subscription + ": ";
    }

    // Apply user language
    if (user) {
      const userRef = doc(db, "users", user.id.toString());
      const snap = await getDoc(userRef);
      applyLanguage(snap.data()?.language || "en");
    }
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
      transition: background-color 0.3s, color 0.3s;
    }
    #app {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      padding: 12px 24px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    button:hover {
      filter: brightness(90%);
    }
    a {
      color: inherit;
      text-decoration: none;
      font-weight: bold;
    }
    a:hover {
      text-decoration: underline;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      padding: 12px;
      margin: 8px 0;
      background: #eee;
      border-radius: 8px;
      font-size: 14px;
    }
    h1, h2, h3 {
      margin: 10px 0;
    }
    #error-message {
      color: red;
      font-size: 14px;
      margin: 10px 0;
    }
    #leaderboard {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Affiliate System</h1>
    <div id="auth-section" style="display:none;">
      <button onclick="telegramLogin()">Login with Telegram</button>
    </div>
    <div id="payment-wall" style="display:none;">
      <h2>Subscribe for $50/month</h2>
      <button onclick="initiateTelegramStarsPayment()">Pay with Telegram Stars</button>
      <div id="error-message"></div>
    </div>
    <div id="dashboard" style="display:none;">
      <h2>Dashboard</h2>
      <p>Referral Link: <a id="referral-link" href="#"></a></p>
      <p>Referrals: <span id="referrals-count"></span></p>
      <p>Earnings: $<span id="earnings"></span></p>
      <p>Analytics: <span id="analytics"></span></p>
      <p>Rank: <span id="rank"></span></p>
      <p>Subscription Status: <span id="subscription-status"></span></p>
    </div>
    <div id="missions" style="display:none;">
      <h3>Daily Missions</h3>
      <ul id="mission-list"></ul>
      <button onclick="addMission('share_tiktok')">Share on TikTok</button>
      <button onclick="addMission('invite_friend')">Invite a Friend</button>
      <button onclick="addMission('daily_checkin')">Daily Check-in</button>
    </div>
    <div id="leaderboard" style="display:none;">
      <h3>Leaderboard</h3>
      <ul id="leaderboard-list"></ul>
    </div>
  </div>
</body>
</html>
