<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Affiliate System</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const tg = window.Telegram.WebApp;
    tg.ready();

    const user = tg.initDataUnsafe.user;

    window.addEventListener("load", async () => {
      if (user) {
        await loginOrRegister(user);
      } else {
        document.getElementById("auth-section").style.display = "block";
      }
    });

    async function loginOrRegister(user) {
      try {
        await signInAnonymously();
        const userRef = doc(db, "users", user.id.toString());
        const snap = await getDoc(userRef);
        const params = new URLSearchParams(window.location.search);
        const referredBy = params.get("ref") || null;

        if (!snap.exists()) {
          const referralCode = generateReferralCode();
          await setDoc(userRef, {
            id: user.id.toString(),
            name: user.first_name + " " + (user.last_name || ""),
            telegram_id: user.id.toString(),
            referral_code: referralCode,
            referred_by: referredBy,
            rank: "Level 1",
            referrals_count: 0,
            subscription_status: "inactive",
            join_date: serverTimestamp()
          });
          if (referredBy) {
            await addDoc(collection(db, "referrals"), {
              referrer_id: referredBy,
              referred_user_id: user.id.toString(),
              timestamp: serverTimestamp()
            });
          }
        }

        checkSubscriptionStatus(user.id.toString());
      } catch (e) {
        showError(e.message);
      }
    }

    function generateReferralCode() {
      return "REF" + Math.random().toString(36).substr(2, 9).toUpperCase();
    }

    async function checkSubscriptionStatus(userId) {
      const userRef = doc(db, "users", userId);
      const snap = await getDoc(userRef);
      const data = snap.data();
      if (data.subscription_status === "active") {
        document.getElementById("payment-wall").style.display = "none";
        document.getElementById("dashboard").style.display = "block";
        document.getElementById("missions").style.display = "block";
        loadDashboard(userId);
        loadMissions(userId);
      } else {
        document.getElementById("payment-wall").style.display = "block";
      }
    }

    async function loadDashboard(userId) {
      const userRef = doc(db, "users", userId);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data();
      const referralLink = `https://metawarefare-gaming.web.app/?ref=${userData.referral_code}`;

      document.getElementById("referral-link").textContent = referralLink;
      document.getElementById("referral-link").href = referralLink;
      document.getElementById("referrals-count").textContent = userData.referrals_count;
      document.getElementById("rank").textContent = userData.rank;
      document.getElementById("subscription-status").textContent = userData.subscription_status;
      document.getElementById("earnings").textContent = await calculateEarnings(userId);
      await updateRank(userId, userData.referrals_count);
    }

    async function calculateEarnings(userId) {
      const refQuery = query(collection(db, "referrals"), where("referrer_id", "==", userId));
      const refSnap = await getDocs(refQuery);
      let total = 0;
      for (const docSnap of refSnap.docs) {
        const referredId = docSnap.data().referred_user_id;
        const paymentsQuery = query(collection(db, "payments"), where("user_id", "==", referredId));
        const paymentsSnap = await getDocs(paymentsQuery);
        for (const pay of paymentsSnap.docs) {
          const payment = pay.data();
          const userRef = doc(db, "users", userId);
          const userSnap = await getDoc(userRef);
          const rank = userSnap.data().rank;
          const rate = rank === "Level 3" ? 0.2 : rank === "Level 2" ? 0.1 : 0;
          total += payment.amount * rate;
        }
      }
      return total.toFixed(2);
    }

    async function updateRank(userId, count) {
      const rank = count >= 10 ? "Level 3" : count >= 5 ? "Level 2" : "Level 1";
      await updateDoc(doc(db, "users", userId), { rank });
    }

    window.initiateTelegramStarsPayment = async function () {
      try {
        const response = await fetch("YOUR_CLOUD_FUNCTION_URL/createStarsInvoice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: user.id.toString() })
        });
        const result = await response.json();
        if (result.error) return showError(result.error);
        Telegram.WebApp.openTelegramLink(result.invoiceLink);
      } catch (e) {
        showError(e.message);
      }
    };

    window.addMission = async function (type) {
      try {
        await addDoc(collection(db, "missions"), {
          user_id: user.id.toString(),
          mission_type: type,
          completed: true,
          points: 10,
          timestamp: serverTimestamp()
        });
        loadMissions(user.id.toString());
      } catch (e) {
        showError(e.message);
      }
    };

    async function loadMissions(userId) {
      const q = query(collection(db, "missions"), where("user_id", "==", userId));
      const snap = await getDocs(q);
      const list = document.getElementById("mission-list");
      list.innerHTML = "";
      snap.forEach(mission => {
        const li = document.createElement("li");
        li.textContent = `${mission.data().mission_type}: ${mission.data().points} points (${mission.data().completed ? "Completed" : "Pending"})`;
        list.appendChild(li);
      });
    }

    function showError(msg) {
      document.getElementById("error-message").textContent = msg;
    }
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f0f2f5;
      margin: 0;
    }
    #app {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      background: #0088cc;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #005f8a;
    }
    a { color: #0088cc; text-decoration: none; }
    a:hover { text-decoration: underline; }
    ul { list-style: none; padding: 0; }
    li { padding: 10px; margin: 5px 0; background: #eee; border-radius: 5px; }
    h1, h2, h3 { color: #333; }
    #error-message { color: red; }
  </style>
</head>
<body>
  <div id="app">
    <h1>Affiliate System</h1>
    <div id="auth-section" style="display:none;">
      <button onclick="telegramLogin()">Login with Telegram</button>
    </div>
    <div id="payment-wall" style="display:none;">
      <h2>Subscribe for $50/month</h2>
      <button onclick="initiateTelegramStarsPayment()">Pay with Telegram Stars</button>
      <div id="error-message"></div>
    </div>
    <div id="dashboard" style="display:none;">
      <h2>Dashboard</h2>
      <p>Referral Link: <a id="referral-link" href="#"></a></p>
      <p>Referrals: <span id="referrals-count"></span></p>
      <p>Earnings: $<span id="earnings"></span></p>
      <p>Rank: <span id="rank"></span></p>
      <p>Subscription Status: <span id="subscription-status"></span></p>
    </div>
    <div id="missions" style="display:none;">
      <h3>Daily Missions</h3>
      <ul id="mission-list"></ul>
      <button onclick="addMission('share_tiktok')">Share on TikTok</button>
      <button onclick="addMission('invite_friend')">Invite a Friend</button>
    </div>
  </div>
</body>
</html>
