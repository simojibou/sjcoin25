<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SJ COIN - Friends</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-lite.js";

    // 🔥 بيانات Firebase الخاصة بك
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 🧠 بيانات المستخدم - استبدلها بـ telegram_id الفعلي
    const telegramId = "123456789"; // غيّره إلى المعرّف الحقيقي
    const botUrl = "https://t.me/sjcoin25bot";
    const referralLink = `${botUrl}/?startapp=ref${telegramId}`;
    const shareMessage = encodeURIComponent("Play SJ COIN with me!");

    // 🧠 المراجع للعناصر
    const bonusesContainer = document.getElementById("bonuses");
    const levelBonusesTable = document.getElementById("levelBonusesTable");
    const friendsList = document.getElementById("friendsList");
    const friendCount = document.getElementById("friendCount");
    const levelBonusesDiv = document.getElementById("levelBonuses");

    let referralConfig = {};
    let levels = [];

    async function loadReferralConfig() {
      const refSnap = await getDoc(doc(db, "config", "referral"));
      referralConfig = refSnap.exists() ? refSnap.data() : {};
    }

    async function loadLevels() {
      const levelSnap = await getDocs(collection(db, "levels"));
      levels = levelSnap.docs.map(doc => doc.data());
    }

    async function loadFriends() {
      const q = query(collection(db, "users"), where("referred_by", "==", telegramId));
      const snap = await getDocs(q);
      const friends = snap.docs.map(doc => doc.data());

      friendCount.textContent = `List of your friends (${friends.length})`;

      if (friends.length === 0) {
        friendsList.innerHTML = `
          <div class="text-center text-white/30 border-2 border-dashed border-white/10 px-4 py-4 rounded-xl">
            You didn’t invite anyone yet
          </div>
        `;
        return;
      }

      friendsList.innerHTML = "";
      for (const user of friends) {
        friendsList.innerHTML += `
          <div class="flex items-center justify-between px-4 py-3 bg-white/10 rounded-xl">
            <div class="flex items-center gap-2">
              <img src="/images/avatar.png" class="w-8 h-8 rounded-full" />
              <div>
                <p class="text-sm font-medium">${user.first_name || ""} ${user.last_name || ""}</p>
                <p class="text-xs">${user.level?.name || ""}</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <img src="/images/coin.png" class="w-5 h-5" />
              <span class="text-sm font-medium text-yellow-400">${user.balance || 0}</span>
            </div>
          </div>
        `;
      }
    }

    async function displayBonuses() {
      bonusesContainer.innerHTML = `
        <div class="flex items-center w-full gap-4 px-4 py-2 bg-white/10 rounded-xl">
          <img src="/images/chest.png" class="w-9 h-9" />
          <div class="text-sm font-medium">
            <p>Invite a friend</p>
            <div class="flex items-center space-x-1">
              <img src="/images/coin.png" class="w-5 h-5" />
              <span class="font-bold text-yellow-400">
                +${referralConfig.base?.welcome?.toLocaleString() || 0}
              </span>
              <span class="text-sm">for you and your friend</span>
            </div>
          </div>
        </div>
        <div class="flex items-center w-full gap-4 px-4 py-2 bg-white/10 rounded-xl mt-2">
          <img src="/images/chest.png" class="w-9 h-9" />
          <div class="text-sm font-medium">
            <p>Invite a friend with Telegram premium</p>
            <div class="flex items-center space-x-1">
              <img src="/images/coin.png" class="w-5 h-5" />
              <span class="font-bold text-yellow-400">
                +${referralConfig.premium?.welcome?.toLocaleString() || 0}
              </span>
              <span class="text-sm">for you and your friend</span>
            </div>
          </div>
        </div>
      `;
    }

    async function displayLevelBonuses() {
      levelBonusesTable.innerHTML = "";
      for (const lvl of levels) {
        levelBonusesTable.innerHTML += `
          <tr class="border-b border-white/10">
            <td class="px-2 py-2">${lvl.name}</td>
            <td class="px-2 py-2 text-right">
              ${referralConfig.base?.levelUp?.[lvl.level]?.toLocaleString() || 0}
            </td>
            <td class="px-2 py-2 text-right">
              ${referralConfig.premium?.levelUp?.[lvl.level]?.toLocaleString() || 0}
            </td>
          </tr>
        `;
      }
    }

    document.getElementById("copyLinkBtn").addEventListener("click", () => {
      navigator.clipboard.writeText(referralLink).then(() => {
        alert("Referral link copied!");
      });
    });

    document.getElementById("inviteBtn").addEventListener("click", () => {
      window.open(`https://t.me/share/url?text=${shareMessage}&url=${referralLink}`, "_blank");
    });

    document.getElementById("toggleBonusesBtn").addEventListener("click", () => {
      levelBonusesDiv.classList.toggle("hidden");
    });

    // ⏳ تحميل البيانات عند فتح الصفحة
    (async () => {
      await loadReferralConfig();
      await loadLevels();
      await displayBonuses();
      await displayLevelBonuses();
      await loadFriends();
    })();
  </script>
</head>

<body class="bg-[url('/images/bg.png')] bg-cover min-h-screen text-white">
  <div class="px-6 py-8 mt-12">
    <h1 class="text-2xl font-bold text-center uppercase">Friends</h1>
    <p class="mt-2.5 font-medium text-center">You and your friend will receive bonuses.</p>

    <div id="bonuses" class="mt-4"></div>

    <div class="text-center mt-4">
      <button id="toggleBonusesBtn" class="rounded-full border-2 border-yellow-200/10 text-yellow-200 text-xs font-bold py-2.5 px-4">
        More bonuses
      </button>
    </div>

    <div id="levelBonuses" class="hidden mt-6">
      <p class="mt-8 text-sm font-bold uppercase">Bonus for leveling up</p>
      <div class="overflow-y-auto max-h-60 mt-4">
        <table class="w-full text-white text-xs">
          <thead>
            <tr class="border-b border-white/10">
              <th class="px-2 py-2 text-left">Level</th>
              <th class="px-2 py-2 text-right">For friend</th>
              <th class="px-2 py-2 text-right">Premium</th>
            </tr>
          </thead>
          <tbody id="levelBonusesTable"></tbody>
        </table>
      </div>
    </div>

    <p id="friendCount" class="mt-8 text-sm font-bold uppercase">List of your friends</p>
    <div id="friendsList" class="mt-4 space-y-4"></div>

    <div class="flex gap-3 mt-6">
      <button id="copyLinkBtn" class="bg-white text-black px-4 py-2 rounded">Copy Link</button>
      <button id="inviteBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded">Invite a Friend</button>
    </div>
  </div>
</body>
</html>
