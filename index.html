<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SJ COIN Payment</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background-color: #121212;
      color: #fff;
      font-family: 'Cairo', sans-serif;
      padding: 20px;
      text-align: center;
      direction: rtl;
      transition: background-color 0.3s, color 0.3s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    body.light-mode {
      background-color: #f5f5f5;
      color: #1a1a1a;
    }
    .container {
      max-width: 600px;
      width: 100%;
      padding: 20px;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
    }
    .purchase-options {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .purchase-option {
      padding: 10px 20px;
      background-color: #0088cc;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .purchase-option:hover {
      background-color: #00aaff;
    }
    .purchase-option.selected {
      background-color: #00ff88;
      color: #000;
    }
    button {
      background-color: #0088cc;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 1.2rem;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover {
      background-color: #00aaff;
      transform: scale(1.05);
    }
    button:disabled {
      background-color: #555;
      cursor: not-allowed;
      transform: none;
    }
    .balance {
      font-size: 1.8rem;
      margin: 20px 0;
      color: #00ff88;
    }
    .error, .info {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      font-size: 1rem;
    }
    .error {
      background-color: #ff4444;
      color: white;
    }
    .info {
      background-color: #0088cc;
      color: white;
    }
    .progress-bar {
      width: 100%;
      height: 10px;
      background-color: #333;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background-color: #00ff88;
      width: 0;
      transition: width 0.5s;
    }
    .transaction-history {
      margin-top: 20px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
    }
    .transaction-item {
      padding: 10px;
      border-bottom: 1px solid #444;
      font-size: 0.9rem;
    }
    .chart-container {
      margin-top: 20px;
      padding: 15px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }
    .theme-toggle, .lang-toggle {
      position: absolute;
      top: 20px;
      padding: 10px;
      font-size: 1rem;
      border-radius: 5px;
    }
    .theme-toggle {
      left: 20px;
    }
    .lang-toggle {
      left: 80px;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.8rem; }
      button { font-size: 1rem; padding: 12px 20px; }
      .purchase-options { flex-direction: column; }
      .theme-toggle, .lang-toggle { font-size: 0.9rem; padding: 8px; }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">üåô</button>
  <button class="lang-toggle" id="langToggle">EN</button>
  <div class="container">
    <h1 data-lang="title">ÿ¥ÿ±ÿßÿ° SJ COIN</h1>
    <div class="purchase-options" id="purchaseOptions">
      <div class="purchase-option" data-amount="0.5" data-coins="1000">0.5 TON = 1000 SJ COIN</div>
      <div class="purchase-option" data-amount="1" data-coins="2000">1 TON = 2000 SJ COIN</div>
      <div class="purchase-option" data-amount="2" data-coins="4000">2 TON = 4000 SJ COIN</div>
    </div>
    <button id="buyBtn" data-lang="buyBtn">üí∞ ÿßÿ¥ÿ™ÿ±Ÿê ÿßŸÑÿ¢ŸÜ ÿ®ŸÖÿ≠ŸÅÿ∏ÿ© TON</button>
    <br/>
    <button id="checkBtn" data-lang="checkBtn">‚úÖ ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸÅÿπ</button>
    <br/>
    <button id="refreshBtn" data-lang="refreshBtn">üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿµŸäÿØ</button>
    <div class="balance" id="balance" data-lang="balance">ÿ±ÿµŸäÿØŸÉ: ...</div>
    <div class="info" id="info"></div>
    <div class="error" id="error"></div>
    <div class="progress-bar" id="progressBar">
      <div class="progress-bar-fill" id="progressBarFill"></div>
    </div>
    <div class="transaction-history">
      <h3 data-lang="historyTitle">ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™</h3>
      <div id="transactions"></div>
    </div>
    <div class="chart-container">
      <canvas id="balanceChart"></canvas>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // Embedded Service Worker code
    const serviceWorkerCode = `
      const CACHE_NAME = "sj-coin-cache-v1";
      const urlsToCache = ["/", "/index.html", "https://cdn.jsdelivr.net/npm/chart.js"];

      self.addEventListener("install", event => {
        event.waitUntil(
          caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
        );
      });

      self.addEventListener("fetch", event => {
        event.respondWith(
          caches.match(event.request).then(response => response || fetch(event.request))
        );
      });
    `;

    // Register Service Worker dynamically
    if ("serviceWorker" in navigator) {
      // Create a Blob for the Service Worker code
      const blob = new Blob([serviceWorkerCode], { type: "application/javascript" });
      const serviceWorkerURL = URL.createObjectURL(blob);

      // Register the Service Worker
      navigator.serviceWorker.register(serviceWorkerURL).catch(error => {
        console.error("Service Worker registration failed:", error);
      });
    }

    // Language translations
    const translations = {
      ar: {
        title: "ÿ¥ÿ±ÿßÿ° SJ COIN",
        buyBtn: "üí∞ ÿßÿ¥ÿ™ÿ±Ÿê ÿßŸÑÿ¢ŸÜ ÿ®ŸÖÿ≠ŸÅÿ∏ÿ© TON",
        checkBtn: "‚úÖ ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸÅÿπ",
        refreshBtn: "üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿµŸäÿØ",
        balance: "ÿ±ÿµŸäÿØŸÉ: {balance} SJ COIN",
        historyTitle: "ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™",
        noTransactions: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿπÿßŸÖŸÑÿßÿ™ ÿ®ÿπÿØ",
        pendingMessage: "ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØŸÅÿπ. ÿßŸÜŸÇÿ± ÿπŸÑŸâ 'ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸÅÿπ' ÿ®ÿπÿØ ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿπŸÖŸÑŸäÿ©.",
        paidMessage: "ÿ™ŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿØŸÅÿπŸÉ! ÿ±ÿµŸäÿØŸÉ ŸÖÿ≠ÿØÿ´.",
        defaultMessage: "ÿßÿÆÿ™ÿ± ŸÉŸÖŸäÿ© SJ COIN Ÿàÿßÿ∂ÿ∫ÿ∑ 'ÿßÿ¥ÿ™ÿ±Ÿê ÿßŸÑÿ¢ŸÜ'.",
        offlineMessage: "ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ. Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿ¢ÿÆÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©.",
        errorUser: "Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿπÿ®ÿ± Telegram",
        errorBalance: "ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ±ÿµŸäÿØ",
        errorPurchase: "ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ¥ÿ±ÿßÿ°",
        errorCheck: "ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸÅÿπ",
        errorTransactions: "ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™"
      },
      en: {
        title: "Buy SJ COIN",
        buyBtn: "üí∞ Buy Now with TON Wallet",
        checkBtn: "‚úÖ Check Payment",
        refreshBtn: "üîÑ Refresh Balance",
        balance: "Your Balance: {balance} SJ COIN",
        historyTitle: "Transaction History",
        noTransactions: "No transactions yet",
        pendingMessage: "Pending payment confirmation. Click 'Check Payment' after completing.",
        paidMessage: "Payment confirmed! Your balance is updated.",
        defaultMessage: "Choose an SJ COIN amount and click 'Buy Now'.",
        offlineMessage: "Offline. Showing last cached data.",
        errorUser: "Please open via Telegram",
        errorBalance: "Error loading balance",
        errorPurchase: "Error processing purchase",
        errorCheck: "Error checking payment",
        errorTransactions: "Error loading transaction history"
      }
    };

    // IMPORTANT: Firebase config should be moved to server-side in production
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdefg"
    };

    // Initialize Firebase
    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (error) {
      displayError("errorUser");
    }

    // Telegram WebApp
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
    }

    const user = tg?.initDataUnsafe?.user || {};
    const userId = user.id;
    const name = `${user.first_name || ''} ${user.last_name || ''}`.trim();

    // DOM Elements
    const buyBtn = document.getElementById("buyBtn");
    const checkBtn = document.getElementById("checkBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const balanceDiv = document.getElementById("balance");
    const errorDiv = document.getElementById("error");
    const infoDiv = document.getElementById("info");
    const progressBarFill = document.getElementById("progressBarFill");
    const transactionsDiv = document.getElementById("transactions");
    const themeToggle = document.getElementById("themeToggle");
    const langToggle = document.getElementById("langToggle");
    const purchaseOptions = document.getElementById("purchaseOptions");
    const balanceChart = document.getElementById("balanceChart").getContext("2d");

    // State
    let currentLang = localStorage.getItem("lang") || "ar";
    let selectedPurchase = { amount: 0.5, coins: 1000 };
    let isOnline = navigator.onLine;
    let cachedData = JSON.parse(localStorage.getItem("cachedData") || "{}");

    // Utility functions
    function setLoading(state, progress = 0) {
      buyBtn.disabled = state;
      checkBtn.disabled = state;
      refreshBtn.disabled = state;
      buyBtn.classList.toggle("loading", state);
      checkBtn.classList.toggle("loading", state);
      refreshBtn.classList.toggle("loading", state);
      progressBarFill.style.width = `${progress}%`;
    }

    function displayError(key) {
      errorDiv.textContent = translations[currentLang][key];
      setTimeout(() => errorDiv.textContent = "", 5000);
    }

    function displayInfo(key) {
      infoDiv.textContent = translations[currentLang][key];
      setTimeout(() => infoDiv.textContent = "", 5000);
    }

    function updateLanguage() {
      document.querySelectorAll("[data-lang]").forEach(el => {
        const key = el.getAttribute("data-lang");
        el.textContent = translations[currentLang][key].replace("{balance}", balanceDiv.textContent.match(/\d+/)?.[0] || "...");
      });
      langToggle.textContent = currentLang === "ar" ? "EN" : "AR";
      localStorage.setItem("lang", currentLang);
    }

    // Load balance
    async function loadBalance() {
      if (!userId) {
        balanceDiv.textContent = translations[currentLang].balance.replace("{balance}", "...");
        displayError("errorUser");
        return;
      }

      try {
        setLoading(true, 30);
        if (!isOnline && cachedData.balance) {
          balanceDiv.textContent = translations[currentLang].balance.replace("{balance}", cachedData.balance);
          displayInfo("offlineMessage");
          return;
        }

        const snapshot = await db.ref("users/" + userId).once("value");
        const data = snapshot.val();
        const bal = data?.balance || 0;
        balanceDiv.textContent = translations[currentLang].balance.replace("{balance}", bal);
        cachedData.balance = bal;
        localStorage.setItem("cachedData", JSON.stringify(cachedData));
        displayInfo(getDynamicMessage(data?.status));
        updateChart(bal);
        setLoading(false, 100);
      } catch (error) {
        displayError("errorBalance");
        console.error(error);
        setLoading(false, 0);
      }
    }

    // Load transaction history
    async function loadTransactions() {
      if (!userId) return;

      try {
        if (!isOnline && cachedData.transactions) {
          renderTransactions(cachedData.transactions);
          displayInfo("offlineMessage");
          return;
        }

        const snapshot = await db.ref("transactions/" + userId).limitToLast(5).once("value");
        const transactions = snapshot.val();
        renderTransactions(transactions);
        cachedData.transactions = transactions;
        localStorage.setItem("cachedData", JSON.stringify(cachedData));
      } catch (error) {
        displayError("errorTransactions");
        console.error(error);
      }
    }

    function renderTransactions(transactions) {
      transactionsDiv.innerHTML = "";
      if (transactions) {
        Object.entries(transactions).forEach(([key, tx]) => {
          const date = new Date(tx.timestamp).toLocaleString(currentLang);
          const item = document.createElement("div");
          item.className = "transaction-item";
          item.textContent = `${date}: ${tx.amount} SJ COIN - ${tx.status}`;
          transactionsDiv.appendChild(item);
        });
      } else {
        transactionsDiv.textContent = translations[currentLang].noTransactions;
      }
    }

    // Dynamic info message based on user status
    function getDynamicMessage(status) {
      switch (status) {
        case "pending": return "pendingMessage";
        case "paid": return "paidMessage";
        default: return "defaultMessage";
      }
    }

    // Update chart
    let chartInstance;
    function updateChart(balance) {
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(balanceChart, {
        type: "bar",
        data: {
          labels: [translations[currentLang].balance],
          datasets: [{
            label: "SJ COIN",
            data: [balance],
            backgroundColor: "#00ff88",
            borderColor: "#0088cc",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Buy button handler
    buyBtn.addEventListener("click", async () => {
      if (!userId) {
        displayError("errorUser");
        return;
      }

      try {
        setLoading(true, 50);
        const TON_ADDRESS = "UQD1TlRrCeCd004h4V14Lt2L-DZqSJ8x5Vjhq-JU282mDQfz";
        const TON_LINK = `https://t.me/wallet/send?amount=${selectedPurchase.amount}&token=ton&to=${TON_ADDRESS}`;
        window.open(TON_LINK, "_blank");

        await db.ref("users/" + userId).set({
          name: name,
          balance: 0,
          status: "pending",
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        await db.ref("transactions/" + userId).push({
          amount: 0,
          status: "pending",
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        displayInfo("pendingMessage");
        loadTransactions();
        setLoading(false, 100);
      } catch (error) {
        displayError("errorPurchase");
        console.error(error);
        setLoading(false, 0);
      }
    });

    // Check payment handler (replace with blockchain verification in production)
    checkBtn.addEventListener("click", async () => {
      if (!userId) {
        displayError("errorUser");
        return;
      }

      const confirmPaid = confirm(translations[currentLang].checkBtn.replace("‚úÖ ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿØŸÅÿπ", `ŸáŸÑ ÿ£ŸÉŸÖŸÑÿ™ ÿØŸÅÿπ ${selectedPurchase.amount} TONÿü`).replace("‚úÖ Check Payment", `Did you complete the payment of ${selectedPurchase.amount} TON?`));
      if (!confirmPaid) return;

      try {
        setLoading(true, 70);
        await db.ref("users/" + userId).update({
          balance: selectedPurchase.coins,
          status: "paid",
          lastUpdated: firebase.database.ServerValue.TIMESTAMP
        });

        await db.ref("transactions/" + userId).push({
          amount: selectedPurchase.coins,
          status: "paid",
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        alert("‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿµŸäÿØŸÉ! / Payment updated successfully!");
        await loadBalance();
        await loadTransactions();
        setLoading(false, 100);
      } catch (error) {
        displayError("errorCheck");
        console.error(error);
        setLoading(false, 0);
      }
    });

    // Refresh balance handler
    refreshBtn.addEventListener("click", async () => {
      await loadBalance();
      await loadTransactions();
      displayInfo("paidMessage");
    });

    // Theme toggle handler
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("light-mode");
      themeToggle.textContent = document.body.classList.contains("light-mode") ? "üåô" : "‚òÄÔ∏è";
      localStorage.setItem("theme", document.body.classList.contains("light-mode") ? "light" : "dark");
    });

    // Language toggle handler
    langToggle.addEventListener("click", () => {
      currentLang = currentLang === "ar" ? "en" : "ar";
      updateLanguage();
      loadTransactions();
      updateChart(parseInt(balanceDiv.textContent.match(/\d+/)?.[0] || 0));
    });

    // Purchase options handler
    purchaseOptions.addEventListener("click", (e) => {
      const option = e.target.closest(".purchase-option");
      if (!option) return;
      document.querySelectorAll(".purchase-option").forEach(opt => opt.classList.remove("selected"));
      option.classList.add("selected");
      selectedPurchase = {
        amount: parseFloat(option.dataset.amount),
        coins: parseInt(option.dataset.coins)
      };
    });

    // Realtime updates
    if (userId && db) {
      db.ref("users/" + userId).on("value", (snapshot) => {
        const data = snapshot.val();
        if (data) {
          balanceDiv.textContent = translations[currentLang].balance.replace("{balance}", data.balance || 0);
          displayInfo(getDynamicMessage(data.status));
          updateChart(data.balance || 0);
        }
      });
    }

    // Handle online/offline status
    window.addEventListener("online", () => {
      isOnline = true;
      loadBalance();
      loadTransactions();
    });
    window.addEventListener("offline", () => {
      isOnline = false;
      displayInfo("offlineMessage");
    });

    // Initial load
    if (userId && db) {
      loadBalance();
      loadTransactions();
      updateLanguage();
      document.querySelector(".purchase-option").classList.add("selected");
    } else {
      balanceDiv.textContent = translations[currentLang].balance.replace("{balance}", "...");
      displayError("errorUser");
    }

    // Load saved theme
    if (localStorage.getItem("theme") === "light") {
      document.body.classList.add("light-mode");
      themeToggle.textContent = "üåô";
    }
  </script>
</body>
</html>
