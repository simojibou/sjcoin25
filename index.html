<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Drift & Merge Game - Telegram Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { background: #121212; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 10px; }
    #inventory { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
    .car-slot { background: #222; padding: 10px; border-radius: 8px; text-align: center; cursor: grab; user-select: none; }
    .car-level { font-weight: bold; margin-top: 5px; }
    #stats { margin-top: 15px; font-size: 18px; }
    button { margin: 5px; padding: 10px 15px; font-size: 16px; border-radius: 6px; border: none; cursor: pointer; }
    #boostBtn { background: #ff5500; color: white; }
    #autoBtn { background: #007bff; color: white; }
  </style>
</head>
<body>

  <h1>Drift & Merge</h1>

  <div id="inventory"></div>

  <div id="stats">
    Coins: <span id="coins">0</span> |
    Income/sec: <span id="incomePerSec">0</span> |
    Energy: <span id="energy">0</span>
  </div>

  <button id="boostBtn">BOOST</button>
  <button id="autoBtn">AUTO MODE</button>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    // --- Firebase Setup ---
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Telegram Mini App Setup ---
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- Game Data ---
    let playerId = tg.initDataUnsafe?.user?.id || 'guest';
    let inventory = [];  // array of cars { id, model, level }
    let coins = 0;
    let energy = 0;
    let incomePerSec = 0;
    let boostActive = false;
    let autoMode = false;

    // Inventory UI container
    const inventoryEl = document.getElementById('inventory');
    const coinsEl = document.getElementById('coins');
    const energyEl = document.getElementById('energy');
    const incomeEl = document.getElementById('incomePerSec');
    const boostBtn = document.getElementById('boostBtn');
    const autoBtn = document.getElementById('autoBtn');

    // --- Load Player Data ---
    function loadPlayerData() {
      db.ref('players/' + playerId).once('value').then(snapshot => {
        const data = snapshot.val();
        if (data) {
          inventory = data.inventory || [];
          coins = data.coins || 0;
          energy = data.energy || 0;
        } else {
          // New player starter data
          inventory = [
            { id: generateId(), model: 'CarA', level: 1 },
            { id: generateId(), model: 'CarA', level: 1 },
            { id: generateId(), model: 'CarB', level: 1 }
          ];
          coins = 100;
          energy = 10;
          savePlayerData();
        }
        calculateIncome();
        renderInventory();
        updateStats();
      });
    }

    // --- Save Player Data ---
    function savePlayerData() {
      db.ref('players/' + playerId).set({
        inventory,
        coins,
        energy
      });
    }

    // --- Generate Unique ID ---
    function generateId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    // --- Render Inventory ---
    function renderInventory() {
      inventoryEl.innerHTML = '';
      inventory.forEach(car => {
        const slot = document.createElement('div');
        slot.className = 'car-slot';
        slot.draggable = true;
        slot.dataset.id = car.id;
        slot.innerHTML = `
          <div>${car.model}</div>
          <div class="car-level">Lvl ${car.level}</div>
        `;

        // Drag and drop handlers
        slot.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', car.id);
        });
        slot.addEventListener('dragover', e => {
          e.preventDefault();
        });
        slot.addEventListener('drop', e => {
          e.preventDefault();
          const sourceId = e.dataTransfer.getData('text/plain');
          const targetId = car.id;
          mergeCars(sourceId, targetId);
        });

        inventoryEl.appendChild(slot);
      });
    }

    // --- Merge Cars ---
    function mergeCars(sourceId, targetId) {
      if (sourceId === targetId) return;

      const sourceCar = inventory.find(c => c.id === sourceId);
      const targetCar = inventory.find(c => c.id === targetId);

      if (!sourceCar || !targetCar) return;

      if (sourceCar.model === targetCar.model && sourceCar.level === targetCar.level) {
        // Merge logic: remove both and add higher level car
        inventory = inventory.filter(c => c.id !== sourceId && c.id !== targetId);
        const newCar = {
          id: generateId(),
          model: sourceCar.model,
          level: sourceCar.level + 1
        };
        inventory.push(newCar);
        calculateIncome();
        savePlayerData();
        renderInventory();
        updateStats();
        alert(`Merged two level ${sourceCar.level} ${sourceCar.model} cars into level ${newCar.level}!`);
      } else {
        alert('Only cars of same model and level can be merged!');
      }
    }

    // --- Calculate Passive Income per Second ---
    function calculateIncome() {
      // Example: base income 10 coins per level
      incomePerSec = inventory.reduce((sum, car) => sum + (car.level * 10), 0);
      incomeEl.textContent = incomePerSec;
    }

    // --- Update UI Stats ---
    function updateStats() {
      coinsEl.textContent = coins.toFixed(0);
      energyEl.textContent = energy.toFixed(0);
      incomeEl.textContent = incomePerSec.toFixed(0);
    }

    // --- Drift & Earn Simulation ---
    function driftEarn(tick = 1000) {
      let earnAmount = incomePerSec;
      if (boostActive) {
        earnAmount *= 2;  // Double income on boost
      }
      coins += earnAmount * (tick / 1000);
      energy += 1 * (tick / 1000);  // Gain energy slowly while drifting

      updateStats();
      savePlayerData();
    }

    // --- Boost Handling ---
    boostBtn.addEventListener('click', () => {
      if (energy < 5) {
        alert('Not enough energy to boost!');
        return;
      }
      energy -= 5;
      boostActive = true;
      updateStats();

      setTimeout(() => {
        boostActive = false;
        updateStats();
      }, 10000);  // Boost lasts 10 seconds
    });

    // --- Auto Mode ---
    autoBtn.addEventListener('click', () => {
      autoMode = !autoMode;
      autoBtn.textContent = autoMode ? 'AUTO MODE ON' : 'AUTO MODE OFF';
      if (autoMode) {
        autoPlay();
      }
    });

    function autoPlay() {
      if (!autoMode) return;

      // Auto-merge cars if possible
      for (let i = 0; i < inventory.length; i++) {
        for (let j = i + 1; j < inventory.length; j++) {
          if (inventory[i].model === inventory[j].model && inventory[i].level === inventory[j].level) {
            mergeCars(inventory[i].id, inventory[j].id);
            break;
          }
        }
      }
      // Auto boost if energy available
      if (energy >= 5 && !boostActive) {
        boostBtn.click();
      }

      // Continue drifting (earn coins)
      driftEarn();

      // Repeat every second
      setTimeout(autoPlay, 1000);
    }

    // --- Initialize ---
    loadPlayerData();

    // Start passive earning every second
    setInterval(() => {
      if (!autoMode) driftEarn();
    }, 1000);
  </script>
</body>
</html>
