<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SJ COIN Payment</title>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
      direction: rtl;
      transition: background-color 0.3s, color 0.3s;
    }
    body.light-mode {
      background-color: #f5f5f5;
      color: #333;
    }
    button {
      background-color: #0088cc;
      color: white;
      border: none;
      padding: 15px 25px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #00aaff;
    }
    button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    .balance {
      font-size: 26px;
      margin-top: 30px;
      color: #00ff88;
    }
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .error, .info {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .error {
      background-color: #ff4444;
      color: white;
    }
    .info {
      background-color: #0088cc;
      color: white;
    }
    .progress-bar {
      width: 100%;
      max-width: 300px;
      height: 10px;
      background-color: #333;
      border-radius: 5px;
      margin: 10px auto;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background-color: #00ff88;
      width: 0;
      transition: width 0.5s;
    }
    .transaction-history {
      margin-top: 20px;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
    }
    .transaction-item {
      padding: 5px;
      border-bottom: 1px solid #444;
    }
    .theme-toggle {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: #666;
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">🌙 تبديل الوضع</button>
  <h1>شراء SJ COIN</h1>
  <p>0.5 TON = 1000 SJ COIN</p>

  <button id="buyBtn">💰 اشترِ الآن بمحفظة TON</button>
  <br/>
  <button id="checkBtn">✅ تحقق من الدفع</button>
  <br/>
  <button id="refreshBtn">🔄 إعادة تحميل الرصيد</button>

  <div class="balance" id="balance">رصيدك: ...</div>
  <div class="info" id="info"></div>
  <div class="error" id="error"></div>
  <div class="progress-bar" id="progressBar">
    <div class="progress-bar-fill" id="progressBarFill"></div>
  </div>
  <div class="transaction-history" id="transactionHistory">
    <h3>سجل المعاملات</h3>
    <div id="transactions"></div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // IMPORTANT: Firebase config should be moved to server-side in production
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdefg"
    };

    // Initialize Firebase
    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (error) {
      displayError("خطأ في تهيئة قاعدة البيانات");
    }

    // Telegram WebApp
    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.expand();
    }

    const user = tg?.initDataUnsafe?.user || {};
    const userId = user.id;
    const name = `${user.first_name || ''} ${user.last_name || ''}`.trim();

    // DOM Elements
    const buyBtn = document.getElementById("buyBtn");
    const checkBtn = document.getElementById("checkBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const balanceDiv = document.getElementById("balance");
    const errorDiv = document.getElementById("error");
    const infoDiv = document.getElementById("info");
    const progressBarFill = document.getElementById("progressBarFill");
    const transactionsDiv = document.getElementById("transactions");
    const themeToggle = document.getElementById("themeToggle");

    // Utility functions
    function setLoading(state, progress = 0) {
      buyBtn.disabled = state;
      checkBtn.disabled = state;
      refreshBtn.disabled = state;
      buyBtn.classList.toggle("loading", state);
      checkBtn.classList.toggle("loading", state);
      refreshBtn.classList.toggle("loading", state);
      progressBarFill.style.width = `${progress}%`;
    }

    function displayError(message) {
      errorDiv.textContent = message;
      setTimeout(() => errorDiv.textContent = "", 5000);
    }

    function displayInfo(message) {
      infoDiv.textContent = message;
      setTimeout(() => infoDiv.textContent = "", 5000);
    }

    // Load balance
    async function loadBalance() {
      if (!userId) {
        balanceDiv.textContent = "❌ لم يتم التعرف على المستخدم";
        displayInfo("يرجى فتح التطبيق عبر Telegram");
        return;
      }

      try {
        setLoading(true, 30);
        const snapshot = await db.ref("users/" + userId).once("value");
        const data = snapshot.val();
        const bal = data?.balance || 0;
        balanceDiv.textContent = `رصيدك: ${bal} SJ COIN`;
        displayInfo(getDynamicMessage(data?.status));
        setLoading(false, 100);
      } catch (error) {
        displayError("خطأ في تحميل الرصيد");
        console.error(error);
        setLoading(false, 0);
      }
    }

    // Load transaction history
    async function loadTransactions() {
      if (!userId) return;

      try {
        const snapshot = await db.ref("transactions/" + userId).limitToLast(5).once("value");
        const transactions = snapshot.val();
        transactionsDiv.innerHTML = "";
        if (transactions) {
          Object.entries(transactions).forEach(([key, tx]) => {
            const date = new Date(tx.timestamp).toLocaleString("ar");
            const item = document.createElement("div");
            item.className = "transaction-item";
            item.textContent = `${date}: ${tx.amount} SJ COIN - ${tx.status}`;
            transactionsDiv.appendChild(item);
          });
        } else {
          transactionsDiv.textContent = "لا توجد معاملات بعد";
        }
      } catch (error) {
        displayError("خطأ في تحميل سجل المعاملات");
        console.error(error);
      }
    }

    // Dynamic info message based on user status
    function getDynamicMessage(status) {
      switch (status) {
        case "pending":
          return "في انتظار تأكيد الدفع. انقر على 'تحقق من الدفع' بعد إتمام العملية.";
        case "paid":
          return "تم تأكيد دفعك! رصيدك محدث.";
        default:
          return "اضغط 'اشترِ الآن' لبدء عملية الشراء.";
      }
    }

    // Buy button handler
    buyBtn.addEventListener("click", async () => {
      if (!userId) {
        displayError("يرجى تسجيل الدخول عبر Telegram");
        return;
      }

      try {
        setLoading(true, 50);
        const TON_ADDRESS = "UQD1TlRrCeCd004h4V14Lt2L-DZqSJ8x5Vjhq-JU282mDQfz";
        const TON_LINK = `https://t.me/wallet/send?amount=0.5&token=ton&to=${TON_ADDRESS}`;
        window.open(TON_LINK, "_blank");

        await db.ref("users/" + userId).set({
          name: name,
          balance: 0,
          status: "pending",
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        await db.ref("transactions/" + userId).push({
          amount: 0,
          status: "pending",
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        displayInfo("تم فتح رابط الدفع. أكمل الدفع ثم تحقق.");
        loadTransactions();
        setLoading(false, 100);
      } catch (error) {
        displayError("خطأ أثناء معالجة الشراء");
        console.error(error);
        setLoading(false, 0);
      }
    });

    // Check payment handler
    checkBtn.addEventListener("click", async () => {
      if (!userId) {
        displayError("يرجى تسجيل الدخول عبر Telegram");
        return;
      }

      const confirmPaid = confirm("هل أكملت الدفع 0.5 TON؟");
      if (!confirmPaid) return;

      try {
        setLoading(true, 70);
        await db.ref("users/" + userId).update({
          balance: 1000,
          status: "paid",
          lastUpdated: firebase.database.ServerValue.TIMESTAMP
        });

        await db.ref("transactions/" + userId).push({
          amount: 1000,
          status: "paid",
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        alert("✅ تم تحديث رصيدك!");
        await loadBalance();
        await loadTransactions();
        setLoading(false, 100);
      } catch (error) {
        displayError("خطأ أثناء التحقق من الدفع");
        console.error(error);
        setLoading(false, 0);
      }
    });

    // Refresh balance handler
    refreshBtn.addEventListener("click", async () => {
      await loadBalance();
      await loadTransactions();
      displayInfo("تم تحديث الرصيد وسجل المعاملات");
    });

    // Theme toggle handler
    themeToggle.addEventListener("click", () => {
      document.body.classList.toggle("light-mode");
      themeToggle.textContent = document.body.classList.contains("light-mode") ? "🌙" : "☀️";
      localStorage.setItem("theme", document.body.classList.contains("light-mode") ? "light" : "dark");
    });

    // Load saved theme
    if (localStorage.getItem("theme") === "light") {
      document.body.classList.add("light-mode");
      themeToggle.textContent = "🌙";
    }

    // Initial load
    if (userId && db) {
      loadBalance();
      loadTransactions();
    } else {
      balanceDiv.textContent = "❌ لم يتم التعرف على المستخدم";
      displayInfo("يرجى فتح التطبيق عبر Telegram");
    }
  </script>
</body>
</html>
