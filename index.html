<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SJ COIN — دفع بـ TON (Mini App)</title>

  <!-- Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- TonConnect UI -->
  <script src="https://unpkg.com/@tonconnect/ui"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body { font-family: system-ui, Arial; padding: 16px; background: #f7f7fb }
    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 6px 18px rgba(10,10,30,0.06); max-width: 720px; margin: 12px auto }
    button { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer }
    .primary { background: #2b6ef6; color: white }
    .muted { background: #efefef }
    .center { text-align: center }
  </style>
</head>
<body>
  <div class="card">
    <h2 class="center">SJ COIN — دفع بـ TON</h2>

    <div id="wallet-info" style="margin-bottom:12px">لم يتصل أي محفظة بعد.</div>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <div id="ton-connect"></div>
      <button id="payBtn" class="primary">ادفع 1 TON واحصل على 1000 SJ</button>
      <button id="logoutBtn" class="muted">فصل المحفظة</button>
    </div>

    <hr />
    <p><strong>الحالة:</strong> <span id="status">جاهز</span></p>
  </div>

<script>
// إعداد Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
  authDomain: "metawarefare-gaming.firebaseapp.com",
  databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
  projectId: "metawarefare-gaming",
  storageBucket: "metawarefare-gaming.appspot.com",
  messagingSenderId: "551352148152",
  appId: "1:551352148152:web:xxxxxxxxxxxxxxxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// إعداد TonConnect
const tonConnectUI = new TonConnectUI.TonConnectUI({
  manifestUrl: window.location.origin + '/tonconnect-manifest.json'
});
let activeAccount = null;
tonConnectUI.renderWidget('#ton-connect');

tonConnectUI.on('connect', ({account}) => {
  activeAccount = account;
  document.getElementById('wallet-info').innerText = `متصل: ${account.address}`;
  setStatus('محفظة متصلة');
});
tonConnectUI.on('disconnect', () => {
  activeAccount = null;
  document.getElementById('wallet-info').innerText = 'لم يتصل أي محفظة بعد.';
  setStatus('محفظة مفصولة');
});

// إعدادات الدفع
const TO_WALLET_ADDRESS = "UQD1TlRrCeCd004h4V14Lt2L-DZqSJ8x5Vjhq-JU282mDQfz";
const SJ_REWARD = 1000;
const TON_API = "https://toncenter.com/api/v2"; // Ton API
const TON_API_KEY = ""; // مفتاح API إذا عندك

document.getElementById('payBtn').addEventListener('click', async () => {
  if (!activeAccount) {
    await tonConnectUI.connect();
    return;
  }
  await payOneTON();
});
document.getElementById('logoutBtn').addEventListener('click', () => {
  tonConnectUI.disconnect();
});

async function payOneTON() {
  setStatus('إنشاء طلب الدفع...');
  const amountNanotons = (1 * 1e9).toString();
  const transaction = {
    validUntil: Math.floor(Date.now() / 1000) + 300,
    messages: [{ address: TO_WALLET_ADDRESS, amount: amountNanotons }]
  };
  try {
    const result = await tonConnectUI.sendTransaction(transaction);
    console.log('Transaction result:', result);
    setStatus('تم الدفع، جاري التحقق...');
    await verifyPayment(result);
  } catch (err) {
    console.error(err);
    setStatus('فشل الدفع');
  }
}

async function verifyPayment(txResult) {
  try {
    const resp = await fetch(`${TON_API}/getTransactions?account=${TO_WALLET_ADDRESS}&limit=50`, {
      headers: TON_API_KEY ? { "X-API-Key": TON_API_KEY } : {}
    });
    const data = await resp.json();
    if (!data.ok || !data.result) {
      setStatus('خطأ في Ton API');
      return;
    }
    const found = data.result.find(
      tx => tx.in_msg && tx.in_msg.source &&
            tx.in_msg.value >= 1e9
    );
    if (found) {
      await updateUserBalance();
      setStatus('تم التحقق وإضافة الرصيد ✅');
    } else {
      setStatus('لم يتم العثور على المعاملة ❌');
    }
  } catch (err) {
    console.error(err);
    setStatus('خطأ أثناء التحقق');
  }
}

async function updateUserBalance() {
  const userId = getTelegramUserId();
  const ref = db.ref(`/users/${userId}/balance`);
  await ref.transaction(bal => (bal || 0) + SJ_REWARD);
}

function getTelegramUserId() {
  try {
    const tg = window.Telegram.WebApp;
    return tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'anonymous';
  } catch {
    return 'anonymous';
  }
}

function setStatus(msg) {
  document.getElementById('status').innerText = msg;
}
</script>
</body>
</html>
