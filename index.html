<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>شراء SJ COIN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: Arial;
      text-align: center;
      padding: 20px;
    }
    img {
      border-radius: 50%;
      margin-bottom: 10px;
    }
    h1, h2, p {
      margin: 10px 0;
    }
    button {
      padding: 12px 24px;
      font-size: 18px;
      margin-top: 20px;
      background-color: #1c1c1c;
      color: white;
      border: 1px solid #555;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="profile">
    <img id="photo" src="" width="100" height="100" alt="profile" />
    <h2 id="name">...</h2>
    <p>رصيدك: <span id="balance">0</span> SJ COIN</p>
  </div>

  <hr style="margin: 20px 0; border-color: #444;" />

  <h1>اشترِ 1000 SJ COIN</h1>
  <p>مقابل 10 Telegram Stars</p>
  <button onclick="buyStars()">اشترِ الآن</button>

  <script>
    // إعداد Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.expand();

    const user = tg.initDataUnsafe.user;
    const userId = user.id.toString();

    // إعداد Firebase (معلوماتك الخاصة)
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // عرض الملف الشخصي والرصيد
    document.getElementById("name").innerText = `${user.first_name} ${user.last_name || ""}`;
    document.getElementById("photo").src = user.photo_url;

    async function fetchBalance() {
      const userRef = db.ref('users/' + userId);
      const snapshot = await userRef.once('value');
      let currentBalance = 0;
      if (snapshot.exists()) {
        currentBalance = snapshot.val().balance || 0;
      } else {
        // أنشئ المستخدم إن لم يكن موجودًا
        await userRef.set({
          balance: 0,
          name: `${user.first_name} ${user.last_name || ""}`,
          photo: user.photo_url
        });
      }
      document.getElementById("balance").innerText = currentBalance;
    }

    fetchBalance();

    // الدفع عبر Telegram Stars
    function buyStars() {
      Telegram.WebApp.openInvoice({
        slug: "sjcoin-stars", // ⚠️ يجب إنشاؤها من BotFather أو @PremiumBot
        title: "شراء SJ COIN",
        description: "احصل على 1000 SJ COIN مقابل 10 Telegram Stars",
        currency: "USD",
        prices: [{ label: "SJ COIN", amount: 1000 }], // = 10.00$
        payload: "buy_1000_sjcoin_" + userId
      });
    }

    // التحقق بعد الدفع
    Telegram.WebApp.onEvent('invoiceClosed', async function(data) {
      if (data.status === 'paid') {
        alert("✅ تم الدفع بنجاح! جاري إضافة العملات إلى رصيدك...");

        const userRef = db.ref('users/' + userId);
        const snapshot = await userRef.once('value');
        let balance = 0;

        if (snapshot.exists()) {
          balance = snapshot.val().balance || 0;
        }

        const newBalance = balance + 1000;
        await userRef.update({ balance: newBalance });

        document.getElementById("balance").innerText = newBalance;
        alert("✅ تمت إضافة 1000 SJ COIN إلى رصيدك!");
      } else {
        alert("❌ لم يتم الدفع.");
      }
    });
  </script>

</body>
</html>
