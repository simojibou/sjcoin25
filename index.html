<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Stars ⇄ TON تحويل ميني آب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f3f4f6; padding:20px; }
    button { margin: 10px 0; padding: 10px 15px; font-size: 16px; }
  </style>
</head>
<body>

  <h2>تحويل Telegram Stars إلى TON والعكس</h2>
  <p>رصيد Stars (وهمي): <span id="starsBalance">...تحميل</span></p>
  <p>محفظة TON: <span id="walletAddress">غير متصل</span></p>
  <p>رصيد TON: <span id="tonBalance">-</span></p>

  <button id="connectTonBtn">ربط محفظة TON</button><br/>
  <button id="convertStarsToTonBtn" disabled>تحويل Stars إلى TON</button><br/>
  <button id="convertTonToStarsBtn" disabled>تحويل TON إلى Stars</button>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tg = window.Telegram.WebApp;
    tg.expand();

    const starsBalanceEl = document.getElementById('starsBalance');
    const walletAddressEl = document.getElementById('walletAddress');
    const tonBalanceEl = document.getElementById('tonBalance');
    const connectTonBtn = document.getElementById('connectTonBtn');
    const convertStarsToTonBtn = document.getElementById('convertStarsToTonBtn');
    const convertTonToStarsBtn = document.getElementById('convertTonToStarsBtn');

    // stars رصيد Stars (وهمي)
    let starsBalance = 1500; // هذه قيمة تجريبية — يمكن جلبها من backend لاحقًا
    starsBalanceEl.textContent = starsBalance;

    // TonConnect setup
    let tonConnector;
    let walletAddress = null;
    let tonBalance = 0;

    connectTonBtn.onclick = async () => {
      if (!tonConnector) {
        tonConnector = new TonConnect.UI();
      }
      const session = await tonConnector.connect();
      walletAddress = session.account.address;
      walletAddressEl.textContent = walletAddress;

      // مثال: تحديث رصيد TON وهمي
      tonBalance = 100; 
      tonBalanceEl.textContent = tonBalance + " TON";

      convertStarsToTonBtn.disabled = false;
      convertTonToStarsBtn.disabled = false;
    };

    // تحويل Stars إلى TON (تخزين طلب في Firebase)
    convertStarsToTonBtn.onclick = () => {
      if (starsBalance < 100) {
        alert("رصيد Stars غير كافٍ للتحويل");
        return;
      }
      const amountStars = 100; // كم Stars تريد تحويل
      const requestId = Date.now();

      const requestData = {
        userId: tg.initDataUnsafe?.user?.id || 'guest',
        walletAddress,
        from: "stars",
        to: "ton",
        amountStars,
        status: "pending",
        timestamp: requestId
      };

      db.ref("conversionRequests/" + requestId).set(requestData)
        .then(() => {
          alert("تم إرسال طلب تحويل Stars إلى TON بنجاح");
          starsBalance -= amountStars;
          starsBalanceEl.textContent = starsBalance;
        })
        .catch(() => alert("حدث خطأ أثناء إرسال الطلب"));
    };

    // تحويل TON إلى Stars (تخزين طلب في Firebase)
    convertTonToStarsBtn.onclick = () => {
      if (tonBalance < 1) {
        alert("رصيد TON غير كافٍ للتحويل");
        return;
      }
      const amountTon = 1; // كم TON تريد تحويل
      const requestId = Date.now();

      const requestData = {
        userId: tg.initDataUnsafe?.user?.id || 'guest',
        walletAddress,
        from: "ton",
        to: "stars",
        amountTon,
        status: "pending",
        timestamp: requestId
      };

      db.ref("conversionRequests/" + requestId).set(requestData)
        .then(() => {
          alert("تم إرسال طلب تحويل TON إلى Stars بنجاح");
          tonBalance -= amountTon;
          tonBalanceEl.textContent = tonBalance + " TON";
        })
        .catch(() => alert("حدث خطأ أثناء إرسال الطلب"));
    };
  </script>

</body>
</html>
