```html
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SJ COIN Referral & Affiliate System</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white font-sans">

  <!-- Top bar with Back button -->
  <header class="fixed top-4 left-4 right-4 z-50 flex items-center justify-between">
    <a href="./index.html" class="flex items-center gap-3 bg-white/5 backdrop-blur-sm px-3 py-2 rounded-2xl border border-white/10 hover:bg-white/10 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      <span class="text-sm">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </a>

    <!-- Premium badge placeholder -->
    <div id="premiumBadgeContainer" class="hidden items-center gap-2 bg-gradient-to-r from-yellow-400 to-orange-400 text-black px-3 py-2 rounded-2xl font-semibold shadow-lg">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.79 1.402 8.177L12 18.896l-7.336 3.88 1.402-8.178L.132 9.21l8.2-1.192z"/></svg>
      <span id="premiumText">Premium</span>
    </div>
  </header>

  <!-- Loading Screen -->
  <div id="loading" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="text-center">
      <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-20 h-20 rounded-full mx-auto mb-4 animate-pulse" />
      <p class="text-lg font-medium">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div id="errorMessage" class="fixed inset-0 bg-red-900/90 flex items-center justify-center z-40" style="display:none;">
    <div class="text-center px-6">
      <p class="text-lg font-medium mb-4">Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
      <button onclick="location.reload()" class="bg-white text-black px-6 py-2 rounded-lg font-medium">
        Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
      </button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-60 hidden">
    <span id="toastMessage"></span>
  </div>

  <main class="max-w-2xl mx-auto px-6 py-10 pt-24">
    <div class="text-center mb-6">
      <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white/10 shadow-2xl" />
      <h1 class="text-3xl font-extrabold uppercase bg-gradient-to-r from-yellow-300 via-white to-orange-500 bg-clip-text text-transparent mb-2 tracking-wide">
        Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© SJ COIN
      </h1>
      <p class="text-white/80 font-medium mb-4">Ø§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ¢Øª â€” 50 SJ Ù„ÙƒÙ„ Ø·Ø±Ù ğŸ‰</p>

      <!-- Referral Code Display -->
      <div class="mb-4 inline-block">
        <div class="flex items-center gap-3 bg-white/6 px-4 py-2 rounded-2xl border border-white/10 shadow-inner cursor-pointer select-all"
             title="Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©" id="referralCodeDisplay" style="user-select: all;">
          <span class="text-xs text-white/70">ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</span>
          <span id="referralCodeText" class="text-sm font-mono font-semibold text-yellow-300"></span>
        </div>
      </div>
    </div>

    <!-- Referral Link Display -->
    <div class="mb-6 p-4 bg-white/6 rounded-2xl border border-white/8 break-words shadow-sm">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-xs text-white/60 mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
          <p id="referralDisplay" class="text-sm font-mono text-yellow-300 select-all cursor-pointer" title="Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·"></p>
        </div>
        <button id="copyLinkBtn" class="ml-4 bg-white/6 px-3 py-2 rounded-xl border border-white/8 hover:bg-white/10 transition">ğŸ“‹ Ù†Ø³Ø®</button>
      </div>
    </div>

    <!-- Wallet & Payment Section -->
    <div class="mb-6 p-4 bg-white/6 rounded-2xl border border-white/8">
      <h3 class="text-sm font-semibold mb-4">Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ§Ù„Ø¯ÙØ¹ Ø¨Ù€ TON</h3>

      <!-- Wallet Connection -->
      <div class="mb-4">
        <div id="ton-connect" class="p-3 bg-blue-500/20 border border-blue-500 rounded-lg text-sm">
          <button id="connectWalletBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
            ğŸ”— Ø±Ø¨Ø· Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
          </button>
        </div>
      </div>

      <!-- Payment Form -->
      <div class="grid gap-3 sm:grid-cols-2">
        <div>
          <label class="block text-xs text-white/70 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ù€ TON</label>
          <input id="payAmount" type="number" step="0.001" min="0.1" value="0.1" 
                 class="w-full px-3 py-2 rounded-xl text-black bg-white" 
                 placeholder="0.1" />
        </div>
        <div>
          <label class="block text-xs text-white/70 mb-1">Ù…Ù‚Ø¯Ø§Ø± SJ</label>
          <input id="sjAmount" type="number" readonly 
                 class="w-full px-3 py-2 rounded-xl text-black bg-gray-100" 
                 placeholder="ÙŠØªÙ… Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ" />
        </div>
      </div>

      <div class="mt-4">
        <button id="createPaymentBtn" 
                class="w-full bg-green-500 hover:bg-green-600 disabled:bg-gray-500 text-white px-4 py-3 rounded-xl font-bold transition-colors"
                disabled>
          ğŸ’° Ø§Ø´ØªØ±ÙŠ SJ COIN
        </button>
      </div>

      <!-- Payment Status -->
      <div id="paymentStatus" class="mt-3 p-3 rounded-lg hidden">
        <p id="statusText" class="text-sm"></p>
      </div>

      <div class="mt-3 text-xs text-white/60">
        <p>â€¢ 1 TON = 1000 SJ COIN</p>
        <p>â€¢ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¯ÙØ¹: 0.1 TON</p>
        <p>â€¢ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¢Ù…Ù†Ø© ÙˆÙ…Ø¶Ù…ÙˆÙ†Ø©</p>
      </div>
    </div>

    <!-- Referral Code Input -->
    <div class="mb-6 p-4 bg-white/6 rounded-2xl border border-white/8">
      <p class="text-xs text-white/60 mb-2">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ 50 SJ:</p>
      <div class="flex gap-3">
        <input id="referralCodeInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§" 
               class="flex-1 px-4 py-3 rounded-xl text-black" autocomplete="off" />
        <button id="applyReferralBtn" 
                class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl font-bold transition-colors duration-200">
          ØªÙØ¹ÙŠÙ„
        </button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3 mb-8">
      <button id="inviteBtn" 
              class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-2xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
        ğŸ‘¥ Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
      </button>
      <button id="shareBtn" 
              class="flex-1 bg-white/6 text-white px-6 py-3 rounded-2xl font-bold border border-white/10 hover:bg-white/10 transition-all">
        ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©
      </button>
    </div>

    <!-- Affiliate Stats -->
    <div id="affiliateStats" class="mb-6 p-5 bg-white/6 rounded-2xl border border-white/8 hidden shadow-md"></div>

    <!-- Premium Actions -->
    <div class="grid gap-3 mb-10 sm:grid-cols-2">
      <button id="upgradeBtn" 
              class="bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-semibold px-6 py-3 rounded-full shadow-lg hover:from-yellow-500 hover:to-orange-600 transition">
        â­ ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Premium
      </button>
      <button id="buySJBtn" 
              class="bg-gradient-to-r from-blue-700 to-blue-900 text-white font-semibold px-6 py-3 rounded-full shadow-lg hover:from-blue-800 hover:to-blue-950 transition">
        âœ¨ Ø´Ø±Ø§Ø¡ Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ… (Stars)
      </button>
    </div>

    <!-- Friends List -->
    <section>
      <h2 id="friendCount" class="text-xl font-semibold mb-3">Ø£ØµØ¯Ù‚Ø§Ø¤Ùƒ</h2>
      <div id="friendsList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
    </section>
  </main>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      setDoc,
      updateDoc,
      increment,
      addDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-lite.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Telegram user data
    const telegramUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
    const telegramId = telegramUser.id?.toString() || "demo_user";
    const firstName = telegramUser.first_name || "Demo";
    const lastName = telegramUser.last_name || "User";
    const isPremium = telegramUser.is_premium || false;

    const botUrl = "https://t.me/sjcoin25bot";
    const referralLink = `${botUrl}?startapp=ref${telegramId}`;
    const referralCode = telegramId;

    // Constants
    const RECEIVER_TON_ADDRESS = "UQACzRKZn07xqQK0zM5nLhEqSTRN5ThZaFZ_sQLEbavU9ZaW";
    const TON_TO_SJ_RATE = 1000; // 1 TON = 1000 SJ

    // DOM Elements
    const elements = {
      referralCodeInput: document.getElementById("referralCodeInput"),
      applyReferralBtn: document.getElementById("applyReferralBtn"),
      referralDisplay: document.getElementById("referralDisplay"),
      copyLinkBtn: document.getElementById("copyLinkBtn"),
      inviteBtn: document.getElementById("inviteBtn"),
      shareBtn: document.getElementById("shareBtn"),
      affiliateStatsDiv: document.getElementById("affiliateStats"),
      referralCodeDisplay: document.getElementById("referralCodeDisplay"),
      referralCodeText: document.getElementById("referralCodeText"),
      premiumBadgeContainer: document.getElementById("premiumBadgeContainer"),
      upgradeBtn: document.getElementById("upgradeBtn"),
      buySJBtn: document.getElementById("buySJBtn"),
      friendsList: document.getElementById("friendsList"),
      loadingEl: document.getElementById("loading"),
      errorEl: document.getElementById("errorMessage"),
      payAmountInput: document.getElementById("payAmount"),
      sjAmountInput: document.getElementById("sjAmount"),
      createPaymentBtn: document.getElementById("createPaymentBtn"),
      paymentStatus: document.getElementById("paymentStatus"),
      statusText: document.getElementById("statusText"),
      toast: document.getElementById("toast"),
      toastMessage: document.getElementById("toastMessage"),
      tonConnectDiv: document.getElementById("ton-connect"),
      connectWalletBtn: document.getElementById("connectWalletBtn")
    };

    // Telegram Wallet
    let isTelegramWalletAvailable = false;

    // Utility Functions
    function showToast(message, type = 'success') {
      elements.toastMessage.textContent = message;
      elements.toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-60 ${
        type === 'success' ? 'bg-green-600' : 'bg-red-600'
      } text-white`;
      elements.toast.classList.remove('hidden');
      setTimeout(() => elements.toast.classList.add('hidden'), 3000);
    }

    function updatePaymentStatus(message, type = 'info') {
      elements.statusText.textContent = message;
      elements.paymentStatus.className = `mt-3 p-3 rounded-lg ${
        type === 'success' ? 'bg-green-600/20 border border-green-500' :
        type === 'error' ? 'bg-red-600/20 border border-red-500' :
        'bg-blue-600/20 border border-blue-500'
      }`;
      elements.paymentStatus.classList.remove('hidden');
    }

    function calculateSJAmount(tonAmount) {
      return tonAmount * TON_TO_SJ_RATE;
    }

    // Validate TON Address
    function isValidTonAddress(address) {
      // Basic TON address validation: 48 characters, base64url, starts with 'UQ' or 'EQ'
      const tonAddressRegex = /^[UE]Q[0-9a-zA-Z_-]{46}$/;
      return tonAddressRegex.test(address);
    }

    // Telegram Wallet Setup
    async function initTonConnect() {
      try {
        if (!isValidTonAddress(RECEIVER_TON_ADDRESS)) {
          throw new Error('Ø¹Ù†ÙˆØ§Ù† TON ØºÙŠØ± ØµØ§Ù„Ø­');
        }
        if (window.Telegram?.WebApp) {
          elements.tonConnectDiv.innerHTML = `
            <div class="p-3 bg-blue-500/20 border border-blue-500 rounded-lg text-sm">
              <button id="connectWalletBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                ğŸ”— Ø±Ø¨Ø· Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
              </button>
            </div>
          `;
          elements.connectWalletBtn = document.getElementById("connectWalletBtn");
          elements.connectWalletBtn.addEventListener('click', connectTelegramWallet);
          return true;
        } else {
          console.warn('Telegram WebApp not available - using fallback payment method');
          setupPaymentFallback();
          return false;
        }
      } catch (error) {
        console.error('Telegram Wallet initialization failed:', error);
        setupPaymentFallback();
        showToast(error.message || 'ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø©', 'error');
        return false;
      }
    }

    async function connectTelegramWallet() {
      try {
        if (window.Telegram?.WebApp) {
          isTelegramWalletAvailable = true;
          elements.tonConnectDiv.innerHTML = `
            <div class="p-3 bg-green-500/20 border border-green-500 rounded-lg text-sm">
              <p class="text-green-300">âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</p>
            </div>
          `;
          elements.createPaymentBtn.disabled = false;
          elements.createPaymentBtn.textContent = 'ğŸ’° Ø§Ø´ØªØ±ÙŠ SJ COIN';
          showToast('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!');
        } else {
          throw new Error('Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
        }
      } catch (error) {
        console.error('Telegram Wallet connection failed:', error);
        setupPaymentFallback();
        showToast(error.message || 'ÙØ´Ù„ ÙÙŠ Ø±Ø¨Ø· Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…', 'error');
      }
    }

    function setupPaymentFallback() {
      elements.createPaymentBtn.disabled = false;
      elements.createPaymentBtn.textContent = 'ğŸ’° Ø¯ÙØ¹ Ù…Ø¨Ø§Ø´Ø±';
      elements.tonConnectDiv.innerHTML = `
        <div class="p-3 bg-yellow-500/20 border border-yellow-500 rounded-lg text-sm">
          <p class="text-yellow-300">âš ï¸ Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ØºÙŠØ± Ù…ØªØ§Ø­Ø© - Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</p>
        </div>
      `;
    }

    // Payment Functions
    async function createPayment() {
      const tonAmount = parseFloat(elements.payAmountInput.value);
      if (!tonAmount || tonAmount < 0.1) {
        showToast('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¯ÙØ¹ 0.1 TON', 'error');
        return;
      }
      if (!isTelegramWalletAvailable && !elements.createPaymentBtn.textContent.includes('Ø¯ÙØ¹ Ù…Ø¨Ø§Ø´Ø±')) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø±Ø¨Ø· Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
      }

      try {
        updatePaymentStatus('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©...', 'info');

        const invoice = {
          buyer_telegram_id: telegramId,
          buyer_wallet: isTelegramWalletAvailable ? 'telegram_wallet' : 'direct_payment',
          amount_ton: tonAmount,
          amount_sj: calculateSJAmount(tonAmount),
          status: 'pending',
          created_at: new Date().toISOString(),
          tx_hash: null
        };

        const invoicesCol = collection(db, 'invoices');
        const invoiceRef = await addDoc(invoicesCol, invoice);

        if (isTelegramWalletAvailable) {
          await processTelegramWalletPayment(tonAmount, invoiceRef.id);
        } else {
          await processDirectPayment(tonAmount, invoiceRef.id);
        }
      } catch (error) {
        console.error('Payment error:', error);
        updatePaymentStatus('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¯ÙØ¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹', 'error');
      }
    }

    async function processTelegramWalletPayment(tonAmount, invoiceId) {
      try {
        const comment = encodeURIComponent(`SJ-COIN-${invoiceId}`);
        const tonLink = `ton://transfer/${RECEIVER_TON_ADDRESS}?amount=${tonAmount * 1_000_000_000}&text=${comment}`;
        
        updatePaymentStatus('Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…...', 'info');
        
        window.Telegram.WebApp.openLink(tonLink);
        
        updatePaymentStatus(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹. Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙŠ Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ÙˆØ³ØªØªÙ… Ø¥Ø¶Ø§ÙØ© ${calculateSJAmount(tonAmount)} SJ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.`, 'info');
        
        // Simulate transaction verification (replace with real API in production)
        const isTransactionConfirmed = await simulateTransactionVerification(invoiceId, tonAmount);
        if (isTransactionConfirmed) {
          await completePayment(invoiceId, 'telegram_wallet_payment_hash', tonAmount);
        } else {
          throw new Error('ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
        }
      } catch (error) {
        console.error('Telegram Wallet payment error:', error);
        updatePaymentStatus('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ù…Ø­ÙØ¸Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…. Ø¬Ø±Ø¨ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±.', 'error');
        await processDirectPayment(tonAmount, invoiceId);
      }
    }

    async function processDirectPayment(tonAmount, invoiceId) {
      try {
        const comment = encodeURIComponent(`SJ-COIN-${invoiceId}`);
        const tonLink = `ton://transfer/${RECEIVER_TON_ADDRESS}?amount=${tonAmount * 1_000_000_000}&text=${comment}`;
        
        updatePaymentStatus('Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹...', 'info');
        
        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.openLink(tonLink);
        } else {
          window.open(tonLink, '_blank');
        }
        
        updatePaymentStatus(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹. Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ³ØªØªÙ… Ø¥Ø¶Ø§ÙØ© ${calculateSJAmount(tonAmount)} SJ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.`, 'info');
        
        // Simulate transaction verification (replace with real API in production)
        const isTransactionConfirmed = await simulateTransactionVerification(invoiceId, tonAmount);
        if (isTransactionConfirmed) {
          await completePayment(invoiceId, 'direct_payment_hash', tonAmount);
        } else {
          throw new Error('ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©');
        }
      } catch (error) {
        console.error('Direct payment error:', error);
        updatePaymentStatus('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
        showToast('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±', 'error');
      }
    }

    async function simulateTransactionVerification(invoiceId, tonAmount) {
      // TODO: Replace with real TON blockchain API (e.g., Toncenter API)
      // Example API call: fetch(`https://toncenter.com/api/v2/getTransactions?address=${RECEIVER_TON_ADDRESS}`)
      // Check for transaction with matching invoiceId in comment and amount
      console.log(`Simulating transaction verification for invoice ${invoiceId}, amount ${tonAmount} TON`);
      return new Promise((resolve) => {
        setTimeout(() => resolve(true), 5000); // Simulate 5-second verification delay
      });
    }

    async function completePayment(invoiceId, txHash, tonAmount) {
      try {
        await updateDoc(doc(db, 'invoices', invoiceId), {
          tx_hash: txHash,
          status: 'completed',
          completed_at: new Date().toISOString()
        });

        const userRef = doc(db, 'users', telegramId);
        await updateDoc(userRef, {
          balance: increment(calculateSJAmount(tonAmount))
        });

        updatePaymentStatus('ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ', 'success');
        showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${calculateSJAmount(tonAmount)} SJ Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ!`);
        
        setTimeout(loadAffiliateStats, 1000);
      } catch (error) {
        console.error('Failed to complete payment:', error);
        updatePaymentStatus('ØªÙ… Ø§Ù„Ø¯ÙØ¹ ÙˆÙ„ÙƒÙ† Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹', 'error');
      }
    }

    // Event Listeners for Payment
    elements.payAmountInput.addEventListener('input', (e) => {
      const tonAmount = parseFloat(e.target.value) || 0;
      elements.sjAmountInput.value = calculateSJAmount(tonAmount);
    });

    elements.createPaymentBtn.addEventListener('click', createPayment);

    // User Functions
    async function ensureUserExists() {
      try {
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Firebase timeout')), 8000);
        });

        const userRef = doc(db, "users", telegramId);
        const userSnap = await Promise.race([getDoc(userRef), timeoutPromise]);
        const photoFromTG = telegramUser.photo_url || `https://t.me/i/userpic/320/${telegramId}.jpg`;

        if (!userSnap.exists()) {
          await Promise.race([
            setDoc(userRef, {
              id: telegramId,
              first_name: firstName,
              last_name: lastName,
              photo_url: photoFromTG,
              referred_by: null,
              balance: 0,
              premium: isPremium,
              referral_count: 0,
              total_earned: 0,
              created_at: new Date().toISOString(),
              last_active: new Date().toISOString()
            }),
            timeoutPromise
          ]);
        } else {
          const existing = userSnap.data();
          const updatedPhoto = telegramUser.photo_url || existing.photo_url || photoFromTG;
          await Promise.race([
            updateDoc(userRef, {
              last_active: new Date().toISOString(),
              photo_url: updatedPhoto
            }),
            timeoutPromise
          ]);
        }
      } catch (error) {
        console.error('ensureUserExists failed:', error);
        showToast('ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
      }
    }

    async function applyReferralCode() {
      const code = elements.referralCodeInput.value.trim();
      if (!code) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©', 'error');
        return;
      }
      if (code === telegramId) {
        showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ', 'error');
        return;
      }

      try {
        const refUserRef = doc(db, "users", code);
        const refUserSnap = await getDoc(refUserRef);

        if (!refUserSnap.exists()) {
          showToast('ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
          return;
        }

        const userRef = doc(db, "users", telegramId);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();

        if (userData.referred_by) {
          showToast('Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§', 'error');
          return;
        }

        await updateDoc(refUserRef, { 
          balance: increment(50), 
          referral_count: increment(1) 
        });
        await updateDoc(userRef, { 
          balance: increment(50), 
          referred_by: code 
        });

        showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 50 SJ ğŸ‰');
        elements.referralCodeInput.value = "";
        await loadAffiliateStats();
      } catch (error) {
        console.error(error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯', 'error');
      }
    }

    async function copyToClipboard(text, successMessage) {
      try {
        await navigator.clipboard.writeText(text);
        showToast(successMessage);
      } catch {
        showToast('Ø§Ù„Ù†Ø³Ø® ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ', 'error');
      }
    }

    // Event Listeners
    elements.copyLinkBtn.onclick = () => copyToClipboard(referralLink, 'ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©!');
    elements.referralCodeDisplay.onclick = () => copyToClipboard(referralCode, 'ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©!');
    elements.referralDisplay.onclick = () => copyToClipboard(referralLink, 'ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©!');

    elements.shareBtn.onclick = async () => {
      try {
        if (navigator.share) {
          await navigator.share({
            title: 'Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ SJ COIN',
            text: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 50 SJ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¨Ø± Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·!',
            url: referralLink
          });
        } else {
          await copyToClipboard(referralLink, 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· â€” Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ!');
        }
      } catch (e) {
        console.error(e);
        showToast('ØªØ¹Ø°Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', 'error');
      }
    };

    elements.inviteBtn.onclick = () => {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.openLink(referralLink);
      } else {
        window.open(referralLink, "_blank");
      }
    };

    elements.upgradeBtn.onclick = () => {
      const upgradeUrl = "https://t.me/sjcoin25bot?start=premium";
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.openLink(upgradeUrl);
      } else {
        window.open(upgradeUrl, "_blank");
      }
    };

    elements.buySJBtn.onclick = () => {
      const buyUrl = "https://t.me/sjcoin25bot?start=buystars";
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.openLink(buyUrl);
      } else {
        window.open(buyUrl, "_blank");
      }
    };

    elements.applyReferralBtn.onclick = applyReferralCode;

    async function loadAffiliateStats() {
      try {
        const friendsQuery = query(collection(db, "users"), where("referred_by", "==", telegramId));
        const friendsSnap = await getDocs(friendsQuery);
        const friends = [];
        friendsSnap.forEach(d => friends.push(d.data()));

        const userRef = doc(db, "users", telegramId);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.exists() ? userSnap.data() : {};

        elements.affiliateStatsDiv.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-bold mb-1">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</h3>
              <p class="text-sm text-white/80">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${userData.balance ?? 0} SJ</b></p>
              <p class="text-sm text-white/80">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†: <b>${friends.length}</b></p>
            </div>
            <div class="text-right">
              <p class="text-xs text-white/60">Ø¢Ø®Ø± ØªÙØ¹ÙŠÙ„: <span class="block text-sm font-mono">${userData.last_active ? new Date(userData.last_active).toLocaleString() : "â€”"}</span></p>
            </div>
          </div>
        `;
        elements.affiliateStatsDiv.classList.remove("hidden");

        if (userData.premium) elements.premiumBadgeContainer.classList.remove("hidden");
        else elements.premiumBadgeContainer.classList.add("hidden");

        elements.friendsList.innerHTML = "";
        if (friends.length === 0) {
          elements.friendsList.innerHTML = "<p class='text-white/70'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø£ØµØ¯Ù‚Ø§Ø¡ Ù…Ø¯Ø¹ÙˆÙˆÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>";
        } else {
          friends.forEach(f => {
            const photo = f.photo_url || `https://t.me/i/userpic/320/${f.id}.jpg` || 'https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG';
            const name = `${f.first_name || 'Ù…Ø³ØªØ®Ø¯Ù…'} ${f.last_name || ''}`.trim();
            const balance = f.balance ?? 0;

            const friendHTML = `
              <div class="p-4 bg-white/5 rounded-2xl border border-white/6 flex items-center gap-4 shadow-sm">
                <img src="${photo}" alt="avatar" class="w-16 h-16 rounded-full object-cover border-2 border-white/10" onerror="this.src='https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG'"/>
                <div class="flex-1">
                  <div class="flex items-center justify-between gap-3">
                    <div>
                      <p class="font-semibold">${name}</p>
                      <p class="text-xs text-white/70">Ù…Ø¹Ø±Ù: <span class="font-mono text-sm">${f.id || 'â€”'}</span></p>
                    </div>
                    <div class="text-right">
                      <p class="text-sm font-bold text-yellow-300">${balance} SJ</p>
                      ${f.premium ? '<span class="text-xs bg-yellow-500/20 text-yellow-300 px-2 py-1 rounded-full">Premium</span>' : ''}
                    </div>
                  </div>
                </div>
              </div>
            `;
            elements.friendsList.innerHTML += friendHTML;
          });
        }
      } catch (error) {
        console.error('Failed to load affiliate stats:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª', 'error');
      }
    }

    // Initialize
    async function init() {
      try {
        elements.referralCodeText.textContent = referralCode;
        elements.referralDisplay.textContent = referralLink;
        await ensureUserExists();
        await initTonConnect();
        await loadAffiliateStats();
        elements.loadingEl.classList.add('hidden');
      } catch (error) {
        console.error('Initialization failed:', error);
        elements.loadingEl.classList.add('hidden');
        elements.errorEl.style.display = 'flex';
      }
    }

    init();
  </script>
</body>
</html>
```
