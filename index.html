<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SJ COIN Referral & Affiliate System</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white">

  <!-- Loading Screen -->
  <div id="loading" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="text-center">
      <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-20 h-20 rounded-full mx-auto mb-4 animate-pulse" />
      <p class="text-lg font-medium">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div id="errorMessage" class="fixed inset-0 bg-red-900/90 flex items-center justify-center z-40" style="display:none;">
    <div class="text-center px-6">
      <p class="text-lg font-medium mb-4">Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
      <button onclick="location.reload()" class="bg-white text-black px-6 py-2 rounded-lg font-medium">
        Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
      </button>
    </div>
  </div>

  <main class="max-w-xl mx-auto px-6 py-8 pt-16">
    <div class="text-center mb-6">
      <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-white/20" />
      <h1 class="text-3xl font-bold uppercase bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent mb-2">
        Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© SJ COIN
      </h1>
      <p class="text-white/80 font-medium mb-4">Ø§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ¢Øª!</p>

      <!-- NEW: Referral Code Display -->
      <div class="mb-4 p-3 bg-white/10 rounded-xl border border-white/10 inline-block cursor-pointer select-all"
           title="Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©" id="referralCodeDisplay" style="user-select: all;">
      </div>
    </div>

    <!-- Referral Link Display -->
    <div class="mb-6 p-4 bg-white/10 rounded-xl border border-white/10 break-words">
      <p class="text-xs text-white/60 mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
      <p id="referralDisplay" class="text-sm font-mono text-yellow-300 select-all cursor-pointer" title="Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·"></p>
    </div>

    <!-- Referral Code Input -->
    <div class="mb-6 p-4 bg-white/10 rounded-xl border border-white/10">
      <p class="text-xs text-white/60 mb-2">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ 50 SJ:</p>
      <input id="referralCodeInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§" class="w-full px-4 py-2 rounded-lg text-black mb-3" autocomplete="off" />
      <button id="applyReferralBtn" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold transition-colors duration-200">
        ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      </button>
    </div>

    <!-- Buttons -->
    <div class="flex gap-3 mb-8">
      <button id="copyLinkBtn" class="flex-1 bg-white/20 text-white px-6 py-3 rounded-xl font-bold border border-white/20 hover:bg-white/30 transition-all">
        ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
      </button>
      <button id="inviteBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
        ğŸ‘¥ Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
      </button>
    </div>

    <!-- Affiliate Stats -->
    <div id="affiliateStats" class="mb-6 p-4 bg-white/10 rounded-xl border border-white/10 hidden"></div>

    <!-- Friends List -->
    <section>
      <h2 id="friendCount" class="text-xl font-semibold mb-3">Ø£ØµØ¯Ù‚Ø§Ø¤Ùƒ</h2>
      <div id="friendsList" class="space-y-3"></div>
    </section>
  </main>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      setDoc,
      updateDoc,
      increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-lite.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const telegramUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
    const telegramId = telegramUser.id?.toString() || "demo_user";
    const firstName = telegramUser.first_name || "Demo";
    const lastName = telegramUser.last_name || "User";
    const isPremium = telegramUser.is_premium || false;

    const botUrl = "https://t.me/sjcoin25bot";
    const referralLink = `${botUrl}?startapp=ref${telegramId}`;
    const referralCode = telegramId; // ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ù‡Ùˆ Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù†ÙØ³Ù‡

    const referralCodeInput = document.getElementById("referralCodeInput");
    const applyReferralBtn = document.getElementById("applyReferralBtn");
    const referralDisplay = document.getElementById("referralDisplay");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const inviteBtn = document.getElementById("inviteBtn");
    const affiliateStatsDiv = document.getElementById("affiliateStats");
    const referralCodeDisplay = document.getElementById("referralCodeDisplay");

    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø£Ø¶ÙÙ‡
    async function ensureUserExists() {
      const userRef = doc(db, "users", telegramId);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists()) {
        await setDoc(userRef, {
          id: telegramId,
          first_name: firstName,
          last_name: lastName,
          referred_by: null,
          balance: 0,
          premium: isPremium,
          referral_count: 0,
          total_earned: 0,
          created_at: new Date().toISOString(),
          last_active: new Date().toISOString()
        });
      } else {
        await updateDoc(userRef, { last_active: new Date().toISOString() });
      }
    }

    // ØªÙØ¹ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: Ù…Ù†Ø­ 50 SJ Ù„Ù„Ø·Ø±ÙÙŠÙ† Ø¥Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ØµØ§Ù„Ø­
    async function applyReferralCode() {
      const code = referralCodeInput.value.trim();
      if (!code) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©");
      if (code === telegramId) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ");

      try {
        const refUserRef = doc(db, "users", code);
        const refUserSnap = await getDoc(refUserRef);

        if (!refUserSnap.exists()) {
          return alert("ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        }

        const userRef = doc(db, "users", telegramId);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();

        if (userData.referred_by) {
          return alert("Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§");
        }

        // Ù…Ù†Ø­ 50 SJ Ù„Ù„Ø·Ø±ÙÙŠÙ†
        await updateDoc(refUserRef, { balance: increment(50), referral_count: increment(1) });
        await updateDoc(userRef, { balance: increment(50), referred_by: code });

        alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 50 SJ ğŸ‰");

        referralCodeInput.value = "";
        await loadAffiliateStats();

      } catch (error) {
        console.error(error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯");
      }
    }

    // Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ø³Ù‡ÙˆÙ„Ø©
    copyLinkBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(referralLink);
        alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©!");
      } catch {
        alert("Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ.");
      }
    };

    // Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡
    referralCodeDisplay.onclick = async () => {
      try {
        await navigator.clipboard.writeText(referralCode);
        alert("ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©!");
      } catch {
        alert("Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ.");
      }
    };

    // Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡
    referralDisplay.onclick = async () => {
      try {
        await navigator.clipboard.writeText(referralLink);
        alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©!");
      } catch {
        alert("Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ.");
      }
    };

    // ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (ÙØªØ­ Ø¨ÙˆØª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…)
    inviteBtn.onclick = () => {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.openLink(referralLink);
      } else {
        window.open(referralLink, "_blank");
      }
    };

    applyReferralBtn.onclick = applyReferralCode;

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ (Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
    async function loadAffiliateStats() {
      try {
        const friendsQuery = query(collection(db, "users"), where("referred_by", "==", telegramId));
        const friendsSnap = await getDocs(friendsQuery);
        const friends = [];
        friendsSnap.forEach(doc => {
          friends.push(doc.data());
        });

        const userRef = doc(db, "users", telegramId);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();

        affiliateStatsDiv.innerHTML = `
          <h3 class="text-lg font-bold mb-2">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</h3>
          <p>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${userData.balance ?? 0} SJ</b></p>
          <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†: <b>${friends.length}</b></p>
        `;
        affiliateStatsDiv.classList.remove("hidden");

        const friendsList = document.getElementById("friendsList");
        friendsList.innerHTML = "";
        if (friends.length === 0) {
          friendsList.innerHTML = "<p class='text-white/70'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø£ØµØ¯Ù‚Ø§Ø¡ Ù…Ø¯Ø¹ÙˆÙˆÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>";
        } else {
          friends.forEach(f => {
            friendsList.innerHTML += `
              <div class="p-3 bg-white/10 rounded-xl border border-white/20">
                <p>${f.first_name || "Ù…Ø³ØªØ®Ø¯Ù…"} ${f.last_name || ""}</p>
                <p>Ø§Ù„Ø±ØµÙŠØ¯: ${f.balance ?? 0} SJ</p>
              </div>
            `;
          });
        }
      } catch (e) {
        console.error(e);
      }
    }

    // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    async function init() {
      try {
        await ensureUserExists();
        referralDisplay.textContent = referralLink;
        referralCodeDisplay.textContent = referralCode;
        await loadAffiliateStats();
      } catch (e) {
        console.error(e);
        document.getElementById("loading").style.display = "none";
        document.getElementById("errorMessage").style.display = "flex";
      }
      document.getElementById("loading").style.display = "none";
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
