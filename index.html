<!DOCTYPE html>
<html>
<head>
  <title>SJ COIN Affiliate</title>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body style="font-family: sans-serif;">
  <h2>👥 رابط الدعوة الخاص بك</h2>
  <input id="refLink" style="width:100%;" readonly />
  <button onclick="copyRef()">📋 نسخ الرابط</button>

  <h3>🔗 إحالاتك</h3>
  <ul id="refList"></ul>

  <h3>💰 رصيدك:</h3>
  <div id="balance">0 SJ COIN</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:ffb379ecde6f82c0be07a0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const tg = window.Telegram.WebApp;
    const user = tg.initDataUnsafe.user;

    const userId = user.id;
    const userName = user.first_name + (user.last_name || "");

    // توليد رابط الإحالة
    const refLink = `https://t.me/sjcoin25bot?start=ref_${userId}`;
    document.getElementById("refLink").value = refLink;

    // حفظ بيانات المستخدم
    const userRef = ref(db, "users/" + userId);
    update(userRef, {
      name: userName,
      profile_photo: user.photo_url || "",
    });

    // التحقق من الإحالة
    const urlParams = new URLSearchParams(window.location.search);
    const startParam = tg.initDataUnsafe?.start_param || urlParams.get("start");
    if (startParam && startParam.startsWith("ref_")) {
      const referrerId = startParam.split("_")[1];
      if (referrerId !== String(userId)) {
        const referralRef = ref(db, `users/${referrerId}/referrals/${userId}`);
        set(referralRef, { timestamp: new Date().toISOString() });
        // إضافة مكافأة
        const balanceRef = ref(db, `users/${referrerId}/balance`);
        get(balanceRef).then((snap) => {
          const newBalance = (snap.val() || 0) + 50;
          set(balanceRef, newBalance);
        });
      }
    }

    // عرض الرصيد
    onValue(ref(db, "users/" + userId + "/balance"), (snap) => {
      document.getElementById("balance").innerText = (snap.val() || 0) + " SJ COIN";
    });

    // عرض قائمة الإحالات
    onValue(ref(db, `users/${userId}/referrals`), (snap) => {
      const data = snap.val() || {};
      const list = document.getElementById("refList");
      list.innerHTML = "";
      Object.keys(data).forEach(async (refUserId) => {
        const refSnap = await get(ref(db, "users/" + refUserId));
        const refUser = refSnap.val();
        const name = refUser?.name || "مستخدم مجهول";
        const li = document.createElement("li");
        li.innerHTML = `👤 ${name}`;
        list.appendChild(li);
      });
    });

    // نسخ الرابط
    window.copyRef = () => {
      navigator.clipboard.writeText(refLink);
      alert("تم نسخ الرابط ✅");
    };
  </script>
</body>
</html>
