<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SJ COIN — دفع بـ TON</title>

  <!-- Firebase (v9 modular) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Axios for HTTP requests -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- TonConnect SDK & UI (unpkg) -->
  <script src="https://unpkg.com/@tonconnect/sdk/dist/tonconnect.min.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui/dist/tonconnect-ui.min.js"></script>

  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:900px;margin:16px auto;padding:12px;}
    .card{border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:14px;background:#fff;}
    h1{margin:0 0 10px 0}
    label{display:block;margin:8px 0 4px}
    input, button, select{padding:10px;border-radius:8px;border:1px solid #ddd;width:100%;box-sizing:border-box}
    button{cursor:pointer;margin-top:8px}
    .muted{color:#666;font-size:0.9rem}
    .status{padding:10px;border-radius:8px;margin-top:8px}
    .ok{background:#e6ffef;border:1px solid #b6f0cf}
    .warn{background:#fff7e6;border:1px solid #f2d49c}
  </style>
</head>
<body>
  <div class="card">
    <h1>SJ COIN — اشترِ بـ TON</h1>
    <p class="muted">ادفع TON لتحصل على رصيد SJ داخل حسابك (تجريبي). أدخل المبلغ (TON) واضغط "إنشاء فاتورة" ثم اضغط "دفع بـ TON".</p>
  </div>

  <div class="card" id="app">
    <label>عنوان محفظة التاجر (MERCHANT_ADDRESS)</label>
    <input id="merchantAddress" placeholder="ضع عنوان محفظتك هنا (مثلاً EQ... أو UQ...)" />

    <label>المبلغ (TON)</label>
    <input id="amountTon" type="number" step="0.000001" min="0" value="0.1" />

    <label>اسم المستخدم / معرف داخل التطبيق</label>
    <input id="userId" placeholder="مثلاً user_123" />

    <button id="createInvoiceBtn">إنشاء فاتورة</button>

    <div id="invoiceBlock" style="display:none;margin-top:12px">
      <div><strong>Invoice ID:</strong> <span id="invoiceId"></span></div>
      <div><strong>الحالة:</strong> <span id="invoiceStatus">pending</span></div>
      <button id="payBtn">دفع بـ TON (فتح المحفظة)</button>
      <div style="margin-top:8px">
        <button id="checkBtn">فحص حالة الفاتورة الآن</button>
        <button id="startPollBtn">بدء المراقبة (كل 8 ثواني)</button>
        <button id="stopPollBtn" style="display:none">إيقاف المراقبة</button>
      </div>
      <div id="log" style="margin-top:10px;font-size:0.9rem;color:#333"></div>
    </div>

    <div style="margin-top:12px" class="muted">
      <strong>ملاحظة أمان:</strong> لا تستخدم هذه الصفحة لحفظ مفاتيحك الخاصة. التحقق النهائي من الدفع وإصدار Jettons يجب أن يتم من السيرفر. هذه واجهة تجريبية فقط.
    </div>
  </div>

<script>
/* ====== إعدادات (ضع القيم المناسبة هنا) ====== */
const FIREBASE_CONFIG = {
  // ضع هنا Firebase config الخاص بمشروعك
  apiKey: "REPLACE_ME",
  authDomain: "REPLACE_ME",
  projectId: "REPLACE_ME",
  databaseURL: "REPLACE_ME",
  storageBucket: "REPLACE_ME",
  messagingSenderId: "REPLACE_ME",
  appId: "REPLACE_ME"
};

// عنوان محفظة التاجر التي تستقبل TON (ضع عنوانك)
let MERCHANT_ADDRESS = "";

// TonCenter / RPC endpoint - ضع مفتاح API إن وُجد (مثال: https://toncenter.com/api/v2)
let TONCENTER_API_URL = "https://toncenter.com/api/v2";
let TONCENTER_API_KEY = "REPLACE_WITH_YOUR_TONCENTER_API_KEY";

/* ====== تهيئة Firebase (compat - واجهة سريعة) ====== */
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore(); // سنستخدم Firestore لتخزين الفواتير

/* ====== إعداد TonConnect ======
 * نستخدم @tonconnect/sdk لفتح محفظة المستخدم وطلب إرسال تحويل.
 * المراجع: TonConnect docs (integration). 1
 */
const { TonConnect } = window.TonConnectSdk || window.tonconnect; // بعض الحزم تعرض اسم مختلف
const tonConnect = new TonConnect({});

/* ======= عناصر الواجهة ======= */
const merchantAddressInput = document.getElementById('merchantAddress');
const amountTonInput = document.getElementById('amountTon');
const userIdInput = document.getElementById('userId');
const createInvoiceBtn = document.getElementById('createInvoiceBtn');
const invoiceBlock = document.getElementById('invoiceBlock');
const invoiceIdSpan = document.getElementById('invoiceId');
const invoiceStatusSpan = document.getElementById('invoiceStatus');
const payBtn = document.getElementById('payBtn');
const checkBtn = document.getElementById('checkBtn');
const logDiv = document.getElementById('log');
const startPollBtn = document.getElementById('startPollBtn');
const stopPollBtn = document.getElementById('stopPollBtn');

let currentInvoice = null;
let pollInterval = null;

/* ====== دوال مساعدة ====== */
function log(msg) {
  const ts = new Date().toLocaleTimeString();
  logDiv.innerHTML = `[${ts}] ${msg}<br>` + logDiv.innerHTML;
}

function uuidv4() {
  // معرف فريد بسيط
  return 'xxxxxx'.replace(/[x]/g, function(){ return Math.floor(Math.random()*16).toString(16); }) + Date.now().toString(16);
}

/* ====== إنشاء فاتورة في Firestore ====== */
createInvoiceBtn.addEventListener('click', async () => {
  MERCHANT_ADDRESS = merchantAddressInput.value.trim();
  const amountTon = parseFloat(amountTonInput.value);
  const userId = userIdInput.value.trim() || ("user_"+uuidv4().slice(0,6));

  if (!MERCHANT_ADDRESS) { alert('ضع عنوان محفظة التاجر'); return; }
  if (!amountTon || amountTon <= 0) { alert('ضع مبلغ صحيح بالـ TON'); return; }

  const invoiceId = "sj_" + uuidv4();
  const invoice = {
    invoiceId,
    userId,
    amountTon,
    amountNano: Math.round(amountTon * 1e9), // TON -> nanotons
    status: "pending",
    merchantAddress: MERCHANT_ADDRESS,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  // خزن الفاتورة
  await db.collection('invoices').doc(invoiceId).set(invoice);
  currentInvoice = invoice;
  invoiceBlock.style.display = 'block';
  invoiceIdSpan.textContent = invoiceId;
  invoiceStatusSpan.textContent = "pending";
  log("تم إنشاء الفاتورة: " + invoiceId);

  // تخزن الmerchant address محلياً في حال لم تُحدد بعد
  log("عنوان التاجر: " + MERCHANT_ADDRESS);
});

/* ====== فتح TonConnect لطلب الدفع ====== */
payBtn.addEventListener('click', async () => {
  if (!currentInvoice) { alert('أنشئ فاتورة أولاً'); return; }

  try {
    // تأكد اتصال TonConnect
    if (!tonConnect || !tonConnect.connect) {
      alert('TonConnect SDK غير مُحمّل. راجع إعداداتك.');
      return;
    }

    // اطلب من المستخدم اختيار محفظة وفتح النافذة
    const connectRes = await tonConnect.connect();
    log('اتصل بالمحفظة: ' + JSON.stringify(connectRes?.account));

    // جهّز طلب التحويل: نضيف comment لتحديد الفاتورة
    const transferRequest = {
      address: currentInvoice.merchantAddress,
      amount: String(currentInvoice.amountNano), // بالنانوتون
      // بعض المحافظ تتيح comment/text - TonConnect docs توضح التفاصيل. 2
      comment: `SJ_INVOICE:${currentInvoice.invoiceId}`
    };

    // TonConnect يعيد رابط أو يفتح واجهة المحفظة لإرسال المعاملة
    // الAPI قد تختلف حسب نسخة SDK - راجع docs لو ظهرت أخطاء. 3
    await tonConnect.sendTransaction(transferRequest);
    log('تم إرسال طلب الدفع إلى المحفظة (انتظر تأكيد المعاملة من المستخدم)');
  } catch (err) {
    console.error(err);
    alert('خطأ أثناء فتح المحفظة: ' + (err.message || err));
  }
});

/* ====== فحص المعاملة عبر TonCenter / RPC ======
  هذا فحص بسيط يبحث في معاملات عنوان التاجر عن نص التعليق `SJ_INVOICE:...`.
  **تحذير:** بعض indexers تُرجع الهيكل مشفراً أو تحت حقل مختلف — لذلك الفحص النهائي يجب أن يتم على الباك-إند باستخدام decode مناسب. 4
*/
async function checkInvoicePaidOnce(invoiceId) {
  if (!invoiceId) return {paid:false};

  try {
    // نستخدم endpoint getTransactions (مثال TonCenter)
    // وثائق getTransactions: TonCenter / QuickNode / Chainstack. 5
    const url = `${TONCENTER_API_URL}/getTransactions?address=${encodeURIComponent(MERCHANT_ADDRESS)}&limit=40`;
    const headers = TONCENTER_API_KEY ? { 'X-API-Key': TONCENTER_API_KEY } : {};
    const res = await axios.get(url, { headers });

    // قد تختلف البنية حسب provider؛ هنا نتوقع res.data.result.transactions أو res.data.result
    const txs = res.data.result || res.data.transactions || [];

    for (const tx of txs) {
      // حاول إيجاد النص في in_message.body أو in_message.message
      const inMsg = tx.in_message || tx.in_message || tx.in_message?.message || tx.in_message;
      // بعض النودز تحتوي body كنص مشفّر؛ إذ لم تجده هنا، تحتاج باك-إند لفك الشفرة
      const bodyStr = JSON.stringify(tx);
      if (bodyStr.includes(`SJ_INVOICE:${invoiceId}`)) {
        // تحقق المبلغ (ابحث في fields المناسبة)
        // هنا نعتبر أي وجود مرتبط بالفاتورة يعني دفع (لمثال فقط)
        return { paid: true, txHash: tx.transaction_id || tx.hash || tx.lt || null, raw: tx };
      }
    }
    return { paid:false };
  } catch (err) {
    console.error('checkInvoicePaidOnce error', err);
    return { paid:false, error: err.message || err };
  }
}

/* زر الفحص اليدوي */
checkBtn.addEventListener('click', async () => {
  if (!currentInvoice) return alert('ليس هناك فاتورة.');
  log('جاري الفحص...');
  const r = await checkInvoicePaidOnce(currentInvoice.invoiceId);
  if (r.paid) {
    log('تم العثور على الدفع! tx: ' + (r.txHash || 'unknown'));
    invoiceStatusSpan.textContent = "paid";
    // حدّث الفاتورة في Firestore
    await db.collection('invoices').doc(currentInvoice.invoiceId).update({ status: "paid", paidAt: firebase.firestore.FieldValue.serverTimestamp(), tx: r.txHash || null });
    // هنا تنفذ منطق الإعطاء: إضافة رصيد SJ في Firebase أو استدعاء باك-إند لإرسال Jetton
    log('تحديث الفاتورة في Firestore: paid');
  } else {
    log('لم يتم العثور على الدفع بعد.');
  }
});

/* مراقبة دورية */
startPollBtn.addEventListener('click', () => {
  if (!currentInvoice) return alert('ليس هناك فاتورة.');
  startPollBtn.style.display = 'none';
  stopPollBtn.style.display = 'inline-block';
  pollInterval = setInterval(async () => {
    log('poll: فحص الفاتورة...');
    const r = await checkInvoicePaidOnce(currentInvoice.invoiceId);
    if (r.paid) {
      log('poll: المدفوعات وجدت! tx: ' + (r.txHash || 'unknown'));
      invoiceStatusSpan.textContent = "paid";
      await db.collection('invoices').doc(currentInvoice.invoiceId).update({ status: "paid", paidAt: firebase.firestore.FieldValue.serverTimestamp(), tx: r.txHash || null });
      // أغلق المراقبة
      clearInterval(pollInterval);
      stopPollBtn.style.display = 'none';
      startPollBtn.style.display = 'inline-block';
      alert('تم تأكيد الدفع! الفاتورة مدفوعة.');
    } else {
      log('poll: لم يدفع بعد.');
    }
  }, 8000);
});

stopPollBtn.addEventListener('click', () => {
  if (pollInterval) clearInterval(pollInterval);
  pollInterval = null;
  stopPollBtn.style.display = 'none';
  startPollBtn.style.display = 'inline-block';
  log('تم إيقاف المراقبة.');
});

/* عند تحميل الصفحة، ضع عنوان التاجر إن كان موجوداً سابقاً (تذكّر تعيين المتغيرات) */
window.addEventListener('load', () => {
  // يمكن تعبئته تلقائياً أو تحميله من إعدادات
  if (MERCHANT_ADDRESS) {
    merchantAddressInput.value = MERCHANT_ADDRESS;
  }
  log('الصفحة جاهزة. تأكد من إعداد المتغيرات (FIREBASE_CONFIG, MERCHANT_ADDRESS, TONCENTER_API_KEY).');
});
</script>
</body>
</html>
