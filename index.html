<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle Drift & Merge - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js" type="application/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 0; }
        .screen { display: none; padding: 20px; }
        .active { display: block; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .slot { width: 80px; height: 80px; background-color: #ddd; border: 1px solid #aaa; text-align: center; line-height: 80px; cursor: pointer; }
        .car { draggable: true; }
        .currency { margin: 10px 0; font-weight: bold; }
        button { padding: 10px; margin: 5px; background-color: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <button onclick="showScreen('earn')">Earn</button>
        <button onclick="showScreen('garage')">Garage</button>
        <button onclick="showScreen('pvp')">DRFT PARTY PVP</button>
        <button onclick="showScreen('roadtrip')">Road Trip</button>
        <button onclick="showScreen('leaderboard')">Rating</button>
        <button onclick="showScreen('spin')">Spin</button>
        <button onclick="showScreen('nft')">DRFT NFT CLAIM</button>
    </nav>

    <!-- Earn Screen -->
    <div id="earn" class="screen active">
        <h2>Earn Screen</h2>
        <div class="currency">Gold: <span id="gold">10000</span> | Blue Tokens: <span id="blue">0</span> | Energy: <span id="energy">5/10</span></div>
        <div>EARN/SEC: <span id="earnPerSec">0</span></div>
        <div class="grid" id="earningGrid"></div>
        <button onclick="buyCar()">Buy Level 1 Car (100 Blue)</button>
        <button onclick="activateBoost()">Boost (2x for 5min)</button>
        <button onclick="toggleAutoMode()">Auto Mode</button>
    </div>

    <!-- Garage Screen -->
    <div id="garage" class="screen">
        <h2>Garage</h2>
        <div id="carCollection"></div>
    </div>

    <!-- PVP Screen -->
    <div id="pvp" class="screen">
        <h2>DRFT PARTY PVP</h2>
        <select id="pvpCarSelect"></select>
        <button onclick="startPVP()">Race!</button>
        <div id="pvpResult"></div>
    </div>

    <!-- Road Trip Screen -->
    <div id="roadtrip" class="screen">
        <h2>Road Trip Missions</h2>
        <button onclick="startMission()">Start Mission (1 Energy)</button>
        <div id="missionResult"></div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="leaderboard" class="screen">
        <h2>Rating Leaderboard</h2>
        <ul id="leaderboardList"></ul>
    </div>

    <!-- Spin Screen -->
    <div id="spin" class="screen">
        <h2>Spin the Wheel</h2>
        <button onclick="spinWheel()">Spin (Watch Ad or 1 Token)</button>
        <div id="spinResult"></div>
    </div>

    <!-- NFT Screen -->
    <div id="nft" class="screen">
        <h2>DRFT NFT CLAIM</h2>
        <button onclick="connectWallet()">Connect Wallet</button>
        <select id="nftCarSelect"></select>
        <button onclick="mintNFT()">Mint NFT</button>
        <div id="nftResult"></div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
            authDomain: "metawarefare-gaming.firebaseapp.com",
            databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
            projectId: "metawarefare-gaming",
            storageBucket: "metawarefare-gaming.appspot.com",
            messagingSenderId: "551352148152",
            appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Telegram Mini App Integration
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        const user = tg.initDataUnsafe.user; // Get Telegram user data

        // Custom Auth with Telegram User
        async function telegramAuth() {
            const token = await getCustomTokenFromServer(user.id); // Assume a server function to generate Firebase custom token based on Telegram ID
            await auth.signInWithCustomToken(token);
        }
        // Placeholder for custom token generation (use Cloud Functions in production)
        async function getCustomTokenFromServer(telegramId) {
            // In production, call a backend endpoint to verify and generate token
            return 'dummy-token'; // Replace with actual implementation
        }

        // Game State
        let gold = 10000;
        let blue = 0;
        let energy = 5;
        let maxEnergy = 10;
        let earnPerSec = 0;
        let cars = []; // Array of car objects {id: unique, level: 1, earning: 1}
        let gridSlots = Array(12).fill(null); // 12 slots
        let nextCarId = 0;
        let carCost = 100; // Initial blue cost for level 1 car
        let boostActive = false;
        let autoMode = false;
        let userDocRef;

        // Initialize
        async function init() {
            await telegramAuth();
            userDocRef = db.collection('users').doc(auth.currentUser.uid);
            await loadUserData();
            renderGrid();
            renderCurrencies();
            updateEarnPerSec();
            setInterval(earnLoop, 1000); // Earn every second
            setInterval(regenEnergy, 600000); // Regen energy every 10 min
            loadLeaderboard();
        }

        async function loadUserData() {
            const doc = await userDocRef.get();
            if (doc.exists) {
                const data = doc.data();
                gold = data.gold || 10000;
                blue = data.blue || 0;
                energy = data.energy || 5;
                cars = data.cars || [];
                gridSlots = data.gridSlots || Array(12).fill(null);
                nextCarId = data.nextCarId || 0;
            } else {
                await saveUserData();
            }
        }

        async function saveUserData() {
            await userDocRef.set({
                gold, blue, energy, cars, gridSlots, nextCarId
            });
        }

        function renderCurrencies() {
            document.getElementById('gold').innerText = gold;
            document.getElementById('blue').innerText = blue;
            document.getElementById('energy').innerText = `${energy}/${maxEnergy}`;
        }

        function updateEarnPerSec() {
            earnPerSec = gridSlots.reduce((total, slot) => {
                if (slot !== null) {
                    const car = cars.find(c => c.id === slot);
                    return total + (car ? getCarEarning(car.level) : 0);
                }
                return total;
            }, 0);
            if (boostActive) earnPerSec *= 2;
            document.getElementById('earnPerSec').innerText = earnPerSec;
        }

        function getCarEarning(level) {
            return Math.pow(2, level); // Exponential earning increase
        }

        function earnLoop() {
            gold += earnPerSec;
            renderCurrencies();
            saveUserData();
        }

        function regenEnergy() {
            if (energy < maxEnergy) energy++;
            renderCurrencies();
            saveUserData();
        }

        // Render Earning Grid
        function renderGrid() {
            const grid = document.getElementById('earningGrid');
            grid.innerHTML = '';
            gridSlots.forEach((slot, index) => {
                const div = document.createElement('div');
                div.className = 'slot';
                if (slot !== null) {
                    const car = cars.find(c => c.id === slot);
                    div.innerText = `Car L${car.level}`;
                    div.dataset.carId = car.id;
                    div.draggable = true;
                } else {
                    div.innerText = 'Empty';
                }
                div.addEventListener('dragstart', dragStart);
                div.addEventListener('dragover', dragOver);
                div.addEventListener('drop', drop);
                div.dataset.index = index;
                grid.appendChild(div);
            });
        }

        // Drag & Drop for Merge and Placement
        function dragStart(e) {
            e.dataTransfer.setData('text', e.target.dataset.carId);
        }

        function dragOver(e) {
            e.preventDefault();
        }

        function drop(e) {
            e.preventDefault();
            const draggedId = parseInt(e.dataTransfer.getData('text'));
            const targetIndex = parseInt(e.target.dataset.index);
            const draggedSlotIndex = gridSlots.findIndex(id => id === draggedId);
            const targetCarId = gridSlots[targetIndex];

            if (targetCarId === null) {
                // Place in empty slot
                gridSlots[draggedSlotIndex] = null;
                gridSlots[targetIndex] = draggedId;
            } else {
                // Merge if same level
                const draggedCar = cars.find(c => c.id === draggedId);
                const targetCar = cars.find(c => c.id === targetCarId);
                if (draggedCar.level === targetCar.level) {
                    // Merge
                    targetCar.level++;
                    cars = cars.filter(c => c.id !== draggedId); // Remove dragged car
                    gridSlots[draggedSlotIndex] = null;
                }
            }
            updateEarnPerSec();
            renderGrid();
            saveUserData();
        }

        // Buy Car
        function buyCar() {
            if (blue >= carCost) {
                blue -= carCost;
                carCost += 10; // Increase cost slightly
                cars.push({id: nextCarId++, level: 1, earning: getCarEarning(1)});
                renderCurrencies();
                renderGarage();
                saveUserData();
            }
        }

        // Boost
        function activateBoost() {
            boostActive = true;
            updateEarnPerSec();
            setTimeout(() => {
                boostActive = false;
                updateEarnPerSec();
            }, 300000); // 5 minutes
        }

        // Auto Mode (Premium: Auto Merge simulation)
        function toggleAutoMode() {
            autoMode = !autoMode;
            if (autoMode) {
                setInterval(autoMerge, 60000); // Auto merge every minute
            }
        }

        function autoMerge() {
            // Simple auto merge logic: Find two same level cars in garage and merge
            const levelGroups = {};
            cars.forEach(car => {
                if (!levelGroups[car.level]) levelGroups[car.level] = [];
                levelGroups[car.level].push(car);
            });
            for (let level in levelGroups) {
                if (levelGroups[level].length >= 2) {
                    const car1 = levelGroups[level][0];
                    const car2 = levelGroups[level][1];
                    car1.level++;
                    cars = cars.filter(c => c !== car2);
                    break; // Merge one pair
                }
            }
            renderGarage();
            saveUserData();
        }

        // Garage Render
        function renderGarage() {
            const collection = document.getElementById('carCollection');
            collection.innerHTML = '';
            cars.forEach(car => {
                const div = document.createElement('div');
                div.className = 'slot car';
                div.innerText = `Car L${car.level}`;
                div.dataset.carId = car.id;
                div.draggable = true;
                div.addEventListener('dragstart', dragStart);
                collection.appendChild(div);
            });
        }

        // PVP (Simple simulation)
        async function startPVP() {
            if (energy < 1) return;
            energy--;
            const selectedCarLevel = parseInt(document.getElementById('pvpCarSelect').value);
            // Simulate race: Higher level wins more often
            const win = Math.random() < (selectedCarLevel / 10);
            if (win) {
                blue += 50;
                document.getElementById('pvpResult').innerText = 'Victory! +50 Blue';
            } else {
                document.getElementById('pvpResult').innerText = 'Defeat!';
            }
            renderCurrencies();
            saveUserData();
            updateLeaderboard();
        }

        // Populate PVP car select
        function populatePVPSelect() {
            const select = document.getElementById('pvpCarSelect');
            select.innerHTML = '';
            cars.forEach(car => {
                const option = document.createElement('option');
                option.value = car.level;
                option.text = `Car L${car.level}`;
                select.appendChild(option);
            });
        }

        // Road Trip Mission
        function startMission() {
            if (energy < 1) return;
            energy--;
            // Simulate mission success
            const success = Math.random() > 0.3;
            if (success) {
                gold += 1000;
                document.getElementById('missionResult').innerText = 'Mission Complete! +1000 Gold';
            } else {
                document.getElementById('missionResult').innerText = 'Mission Failed!';
            }
            renderCurrencies();
            saveUserData();
        }

        // Leaderboard
        async function loadLeaderboard() {
            const snapshot = await db.collection('users').orderBy('gold', 'desc').limit(10).get();
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            snapshot.forEach(doc => {
                const li = document.createElement('li');
                li.innerText = `${doc.id}: ${doc.data().gold} Gold`;
                list.appendChild(li);
            });
        }

        async function updateLeaderboard() {
            // Leaderboard updated on load, but in real-time use Firestore listeners
        }

        // Spin Wheel (Simple random prize)
        function spinWheel() {
            // Assume ad watched or token used
            const prizes = ['100 Gold', '50 Blue', 'Level 1 Car', 'Boost'];
            const prize = prizes[Math.floor(Math.random() * prizes.length)];
            if (prize === '100 Gold') gold += 100;
            else if (prize === '50 Blue') blue += 50;
            else if (prize === 'Level 1 Car') cars.push({id: nextCarId++, level: 1, earning: getCarEarning(1)});
            else if (prize === 'Boost') activateBoost();
            document.getElementById('spinResult').innerText = `You won: ${prize}`;
            renderCurrencies();
            saveUserData();
        }

        // Web3/NFT Integration (Example with Polygon, using Ethers.js)
        let provider;
        let signer;
        let contract; // Assume a pre-deployed NFT contract
        const contractAddress = 'YOUR_NFT_CONTRACT_ADDRESS'; // Replace with actual contract address
        const abi = [ // Basic ERC721 ABI for mint
            'function mint(uint256 carLevel) public returns (uint256)'
        ];

        async function connectWallet() {
            if (window.ethereum) {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send('eth_requestAccounts', []);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, abi, signer);
                document.getElementById('nftResult').innerText = 'Wallet Connected!';
            } else {
                document.getElementById('nftResult').innerText = 'Install MetaMask!';
            }
        }

        function populateNFTSelect() {
            const select = document.getElementById('nftCarSelect');
            select.innerHTML = '';
            cars.filter(car => car.level >= 5).forEach(car => { // Only high-level cars
                const option = document.createElement('option');
                option.value = car.id;
                option.text = `Car L${car.level}`;
                select.appendChild(option);
            });
        }

        async function mintNFT() {
            const carId = parseInt(document.getElementById('nftCarSelect').value);
            const car = cars.find(c => c.id === carId);
            try {
                const tx = await contract.mint(car.level);
                await tx.wait();
                // Remove from in-game after mint
                cars = cars.filter(c => c.id !== carId);
                const slotIndex = gridSlots.findIndex(id => id === carId);
                if (slotIndex !== -1) gridSlots[slotIndex] = null;
                document.getElementById('nftResult').innerText = 'NFT Minted!';
                renderGrid();
                renderGarage();
                saveUserData();
            } catch (error) {
                document.getElementById('nftResult').innerText = 'Mint Failed: ' + error.message;
            }
        }

        // Screen Navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if (screenId === 'garage') renderGarage();
            if (screenId === 'pvp') populatePVPSelect();
            if (screenId === 'nft') populateNFTSelect();
        }

        // Init on load
        init();
    </script>
</body>
</html>
