<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>SJ COIN Idle Drift & Merge - Telegram Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      margin: 0; padding: 10px;
      text-align: center;
    }
    #currency-bar {
      margin-bottom: 15px;
      font-size: 1.2em;
    }
    #earnPerSec {
      font-weight: bold;
      margin-bottom: 20px;
    }
    #totalBalance {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: #0f0;
      font-weight: bold;
    }
    #grid {
      display: grid;
      grid-template-columns: repeat(4, 80px);
      grid-gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .slot {
      width: 80px;
      height: 80px;
      background: #222;
      border: 2px solid #444;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      cursor: pointer;
      position: relative;
    }
    .car-level {
      width: 60px;
      height: 60px;
      background: gold;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      cursor: grab;
      font-weight: bold;
      font-size: 1.1em;
    }
    #shop {
      margin-top: 10px;
    }
    #shop button {
      background: #00aaff;
      border: none;
      color: white;
      font-size: 1em;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
    }
    #shop button:disabled {
      background: #444;
      cursor: not-allowed;
    }
    #message {
      margin-top: 10px;
      min-height: 20px;
      font-size: 0.9em;
      color: #ffa;
    }
  </style>
</head>
<body>

  <h1>SJ COIN - Idle Drift & Merge</h1>

  <div id="currency-bar">
    ذهب: <span id="gold">10000</span> &nbsp;|&nbsp; رموز زرقاء: <span id="blueTokens">0</span> &nbsp;|&nbsp; طاقة: <span id="energy">5</span>
  </div>

  <div id="earnPerSec">الإيراد في الثانية: <span id="earnRate">0</span></div>

  <div id="totalBalance">الرصيد الكلي: <span id="totalBalanceValue">0</span></div>

  <div id="grid"></div>

  <div id="shop">
    <button id="buyCarBtn">شراء سيارة مستوى 1 - السعر: <span id="carPrice">100</span> ذهب</button>
  </div>

  <div id="message"></div>

  <!-- Telegram Web App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // === إعداد Telegram Mini App ===
    Telegram.WebApp.ready();

    // === إعداد Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // === بيانات اللعبة ===
    const GRID_SIZE = 12;
    let userId = null;
    let userData = {
      gold: 10000,
      blueTokens: 0,
      energy: 5,
      carPrice: 100,
      carsOnGrid: Array(GRID_SIZE).fill(null),
      carInventory: []
    };

    // === عناصر الواجهة ===
    const goldEl = document.getElementById('gold');
    const blueTokensEl = document.getElementById('blueTokens');
    const energyEl = document.getElementById('energy');
    const earnRateEl = document.getElementById('earnRate');
    const totalBalanceEl = document.getElementById('totalBalanceValue');
    const gridEl = document.getElementById('grid');
    const buyCarBtn = document.getElementById('buyCarBtn');
    const carPriceEl = document.getElementById('carPrice');
    const messageEl = document.getElementById('message');

    // === تحديث الواجهة ===
    function updateDisplay() {
      goldEl.textContent = Math.floor(userData.gold);
      blueTokensEl.textContent = userData.blueTokens;
      energyEl.textContent = userData.energy;
      carPriceEl.textContent = Math.floor(userData.carPrice);
      earnRateEl.textContent = calculateEarnRate().toFixed(1);
      totalBalanceEl.textContent = calculateTotalBalance().toLocaleString();
    }

    // حساب الإيراد في الثانية
    function calculateEarnRate() {
      let rate = 0;
      userData.carsOnGrid.forEach(level => {
        if(level) {
          rate += 10 * Math.pow(2, level -1);
        }
      });
      return rate;
    }

    // حساب الرصيد الكلي = ذهب + (رموز زرقاء * 1000) مثلاً
    function calculateTotalBalance() {
      return userData.gold + userData.blueTokens * 1000;
    }

    // توليد الذهب كل ثانية
    function startEarning() {
      setInterval(() => {
        let earn = calculateEarnRate();
        userData.gold += earn;
        updateDisplay();
        saveUserData();
      }, 1000);
    }

    // إنشاء شبكة السيارات
    function createGrid() {
      gridEl.innerHTML = '';
      for(let i=0; i < GRID_SIZE; i++) {
        const slot = document.createElement('div');
        slot.classList.add('slot');
        slot.dataset.index = i;

        if(userData.carsOnGrid[i]) {
          const carDiv = createCarDiv(userData.carsOnGrid[i]);
          slot.appendChild(carDiv);
        }

        slot.addEventListener('click', () => onSlotClick(i));
        gridEl.appendChild(slot);
      }
    }

    // إنشاء سيارة بمستوى معين
    function createCarDiv(level) {
      const div = document.createElement('div');
      div.classList.add('car-level');
      div.textContent = 'Lv ' + level;
      div.draggable = true;
      div.dataset.level = level;
      div.addEventListener('dragstart', onDragStart);
      div.addEventListener('click', e => e.stopPropagation());
      return div;
    }

    // شراء سيارة مستوى 1
    function buyCar() {
      if(userData.gold >= userData.carPrice) {
        const emptyIndex = userData.carsOnGrid.indexOf(null);
        if(emptyIndex === -1) {
          showMessage('الشبكة ممتلئة، ادمج سيارات لفتح مكان.');
          return;
        }
        userData.gold -= userData.carPrice;
        userData.carsOnGrid[emptyIndex] = 1;
        userData.carPrice = Math.floor(userData.carPrice * 1.15);
        updateDisplay();
        createGrid();
        saveUserData();
      } else {
        showMessage('لا يوجد لديك ذهب كافي للشراء.');
      }
    }

    // عرض رسالة
    function showMessage(msg) {
      messageEl.textContent = msg;
      setTimeout(() => { messageEl.textContent = ''; }, 3000);
    }

    // دمج السيارات
    function mergeCars(fromIndex, toIndex) {
      const fromLevel = userData.carsOnGrid[fromIndex];
      const toLevel = userData.carsOnGrid[toIndex];
      if(fromIndex === toIndex) return false;
      if(fromLevel && toLevel && fromLevel === toLevel) {
        userData.carsOnGrid[toIndex] = toLevel + 1;
        userData.carsOnGrid[fromIndex] = null;
        createGrid();
        updateDisplay();
        saveUserData();
        showMessage('تم الدمج إلى مستوى ' + (toLevel + 1));
        return true;
      }
      return false;
    }

    // حفظ البيانات في Firebase
    function saveUserData() {
      if(!userId) return;
      db.collection('users').doc(userId).set(userData).catch(console.error);
    }

    // تحميل بيانات المستخدم
    function loadUserData() {
      if(!userId) return;
      db.collection('users').doc(userId).get()
        .then(doc => {
          if(doc.exists) {
            userData = doc.data();
            if(!userData.carsOnGrid || userData.carsOnGrid.length !== GRID_SIZE) {
              userData.carsOnGrid = Array(GRID_SIZE).fill(null);
            }
          }
          updateDisplay();
          createGrid();
        }).catch(console.error);
    }

    // Drag & Drop logic
    let draggedCarIndex = null;

    function onDragStart(e) {
      const parentSlot = e.target.parentElement;
      draggedCarIndex = parseInt(parentSlot.dataset.index);
      e.dataTransfer.effectAllowed = "move";
    }

    function onSlotClick(index) {
      if(draggedCarIndex === null) return;
      if(mergeCars(draggedCarIndex, index)) {
        draggedCarIndex = null;
      }
    }

    // Firebase anonymous login
    function login() {
      auth.signInAnonymously()
      .then(userCredential => {
        userId = userCredential.user.uid;
        loadUserData();
        startEarning();
      })
      .catch(error => {
        console.error(error);
        showMessage('خطأ في تسجيل الدخول إلى Firebase.');
      });
    }

    buyCarBtn.addEventListener('click', buyCar);

    // بدء التطبيق
    login();
  </script>

</body>
</html>
