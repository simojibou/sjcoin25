<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SJ COIN Referral & Affiliate System</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- TonConnect (UMD) - manifestUrl must be valid (Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ manifest Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ) -->
  <script src="https://unpkg.com/@tonconnect/sdk/dist/tonconnect.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white font-sans">

  <!-- Top bar with Back button -->
  <header class="fixed top-4 left-4 right-4 z-50 flex items-center justify-between">
    <a href="./index.html" class="flex items-center gap-3 bg-white/5 backdrop-blur-sm px-3 py-2 rounded-2xl border border-white/10 hover:bg-white/10 transition">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
      <span class="text-sm">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </a>

    <!-- Premium badge placeholder - toggled by JS -->
    <div id="premiumBadgeContainer" class="hidden items-center gap-2 bg-gradient-to-r from-yellow-400 to-orange-400 text-black px-3 py-2 rounded-2xl font-semibold shadow-lg">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 .587l3.668 7.431 8.2 1.192-5.934 5.79 1.402 8.177L12 18.896l-7.336 3.88 1.402-8.178L.132 9.21l8.2-1.192z"/></svg>
      <span id="premiumText">Premium</span>
    </div>
  </header>

  <!-- Loading Screen -->
  <div id="loading" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="text-center">
      <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-20 h-20 rounded-full mx-auto mb-4 animate-pulse" />
      <p class="text-lg font-medium">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div id="errorMessage" class="fixed inset-0 bg-red-900/90 flex items-center justify-center z-40" style="display:none;">
    <div class="text-center px-6">
      <p class="text-lg font-medium mb-4">Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
      <button onclick="location.reload()" class="bg-white text-black px-6 py-2 rounded-lg font-medium">
        Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
      </button>
    </div>
  </div>

  <main class="max-w-2xl mx-auto px-6 py-10 pt-24">
    <div class="text-center mb-6">
      <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white/10 shadow-2xl" />
      <h1 class="text-3xl font-extrabold uppercase bg-gradient-to-r from-yellow-300 via-white to-orange-500 bg-clip-text text-transparent mb-2 tracking-wide">
        Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© SJ COIN
      </h1>
      <p class="text-white/80 font-medium mb-4">Ø§Ø¯Ø¹Ù Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ¢Øª â€” 50 SJ Ù„ÙƒÙ„ Ø·Ø±Ù ğŸ‰</p>

      <!-- Referral Code Display -->
      <div class="mb-4 inline-block">
        <div class="flex items-center gap-3 bg-white/6 px-4 py-2 rounded-2xl border border-white/10 shadow-inner cursor-pointer select-all"
             title="Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©" id="referralCodeDisplay" style="user-select: all;">
          <span class="text-xs text-white/70">ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</span>
          <span id="referralCodeText" class="text-sm font-mono font-semibold text-yellow-300"></span>
        </div>
      </div>
    </div>

    <!-- Referral Link Display -->
    <div class="mb-6 p-4 bg-white/6 rounded-2xl border border-white/8 break-words shadow-sm">
      <div class="flex justify-between items-start">
        <div>
          <p class="text-xs text-white/60 mb-1">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
          <p id="referralDisplay" class="text-sm font-mono text-yellow-300 select-all cursor-pointer" title="Ø§Ø¶ØºØ· Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·"></p>
        </div>
        <button id="copyLinkBtn" class="ml-4 bg-white/6 px-3 py-2 rounded-xl border border-white/8 hover:bg-white/10 transition">ğŸ“‹ Ù†Ø³Ø®</button>
      </div>
    </div>

    <!-- Wallet & Payment Section -->
    <div class="mb-6 p-4 bg-white/6 rounded-2xl border border-white/8">
      <h3 class="text-sm font-semibold mb-2">Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ù€ Crypto (TON)</h3>

      <div class="grid gap-3 sm:grid-cols-2">
        <div>
          <button id="connectWalletBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 px-4 py-3 rounded-xl font-bold">ğŸ”Œ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø­ÙØ¸Ø©</button>
        </div>
        <div>
          <div class="flex gap-2">
            <input id="payAmount" type="number" step="0.001" min="0" value="0.1" class="flex-1 px-3 py-2 rounded-xl text-black" />
            <button id="createInvoiceBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-bold">âœ¨ Ø§Ø´ØªØ±ÙŠ SJ</button>
          </div>
        </div>

        <div class="sm:col-span-2">
          <p class="text-xs text-white/70 mb-2">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØªØµÙ„:</p>
          <div class="flex items-center gap-3">
            <div id="connectedAddress" class="flex-1 px-3 py-2 rounded-xl bg-white/5 font-mono text-sm">ØºÙŠØ± Ù…ØªØµÙ„</div>
            <button id="copyWalletBtn" class="bg-white/6 px-3 py-2 rounded-xl border border-white/8 hover:bg-white/10">ğŸ“‹ Ù†Ø³Ø®</button>
          </div>
          <p class="text-xs text-white/60 mt-2">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¯ÙØ¹ ÙŠÙØªØ­ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· <code>ton://transfer</code> Ø£Ùˆ Ø¹Ø¨Ø± TonConnect Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø©.</p>
        </div>
      </div>
    </div>

    <!-- Referral Code Input -->
    <div class="mb-6 p-4 bg-white/6 rounded-2xl border border-white/8">
      <p class="text-xs text-white/60 mb-2">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ 50 SJ:</p>
      <div class="flex gap-3">
        <input id="referralCodeInput" type="text" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§" class="flex-1 px-4 py-3 rounded-xl text-black" autocomplete="off" />
        <button id="applyReferralBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl font-bold transition-colors duration-200">ØªÙØ¹ÙŠÙ„</button>
      </div>
    </div>

    <!-- Buttons -->
    <div class="flex gap-3 mb-8">
      <button id="inviteBtn" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-2xl font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
        ğŸ‘¥ Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
      </button>
      <button id="shareBtn" class="flex-1 bg-white/6 text-white px-6 py-3 rounded-2xl font-bold border border-white/10 hover:bg-white/10 transition-all">
        ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©
      </button>
    </div>

    <!-- Affiliate Stats -->
    <div id="affiliateStats" class="mb-6 p-5 bg-white/6 rounded-2xl border border-white/8 hidden shadow-md"></div>

    <!-- Upgrade to Premium Button -->
    <div class="mb-6 text-center">
      <button id="upgradeBtn" class="inline-block bg-gradient-to-r from-yellow-400 to-orange-500 text-black font-semibold px-8 py-3 rounded-full shadow-lg hover:from-yellow-500 hover:to-orange-600 transition">
        â­ ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Premium
      </button>
    </div>

    <!-- Buy SJ COIN with Stars Button -->
    <div class="mb-10 text-center">
      <button id="buySJBtn" class="inline-block bg-gradient-to-r from-blue-700 to-blue-900 text-white font-semibold px-8 py-3 rounded-full shadow-lg hover:from-blue-800 hover:to-blue-950 transition">
        âœ¨ Ø´Ø±Ø§Ø¡ SJ COIN Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ… (Stars)
      </button>
    </div>

    <!-- Friends List -->
    <section>
      <h2 id="friendCount" class="text-xl font-semibold mb-3">Ø£ØµØ¯Ù‚Ø§Ø¤Ùƒ</h2>
      <div id="friendsList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
    </section>
  </main>

  <!-- Firebase + App Logic -->
  <script type="module">
    // Ø§Ø³ØªÙˆØ±Ø¯ Firebase (lite) Ù„Ø³Ø±Ø¹Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¯Ø§Ø®Ù„ WebApp
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      setDoc,
      updateDoc,
      increment,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-lite.js";

    // â† Ø¹Ø¯Ù‘Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø¥Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ù† WebApp (Ø¢Ù…Ù†Ø© Ù„Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†ØµØ© WebApp)
    const telegramUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
    const telegramId = (telegramUser.id?.toString()) || "demo_user";
    const firstName = telegramUser.first_name || "Demo";
    const lastName = telegramUser.last_name || "User";
    const isPremium = telegramUser.is_premium || false;

    const botUrl = "https://t.me/sjcoin25bot";
    const referralLink = `${botUrl}?startapp=ref${telegramId}`;
    const referralCode = telegramId; // Ù†Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ÙƒÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø©

    // Ø¹Ù†Ø§ØµØ± DOM
    const referralCodeInput = document.getElementById("referralCodeInput");
    const applyReferralBtn = document.getElementById("applyReferralBtn");
    const referralDisplay = document.getElementById("referralDisplay");
    const copyLinkBtn = document.getElementById("copyLinkBtn");
    const inviteBtn = document.getElementById("inviteBtn");
    const shareBtn = document.getElementById("shareBtn");
    const affiliateStatsDiv = document.getElementById("affiliateStats");
    const referralCodeDisplay = document.getElementById("referralCodeDisplay");
    const referralCodeText = document.getElementById("referralCodeText");
    const premiumBadgeContainer = document.getElementById("premiumBadgeContainer");
    const upgradeBtn = document.getElementById("upgradeBtn");
    const buySJBtn = document.getElementById("buySJBtn");
    const friendsList = document.getElementById("friendsList");
    const loadingEl = document.getElementById("loading");
    const errorEl = document.getElementById("errorMessage");

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ§Ù„Ø¯ÙØ¹
    const connectWalletBtn = document.getElementById("connectWalletBtn");
    const connectedAddressEl = document.getElementById("connectedAddress");
    const copyWalletBtn = document.getElementById("copyWalletBtn");
    const payAmountInput = document.getElementById("payAmount");
    const createInvoiceBtn = document.getElementById("createInvoiceBtn");

    // RECEIVER: Ø¶Ø¹ Ù‡Ù†Ø§ Ø¹Ù†ÙˆØ§Ù† TON Ø§Ù„Ø°ÙŠ ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Ù…Ø«Ø§Ù„: Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø§Øµ Ø¨Ø­Ø³Ø§Ø¨Ùƒ Ø£Ùˆ Ø¨Ø§Ù„Ù…Ø´Ø±ÙˆØ¹)
    const RECEIVER_TON_ADDRESS = "UQD1TlRrCeCd004h4V14Lt2L-DZqSJ8x5Vjhq-JU282mDQfz"; // â† ØºÙŠÙ‘ÙØ±Ù‡ Ø¥Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù†Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ

    // TonConnect client (Ø³ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨)
    let tonConnector = null;
    let connectedWallet = null;

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ§Ù„Ø¯ÙØ¹ ---
    async function initTonConnectIfPossible() {
      try {
        if (!window.TonConnect) {
          console.warn("TonConnect UMD ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„ Ø£Ùˆ ØºÙŠØ± Ù…ØªÙˆÙØ±.");
          return;
        }
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¶Ø¹ manifestUrl ØµØ§Ù„Ø­ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ tonconnect-manifest.json Ù…Ø³ØªØ¶Ø§Ù Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ/ GitHub
        const manifestUrl = "https://raw.githubusercontent.com/simojibou/tonconnect/main/tonconnect-manifest.json"; // â† Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· manifest ØµØ§Ù„Ø­ Ù„Ø¯ÙŠÙƒ
        tonConnector = new window.TonConnect.TonConnect({ manifestUrl });

        // Ø§Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        tonConnector.onStatusChange((walletInfo) => {
          if (walletInfo) {
            // walletInfo.accounts => Ù…ØµÙÙˆÙØ© Ø¹Ù†Ø§ÙˆÙŠÙ†
            const firstAccount = (walletInfo?.account ? walletInfo.account : (walletInfo.accounts && walletInfo.accounts[0])) || null;
            setConnectedWallet(firstAccount);
          } else {
            setConnectedWallet(null);
          }
        });

      } catch (e) {
        console.error("Ø®Ø·Ø£ ØªÙ‡ÙŠØ¦Ø© TonConnect:", e);
      }
    }

    function setConnectedWallet(account) {
      if (account) {
        connectedWallet = account;
        connectedAddressEl.textContent = account;
        // Ø®Ø²Ù‘Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù„Ø§Ø­Ù‚Ù‹Ø§)
        const userRef = doc(db, "users", telegramId);
        updateDoc(userRef, { wallet_address: account }).catch(() => {
          // Ø¥Ø°Ø§ Ø±ÙØ¶ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠÙÙ†Ø´ÙØ£ Ø¨Ø¹Ø¯ â€” Ù„Ø§ Ù†ÙƒØ³Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        });
      } else {
        connectedWallet = null;
        connectedAddressEl.textContent = "ØºÙŠØ± Ù…ØªØµÙ„";
      }
    }

    connectWalletBtn.onclick = async () => {
      try {
        // Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… TonConnect Ø£ÙˆÙ„Ù‹Ø§
        if (!tonConnector) {
          await initTonConnectIfPossible();
        }

        if (tonConnector) {
          // Ø§Ø·Ù„Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„ (Ø³ÙŠØ¹Ø±Ø¶ Ù…ÙˆØ¯Ø§Ù„ TonConnect Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© ØªØ¯Ø¹Ù…Ù‡)
          const connected = await tonConnector.connect();
          // connected Ù‚Ø¯ ØªØ±Ø¬Ø¹ account
          const account = connected?.account || (connected?.accounts && connected.accounts[0]) || null;
          if (account) {
            setConnectedWallet(account);
            alert("ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­!");
            return;
          }
        }

        // Ø¥Ø°Ø§ ØªØ¹Ø°Ø± TonConnectØŒ Ù†Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© ÙŠØ¯ÙˆÙŠØ©: ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­ÙØ¸Ø© (ton://)
        alert("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø± TonConnect â€” Ø³ÙŠØªÙ… ÙØªØ­ Ø±Ø§Ø¨Ø· Ø¯ÙØ¹ Ø¹Ø§Ù… ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø¹ Ù…Ø­ÙØ¸ØªÙƒ.");
      } catch (e) {
        console.error(e);
        alert("ÙØ´Ù„ Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­ÙØ¸Ø©: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ùˆ Ø§Ù„Ù€ manifest.");
      }
    };

    copyWalletBtn.onclick = async () => {
      if (!connectedWallet) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ÙØ¸Ø© Ù…ØªØµÙ„Ø© Ù„Ù„Ù†Ø³Ø®.");
      try {
        await navigator.clipboard.writeText(connectedWallet);
        alert("ØªÙ… Ù†Ø³Ø® Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©!");
      } catch {
        alert("Ù†Ø³Ø® ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ.");
      }
    };

    // Ø£Ù†Ø´Ø¦ ÙØ§ØªÙˆØ±Ø© ÙˆØ£ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ ton://transfer
    createInvoiceBtn.onclick = async () => {
      try {
        const amount = parseFloat(payAmountInput.value);
        if (!amount || amount <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ù„Ù„Ø¯ÙØ¹.");

        // Ø£Ù†Ø´Ø¦ Ù…Ø³ØªÙ†Ø¯ ÙØ§ØªÙˆØ±Ø© ÙÙŠ Firestore (ÙŠÙ…ÙƒÙ† Ù„Ø®Ø§Ø¯ÙˆÙ…Ùƒ Ù…Ø±Ø§Ù‚Ø¨ØªÙ‡ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù„Ø§Ø­Ù‚Ù‹Ø§)
        const invoice = {
          buyer_telegram_id: telegramId,
          buyer_wallet: connectedWallet || null,
          amount: amount, // Ø¨Ù€TON (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ SJ Ø­Ø³Ø¨ Ø³Ø¹Ø±Ùƒ)
          currency: "TON",
          status: "pending",
          created_at: new Date().toISOString(),
          referral_code_used: null
        };

        // Ø§Ø³ØªØ®Ø¯Ù… addDoc Ù„Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ù…Ø¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ
        const invoicesCol = collection(db, "invoices");
        const invoiceRef = await addDoc(invoicesCol, invoice);

        // Ø£Ù†Ø´Ø¦ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ: ton://transfer/<address>?amount=<TON>&text=<desc>
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø±Ø§Ø¨Ø· Ù‚Ø¯ ÙŠÙØªØ­ Ù…Ø­ÙØ¸Ø© TON (Tonkeeper, Tonhub, Telegram Wallet...) ÙˆÙŠØ¯Ø¹Ù… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
        const text = encodeURIComponent(`Buy SJ - invoice:${invoiceRef.id}`);
        const tonLink = `ton://transfer/${RECEIVER_TON_ADDRESS}?amount=${amount}&text=${text}`;

        // Ø¥Ø°Ø§ ÙƒØ§Ù† TonConnect Ù…ØªØµÙ„Ù‹Ø§ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¹Ø¨Ø± TonConnect
        if (tonConnector && connectedWallet) {
          try {
            // Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± TonConnect (Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø­Ø§ÙØ¸ ØªØ¯Ø¹Ù… sendTransaction Ø¹Ø¨Ø± TonConnect)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙˆØ§Ø¬Ù‡Ø© sendTransaction Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø­Ø³Ø¨ Ù†Ø³Ø®Ø© SDK - Ù‡Ù†Ø§ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¢Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚
            if (typeof tonConnector.sendTransaction === "function") {
              // amount needs to be in nanotons (1 TON = 1e9 nanotons) â€” Ø¨Ø¹Ø¶ ÙˆØ§Ø¬Ù‡Ø§Øª TonConnect ØªØ·Ù„Ø¨ nanotons
              const nano = BigInt(Math.floor(amount * 1_000_000_000));
              await tonConnector.sendTransaction({
                validUntil: Math.floor(Date.now() / 1000) + 300,
                messages: [
                  {
                    address: RECEIVER_TON_ADDRESS,
                    amount: nano.toString(), // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù…Ù‚ÙŠØ§Ø³ nanotons ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ø³Ø®
                    payload: text
                  }
                ]
              });
              // Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙŠÙ…ÙƒÙ† Ù„Ù„Ø®Ø§Ø¯Ù… Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
              alert("Ø·Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹ Ø£ÙØ±Ø³Ù„ Ø¹Ø¨Ø± TonConnect â€” ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø­ÙØ¸ØªÙƒ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©.");
              return;
            }
          } catch (e) {
            console.warn("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± TonConnectØŒ Ø³Ù†ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ ÙƒØ¨Ø¯ÙŠÙ„.", e);
          }
        }

        // ÙƒØ¨Ø¯ÙŠÙ„: Ø§ÙØªØ­ Ø±Ø§Ø¨Ø· ton://transfer Ø£Ùˆ Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
        if (window.Telegram?.WebApp) {
          // ÙÙŠ Ø¨ÙŠØ¦Ø© Telegram WebApp Ø­Ø§ÙˆÙ„ ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          try {
            window.Telegram.WebApp.openLink(tonLink);
            alert("ØªÙ… ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯ÙØ¹ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø©. Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¯ÙØ¹ Ø«Ù… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§.");
          } catch {
            window.open(tonLink, "_blank");
            alert("ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹. Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¯ÙØ¹ Ø«Ù… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§.");
          }
        } else {
          // Ø®Ø§Ø±Ø¬ Telegram: Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
          window.open(tonLink, "_blank");
          alert("ØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹. Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¯ÙØ¹ Ø«Ù… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§.");
        }

      } catch (e) {
        console.error(e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.");
      }
    };

    // --- Ø¨Ø§Ù‚ÙŠ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø­Ø§Ù„Ø© (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚) ---
    async function ensureUserExists() {
      const userRef = doc(db, "users", telegramId);
      const userSnap = await getDoc(userRef);
      const photoFromTG = telegramUser.photo_url || `https://t.me/i/userpic/320/${telegramId}.jpg`;

      if (!userSnap.exists()) {
        await setDoc(userRef, {
          id: telegramId,
          first_name: firstName,
          last_name: lastName,
          photo_url: photoFromTG,
          referred_by: null,
          balance: 0,
          premium: isPremium,
          referral_count: 0,
          total_earned: 0,
          created_at: new Date().toISOString(),
          last_active: new Date().toISOString()
        });
      } else {
        const existing = userSnap.data();
        const updatedPhoto = telegramUser.photo_url || existing.photo_url || photoFromTG;
        await updateDoc(userRef, {
          last_active: new Date().toISOString(),
          photo_url: updatedPhoto
        });
      }
    }

    async function applyReferralCode() {
      const code = referralCodeInput.value.trim();
      if (!code) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©");
      if (code === telegramId) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ");

      try {
        const refUserRef = doc(db, "users", code);
        const refUserSnap = await getDoc(refUserRef);

        if (!refUserSnap.exists()) {
          return alert("ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        }

        const userRef = doc(db, "users", telegramId);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();

        if (userData.referred_by) {
          return alert("Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª ÙƒÙˆØ¯ Ø¥Ø­Ø§Ù„Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§");
        }

        await updateDoc(refUserRef, { balance: increment(50), referral_count: increment(1) });
        await updateDoc(userRef, { balance: increment(50), referred_by: code });

        alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­! Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 50 SJ ğŸ‰");

        referralCodeInput.value = "";
        await loadAffiliateStats();
      } catch (error) {
        console.error(error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯");
      }
    }

    copyLinkBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(referralLink);
        alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©!");
      } catch {
        alert("Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ.");
      }
    };

    referralCodeDisplay.onclick = async () => {
      try {
        await navigator.clipboard.writeText(referralCode);
        alert("ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©!");
      } catch {
        alert("Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ.");
      }
    };

    referralDisplay.onclick = async () => {
      try {
        await navigator.clipboard.writeText(referralLink);
        alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©!");
      } catch {
        alert("Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ.");
      }
    };

    shareBtn.onclick = async () => {
      try {
        if (navigator.share) {
          await navigator.share({ title: 'Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ SJ COIN', text: 'Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ 50 SJ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¨Ø± Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·!', url: referralLink });
        } else {
          await navigator.clipboard.writeText(referralLink);
          alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· â€” Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ!');
        }
      } catch (e) {
        console.error(e);
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
      }
    };

    inviteBtn.onclick = () => {
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.openLink(referralLink);
      } else {
        window.open(referralLink, "_blank");
      }
    };

    upgradeBtn.onclick = () => {
      const upgradeUrl = "https://t.me/sjcoin25bot?start=premium";
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.openLink(upgradeUrl);
      } else {
        window.open(upgradeUrl, "_blank");
      }
    };

    buySJBtn.onclick = () => {
      const buyUrl = "https://t.me/sjcoin25bot?start=buystars";
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.openLink(buyUrl);
      } else {
        window.open(buyUrl, "_blank");
      }
    };

    applyReferralBtn.onclick = applyReferralCode;

    async function loadAffiliateStats() {
      try {
        const friendsQuery = query(collection(db, "users"), where("referred_by", "==", telegramId));
        const friendsSnap = await getDocs(friendsQuery);
        const friends = [];
        friendsSnap.forEach(d => friends.push(d.data()));

        const userRef = doc(db, "users", telegramId);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.exists() ? userSnap.data() : {};

        affiliateStatsDiv.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-bold mb-1">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</h3>
              <p class="text-sm text-white/80">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${userData.balance ?? 0} SJ</b></p>
              <p class="text-sm text-white/80">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙŠÙ†: <b>${friends.length}</b></p>
            </div>
            <div class="text-right">
              <p class="text-xs text-white/60">Ø¢Ø®Ø± ØªÙØ¹ÙŠÙ„: <span class="block text-sm font-mono">${userData.last_active ? new Date(userData.last_active).toLocaleString() : "â€”"}</span></p>
            </div>
          </div>
        `;
        affiliateStatsDiv.classList.remove("hidden");

        if (userData.premium) premiumBadgeContainer.classList.remove("hidden");
        else premiumBadgeContainer.classList.add("hidden");

        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
        friendsList.innerHTML = "";
        if (friends.length === 0) {
          friendsList.innerHTML = "<p class='text-white/70'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø£ØµØ¯Ù‚Ø§Ø¡ Ù…Ø¯Ø¹ÙˆÙˆÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>";
        } else {
          friends.forEach(f => {
            const photo = f.photo_url || `https://t.me/i/userpic/320/${f.id}.jpg` || 'https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG';
            const name = `${f.first_name || 'Ù…Ø³ØªØ®Ø¯Ù…'} ${f.last_name || ''}`.trim();
            const balance = f.balance ?? 0;

            const friendHTML = `
              <div class="p-4 bg-white/5 rounded-2xl border border-white/6 flex items-center gap-4 shadow-sm">
                <img src="${photo}" alt="avatar" class="w-16 h-16 rounded-full object-cover border-2 border-white/10" onerror="this.src='https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG'"/>
                <div class="flex-1">
                  <div class="flex items-center justify-between gap-3">
                    <div>
                      <p class="font-semibold">${name}</p>
                      <p class="text-xs text-white/70">Ù…Ø¹Ø±Ù: <span class="font-mono text-sm">${f.id || 'â€”'}</span></p>
                    </div>
                    <div class="text-right">
                      <p class="text-sm font-bold text-yellow-300">${balance} SJ</p>
                      ${f.premium ? '<span class="text-xs bg-yellow-400 text-black px-2 py-1 rounded-lg font-medium inline-block mt-1">Premium</span>' : ''}
                    </div>
                  </div>
                </div>
              </div>
            `;
            friendsList.insertAdjacentHTML('beforeend', friendHTML);
          });
        }
      } catch (e) {
        console.error(e);
        friendsList.innerHTML = "<p class='text-white/70'>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ Ø§Ù„Ø¢Ù†.</p>";
      }
    }

    // ØªÙ‡ÙŠØ¦Ø©: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø«Ù… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    async function init() {
      try {
        referralCodeText.textContent = referralCode;
        referralDisplay.textContent = referralLink;

        await ensureUserExists();
        await initTonConnectIfPossible(); // Ø¬Ù‡Ù‘Ø² TonConnect Ù„ÙƒÙ† Ù„Ø§ ØªÙØ±Ø¶Ù‡
        await loadAffiliateStats();

        // Ø£Ø²Ù„ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        loadingEl.style.display = "none";

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø®Ø²Ù†Ù‹Ø§ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙÙŠ DBØŒ Ø§Ø¹Ø±Ø¶Ù‡
        const userRef = doc(db, "users", telegramId);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const ud = userSnap.data();
          if (ud?.wallet_address) setConnectedWallet(ud.wallet_address);
        }
      } catch (err) {
        console.error(err);
        loadingEl.style.display = "none";
        errorEl.style.display = "flex";
      }
    }

    window.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible') {
        try {
          await ensureUserExists();
          await loadAffiliateStats();
        } catch (e) {
          console.error(e);
        }
      }
    });

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    init();
  </script>

</body>
</html>
