<!DOCTYPE html>
<html>
<head>
  <title>SJ COIN Tap2Earn</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const user = tg.initDataUnsafe.user;
    const userId = user?.id;

    async function rewardUser(amount) {
      const userRef = ref(db, 'users/' + userId);
      const snapshot = await get(userRef);
      const currentCoins = snapshot.exists() ? snapshot.val().coins || 0 : 0;
      await update(userRef, { coins: currentCoins + amount });
      document.getElementById("coins").textContent = currentCoins + amount;
    }

    // Telegram Stars Payment
    async function handleBuy() {
      // Open Telegram Invoice
      tg.openInvoice({
        slug: "sjstars-10sj", // â† ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø£Ù†Ø´Ø£Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ @BotFather
        success: () => {
          alert("âœ… Payment successful! You received 10 SJ COIN.");
          rewardUser(10);
        },
        error: (err) => {
          alert("âŒ Payment failed: " + err);
        }
      });
    }

    window.onload = async () => {
      if (!userId) {
        document.getElementById("coins").textContent = "Login via Telegram required";
        return;
      }
      const userRef = ref(db, 'users/' + userId);
      const snapshot = await get(userRef);
      if (!snapshot.exists()) {
        await set(userRef, { coins: 0 });
        document.getElementById("coins").textContent = 0;
      } else {
        document.getElementById("coins").textContent = snapshot.val().coins || 0;
      }
    };

    window.handleBuy = handleBuy;
  </script>

  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
      text-align: center;
    }
    .button {
      padding: 10px 20px;
      font-size: 20px;
      margin-top: 20px;
      background-color: #0088cc;
      color: white;
      border: none;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>ðŸª™ SJ COIN Tap2Earn</h1>
  <p>Current Balance: <span id="coins">Loading...</span> SJ</p>
  <button class="button" onclick="handleBuy()">Buy 10 SJ COIN (via Telegram Stars)</button>
</body>
</html>
