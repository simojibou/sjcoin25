<!DOCTYPE html>
<html>
<head>
  <title>SJ COIN Tap2Earn</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Initialize Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.ready(); // Ensure Telegram Web App is initialized
    tg.expand(); // Expand the Web App to full screen

    const user = tg.initDataUnsafe?.user;
    const userId = user?.id;
    let isPaymentInProgress = false; // Flag to prevent multiple payments

    // Function to update user's coin balance
    async function rewardUser(amount) {
      try {
        const userRef = ref(db, `users/${userId}`);
        const snapshot = await get(userRef);
        const currentCoins = snapshot.exists() ? snapshot.val().coins || 0 : 0;
        const newBalance = currentCoins + amount;
        await update(userRef, { coins: newBalance });
        document.getElementById("coins").textContent = newBalance;
      } catch (error) {
        console.error("Error updating coins:", error);
        alert("‚ùå Failed to update coins. Please try again.");
      }
    }

    // Handle purchase (for both SJ COIN and Telegram Stars)
    async function handlePurchase(productType, amount, description) {
      if (!tg.MainButton) {
        alert("‚ùå Telegram Web App MainButton not supported.");
        return;
      }

      if (isPaymentInProgress) {
        alert("‚è≥ Payment already in progress. Please wait.");
        return;
      }

      isPaymentInProgress = true;
      tg.MainButton.setText(`Pay for ${description}`);
      tg.MainButton.show();
      tg.MainButton.showProgress(true); // Show loading state

      try {
        const invoiceLink = await createInvoice(productType, amount, description);
        tg.openInvoice(invoiceLink, {
          success: async () => {
            if (productType === "sjcoin") {
              await rewardUser(amount);
              alert(`‚úÖ Payment successful! You received ${amount} SJ COIN.`);
            } else {
              alert(`‚úÖ Payment successful! You purchased ${amount} Telegram Stars.`);
            }
            tg.MainButton.hide();
          },
          error: (error) => {
            console.error("Payment error:", error);
            alert(`‚ùå Payment failed: ${error.message || "Unknown error"}`);
          },
          finally: () => {
            tg.MainButton.showProgress(false);
            tg.MainButton.hide();
            isPaymentInProgress = false;
          }
        });
      } catch (error) {
        console.error("Invoice creation error:", error);
        alert("‚ùå Failed to initiate payment. Please try again.");
        tg.MainButton.showProgress(false);
        tg.MainButton.hide();
        isPaymentInProgress = false;
      }
    }

    // Simulate invoice creation (replace with actual BotFather invoice creation)
    async function createInvoice(productType, amount, description) {
      // Placeholder: Use Telegram Bot API to generate invoice link
      // 1. Create products in @BotFather with Telegram Stars payment
      // 2. Use createInvoiceLink API (e.g., https://api.telegram.org/bot<token>/createInvoiceLink)
      // Example payload: { title: description, description: ..., payload: unique_id, provider_token: "", currency: "XTR", prices: [{ label: description, amount: <stars_amount> }] }
      if (productType === "sjcoin") {
        return "https://t.me/$yourBotName?start=invoice_sjstars_10sj"; // Replace with actual invoice link
      } else if (productType === "stars") {
        return "https://t.me/$yourBotName?start=invoice_stars_100"; // Replace with actual invoice link
      }
      throw new Error("Invalid product type");
    }

    // Initialize user data on page load
    window.onload = async () => {
      if (!userId) {
        document.getElementById("coins").textContent = "Login via Telegram required";
        return;
      }

      try {
        const userRef = ref(db, `users/${userId}`);
        const snapshot = await get(userRef);
        if (!snapshot.exists()) {
          await set(userRef, { coins: 0, username: user.username || "Anonymous" });
          document.getElementById("coins").textContent = 0;
        } else {
          document.getElementById("coins").textContent = snapshot.val().coins || 0;
        }
      } catch (error) {
        console.error("Error loading user data:", error);
        document.getElementById("coins").textContent = "Error loading balance";
      }
    };

    // Expose purchase functions to global scope
    window.handleBuySJCoin = () => handlePurchase("sjcoin", 10, "10 SJ COIN");
    window.handleBuyStars = () => handlePurchase("stars", 100, "100 Telegram Stars");
  </script>

  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
      text-align: center;
    }
    .button {
      padding: 10px 20px;
      font-size: 20px;
      margin: 10px;
      background-color: #0088cc;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .button:hover {
      background-color: #006699;
    }
    .button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>ü™ô SJ COIN Tap2Earn</h1>
  <p>Current Balance: <span id="coins">Loading...</span> SJ</p>
  <button class="button" onclick="handleBuySJCoin()">Buy 10 SJ COIN</button>
  <button class="button" onclick="handleBuyStars()">Buy 100 Telegram Stars</button>
</body>
</html>
