<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SJ COIN - Friends</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      setDoc,
      updateDoc,
      increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-lite.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Telegram User info
    const telegramUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    const telegramId = telegramUser?.id?.toString() || "demo_user";
    const firstName = telegramUser?.first_name || "Demo";
    const lastName = telegramUser?.last_name || "User";
    const isPremium = telegramUser?.is_premium || false;

    const botUrl = "https://t.me/sjcoin25bot";
    const referralLink = `${botUrl}?startapp=ref${telegramId}`;

    // DOM Elements
    let bonusesContainer, levelBonusesTable, friendsList, friendCount, levelBonusesDiv, loadingDiv, errorMessageDiv;

    let referralConfig = {
      base: { welcome: 1000, levelUp: {} },
      premium: { welcome: 2500, levelUp: {} }
    };
    let levels = [];

    function showLoading(show = true) {
      if (loadingDiv) loadingDiv.style.display = show ? "flex" : "none";
    }

    function getReferralCode() {
      const urlParams = new URLSearchParams(window.location.search);
      const startApp = urlParams.get("startapp") || urlParams.get("start");

      if (startApp && startApp.startsWith("ref")) {
        return startApp.replace("ref", "");
      }

      return urlParams.get("ref") || null;
    }

    async function ensureUserExists() {
      try {
        const userRef = doc(db, "users", telegramId);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          const referralCode = getReferralCode();
          const validReferral = referralCode && referralCode !== telegramId;

          const newUser = {
            id: telegramId,
            first_name: firstName,
            last_name: lastName,
            username: telegramUser?.username || "",
            referred_by: validReferral ? referralCode : null,
            balance: 0,
            premium: isPremium,
            level: { name: "Bronze", level: 1 },
            referral_count: 0,
            total_earned: 0,
            created_at: new Date().toISOString(),
            last_active: new Date().toISOString(),
            referral_bonus_received: false
          };

          await setDoc(userRef, newUser);
          console.log("User created successfully");

          if (validReferral) {
            await handleReferralBonus(referralCode);
          }
        } else {
          // Update last active date
          await updateDoc(userRef, { last_active: new Date().toISOString() });
        }
      } catch (error) {
        console.error("Error ensuring user exists:", error);
      }
    }

    async function handleReferralBonus(referrerId) {
      try {
        const userRef = doc(db, "users", telegramId);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();

        if (userData.referral_bonus_received) {
          console.log("Referral bonus already granted.");
          return;
        }

        const referrerRef = doc(db, "users", referrerId);
        const referrerSnap = await getDoc(referrerRef);

        if (!referrerSnap.exists()) {
          console.log("Referrer not found:", referrerId);
          return;
        }

        const welcomeBonus = isPremium 
          ? (referralConfig.premium?.welcome || 2500)
          : (referralConfig.base?.welcome || 1000);

        // Update referrer
        await updateDoc(referrerRef, {
          balance: increment(welcomeBonus),
          referral_count: increment(1),
          total_earned: increment(welcomeBonus)
        });

        // Update user + mark bonus received
        await updateDoc(userRef, {
          balance: increment(welcomeBonus),
          total_earned: increment(welcomeBonus),
          referral_bonus_received: true
        });

        console.log(`Referral bonus applied: ${welcomeBonus} coins each`);

        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.showAlert(`üéâ Welcome bonus! You and your friend each received ${welcomeBonus.toLocaleString()} coins!`);
        }

        // Refresh friends and bonuses display
        await loadFriends();
        await displayBonuses();

      } catch (error) {
        console.error("Error handling referral bonus:", error);
      }
    }

    async function loadReferralConfig() {
      try {
        const refSnap = await getDoc(doc(db, "config", "referral"));
        if (refSnap.exists()) {
          referralConfig = { ...referralConfig, ...refSnap.data() };
        }
        console.log("Referral config loaded:", referralConfig);
      } catch (error) {
        console.error("Error loading referral config:", error);
      }
    }

    async function loadLevels() {
      try {
        const levelSnap = await getDocs(collection(db, "levels"));
        levels = levelSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        if (levels.length === 0) {
          levels = [
            { level: 1, name: "Bronze", min_balance: 0 },
            { level: 2, name: "Silver", min_balance: 5000 },
            { level: 3, name: "Gold", min_balance: 25000 },
            { level: 4, name: "Platinum", min_balance: 100000 },
            { level: 5, name: "Diamond", min_balance: 1000000 }
          ];
        }

        levels.sort((a, b) => a.level - b.level);
        console.log("Levels loaded:", levels);
      } catch (error) {
        console.error("Error loading levels:", error);
        levels = [{ level: 1, name: "Bronze", min_balance: 0 }];
      }
    }

    async function loadFriends() {
      try {
        const q = query(collection(db, "users"), where("referred_by", "==", telegramId));
        const snap = await getDocs(q);
        const friends = snap.docs.map(doc => doc.data());

        friendCount.textContent = `List of your friends (${friends.length})`;

        if (friends.length === 0) {
          friendsList.innerHTML = `
            <div class="text-center text-white/60 border-2 border-dashed border-white/20 px-6 py-8 rounded-xl">
              <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-16 h-16 rounded-full mx-auto mb-4 opacity-50" />
              <p class="text-lg font-medium mb-2">No friends yet</p>
              <p class="text-sm text-white/40">Invite friends to earn bonuses together!</p>
            </div>
          `;
          return;
        }

        friends.sort((a, b) => (b.balance || 0) - (a.balance || 0));

        friendsList.innerHTML = "";
        friends.forEach(user => {
          const joinDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : "Unknown";
          const isPremiumUser = user.premium;

          friendsList.innerHTML += `
            <div class="flex items-center justify-between px-4 py-3 bg-white/10 rounded-xl border border-white/5 hover:bg-white/15 transition-all">
              <div class="flex items-center gap-3">
                <div class="relative">
                  <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-10 h-10 rounded-full border-2 border-white/20" />
                  ${isPremiumUser ? '<div class="absolute -top-1 -right-1 w-4 h-4 bg-yellow-400 rounded-full flex items-center justify-center"><span class="text-xs">‚≠ê</span></div>' : ''}
                </div>
                <div>
                  <p class="text-sm font-medium">${user.first_name || ""} ${user.last_name || ""}</p>
                  <p class="text-xs text-white/60">${user.level?.name || "Bronze"} ‚Ä¢ Joined ${joinDate}</p>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-5 h-5" />
                <span class="text-sm font-bold text-yellow-400">${(user.balance || 0).toLocaleString()}</span>
              </div>
            </div>
          `;
        });
      } catch (error) {
        console.error("Error loading friends:", error);
        friendsList.innerHTML = `
          <div class="text-center text-red-400 px-4 py-4 rounded-xl">
            Error loading friends. Please try again.
          </div>
        `;
      }
    }

    async function displayBonuses() {
      const baseWelcome = referralConfig.base?.welcome || 1000;
      const premiumWelcome = referralConfig.premium?.welcome || 2500;

      bonusesContainer.innerHTML = `
        <div class="space-y-3">
          <div class="flex items-center w-full gap-4 px-4 py-3 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-xl border border-white/10">
            <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-12 h-12 rounded-full" />
            <div class="text-sm font-medium flex-1">
              <p class="font-bold text-blue-300">Invite a friend</p>
              <div class="flex items-center space-x-1 mt-1">
                <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-5 h-5" />
                <span class="font-bold text-yellow-400">+${baseWelcome.toLocaleString()}</span>
                <span class="text-xs text-white/70">for you and your friend</span>
              </div>
            </div>
          </div>

          <div class="flex items-center w-full gap-4 px-4 py-3 bg-gradient-to-r from-yellow-500/20 to-orange-500/20 rounded-xl border border-yellow-300/20">
            <div class="relative">
              <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-12 h-12 rounded-full" />
              <div class="absolute -top-1 -right-1 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center">
                <span class="text-xs">‚≠ê</span>
              </div>
            </div>
            <div class="text-sm font-medium flex-1">
              <p class="font-bold text-yellow-300">Invite a Premium friend</p>
              <div class="flex items-center space-x-1 mt-1">
                <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-5 h-5" />
                <span class="font-bold text-yellow-400">+${premiumWelcome.toLocaleString()}</span>
                <span class="text-xs text-white/70">for you and your friend</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function displayLevelBonuses() {
      levelBonusesTable.innerHTML = "";

      levels.forEach(lvl => {
        const baseBonus = referralConfig.base?.levelUp?.[lvl.level] || (lvl.level * 500);
        const premiumBonus = referralConfig.premium?.levelUp?.[lvl.level] || (lvl.level * 1000);

        levelBonusesTable.innerHTML += `
          <tr class="border-b border-white/10 hover:bg-white/5">
            <td class="px-3 py-3 font-medium">${lvl.name}</td>
            <td class="px-3 py-3 text-right">
              <div class="flex items-center justify-end gap-1">
                <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-4 h-4" />
                <span class="font-bold text-yellow-400">${baseBonus.toLocaleString()}</span>
              </div>
            </td>
            <td class="px-3 py-3 text-right">
              <div class="flex items-center justify-end gap-1">
                <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-4 h-4" />
                <span class="font-bold text-yellow-400">${premiumBonus.toLocaleString()}</span>
              </div>
            </td>
          </tr>
        `;
      });
    }

    async function copyReferralLink() {
      try {
        await navigator.clipboard.writeText(referralLink);

        const btn = document.getElementById("copyLinkBtn");
        const originalText = btn.textContent;
        btn.textContent = "‚úÖ Copied!";
        btn.classList.add("bg-green-500");

        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove("bg-green-500");
        }, 2000);

        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.showAlert("Referral link copied to clipboard!");
        }
      } catch (error) {
        console.error("Failed to copy:", error);
        if (window.Telegram?.WebApp) {
          window.Telegram.WebApp.showAlert("Failed to copy link. Please try again.");
        }
      }
    }

    function shareInvitation() {
      const shareText = `ü™ô Join me in SJ COIN and let's earn together!\n\nüí∞ Get ${referralConfig.base?.welcome?.toLocaleString() || 1000} coins bonus when you join!\nüåü Premium users get ${referralConfig.premium?.welcome?.toLocaleString() || 2500} coins!\n\n`;

      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.openTelegramLink(`https://t.me/share/url?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(referralLink)}`);
      } else {
        window.open(`https://t.me/share/url?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(referralLink)}`, "_blank");
      }
    }

    function addEventListeners() {
      document.getElementById("copyLinkBtn").addEventListener("click", copyReferralLink);
      document.getElementById("inviteBtn").addEventListener("click", shareInvitation);
      document.getElementById("toggleBonusesBtn").addEventListener("click", () => {
        levelBonusesDiv.classList.toggle("hidden");
        const btn = document.getElementById("toggleBonusesBtn");
        btn.textContent = levelBonusesDiv.classList.contains("hidden") ? "Show more bonuses" : "Hide bonuses";
      });
    }

    async function initializeApp() {
      // Query DOM elements after DOM loaded
      bonusesContainer = document.getElementById("bonuses");
      levelBonusesTable = document.getElementById("levelBonusesTable");
      friendsList = document.getElementById("friendsList");
      friendCount = document.getElementById("friendCount");
      levelBonusesDiv = document.getElementById("levelBonuses");
      loadingDiv = document.getElementById("loading");
      errorMessageDiv = document.getElementById("errorMessage");

      try {
        showLoading(true);
        addEventListeners();

        await ensureUserExists();
        await loadReferralConfig();
        await loadLevels();

        await displayBonuses();
        await displayLevelBonuses();
        await loadFriends();

        showLoading(false);
        console.log("App initialized successfully");
      } catch (error) {
        console.error("Error initializing app:", error);
        showLoading(false);
        if (errorMessageDiv) {
          errorMessageDiv.style.display = "flex";
        }
      }
    }

    // Start
    window.addEventListener("DOMContentLoaded", () => {
      // Set referral link display
      const referralDisplay = document.getElementById("referralDisplay");
      referralDisplay.textContent = referralLink;

      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }

      initializeApp();
    });
  </script>
</head>

<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen text-white">
  <!-- Loading Screen -->
  <div id="loading" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="text-center">
      <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" class="w-20 h-20 rounded-full mx-auto mb-4 animate-pulse" />
      <p class="text-lg font-medium">Loading...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div id="errorMessage" class="hidden fixed inset-0 bg-red-900/90 flex items-center justify-center z-50 px-4">
    <div class="bg-red-800 p-6 rounded-xl max-w-md text-center">
      <h2 class="text-2xl font-bold mb-4">Error loading app</h2>
      <p>Please check your internet connection and try again.</p>
    </div>
  </div>

  <main class="max-w-3xl mx-auto p-4 space-y-8">
    <section class="text-center space-y-4">
      <h1 class="text-3xl font-extrabold">üéâ SJ COIN Referral Program</h1>
      <p>Share your referral link and earn coins together!</p>

      <div class="bg-white/10 p-4 rounded-xl select-all cursor-pointer">
        <p id="referralDisplay" class="font-mono break-words"></p>
      </div>

      <div class="flex justify-center space-x-4 mt-2">
        <button id="copyLinkBtn" class="bg-blue-600 hover:bg-blue-700 px-5 py-2 rounded-lg font-semibold transition">Copy Link</button>
        <button id="inviteBtn" class="bg-green-600 hover:bg-green-700 px-5 py-2 rounded-lg font-semibold transition">Invite Friends</button>
      </div>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-3">Your Bonuses</h2>
      <div id="bonuses" class="space-y-4"></div>
      <button id="toggleBonusesBtn" class="mt-4 text-sm text-blue-400 hover:underline">Show more bonuses</button>

      <div id="levelBonuses" class="hidden mt-4 overflow-x-auto">
        <table class="w-full text-left border-collapse border border-white/20 rounded-xl overflow-hidden">
          <thead class="bg-white/10">
            <tr>
              <th class="px-3 py-3">Level</th>
              <th class="px-3 py-3 text-right">Base Bonus</th>
              <th class="px-3 py-3 text-right">Premium Bonus</th>
            </tr>
          </thead>
          <tbody id="levelBonusesTable"></tbody>
        </table>
      </div>
    </section>

    <section>
      <h2 id="friendCount" class="text-xl font-semibold mb-3">Your Friends</h2>
      <div id="friendsList" class="space-y-3"></div>
    </section>
  </main>
</body>
</html>
