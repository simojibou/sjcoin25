<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>SJ COIN - Daily Rewards</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg-color: #0d1221;
      --secondary-bg-color: #1a223a;
      --text-color: #ffffff;
      --accent-color: #ff3c7f;
      --free-color: #00ffaa;
      --border-color: #2e3a62;
    }

    body {
      background-color: var(--tg-theme-bg-color, var(--bg-color));
      color: var(--tg-theme-text-color, var(--text-color));
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 15px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
    }

    header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px 0;
    }

    #user-stats {
      display: flex;
      gap: 15px;
      font-weight: bold;
    }
    
    #user-stats span {
      background-color: var(--secondary-bg-color);
      padding: 5px 12px;
      border-radius: 20px;
    }

    main {
      text-align: center;
      flex-grow: 1;
      overflow-y: auto;
    }

    main h1 {
      margin: 10px 0 20px 0;
      font-size: 2em;
      letter-spacing: 2px;
      text-transform: uppercase;
    }

    main p {
      color: #aaa;
      margin-bottom: 20px;
      font-weight: bold;
    }

    #rewards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px,1fr));
      gap: 12px;
      max-width: 600px;
      margin: 0 auto 20px auto;
    }

    .reward-node {
      background-color: var(--secondary-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 10px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      aspect-ratio: 1 / 1.2;
      position: relative;
      user-select: none;
    }
    
    .reward-node.claimed {
      opacity: 0.5;
    }
    
    .reward-node .day-label {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 1.1em;
    }

    .reward-node .item-amount {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 6px;
      color: var(--free-color);
    }

    .reward-node button {
      background-color: var(--free-color);
      color: black;
      border: none;
      border-radius: 8px;
      padding: 8px 0;
      width: 100%;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .reward-node button:hover:not(:disabled) {
      background-color: #00e699;
    }

    .reward-node button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    
    footer {
      margin-top: auto;
      padding-top: 20px;
    }

    #back-button {
      background-color: var(--secondary-bg-color);
      color: white;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      width: 100%;
      padding: 15px;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <header>
    <div id="user-stats">
      <span id="sj-coin-balance">SJ: ...</span>
    </div>
  </header>

  <main>
    <h1>SJ COIN DAILY REWARDS</h1>
    <p>Next reset in: <span id="countdown-timer">...</span></p>
    
    <div id="rewards-grid"></div>
  </main>

  <footer>
    <button id="back-button">BACK</button>
  </footer>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
      authDomain: "metawarefare-gaming.firebaseapp.com",
      databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
      projectId: "metawarefare-gaming",
      storageBucket: "metawarefare-gaming.appspot.com",
      messagingSenderId: "551352148152",
      appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const totalDays = 30;
    let userData = {
      sjCoins: 1000,
      claimedDays: [],
      lastMonth: null
    };

    // Telegram WebApp أو mock للمتصفح
    const tg = window.Telegram?.WebApp || {
      ready: () => console.log("Telegram WebApp mock ready"),
      showAlert: (msg) => alert(msg),
      HapticFeedback: {
        notificationOccurred: (type) => console.log(`Haptic feedback: ${type}`)
      },
      close: () => console.log("Closing Mini App"),
      themeParams: {
        bg_color: '#0d1221',
        text_color: '#ffffff',
        button_color: '#ff3c7f',
        button_text_color: '#ffffff',
        secondary_bg_color: '#1a223a',
      },
      initDataUnsafe: {
        user: {
          id: null // سيُملأ عند التشغيل الحقيقي داخل Telegram
        }
      }
    };

    // معرف المستخدم من Telegram
    let userId = null;

    // جلب بيانات المستخدم من Firestore
    async function loadUserData() {
      if (!userId) {
        tg.showAlert("خطأ: لم يتم التعرف على المستخدم. الرجاء فتح التطبيق من Telegram.");
        tg.close();
        return;
      }
      try {
        const docRef = db.collection("users").doc(String(userId));
        const doc = await docRef.get();
        if (doc.exists) {
          userData = doc.data();
        } else {
          userData = {
            sjCoins: 1000,
            claimedDays: [],
            lastMonth: null,
          };
          await docRef.set(userData);
        }
      } catch (e) {
        console.error("Firestore read error:", e);
        tg.showAlert("حدث خطأ أثناء تحميل بياناتك.");
      }
    }

    // حفظ بيانات المستخدم في Firestore
    async function saveUserData() {
      try {
        await db.collection("users").doc(String(userId)).set(userData);
      } catch (e) {
        console.error("Firestore write error:", e);
        tg.showAlert("حدث خطأ أثناء حفظ بياناتك.");
      }
    }

    // تحقق من بداية شهر جديد وأعد تعيين المكافآت إن تطلب الأمر
    function checkAndResetMonth() {
      const now = new Date();
      const currentMonth = now.getMonth();
      if (userData.lastMonth === null || userData.lastMonth !== currentMonth) {
        userData.claimedDays = [];
        userData.lastMonth = currentMonth;
        saveUserData();
      }
    }

    // حساب مقدار المكافأة لليوم المحدد
    function getRewardAmount(dayIndex) {
      return 50 + (dayIndex - 1) * 10;
    }

    // رقم اليوم الحالي (محدود بـ totalDays)
    function getTodayDayNumber() {
      const day = new Date().getDate();
      return day > totalDays ? totalDays : day;
    }

    // تحديث عرض رصيد المستخدم
    function updateUserBalanceUI() {
      document.getElementById('sj-coin-balance').innerText = `SJ: ${userData.sjCoins}`;
    }

    // رسم جدول المكافآت اليومية
    function renderRewardsGrid() {
      const grid = document.getElementById('rewards-grid');
      grid.innerHTML = '';
      const today = getTodayDayNumber();

      for(let day = 1; day <= totalDays; day++) {
        const isClaimed = userData.claimedDays.includes(day);
        const rewardAmount = getRewardAmount(day);

        const nodeEl = document.createElement('div');
        nodeEl.className = 'reward-node';
        if (isClaimed) nodeEl.classList.add('claimed');

        nodeEl.innerHTML = `
          <div class="day-label">Day ${day}</div>
          <div class="item-amount">${rewardAmount} SJ</div>
          <button ${ (isClaimed || day > today) ? 'disabled' : '' } data-day="${day}">
            ${isClaimed ? 'Claimed' : (day === today ? 'Claim Now' : 'Locked')}
          </button>
        `;

        if (!isClaimed && day === today) {
          nodeEl.querySelector('button').addEventListener('click', claimReward);
        }

        grid.appendChild(nodeEl);
      }
    }

    // حدث المطالبة بالمكافأة اليومية
    async function claimReward(event) {
      const btn = event.target;
      const day = parseInt(btn.dataset.day);
      const rewardAmount = getRewardAmount(day);

      userData.sjCoins += rewardAmount;
      userData.claimedDays.push(day);

      await saveUserData();

      tg.HapticFeedback.notificationOccurred('success');
      tg.showAlert(`You claimed ${rewardAmount} SJ for day ${day}!`);

      updateUserBalanceUI();
      renderRewardsGrid();
    }

    // عداد للوقت حتى منتصف الليل (لإعادة التعيين)
    function startCountdownToMidnight() {
      const countdownEl = document.getElementById('countdown-timer');

      function updateTimer() {
        const now = new Date();
        const midnight = new Date(now);
        midnight.setHours(24,0,0,0);

        const diff = midnight - now;
        if (diff <= 0) {
          checkAndResetMonth();
          renderRewardsGrid();
          return;
        }

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        countdownEl.textContent = `${hours}h ${minutes}m ${seconds}s`;
      }

      updateTimer();
      setInterval(updateTimer, 1000);
    }

    // تطبيق الثيم من Telegram
    function applyTelegramTheme(theme) {
      document.documentElement.style.setProperty('--tg-theme-bg-color', theme.bg_color);
      document.documentElement.style.setProperty('--tg-theme-text-color', theme.text_color);
      document.documentElement.style.setProperty('--tg-theme-button-color', theme.button_color);
      document.documentElement.style.setProperty('--tg-theme-button-text-color', theme.button_text_color);
      document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', theme.secondary_bg_color);
    }

    // بداية التطبيق
    document.addEventListener('DOMContentLoaded', async () => {
      tg.ready();
      applyTelegramTheme(tg.themeParams);

      userId = tg.initDataUnsafe?.user?.id;
      if (!userId) {
        tg.showAlert("خطأ: لم يتم التعرف على المستخدم. الرجاء فتح التطبيق من Telegram.");
        tg.close();
        return;
      }

      await loadUserData();
      checkAndResetMonth();

      updateUserBalanceUI();
      renderRewardsGrid();
      startCountdownToMidnight();

      document.getElementById('back-button').addEventListener('click', () => tg.close());
    });
  </script>

</body>
</html>
