<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SJ COIN Daily Tasks</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #000; /* خلفية سوداء */
    color: #eee;
    padding: 16px;
  }
  #header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
  }
  #user-photo {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    margin-right: 12px;
  }
  #user-name {
    font-size: 18px;
    font-weight: bold;
  }
  #user-balance {
    font-size: 16px;
    color: #3fdb91; /* أخضر فاتح */
  }
  .task {
    display: flex;
    align-items: center;
    background: #111;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
  }
  .task img {
    width: 48px;
    height: 48px;
    margin-right: 10px;
    border-radius: 8px;
  }
  .task-info {
    flex: 1;
  }
  .task-info a {
    color: #66aaff;
    text-decoration: none;
    font-weight: bold;
  }
  .task-reward {
    font-size: 14px;
    color: #ccc;
  }
  button.complete-btn {
    background-color: #3399ff;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    color: white;
  }
  button.complete-btn:disabled {
    background-color: #555;
    cursor: not-allowed;
  }
  #back-btn {
    background-color: #3399ff;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 16px;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

<button id="back-btn" onclick="history.back()">⬅ Back</button>

<div id="header">
  <img id="user-photo" src="" alt="User Photo">
  <div>
    <div id="user-name">Loading...</div>
    <div>Balance: <span id="user-balance">0</span> 🪙</div>
  </div>
</div>

<div id="tasks"></div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCw46Dkka-64h7Rc3VIS9fZmvrfvbUCTjY",
    authDomain: "metawarefare-gaming.firebaseapp.com",
    databaseURL: "https://metawarefare-gaming-default-rtdb.firebaseio.com",
    projectId: "metawarefare-gaming",
    storageBucket: "metawarefare-gaming.appspot.com",
    messagingSenderId: "551352148152",
    appId: "1:551352148152:web:1b8fe7257e19fba720d44d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Get Telegram user ID
  const tg = window.Telegram.WebApp;
  tg.expand();
  const userId = tg.initDataUnsafe?.user?.id || "test_user";

  function loadUserData() {
    db.ref(`users/${userId}`).once("value").then(userSnap => {
      const user = userSnap.val();

      if (!user) {
        const newUser = {
          balance: 0,
          name: tg.initDataUnsafe.user?.first_name || "New User",
          photo: tg.initDataUnsafe.user?.photo_url || "",
          completedTasks: {}
        };
        db.ref(`users/${userId}`).set(newUser).then(() => {
          loadUserData();
        });
        return;
      }

      db.ref("DailyTasks").once("value").then(tasksSnap => {
        const tasks = tasksSnap.val();

        // نعرض الرصيد مباشرة من الفايربيس
        const totalBalance = user.balance || 0;

        document.getElementById("user-name").textContent = user.name || "No Name";
        document.getElementById("user-photo").src = user.photo || "https://via.placeholder.com/56";
        document.getElementById("user-balance").textContent = totalBalance;

        renderTasks(tasks, user.completedTasks || {});
      });
    });
  }

  function renderTasks(tasks, completedTasks) {
    const container = document.getElementById("tasks");
    container.innerHTML = "";
    for (const key in tasks) {
      const task = tasks[key];
      const done = completedTasks[key] || false;

      const taskDiv = document.createElement("div");
      taskDiv.className = "task";

      const img = document.createElement("img");
      img.src = task.image;
      taskDiv.appendChild(img);

      const infoDiv = document.createElement("div");
      infoDiv.className = "task-info";
      infoDiv.innerHTML = `<a href="${task.link}" target="_blank">${task.name}</a>
                           <div class="task-reward">${task.reward_coins} 🪙</div>`;
      taskDiv.appendChild(infoDiv);

      const btn = document.createElement("button");
      btn.className = "complete-btn";
      btn.textContent = done ? "✅ Done" : "Complete";
      btn.disabled = done;
      btn.onclick = () => completeTask(key, task.reward_coins);
      taskDiv.appendChild(btn);

      container.appendChild(taskDiv);
    }
  }

  function completeTask(taskKey, reward) {
    db.ref(`users/${userId}`).once("value").then(userSnap => {
      const user = userSnap.val();
      if (user.completedTasks && user.completedTasks[taskKey]) {
        alert("Task already completed!");
        return;
      }

      const newBalance = (user.balance || 0) + reward;
      db.ref(`users/${userId}`).update({
        balance: newBalance,
        [`completedTasks/${taskKey}`]: true
      }).then(() => {
        loadUserData();
      });
    });
  }

  loadUserData();
</script>
</body>
</html>
