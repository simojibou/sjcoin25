<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SJ STORE</title>
  <!-- Google Fonts - Roboto as Helvetica alternative -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG" type="image/png">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/logo.PNG">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Firebase v12.3.0 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";
    import { getDatabase, ref, onValue, set, push, remove, get, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
      authDomain: "sj-one.firebaseapp.com",
      databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
      projectId: "sj-one",
      storageBucket: "sj-one.appspot.com",
      messagingSenderId: "426335553508",
      appId: "1:426335553508:web:248f76772f6f78419ca9f1",
      measurementId: "G-YQTVZQWXGB"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();
    document.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("product-list");
      const sliderContainer = document.getElementById("slider-container");
      const loginBtn = document.getElementById("login-btn");
      const profilePic = document.getElementById("profile-pic");
      const dropdownMenu = document.getElementById("dropdown-menu");
      const logoutOption = document.getElementById("logout-option");
      const sellNowOption = document.getElementById("sell-now-option");
      const marketerOption = document.getElementById("marketer-option");
      const settingsOption = document.getElementById("settings-option");
      const chatBtn = document.getElementById("chat-btn");
      const adminPanel = document.getElementById("admin-panel");
      const addProductForm = document.getElementById("add-product-form");
      const addSliderForm = document.getElementById("add-slider-form");
      const sliderList = document.getElementById("slider-list");
      const searchInput = document.getElementById("search-input");
      const cartIcon = document.getElementById("cart-icon");
      const cartCount = document.getElementById("cart-count");
      const cartModal = document.getElementById("cart-modal");
      const cartList = document.getElementById("cart-list");
      const cartTotal = document.getElementById("cart-total");
      const payNowBtn = document.getElementById("pay-now-btn");
      const closeModal = document.getElementById("close-modal");
      const sellModal = document.getElementById("sell-modal");
      const sellProductForm = document.getElementById("sell-product-form");
      const closeSellModal = document.getElementById("close-sell-modal");
      const marketerModal = document.getElementById("marketer-modal");
      const affiliateList = document.getElementById("affiliate-list");
      const closeMarketerModal = document.getElementById("close-marketer-modal");
      const paymentModal = document.getElementById("payment-modal");
      const paymentForm = document.getElementById("payment-form");
      const closePaymentModal = document.getElementById("close-payment-modal");
      const categoryCards = document.querySelectorAll(".category-card");
      const titleH1 = document.querySelector("h1");
      let currentUser = null;
      let isAdmin = false;
      let products = [];
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      let currentCategory = ""; // Track selected category
      let userData = { currency: 'DH', language: 'English' };
      let exchangeRates = {
        DH: 1
      };
      const translations = {
        English: {
          title: 'SJ STORE',
          searchPlaceholder: 'Search products...',
          orderNow: 'Order Now',
          contactWhatsApp: 'ðŸ“ž Contact via WhatsApp',
          addToCart: 'Add to Cart',
          noProducts: 'No products found.',
          cartTitle: 'My Cart',
          cartEmpty: 'Your cart is empty.',
          cartTotal: 'Total',
          payNow: 'Pay Now',
          paymentTitle: 'Payment Details',
          fullName: 'Full Name',
          whatsappPhone: 'WhatsApp Phone Number',
          address: 'Delivery Address',
          paymentMethod: 'Payment Method',
          cod: 'Cash on Delivery (COD)',
          online: 'Online Payment',
          submitPayment: 'Submit Payment',
          close: 'Close',
          sellTitle: 'Sell a Product',
          productTitle: 'Product Title',
          productPrice: 'Price (DH)',
          productDes: 'WhatsApp Phone Number',
          productOrderUrl: 'Order URL (optional)',
          selectCategory: 'Select Category',
          addProduct: 'Add Product',
          adminPanel: 'Admin Control Panel',
          addProductHeader: 'Add Product',
          addSliderHeader: 'Add Slider Item',
          currentSliders: 'Current Sliders',
          delete: 'Delete',
          edit: 'Edit',
          chat: 'Chat',
          login: 'Login',
          sellNow: 'Sell Now',
          marketerDashboard: 'Marketer Dashboard',
          settings: 'Settings',
          logout: 'Logout',
          affiliateTitle: 'Affiliate Dashboard',
          generateLink: 'Generate Affiliate Link',
          copyLink: 'Copy Link',
          commissions: 'Your Commissions'
        },
        French: {
          title: 'SJ STORE',
          searchPlaceholder: 'Rechercher des produits...',
          orderNow: 'Commander maintenant',
          contactWhatsApp: 'ðŸ“ž Contacter via WhatsApp',
          addToCart: 'Ajouter au panier',
          noProducts: 'Aucun produit trouvÃ©.',
          cartTitle: 'Mon panier',
          cartEmpty: 'Votre panier est vide.',
          cartTotal: 'Total',
          payNow: 'Payer maintenant',
          paymentTitle: 'DÃ©tails du paiement',
          fullName: 'Nom complet',
          whatsappPhone: 'NumÃ©ro de tÃ©lÃ©phone WhatsApp',
          address: 'Adresse de livraison',
          paymentMethod: 'MÃ©thode de paiement',
          cod: 'Paiement Ã  la livraison (COD)',
          online: 'Paiement en ligne',
          submitPayment: 'Soumettre le paiement',
          close: 'Fermer',
          sellTitle: 'Vendre un produit',
          productTitle: 'Titre du produit',
          productPrice: 'Prix (DH)',
          productDes: 'NumÃ©ro de tÃ©lÃ©phone WhatsApp',
          productOrderUrl: 'URL de commande (optionnel)',
          selectCategory: 'SÃ©lectionner la catÃ©gorie',
          addProduct: 'Ajouter un produit',
          adminPanel: 'Panneau de contrÃ´le admin',
          addProductHeader: 'Ajouter un produit',
          addSliderHeader: 'Ajouter un Ã©lÃ©ment au slider',
          currentSliders: 'Sliders actuels',
          delete: 'Supprimer',
          edit: 'Modifier',
          chat: 'Chat',
          login: 'Connexion',
          sellNow: 'Vendre maintenant',
          marketerDashboard: 'Tableau de bord du marketeur',
          settings: 'ParamÃ¨tres',
          logout: 'DÃ©connexion',
          affiliateTitle: 'Tableau de bord affiliÃ©',
          generateLink: 'GÃ©nÃ©rer un lien affiliÃ©',
          copyLink: 'Copier le lien',
          commissions: 'Vos commissions'
        },
        Arabic: {
          title: 'SJ STORE',
          searchPlaceholder: 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...',
          orderNow: 'Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†',
          contactWhatsApp: 'ðŸ“ž Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨',
          addToCart: 'Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©',
          noProducts: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬Ø§Øª.',
          cartTitle: 'Ø³Ù„ØªÙŠ',
          cartEmpty: 'Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©.',
          cartTotal: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
          payNow: 'Ø§Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†',
          paymentTitle: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹',
          fullName: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„',
          whatsappPhone: 'Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆØ§ØªØ³Ø§Ø¨',
          address: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„',
          paymentMethod: 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹',
          cod: 'Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (COD)',
          online: 'Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª',
          submitPayment: 'ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø¯ÙØ¹',
          close: 'Ø¥ØºÙ„Ø§Ù‚',
          sellTitle: 'Ø¨ÙŠØ¹ Ù…Ù†ØªØ¬',
          productTitle: 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬',
          productPrice: 'Ø§Ù„Ø³Ø¹Ø± (Ø¯Ø±Ù‡Ù…)',
          productDes: 'Ø±Ù‚Ù… Ù‡Ø§ØªÙ ÙˆØ§ØªØ³Ø§Ø¨',
          productOrderUrl: 'Ø±Ø§Ø¨Ø· Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)',
          selectCategory: 'Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©',
          addProduct: 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬',
          adminPanel: 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù',
          addProductHeader: 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬',
          addSliderHeader: 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠØ­Ø©',
          currentSliders: 'Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠØ©',
          delete: 'Ø­Ø°Ù',
          edit: 'ØªØ¹Ø¯ÙŠÙ„',
          chat: 'Ø¯Ø±Ø¯Ø´Ø©',
          login: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
          sellNow: 'Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ù†',
          marketerDashboard: 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªØ³ÙˆÙŠÙ‚',
          settings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
          logout: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬',
          affiliateTitle: 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªØ§Ø¨Ø¹',
          generateLink: 'Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ØªØ§Ø¨Ø¹',
          copyLink: 'Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·',
          commissions: 'Ø¹Ù…ÙˆÙ„Ø§ØªÙƒ'
        }
      };
      async function fetchExchangeRates() {
        try {
          const response = await fetch('https://open.er-api.com/v6/latest/MAD');
          const data = await response.json();
          if (data.result === 'success') {
            exchangeRates = {
              DH: 1,
              USD: data.rates.USD,
              EUR: data.rates.EUR
            };
          }
        } catch (error) {
          console.error('Failed to fetch exchange rates:', error);
          // Fallback to hardcoded rates
          exchangeRates = {
            DH: 1,
            USD: 0.11,
            EUR: 0.094
          };
        }
      }
      function applyLanguage(lang) {
        const t = translations[lang] || translations.English;
        titleH1.textContent = t.title;
        searchInput.placeholder = t.searchPlaceholder;
        loginBtn.textContent = t.login;
        chatBtn.textContent = t.chat;
        sellNowOption.textContent = t.sellNow;
        marketerOption.textContent = t.marketerDashboard;
        settingsOption.textContent = t.settings;
        logoutOption.textContent = t.logout;
        document.querySelector('#sell-modal h2').textContent = t.sellTitle;
        document.getElementById("sell-product-title").placeholder = t.productTitle;
        document.getElementById("sell-product-price").placeholder = t.productPrice.replace('DH', getCurrencySymbol(userData.currency));
        document.getElementById("sell-product-des").placeholder = t.productDes;
        document.getElementById("product-title").placeholder = t.productTitle;
        document.getElementById("product-price").placeholder = t.productPrice.replace('DH', getCurrencySymbol(userData.currency));
        document.getElementById("product-des").placeholder = t.productDes;
        document.getElementById("product-order-url").placeholder = t.productOrderUrl;
        document.getElementById("sell-product-category").firstChild.textContent = t.selectCategory;
        document.getElementById("product-category").firstChild.textContent = t.selectCategory;
        document.querySelector('#admin-panel h2').textContent = t.adminPanel;
        document.querySelector('#admin-panel h3:first-of-type').textContent = t.addProductHeader;
        document.querySelector('#admin-panel h3:nth-of-type(2)').textContent = t.addSliderHeader;
        document.querySelector('#admin-panel h3:nth-of-type(3)').textContent = t.currentSliders;
        document.querySelector('#cart-modal h2').textContent = t.cartTitle;
        document.querySelector('#payment-modal h2').textContent = t.paymentTitle;
        document.querySelector('#marketer-modal h2').textContent = t.affiliateTitle;
        document.getElementById("payment-fullname-label").textContent = t.fullName;
        document.getElementById("payment-whatsapp-label").textContent = t.whatsappPhone;
        document.getElementById("payment-address-label").textContent = t.address;
        document.getElementById("payment-method-label").textContent = t.paymentMethod;
        document.getElementById("cod-option").textContent = t.cod;
        document.getElementById("online-option").textContent = t.online;
        document.getElementById("submit-payment").textContent = t.submitPayment;
        closeModal.textContent = t.close;
        closeSellModal.textContent = t.close;
        closeMarketerModal.textContent = t.close;
        closePaymentModal.textContent = t.close;
        payNowBtn.textContent = t.payNow;
        if (lang === 'Arabic') {
          document.body.dir = 'rtl';
        } else {
          document.body.dir = 'ltr';
        }
        renderProducts(searchInput.value, currentCategory);
        renderCart();
      }
      function getConvertedPrice(price, currency) {
        const rate = exchangeRates[currency] || 1;
        const numPrice = parseFloat(price) || 0;
        return (numPrice * rate).toFixed(2);
      }
      function getCurrencySymbol(currency) {
        switch (currency) {
          case 'USD': return '$';
          case 'EUR': return 'â‚¬';
          default: return 'DH';
        }
      }
      function updateCartCount() {
        cartCount.textContent = cart.length;
      }
      updateCartCount();
      onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (user) {
          loginBtn.style.display = "none";
          profilePic.src = user.photoURL || "https://via.placeholder.com/40";
          profilePic.style.display = "block";
          profilePic.title = user.displayName || "User";
          isAdmin = user.email === "simo.jibou@gmail.com";
          adminPanel.style.display = isAdmin ? "block" : "none";
          if (isAdmin) loadAdminSliders();

          const userRef = ref(db, `users/${user.uid}`);

          // Create user document if it doesn't exist (critical for iOS reliability)
          const snapshot = await get(userRef);
          if (!snapshot.exists()) {
            await set(userRef, { currency: 'DH', language: 'English' });
          }

          // Listen for ongoing user data changes
          onValue(userRef, (snapshot) => {
            userData = snapshot.val() || { currency: 'DH', language: 'English' };
            marketerOption.style.display = "block";
            sellNowOption.style.display = "block";
            applyLanguage(userData.language);
            renderProducts(searchInput.value, currentCategory);
            loadAffiliateDashboard();
          });
        } else {
          loginBtn.style.display = "inline-block";
          profilePic.style.display = "none";
          dropdownMenu.style.display = "none";
          adminPanel.style.display = "none";
          isAdmin = false;
          userData = { currency: 'DH', language: 'English' };
          applyLanguage('English');
        }
        renderProducts();
      });
      fetchExchangeRates().then(() => {
        renderProducts(searchInput.value, currentCategory);
        renderCart();
      });

      // Fixed login flow for iOS Safari reliability
      loginBtn.addEventListener("click", () => {
        // Inform iOS users (Safari opens popup as new tab)
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
          alert("A new tab will open for Google sign-in. Complete the sign-in there and return to this tab.");
        }

        signInWithPopup(auth, provider)
          .then(() => {
            // Success handled by onAuthStateChanged (UI updates automatically)
            // No alert needed â€“ avoids issues if promise resolves late
          })
          .catch((error) => {
            console.error("Popup error:", error);
            // Ignore common non-critical errors on mobile
            if (error.code !== 'auth/popup-closed-by-user' && 
                error.code !== 'auth/popup-blocked' && 
                error.code !== 'auth/cancelled-popup-request') {
              alert("Login failed: " + error.message);
            }
            // For popup-closed-by-user: do nothing â€“ onAuthStateChanged will detect success if completed
          });
      });

      profilePic.addEventListener("click", () => {
        dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
      });
      logoutOption.addEventListener("click", () => {
        signOut(auth)
          .then(() => {
            alert("Logged out successfully!");
            dropdownMenu.style.display = "none";
          })
          .catch((error) => {
            alert("Logout failed: " + error.message);
          });
      });
      // ... (rest of your event listeners remain unchanged)
      sellNowOption.addEventListener("click", () => {
        dropdownMenu.style.display = "none";
        sellModal.style.display = "block";
      });
      marketerOption.addEventListener("click", () => {
        dropdownMenu.style.display = "none";
        window.location.href = "MARKETERDASHBOARD.html";
      });
      settingsOption.addEventListener("click", () => {
        dropdownMenu.style.display = "none";
        window.location.href = "setenges.html";
      });
      chatBtn.addEventListener("click", () => {
        window.location.href = "sjchat.html";
      });
      window.addEventListener("click", (e) => {
        if (!profilePic.contains(e.target) && !dropdownMenu.contains(e.target)) {
          dropdownMenu.style.display = "none";
        }
        if (e.target === sellModal) {
          sellModal.style.display = "none";
        }
        if (e.target === marketerModal) {
          marketerModal.style.display = "none";
        }
        if (e.target === paymentModal) {
          paymentModal.style.display = "none";
        }
        if (e.target === cartModal) {
          cartModal.style.display = "none";
        }
      });
      closeSellModal.addEventListener("click", () => {
        sellModal.style.display = "none";
      });
      closeMarketerModal.addEventListener("click", () => {
        marketerModal.style.display = "none";
      });
      closePaymentModal.addEventListener("click", () => {
        paymentModal.style.display = "none";
      });
      closeModal.addEventListener("click", () => {
        cartModal.style.display = "none";
      });
      const productRef = ref(db, "Product");
      onValue(productRef, (snapshot) => {
        products = [];
        snapshot.forEach((childSnapshot) => {
          const data = childSnapshot.val();
          products.push({
            id: childSnapshot.key,
            title: data.title,
            price: data.price,
            des: data.des,
            orderUrl: data.orderUrl,
            photo: data.photo,
            userId: data.id,
            sellerName: data.sellerName,
            sellerPhoto: data.sellerPhoto,
            category: data.category || "Uncategorized" // Default if no category
          });
        });
        renderProducts(searchInput.value, currentCategory);
      }, (error) => {
        alert(`Failed to load products: ${error.message}. Please check your Realtime Database configuration and permissions.`);
      });
      // ... (rest of your functions remain unchanged: renderProducts, searchInput, categoryCards, slider logic, uploadFile, forms, cart, payment, affiliate, PWA, etc.)
      // All other code is identical to your original â€“ only the login/auth section was modified for iOS reliability.
    });
  </script>
  <!-- Your original <style> and <body> remain exactly the same -->
  <style>
    /* ... (your full stylesheet unchanged) */
  </style>
</head>
<body>
  <!-- Your original HTML body unchanged -->
</body>
</html>
