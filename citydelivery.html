<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade { animation: fade 0.3s ease-out forwards; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-black text-gray-800 dark:text-gray-100 h-screen overflow-hidden flex justify-center">

    <div id="app" class="w-full max-w-md h-full bg-white dark:bg-gray-900 shadow-xl relative flex flex-col overflow-hidden">
        <!-- Content injected by JS -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, arrayUnion, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
            authDomain: "sj-one.firebaseapp.com",
            databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
            projectId: "sj-one",
            storageBucket: "sj-one.appspot.com",
            messagingSenderId: "426335553508",
            appId: "1:426335553508:web:248f76772f6f78419ca9f1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const state = {
            user: null,
            view: 'loading',
            services: [],
            chats: {},
            selectedCity: null,
            activeService: null,
            darkMode: localStorage.getItem('darkMode') === 'true',
            msgInput: ''
        };

        if(state.darkMode) document.documentElement.classList.add('dark');

        // --- Auth & Data ---
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                subscribeServices();
                subscribeChats();
            } else {
                state.view = 'login';
                render();
            }
        });

        function subscribeServices() {
            // Fetch all services. We filter by city in the render/UI logic.
            onSnapshot(collection(db, 'delivery_services'), (snap) => {
                state.services = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (state.view === 'loading') state.view = 'cities';
                render();
            });
        }

        function subscribeChats() {
            // Fetch chats where I am the customer
            const q = query(collection(db, 'delivery_chats'), where('userId', '==', state.user.uid));
            onSnapshot(q, (snap) => {
                const map = {};
                snap.forEach(d => map[d.data().serviceId] = {id: d.id, ...d.data()});
                state.chats = map;
                if(state.view === 'chat') { render(); scrollToBottom(); }
            });
        }

        // --- Actions ---
        window.login = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.logout = () => { signOut(auth); window.location.reload(); };
        window.setCity = (c) => { state.selectedCity = c; state.view = 'services'; render(); };
        
        window.openService = (id) => {
            state.activeService = state.services.find(s => s.id === id);
            state.view = 'chat';
            render();
            scrollToBottom();
        };

        window.goBack = () => {
            if(state.view === 'chat') state.view = 'services';
            else if(state.view === 'services') state.view = 'cities';
            render();
        };

        window.toggleTheme = () => {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', state.darkMode);
            document.documentElement.classList.toggle('dark');
            render();
        };

        window.updateMsg = (v) => state.msgInput = v;
        
        window.send = async () => {
            const txt = state.msgInput.trim();
            if(!txt || !state.activeService) return;
            state.msgInput = ''; render(); 

            const chatId = `${state.user.uid}_${state.activeService.id}`;
            const existingChat = state.chats[state.activeService.id];
            
            // Critical: Ensure we have the owner email to link to the Provider Panel
            const ownerEmail = state.activeService.ownerEmail ? state.activeService.ownerEmail.toLowerCase() : '';

            const msg = {
                text: txt,
                sender: state.user.uid,
                timestamp: Date.now()
            };

            const chatRef = doc(db, 'delivery_chats', existingChat ? existingChat.id : chatId);

            try {
                if(existingChat) {
                    await updateDoc(chatRef, { 
                        messages: arrayUnion(msg), 
                        lastUpdated: serverTimestamp() 
                    });
                } else {
                    // Create new chat document
                    await setDoc(chatRef, {
                        userId: state.user.uid,
                        userEmail: state.user.email,
                        serviceId: state.activeService.id,
                        serviceName: state.activeService.name,
                        serviceOwnerEmail: ownerEmail, // This allows the provider to query this chat
                        city: state.activeService.city,
                        messages: [msg],
                        createdAt: serverTimestamp(),
                        lastUpdated: serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Error sending message:", e);
                alert("Failed to send. Please try again.");
            }
        };

        function scrollToBottom() {
            setTimeout(() => {
                const el = document.getElementById('chat-scroll');
                if(el) el.scrollTop = el.scrollHeight;
            }, 50);
        }

        // --- Render ---
        function render() {
            const app = document.getElementById('app');
            let content = '';

            // Header Component
            const header = (title, showBack) => `
                <div class="h-16 bg-white dark:bg-gray-800 flex items-center justify-between px-4 shadow-sm z-10 shrink-0 border-b dark:border-gray-700">
                    <div class="flex items-center gap-3">
                        ${showBack ? `<button onclick="goBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>` : ''}
                        <h1 class="font-bold text-lg truncate text-gray-800 dark:text-white">${title}</h1>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="${state.darkMode ? 'sun' : 'moon'}" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i></button>
                        <button onclick="logout()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>
                </div>`;

            if (state.view === 'loading') {
                content = `<div class="flex h-full items-center justify-center bg-white dark:bg-gray-900"><div class="animate-spin w-8 h-8 border-2 border-blue-600 rounded-full border-t-transparent"></div></div>`;
            } 
            else if (state.view === 'login') {
                content = `
                    <div class="flex flex-col h-full items-center justify-center p-8 text-center animate-fade bg-white dark:bg-gray-900">
                        <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mb-6 text-blue-600 dark:text-blue-400">
                            <i data-lucide="shopping-bag" class="w-10 h-10"></i>
                        </div>
                        <h1 class="text-3xl font-bold mb-2 text-gray-800 dark:text-white">City Delivery</h1>
                        <p class="text-gray-500 dark:text-gray-400 mb-8">Order from your favorite local services instantly.</p>
                        <button onclick="login()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold flex items-center justify-center gap-3 shadow-lg shadow-blue-200 dark:shadow-none transition-all active:scale-95">
                            <i data-lucide="log-in" class="w-5 h-5"></i> Continue with Google
                        </button>
                    </div>`;
            }
            else if (state.view === 'cities') {
                const cities = [...new Set(state.services.map(s => s.city))].sort();
                content = `
                    ${header('Select Location', false)}
                    <div class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-50 dark:bg-gray-900">
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 ml-1">Available Cities</h2>
                        ${cities.map(c => `
                            <button onclick="setCity('${c}')" class="w-full bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-500 mb-3 flex items-center justify-between group transition-all animate-fade text-left">
                                <div class="flex items-center gap-3">
                                    <div class="bg-blue-50 dark:bg-blue-900/30 p-2 rounded-lg text-blue-600 dark:text-blue-400"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                                    <span class="font-semibold text-lg text-gray-800 dark:text-gray-100">${c}</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 dark:text-gray-600 group-hover:text-blue-500 transition-colors"></i>
                            </button>
                        `).join('') || '<div class="text-center text-gray-400 mt-10">No cities configured.</div>'}
                    </div>`;
            }
            else if (state.view === 'services') {
                const list = state.services.filter(s => s.city === state.selectedCity);
                content = `
                    ${header(state.selectedCity, true)}
                    <div class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-50 dark:bg-gray-900">
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 ml-1">Services in ${state.selectedCity}</h2>
                        ${list.map(s => `
                            <button onclick="openService('${s.id}')" class="w-full bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-3 flex items-center gap-4 text-left transition-all active:scale-95 animate-fade hover:shadow-md">
                                <div class="w-14 h-14 rounded-full bg-gray-100 dark:bg-gray-700 overflow-hidden flex-shrink-0 border dark:border-gray-600">
                                    ${s.logo ? `<img src="${s.logo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-gray-400"><i data-lucide="store" class="w-6 h-6"></i></div>`}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-bold text-lg text-gray-800 dark:text-gray-100 truncate">${s.name}</h3>
                                    <span class="inline-block px-2 py-0.5 rounded-md bg-gray-100 dark:bg-gray-700 text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wide">${s.type}</span>
                                </div>
                                <div class="p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-full">
                                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                                </div>
                            </button>
                        `).join('') || '<div class="text-center text-gray-400 mt-10">No services found in this city.</div>'}
                    </div>`;
            }
            else if (state.view === 'chat') {
                const msgs = (state.chats[state.activeService.id]?.messages || []);
                content = `
                    ${header(state.activeService.name, true)}
                    <div id="chat-scroll" class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-50 dark:bg-gray-900">
                        ${msgs.map(m => {
                            const me = m.sender === state.user.uid;
                            return `
                                <div class="flex ${me ? 'justify-end' : 'justify-start'} mb-2 animate-fade">
                                    <div class="max-w-[75%] px-4 py-2 rounded-2xl text-sm shadow-sm ${me ? 'bg-blue-600 text-white rounded-br-sm' : 'bg-white dark:bg-gray-800 border dark:border-gray-700 text-gray-800 dark:text-gray-200 rounded-bl-sm'}">
                                        ${m.text}
                                    </div>
                                </div>`;
                        }).join('') || '<div class="flex flex-col items-center justify-center mt-20 text-gray-400"><i data-lucide="message-square-dashed" class="w-12 h-12 mb-2 opacity-30"></i><p>Start chatting to place an order!</p></div>'}
                    </div>
                    <div class="p-3 bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex gap-2 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                        <input value="${state.msgInput}" oninput="updateMsg(this.value)" onkeyup="if(event.key==='Enter') send()" type="text" placeholder="Type your order..." class="flex-1 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-full px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="send()" class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 active:scale-95 transition-transform shadow-lg shadow-blue-200 dark:shadow-none"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                    </div>`;
            }

            app.innerHTML = content;
            lucide.createIcons();
        }
    </script>
</body>
</html>


















