<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SJ Delivery App</title>
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/shared-0-sheet4.png">
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    height: { 'screen-dvh': '100dvh' },
                    padding: { 'safe': 'env(safe-area-inset-bottom)' },
                    margin: { 'safe': 'env(safe-area-inset-bottom)' },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fade 0.2s ease-out forwards',
                        'bounce-slight': 'bounceSlight 0.3s ease-in-out',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fade: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        bounceSlight: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } }
                    }
                }
            }
        }
    </script>

    <!-- 2. Load Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 3. Load Firebase Compat Libraries (Works on file://) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, textarea, select { font-size: 16px !important; }
        .ios-btn-fix { -webkit-appearance: none; appearance: none; border-radius: 0; }
        .toast-enter { transform: translateY(-20px); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease; }
        .toast-exit { opacity: 0; transform: translateY(-10px); transition: all 0.2s ease; }
        
        /* Loading Fallback */
        #error-display { display: none; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-black text-gray-900 dark:text-gray-100 h-screen-dvh w-full overflow-hidden flex justify-center">

    <!-- Error Display (Hidden by default) -->
    <div id="error-display" class="fixed inset-0 z-[999] bg-black text-white p-8 flex flex-col items-center justify-center text-center">
        <div class="text-red-500 mb-4">⚠️ Application Error</div>
        <p id="error-message" class="text-sm font-mono bg-gray-900 p-4 rounded mb-4 max-w-full break-words"></p>
        <button onclick="window.location.reload()" class="bg-white text-black px-6 py-2 rounded-full font-bold">Reload</button>
    </div>

    <!-- App Container -->
    <div id="app" class="w-full max-w-md h-full bg-white dark:bg-gray-950 shadow-2xl relative flex flex-col overflow-hidden sm:rounded-none md:rounded-xl md:h-[95dvh] md:my-auto border-x border-gray-200 dark:border-gray-800">
        <!-- Initial Loading State -->
        <div class="flex h-full items-center justify-center bg-white dark:bg-black">
            <div class="flex flex-col items-center gap-4">
                <div class="animate-spin w-10 h-10 border-4 border-blue-600 rounded-full border-t-transparent"></div>
                <p class="text-sm font-bold text-gray-400 tracking-widest animate-pulse">LOADING SJ</p>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-max max-w-[90%] pointer-events-none"></div>

    <script>
        // --- Global Error Handler ---
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('error-display').style.display = 'flex';
            document.getElementById('error-message').innerText = `${msg}\n\nLine: ${line}`;
            return false;
        };

        // --- Main Application Logic ---
        (function() {
            try {
                // --- 1. Firebase Configuration ---
                const firebaseConfig = {
                    apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
                    authDomain: "sj-one.firebaseapp.com",
                    databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
                    projectId: "sj-one",
                    storageBucket: "sj-one.appspot.com",
                    messagingSenderId: "426335553508",
                    appId: "1:426335553508:web:248f76772f6f78419ca9f1"
                };

                // Initialize Firebase (Compat Mode)
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const auth = firebase.auth();
                const db = firebase.firestore();

                // --- 2. State Management ---
                const state = {
                    user: null,
                    currentView: 'loading',
                    services: [],
                    chats: {},
                    selectedCity: null,
                    activeService: null,
                    draftOrder: [],
                    currentDraftImage: null,
                    darkMode: localStorage.getItem('darkMode') === 'true',
                    listeners: { services: null, chatsList: null, activeChat: null }
                };

                if(state.darkMode) document.documentElement.classList.add('dark');

                // --- 3. UI Helpers ---
                window.showToast = (message, type = 'info') => {
                    const container = document.getElementById('toast-container');
                    const el = document.createElement('div');
                    const colors = type === 'error' ? 'bg-red-500 text-white' : (type === 'success' ? 'bg-green-500 text-white' : 'bg-gray-800 text-white');
                    el.className = `${colors} px-4 py-3 rounded-full shadow-lg text-sm font-semibold flex items-center gap-2 toast-enter pointer-events-auto backdrop-blur-md`;
                    el.innerHTML = `<span>${message}</span>`;
                    container.appendChild(el);
                    requestAnimationFrame(() => el.classList.remove('toast-enter', 'toast-enter-active'));
                    setTimeout(() => { el.classList.add('toast-exit'); setTimeout(() => el.remove(), 200); }, 3000);
                };

                const refreshIcons = () => { if(window.lucide) window.lucide.createIcons(); };
                const formatTime = (ts) => ts ? ts.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                const escapeHtml = (text) => { const div = document.createElement('div'); div.innerText = text || ''; return div.innerHTML; };

                // --- 4. Views & Templates ---
                const Views = {
                    loading: () => `<div class="flex h-full items-center justify-center bg-white dark:bg-black"><div class="flex flex-col items-center gap-4"><div class="animate-spin w-10 h-10 border-4 border-blue-600 rounded-full border-t-transparent"></div><p class="text-sm font-bold text-gray-400 tracking-widest animate-pulse">LOADING SJ</p></div></div>`,
                    
                    login: () => `
                        <div class="flex flex-col h-full items-center justify-center p-8 text-center animate-fade bg-white dark:bg-black relative overflow-hidden">
                            <div class="w-32 h-32 mb-8 shrink-0 animate-bounce-slight relative z-10">
                                <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/shared-0-sheet4.png" class="w-full h-full object-contain drop-shadow-2xl">
                            </div>
                            <h1 class="text-4xl font-black mb-3 text-gray-900 dark:text-white">SJ Delivery</h1>
                            <p class="text-gray-500 dark:text-gray-400 mb-12 max-w-xs text-lg">Your city's best services, delivered to your door instantly.</p>
                            <button onclick="Actions.loginGoogle()" class="w-full max-w-xs py-4 bg-gray-900 dark:bg-white text-white dark:text-black hover:scale-[1.02] transition-transform rounded-2xl font-bold flex items-center justify-center gap-3 shadow-xl">
                                <i data-lucide="mail" class="w-5 h-5"></i> Continue with Google
                            </button>
                        </div>`,

                    header: (title, showBack) => {
                        const user = state.user;
                        const avatar = user ? (user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName)}&background=random`) : '';
                        const left = (!showBack && user) ? `
                            <div class="flex items-center gap-3 overflow-hidden">
                                <img src="${avatar}" class="w-10 h-10 rounded-full border-2 border-white dark:border-gray-800 shadow-sm object-cover">
                                <div class="min-w-0"><div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Welcome</div><div class="font-bold text-sm truncate dark:text-white">${escapeHtml(user.displayName.split(' ')[0])}</div></div>
                            </div>` : `
                            <div class="flex items-center gap-3 min-w-0">
                                ${showBack ? `<button onclick="Actions.goBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800"><i data-lucide="arrow-left" class="w-6 h-6 dark:text-white"></i></button>` : ''}
                                <h1 class="font-bold text-xl truncate dark:text-white">${escapeHtml(title)}</h1>
                            </div>`;
                        return `<div class="h-16 bg-white/80 dark:bg-black/80 backdrop-blur-md flex items-center justify-between px-4 z-20 shrink-0 border-b border-gray-100 dark:border-gray-800 sticky top-0 w-full">${left}<div class="flex gap-1 shrink-0"><button onclick="Actions.toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800"><i id="theme-icon" data-lucide="${state.darkMode ? 'sun' : 'moon'}" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i></button>${!showBack ? `<button onclick="Actions.logout()" class="p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>` : ''}</div></div>`;
                    },

                    cities: () => {
                        const cities = [...new Set(state.services.map(s => s.city).filter(c => c))].sort();
                        return `${Views.header('Select Location', false)}<div class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-50 dark:bg-black/50"><h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 ml-1">Cities</h2>${cities.length ? cities.map(c => `<button onclick="Actions.setCity('${c}')" class="group w-full bg-white dark:bg-gray-900 p-5 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 mb-3 flex items-center justify-between animate-fade text-left active:scale-[0.98]"><div class="flex items-center gap-4"><div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl text-blue-600 dark:text-blue-400"><i data-lucide="map-pin" class="w-6 h-6"></i></div><span class="font-bold text-lg dark:text-gray-100">${c}</span></div><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></button>`).join('') : '<div class="text-center py-10 text-gray-400">Loading services...</div>'}</div>`;
                    },

                    services: () => {
                        const list = state.services.filter(s => s.city === state.selectedCity);
                        return `${Views.header(state.selectedCity, true)}<div class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-50 dark:bg-black/50"><h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 ml-1">Services</h2>${list.map(s => `<button onclick="Actions.openService('${s.id}')" class="group w-full bg-white dark:bg-gray-900 p-4 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 mb-3 flex items-center gap-4 text-left active:scale-[0.98] animate-fade"><div class="w-16 h-16 rounded-xl bg-gray-100 dark:bg-gray-800 overflow-hidden shrink-0 border border-gray-100 dark:border-gray-700 relative">${s.logo ? `<img src="${s.logo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-gray-400"><i data-lucide="store" class="w-6 h-6"></i></div>`}${state.chats[s.id] ? '<span class="absolute top-1 right-1 w-3 h-3 rounded-full bg-green-500 border-2 border-white dark:border-gray-900"></span>' : ''}</div><div class="flex-1 min-w-0"><h3 class="font-bold text-lg dark:text-gray-100 truncate mb-1">${escapeHtml(s.name)}</h3><span class="px-2 py-0.5 rounded-md bg-gray-100 dark:bg-gray-800 text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold">${escapeHtml(s.type)}</span></div><div class="p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-full"><i data-lucide="message-circle" class="w-5 h-5"></i></div></button>`).join('')}</div>`;
                    },

                    chatLayout: () => `
                        ${Views.header(state.activeService.name, true)}
                        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-50 dark:bg-black/50 scroll-smooth pb-4"></div>
                        <form onsubmit="Actions.triggerSend(event)" class="p-3 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 flex items-center gap-2 shrink-0 pb-safe relative z-20">
                            <button type="button" onclick="Actions.sendLocation()" id="loc-btn" class="w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 rounded-full shrink-0 hover:bg-gray-200 dark:hover:bg-gray-700 active:scale-95"><i data-lucide="map-pin" class="w-5 h-5"></i></button>
                            <button type="button" onclick="Actions.toggleOrderModal(true)" class="w-11 h-11 flex items-center justify-center bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 rounded-full shrink-0 hover:bg-gray-200 dark:hover:bg-gray-700 active:scale-95"><i data-lucide="clipboard-list" class="w-5 h-5"></i></button>
                            <div class="flex-1 relative"><input id="chat-input" type="text" autocomplete="off" placeholder="Message..." class="w-full bg-gray-100 dark:bg-gray-800 dark:text-white rounded-full pl-5 pr-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500/50 ios-btn-fix"></div>
                            <button type="submit" class="w-12 h-12 flex items-center justify-center bg-blue-600 text-white rounded-full hover:bg-blue-700 active:scale-90 transition-all shrink-0"><i data-lucide="send" class="w-5 h-5 ml-0.5"></i></button>
                        </form>
                        <div id="order-modal-overlay" class="hidden absolute inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end animate-fade"><div class="w-full bg-white dark:bg-gray-950 rounded-t-3xl shadow-2xl h-[90%] flex flex-col animate-slide-up ring-1 ring-white/10 overflow-hidden"><div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center shrink-0 bg-white dark:bg-gray-950"><div><h2 class="font-bold text-xl dark:text-white">New Order</h2><p class="text-xs text-gray-500 mt-0.5" id="item-counter">0/50 Items</p></div><button onclick="Actions.toggleOrderModal(false)" class="p-2 bg-gray-100 dark:bg-gray-800 rounded-full text-gray-600 dark:text-gray-300"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="order-items-list" class="flex-1 overflow-y-auto p-4 space-y-2 hide-scrollbar bg-gray-50 dark:bg-black/50"></div><div class="p-4 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 shrink-0 space-y-3 pb-safe"><div class="flex gap-2"><input id="new-item-name" type="text" placeholder="Item name..." class="flex-1 bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white ios-btn-fix"><input id="new-item-qty" type="number" value="1" min="1" class="w-20 bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl px-2 py-3.5 text-center dark:text-white ios-btn-fix font-bold"></div><div class="flex gap-2"><label id="cam-btn" class="w-14 h-12 flex items-center justify-center bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 shrink-0"><i id="cam-icon" data-lucide="camera" class="w-6 h-6 text-gray-400"></i><input type="file" id="new-item-img-file" accept="image/*" class="hidden" onchange="Actions.handleImageSelect(this)"></label><button onclick="Actions.addDraftItem()" class="flex-1 bg-gray-900 dark:bg-white dark:text-black text-white font-bold rounded-xl flex items-center justify-center hover:opacity-90 active:scale-[0.98] h-12"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add Item</button></div><button onclick="Actions.submitOrder()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg active:scale-[0.98] transition-all flex items-center justify-center gap-2 mt-2"><span>Send Order Request</span><i data-lucide="arrow-right" class="w-5 h-5"></i></button></div></div></div>`
                };

                // --- 5. Controller (Router & Logic) ---
                function setView(viewName) {
                    state.currentView = viewName;
                    const appEl = document.getElementById('app');
                    if (state.listeners.activeChat && viewName !== 'chat') { state.listeners.activeChat(); state.listeners.activeChat = null; }
                    switch(viewName) {
                        case 'loading': appEl.innerHTML = Views.loading(); break;
                        case 'login': appEl.innerHTML = Views.login(); break;
                        case 'cities': appEl.innerHTML = Views.cities(); break;
                        case 'services': appEl.innerHTML = Views.services(); break;
                        case 'chat': appEl.innerHTML = Views.chatLayout(); mountChatLogic(); break;
                    }
                    refreshIcons();
                }

                // Auth Listener
                auth.onAuthStateChanged((user) => {
                    state.user = user;
                    if (user) {
                        if(!state.listeners.services) subscribeServices();
                        if(!state.listeners.chatsList) subscribeChatsList();
                        if(state.currentView === 'loading' || state.currentView === 'login') setView('cities');
                    } else {
                        unsubscribeAll();
                        setView('login');
                    }
                });

                function subscribeServices() {
                    state.listeners.services = db.collection('delivery_services').onSnapshot((snap) => {
                        state.services = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        if (state.currentView === 'cities' || state.currentView === 'services') setView(state.currentView);
                    }, err => window.showToast("Sync Error", "error"));
                }

                function subscribeChatsList() {
                    if (!state.user) return;
                    state.listeners.chatsList = db.collection('delivery_chats').where('userId', '==', state.user.uid).onSnapshot((snap) => {
                        const map = {};
                        snap.forEach(d => map[d.data().serviceId] = {id: d.id, ...d.data()});
                        state.chats = map;
                        if(state.currentView === 'services') setView('services');
                    });
                }

                function unsubscribeAll() {
                    if(state.listeners.services) state.listeners.services();
                    if(state.listeners.chatsList) state.listeners.chatsList();
                    if(state.listeners.activeChat) state.listeners.activeChat();
                    state.listeners = { services: null, chatsList: null, activeChat: null };
                    state.services = []; state.chats = {};
                }

                // Chat Logic
                function mountChatLogic() {
                    if (!state.user || !state.activeService) return;
                    const chatId = `${state.user.uid}_${state.activeService.id}`;
                    const container = document.getElementById('chat-messages');
                    const q = db.collection('delivery_chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc');

                    state.listeners.activeChat = q.onSnapshot((snapshot) => {
                        let shouldScroll = false;
                        if(snapshot.empty) container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60 animate-fade"><i data-lucide="message-square-dashed" class="w-12 h-12 mb-2"></i><p>Start ordering...</p></div>`;
                        else if(container.querySelector('.opacity-60')) container.innerHTML = '';

                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added") {
                                shouldScroll = true;
                                container.appendChild(createMessageElement(change.doc.data()));
                            }
                        });
                        if(shouldScroll) { refreshIcons(); scrollToBottom(); }
                    });
                }

                function createMessageElement(msg) {
                    const isMe = msg.sender === state.user.uid;
                    const time = formatTime(msg.timestamp);
                    const div = document.createElement('div');
                    div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-4 animate-fade-in group`;
                    
                    let content = '';
                    if(msg.type === 'bill') {
                         content = `<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl p-4 w-64 shadow-sm"><div class="flex items-center gap-2 mb-2 text-purple-600 dark:text-purple-400 font-bold text-xs uppercase border-b pb-2 dark:border-gray-700">Receipt</div><div class="flex justify-between items-end"><span class="text-sm dark:text-gray-400">Total</span><span class="text-2xl font-black dark:text-white">$${(msg.total || 0).toFixed(2)}</span></div></div>`;
                    } else if (msg.type === 'order') {
                        content = `<div class="bg-white dark:bg-gray-800 border ${isMe ? 'border-blue-100 dark:border-blue-900' : 'border-gray-200 dark:border-gray-700'} rounded-2xl overflow-hidden w-64 shadow-sm"><div class="${isMe ? 'bg-blue-600' : 'bg-gray-700'} px-4 py-2 text-white text-xs font-bold flex justify-between"><span>ORDER</span><span>${msg.items.length} Items</span></div><div class="max-h-48 overflow-y-auto divide-y divide-gray-100 dark:divide-gray-700">${msg.items.map(i => `<div class="flex gap-2 p-2 hover:bg-gray-50 dark:hover:bg-gray-700/50"><div class="w-8 h-8 bg-gray-100 rounded bg-cover" style="background-image:url('${i.image||''}');"></div><div class="min-w-0"><div class="truncate text-xs font-bold dark:text-white">${escapeHtml(i.name)}</div><div class="text-[10px]">x${i.qty}</div></div></div>`).join('')}</div></div>`;
                    } else if (msg.type === 'location') {
                        content = `<a href="https://maps.google.com/?q=${msg.location.lat},${msg.location.lng}" target="_blank" class="block bg-white dark:bg-gray-800 border rounded-2xl p-2 w-56 hover:opacity-90"><div class="h-24 bg-gray-100 dark:bg-gray-700 rounded-xl flex items-center justify-center mb-2"><i data-lucide="map-pin" class="text-red-500 w-8 h-8"></i></div><div class="text-xs font-bold text-center dark:text-white">Open Map</div></a>`;
                    } else {
                        content = `<div class="px-4 py-2.5 rounded-2xl text-[15px] shadow-sm max-w-[85%] break-words ${isMe ? 'bg-blue-600 text-white rounded-br-sm' : 'bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 text-gray-800 dark:text-gray-200 rounded-bl-sm'}">${escapeHtml(msg.text)}</div>`;
                    }
                    div.innerHTML = `<div class="flex flex-col ${isMe?'items-end':'items-start'}">${content}<span class="text-[10px] text-gray-400 mt-1 mx-1 opacity-0 group-hover:opacity-100 transition-opacity">${time}</span></div>`;
                    return div;
                }

                function scrollToBottom() { 
                    const el = document.getElementById('chat-messages'); 
                    if(el) requestAnimationFrame(() => el.scrollTop = el.scrollHeight); 
                }

                // --- 6. Exposed Actions ---
                window.Actions = {
                    loginGoogle: async () => { try { await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); } catch(e){ window.showToast("Login Failed", "error"); } },
                    logout: () => { if(confirm("Log out?")) auth.signOut(); },
                    setCity: (c) => { state.selectedCity = c; setView('services'); },
                    openService: (id) => { state.activeService = state.services.find(s=>s.id===id); if(state.activeService) setView('chat'); },
                    goBack: () => { if(state.currentView==='chat') setView('services'); else if(state.currentView==='services') setView('cities'); },
                    toggleTheme: () => { state.darkMode = !state.darkMode; localStorage.setItem('darkMode', state.darkMode); document.documentElement.classList.toggle('dark'); refreshIcons(); },
                    
                    // Order
                    toggleOrderModal: (show) => {
                        const el = document.getElementById('order-modal-overlay');
                        if(show) { state.draftOrder=[]; state.currentDraftImage=null; Actions.renderDraftList(); document.getElementById('cam-icon').classList.replace('text-green-500','text-gray-400'); el.classList.remove('hidden'); }
                        else el.classList.add('hidden');
                    },
                    handleImageSelect: (input) => {
                        if(input.files[0]) {
                            const icon=document.getElementById('cam-icon'); icon.classList.add('animate-spin');
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                const img = new Image(); img.src=e.target.result;
                                img.onload = () => {
                                    const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d');
                                    const scale = 300/img.width; cvs.width=300; cvs.height=img.height*scale;
                                    ctx.drawImage(img,0,0,cvs.width,cvs.height);
                                    state.currentDraftImage = cvs.toDataURL('image/jpeg',0.7);
                                    icon.classList.remove('animate-spin','text-gray-400'); icon.classList.add('text-green-500'); refreshIcons();
                                }
                            };
                            reader.readAsDataURL(input.files[0]);
                        }
                    },
                    addDraftItem: () => {
                        const name=document.getElementById('new-item-name').value.trim();
                        const qty=document.getElementById('new-item-qty').value;
                        if(!name) return;
                        state.draftOrder.push({id:Date.now(), name, qty, image:state.currentDraftImage});
                        document.getElementById('new-item-name').value=''; state.currentDraftImage=null;
                        document.getElementById('cam-icon').classList.replace('text-green-500','text-gray-400');
                        Actions.renderDraftList();
                    },
                    removeDraftItem: (id) => { state.draftOrder=state.draftOrder.filter(i=>i.id!==id); Actions.renderDraftList(); },
                    renderDraftList: () => {
                        const el = document.getElementById('order-items-list');
                        document.getElementById('item-counter').innerText = `${state.draftOrder.length}/50 Items`;
                        el.innerHTML = state.draftOrder.map(i => `<div class="flex justify-between items-center bg-white dark:bg-gray-800 p-2 rounded-lg mb-2 shadow-sm"><div class="flex items-center gap-2"><div class="w-10 h-10 bg-gray-100 rounded bg-cover border dark:border-gray-700" style="background-image:url('${i.image||''}');"></div><div><div class="font-bold text-sm dark:text-white">${escapeHtml(i.name)}</div><div class="text-xs">Qty: ${i.qty}</div></div></div><button onclick="Actions.removeDraftItem(${i.id})" class="text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join('');
                        refreshIcons(); el.scrollTop=el.scrollHeight;
                    },
                    submitOrder: () => {
                        if(!state.draftOrder.length) return window.showToast("Empty Order", "error");
                        Actions.triggerSend(null, 'order', {items:state.draftOrder});
                        Actions.toggleOrderModal(false);
                    },
                    
                    // Send
                    triggerSend: (e, type='text', data={}) => {
                        if(e) e.preventDefault();
                        const input=document.getElementById('chat-input');
                        const txt = type==='text' ? input.value.trim() : (type==='order'?'Order Request':'Location');
                        if(!txt && type==='text') return;
                        if(input) input.value='';
                        
                        const chatId = `${state.user.uid}_${state.activeService.id}`;
                        const batch = db.batch();
                        const msgRef = db.collection('delivery_chats').doc(chatId).collection('messages').doc();
                        batch.set(msgRef, { type, text:txt, sender:state.user.uid, timestamp:firebase.firestore.FieldValue.serverTimestamp(), ...data });
                        
                        const chatRef = db.collection('delivery_chats').doc(chatId);
                        batch.set(chatRef, { userId:state.user.uid, serviceId:state.activeService.id, serviceName:state.activeService.name, city:state.activeService.city, lastMessage:txt, lastUpdated:firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
                        
                        batch.commit();
                    },
                    sendLocation: () => {
                         if(!navigator.geolocation) return window.showToast("No Geo","error");
                         navigator.geolocation.getCurrentPosition(pos => Actions.triggerSend(null, 'location', {location:{lat:pos.coords.latitude, lng:pos.coords.longitude}}));
                    }
                };

            } catch (err) {
                console.error("Critical Init Error:", err);
                document.getElementById('error-display').style.display = 'flex';
                document.getElementById('error-message').innerText = err.message;
            }
        })();
    </script>
</body>
</html>








