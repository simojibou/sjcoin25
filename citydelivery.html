<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>City Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    height: { 'screen-dvh': '100dvh' }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        /* Mobile Scroll Optimization */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade { animation: fade 0.3s ease-out forwards; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Prevent iOS input zoom */
        input, textarea { font-size: 16px !important; } 
    </style>
</head>
<body class="bg-gray-100 dark:bg-black text-gray-800 dark:text-gray-100 h-screen-dvh overflow-hidden flex justify-center">

    <div id="app" class="w-full max-w-md h-full bg-white dark:bg-gray-900 shadow-xl relative flex flex-col overflow-hidden">
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, addDoc, serverTimestamp, query, where, orderBy, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
            authDomain: "sj-one.firebaseapp.com",
            databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
            projectId: "sj-one",
            storageBucket: "sj-one.appspot.com",
            messagingSenderId: "426335553508",
            appId: "1:426335553508:web:248f76772f6f78419ca9f1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State Management ---
        const state = {
            user: null,
            currentView: 'loading', // Added explicitly to track view state
            services: [],
            chats: {}, // Map of serviceId -> chatData
            selectedCity: null,
            activeService: null,
            darkMode: localStorage.getItem('darkMode') === 'true',
            listeners: {
                services: null,
                chatsList: null,
                activeChat: null
            }
        };

        if(state.darkMode) document.documentElement.classList.add('dark');

        // --- Main Router ---
        function setView(viewName) {
            state.currentView = viewName; // Update state tracker
            const appEl = document.getElementById('app');
            
            // Clean up chat listener if leaving chat view
            if (state.listeners.activeChat && viewName !== 'chat') {
                state.listeners.activeChat();
                state.listeners.activeChat = null;
            }

            // Render specific view
            switch(viewName) {
                case 'loading': appEl.innerHTML = renderLoading(); break;
                case 'login': appEl.innerHTML = renderLogin(); break;
                case 'cities': appEl.innerHTML = renderCities(); break;
                case 'services': appEl.innerHTML = renderServices(); break;
                case 'chat': 
                    appEl.innerHTML = renderChatLayout(); 
                    mountChatLogic(); 
                    break;
            }
            lucide.createIcons();
        }

        // --- Auth & Global Subscriptions ---
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                if(!state.listeners.services) subscribeServices();
                if(!state.listeners.chatsList) subscribeChatsList();
                setView('cities');
            } else {
                unsubscribeAll();
                setView('login');
            }
        });

        function subscribeServices() {
            state.listeners.services = onSnapshot(collection(db, 'delivery_services'), (snap) => {
                state.services = snap.docs.map(d => ({id: d.id, ...d.data()}));
                
                // FIXED: Check state.currentView instead of relying on DOM/Header text
                if (state.currentView === 'cities') {
                    setView('cities');
                } else if (state.currentView === 'services') {
                    setView('services');
                }
            });
        }

        function subscribeChatsList() {
            // Listen for changes to the chat METADATA only
            const q = query(collection(db, 'delivery_chats'), where('userId', '==', state.user.uid));
            state.listeners.chatsList = onSnapshot(q, (snap) => {
                const map = {};
                snap.forEach(d => map[d.data().serviceId] = {id: d.id, ...d.data()});
                state.chats = map;
                
                // Refresh services view if open (to show notification dots)
                if (state.currentView === 'services') {
                    setView('services');
                }
            });
        }

        function unsubscribeAll() {
            if(state.listeners.services) state.listeners.services();
            if(state.listeners.chatsList) state.listeners.chatsList();
            if(state.listeners.activeChat) state.listeners.activeChat();
            state.listeners = { services: null, chatsList: null, activeChat: null };
            state.services = [];
            state.chats = {};
        }

        // --- Chat Architecture (Subcollections) ---
        function mountChatLogic() {
            const chatId = getChatId(state.user.uid, state.activeService.id);
            const container = document.getElementById('chat-messages');
            
            // Subcollection Listener
            const msgsRef = collection(db, 'delivery_chats', chatId, 'messages');
            const q = query(msgsRef, orderBy('timestamp', 'asc'));

            state.listeners.activeChat = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const msg = change.doc.data();
                        const isMe = msg.sender === state.user.uid;
                        const div = document.createElement('div');
                        
                        // Handle Bill Messages
                        if(msg.type === 'bill') {
                             div.className = `flex justify-start mb-4 animate-fade`;
                             const isPromo = msg.deliveryFee === 0;
                             const feeDisplay = isPromo ? 'FREE' : `$${msg.deliveryFee.toFixed(2)}`;
                             const displayTotal = msg.total || msg.amount;

                             div.innerHTML = `
                                <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl p-4 shadow-md w-64">
                                    <div class="flex items-center gap-2 mb-3 text-purple-600 dark:text-purple-400 font-bold text-xs uppercase tracking-wider border-b border-gray-100 dark:border-gray-700 pb-2">
                                        <i data-lucide="receipt" class="w-4 h-4"></i> Payment Request
                                    </div>
                                    
                                    ${isPromo ? `
                                    <div class="mb-3 flex items-center gap-1.5 text-[10px] font-bold text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 p-1.5 rounded-lg border border-emerald-100 dark:border-emerald-800/50">
                                            <i data-lucide="ticket" class="w-3 h-3"></i> SJ CODE APPLIED
                                    </div>
                                    ` : ''}

                                    <div class="space-y-1 mb-3">
                                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                            <span>Subtotal</span>
                                            <span>$${msg.amount.toFixed(2)}</span>
                                        </div>
                                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                            <span>Delivery</span>
                                            <span class="${isPromo ? 'text-emerald-500 font-bold' : ''}">${feeDisplay}</span>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-end border-t border-gray-100 dark:border-gray-700 pt-2">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Total</span>
                                        <span class="text-xl font-bold text-gray-900 dark:text-white">$${displayTotal.toFixed(2)}</span>
                                    </div>
                                    ${msg.description ? `<div class="text-[10px] text-gray-400 mt-2 italic">${msg.description}</div>` : ''}
                                </div>
                             `;
                        } else {
                            // Standard Text Messages
                            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-2 animate-fade`;
                            div.innerHTML = `
                                <div class="max-w-[75%] px-4 py-2 rounded-2xl text-sm shadow-sm ${
                                    isMe 
                                    ? 'bg-blue-600 text-white rounded-br-sm' 
                                    : 'bg-white dark:bg-gray-800 border dark:border-gray-700 text-gray-800 dark:text-gray-200 rounded-bl-sm'
                                }">
                                    ${escapeHtml(msg.text)}
                                </div>
                            `;
                        }
                        container.appendChild(div);
                    }
                });
                
                // Scroll to bottom on updates
                scrollToBottom();
            });
        }

        async function sendMessage(textOverride = null) {
            const input = document.getElementById('chat-input');
            const txt = textOverride || input.value.trim();
            
            if(!txt || !state.activeService) return;

            if(!textOverride) {
                input.value = ''; // Instant UI feedback only if typed
                input.focus();
            }

            const chatId = getChatId(state.user.uid, state.activeService.id);
            const chatDocRef = doc(db, 'delivery_chats', chatId);
            const messagesColRef = collection(db, 'delivery_chats', chatId, 'messages');

            try {
                // FIXED: We check our local state to see if the chat exists. 
                // Calling getDoc() on a non-existent document will fail due to Firestore Security Rules.
                const existingChat = state.chats[state.activeService.id];
                const batch = writeBatch(db);

                // 1. Prepare Message
                const newMsgRef = doc(messagesColRef);
                batch.set(newMsgRef, {
                    type: 'text',
                    text: txt,
                    sender: state.user.uid,
                    timestamp: serverTimestamp()
                });

                // 2. Create or Update Chat Metadata
                const ownerEmail = state.activeService.ownerEmail || '';

                if (!existingChat) {
                      batch.set(chatDocRef, {
                        userId: state.user.uid,
                        userEmail: state.user.email || 'anon',
                        serviceId: state.activeService.id,
                        serviceName: state.activeService.name,
                        serviceOwnerEmail: ownerEmail,
                        city: state.activeService.city,
                        createdAt: serverTimestamp(),
                        lastMessage: txt,
                        lastUpdated: serverTimestamp()
                    });
                } else {
                    batch.update(chatDocRef, {
                        lastMessage: txt,
                        lastUpdated: serverTimestamp(),
                        serviceOwnerEmail: ownerEmail
                    });
                }

                await batch.commit();
            } catch (e) {
                console.error("Send error:", e);
                alert("Failed to send message: " + e.message);
            }
        }

        // --- Helpers ---
        function getChatId(uid, serviceId) {
            return `${uid}_${serviceId}`;
        }

        function scrollToBottom() {
            const el = document.getElementById('chat-messages');
            if(el) {
                setTimeout(() => {
                    el.scrollTop = el.scrollHeight;
                }, 100);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.innerText = text;
            return div.innerHTML;
        }

        // --- UI Interactions ---

        window.loginGoogle = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); }
            catch(e) { console.error(e); }
        };

        window.logout = () => signOut(auth);
        
        window.setCity = (c) => { 
            state.selectedCity = c; 
            setView('services'); 
        };

        window.openService = (id) => {
            state.activeService = state.services.find(s => s.id === id);
            setView('chat');
        };

        window.goBack = () => {
            if(document.getElementById('chat-messages')) setView('services');
            else if(document.getElementById('service-list')) setView('cities');
        };

        window.toggleTheme = () => {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', state.darkMode);
            document.documentElement.classList.toggle('dark');
            // Re-render current view to update icons, keeping input state if in chat is unnecessary as theme toggle usually redraws
            const icon = document.getElementById('theme-icon');
            if(icon) {
                 icon.setAttribute('data-lucide', state.darkMode ? 'sun' : 'moon');
                 lucide.createIcons();
            }
        };

        window.triggerSend = () => sendMessage();
        window.sendPromo = () => sendMessage("SJ CODE");
        
        // Handle "Enter" key in chat
        window.handleChatKey = (e) => {
            if(e.key === 'Enter') sendMessage();
        };

        // --- Render Functions (Strings) ---

        const header = (title, showBack) => {
            const user = state.user;
            // Generate user profile HTML if on root screen (no back button) and user exists
            const showProfile = !showBack && user;
            
            // --- UPDATED SECTION: Clickable Profile ---
            const leftSection = showProfile ? `
                <a href="https://simojibou.github.io/sjcoin25/duserprofile.html" class="flex items-center gap-3 overflow-hidden hover:opacity-75 transition-opacity">
                    ${user.photoURL 
                        ? `<img src="${user.photoURL}" alt="Profile" class="w-9 h-9 rounded-full border border-gray-200 dark:border-gray-700 object-cover shrink-0">` 
                        : `<div class="w-9 h-9 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 shrink-0"><i data-lucide="user" class="w-5 h-5"></i></div>`
                    }
                    <div class="flex flex-col min-w-0">
                        <span class="text-[10px] uppercase font-bold text-gray-400 leading-tight">Welcome</span>
                        <span class="font-bold text-sm truncate text-gray-800 dark:text-white leading-tight">${(user.displayName || 'User').split(' ')[0]}</span>
                    </div>
                </a>
            ` : `
                <div class="flex items-center gap-3 min-w-0">
                    ${showBack ? `<button onclick="goBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>` : ''}
                    <h1 class="font-bold text-lg truncate text-gray-800 dark:text-white">${title}</h1>
                </div>
            `;

            return `
            <div class="h-16 bg-white dark:bg-gray-800 flex items-center justify-between px-4 shadow-sm z-10 shrink-0 border-b dark:border-gray-700">
                ${leftSection}
                <div class="flex gap-2 shrink-0">
                    <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i id="theme-icon" data-lucide="${state.darkMode ? 'sun' : 'moon'}" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i></button>
                    <button onclick="logout()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </div>`;
        };

        function renderLoading() {
            return `<div class="flex h-full items-center justify-center bg-white dark:bg-gray-900"><div class="animate-spin w-8 h-8 border-2 border-blue-600 rounded-full border-t-transparent"></div></div>`;
        }

        function renderLogin() {
            return `
                <div class="flex flex-col h-full items-center justify-center p-8 text-center animate-fade bg-white dark:bg-gray-900 overflow-y-auto">
                    <div class="w-24 h-24 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mb-8 text-blue-600 dark:text-blue-400 shrink-0 ring-4 ring-blue-50 dark:ring-blue-900/10">
                        <i data-lucide="shopping-bag" class="w-12 h-12"></i>
                    </div>
                    <h1 class="text-3xl font-bold mb-3 text-gray-800 dark:text-white tracking-tight">City Delivery</h1>
                    <p class="text-gray-500 dark:text-gray-400 mb-12 max-w-xs leading-relaxed">Your favorite local services, delivered instantly to your door.</p>

                    <button onclick="loginGoogle()" class="w-full max-w-xs py-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-2xl font-bold flex items-center justify-center gap-3 transition-all shadow-sm hover:shadow-md dark:text-white group relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-500/0 via-blue-500/5 to-blue-500/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                        <i data-lucide="mail" class="w-5 h-5 text-red-500"></i> 
                        <span>Continue with Google</span>
                    </button>
                    
                    <p class="mt-8 text-xs text-gray-400">By continuing, you agree to our Terms of Service.</p>
                </div>`;
        }

        function renderCities() {
            const cities = [...new Set(state.services.map(s => s.city).filter(c => c))].sort();
            return `
                ${header('Select Location', false)}
                <div id="city-list" class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-5 dark:bg-gray-900">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 ml-1">Available Cities</h2>
                    ${cities.map(c => `
                        <button onclick="setCity('${c}')" class="w-full bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-500 mb-3 flex items-center justify-between group transition-all animate-fade text-left active:scale-[0.98]">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-50 dark:bg-blue-900/30 p-2 rounded-lg text-blue-600 dark:text-blue-400"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                                <span class="font-semibold text-lg text-gray-800 dark:text-gray-100">${c}</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 dark:text-gray-600 group-hover:text-blue-500 transition-colors"></i>
                        </button>
                    `).join('') || '<div class="text-center text-gray-400 mt-10">No cities configured.</div>'}
                </div>`;
        }

        function renderServices() {
            const list = state.services.filter(s => s.city === state.selectedCity);
            return `
                ${header(state.selectedCity, true)}
                <div id="service-list" class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-5 dark:bg-gray-900">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 ml-1">Services in ${state.selectedCity}</h2>
                    ${list.map(s => {
                        // Check if we have an active chat for this service to show indicator
                        const hasChat = state.chats[s.id];
                        return `
                        <button onclick="openService('${s.id}')" class="w-full bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-3 flex items-center gap-4 text-left transition-all active:scale-[0.98] animate-fade hover:shadow-md">
                            <div class="w-14 h-14 rounded-full bg-gray-100 dark:bg-gray-700 overflow-hidden flex-shrink-0 border dark:border-gray-600">
                                ${s.logo ? `<img src="${s.logo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-gray-400"><i data-lucide="store" class="w-6 h-6"></i></div>`}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-lg text-gray-800 dark:text-gray-100 truncate">${s.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="inline-block px-2 py-0.5 rounded-md bg-gray-100 dark:bg-gray-700 text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wide">${s.type}</span>
                                    ${hasChat ? '<span class="w-2 h-2 rounded-full bg-green-500"></span>' : ''}
                                </div>
                            </div>
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-full">
                                <i data-lucide="message-circle" class="w-5 h-5"></i>
                            </div>
                        </button>
                    `}).join('') || '<div class="text-center text-gray-400 mt-10">No services found in this city.</div>'}
                </div>`;
        }

        // Only renders the layout. Messages are mounted via mountChatLogic
        function renderChatLayout() {
            return `
                ${header(state.activeService.name, true)}
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-5 dark:bg-gray-900 scroll-smooth">
                    <div class="flex flex-col items-center justify-center mt-10 text-gray-400 opacity-50 pointer-events-none">
                        <i data-lucide="message-square-dashed" class="w-10 h-10 mb-2"></i>
                        <p class="text-xs">Connecting to ${state.activeService.name}...</p>
                    </div>
                </div>
                <div class="p-3 bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex gap-2 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] pb-safe">
                    <button onclick="sendPromo()" class="p-3 bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400 rounded-full hover:bg-emerald-200 dark:hover:bg-emerald-800/40 transition-colors" title="Use SJ CODE">
                        <i data-lucide="ticket" class="w-5 h-5"></i>
                    </button>
                    <input id="chat-input" type="text" onkeyup="handleChatKey(event)" placeholder="Type your order..." autocomplete="off" class="flex-1 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-full px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                    <button onclick="triggerSend()" class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 active:scale-95 transition-transform shadow-lg shadow-blue-200 dark:shadow-none"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                </div>`;
        }
    </script>
</body>
</html>
