<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .animate-enter { animation: enter 0.3s ease-out forwards; }
        @keyframes enter { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 flex justify-center h-screen overflow-hidden">

    <div id="app" class="w-full max-w-md h-full bg-gray-50 flex flex-col shadow-2xl relative overflow-hidden">
        <div class="flex items-center justify-center h-full">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, arrayUnion, setDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
            authDomain: "sj-one.firebaseapp.com",
            databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
            projectId: "sj-one",
            storageBucket: "sj-one.appspot.com",
            messagingSenderId: "426335553508",
            appId: "1:426335553508:web:248f76772f6f78419ca9f1",
            measurementId: "G-YQTVZQWXGB"
        };

        const ADMIN_EMAIL = 'simo.jibou@gmail.com';
        // Internal App ID for data separation within Firestore
        const APP_ID = 'delivery-app-v1'; 

        // --- Init Firebase ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            document.getElementById('app').innerHTML = `<div class="p-4 text-red-500 text-center">Error initializing app. Check console.<br>${error.message}</div>`;
        }

        // --- State ---
        const state = {
            user: null,
            view: 'loading',
            selectedCity: '',
            services: [],
            activeService: null,
            chats: {},
            isAdmin: false,
            inputText: '' 
        };

        const appContainer = document.getElementById('app');
        let unsubscribeServices = null;
        let unsubscribeChats = null;

        // --- Auth Listener ---
        onAuthStateChanged(auth, (user) => {
            const previousUser = state.user?.uid;
            state.user = user;
            
            if (user) {
                console.log("User logged in:", user.email || "Anonymous");
                state.isAdmin = user.email === ADMIN_EMAIL;
                
                // If we were loading or logged out, go to main view
                if (!previousUser) {
                    state.view = 'cities'; 
                }
                subscribeToData();
            } else {
                console.log("User logged out");
                cleanupListeners();
                state.view = 'login';
                state.services = [];
                state.chats = {};
                state.isAdmin = false;
            }
            render();
        }, (error) => {
            console.error("Auth state change error:", error);
            state.view = 'login'; // Fallback
            render();
        });

        // --- Data Subscription ---
        function cleanupListeners() {
            if (unsubscribeServices) { 
                unsubscribeServices(); 
                unsubscribeServices = null; 
            }
            if (unsubscribeChats) { 
                unsubscribeChats(); 
                unsubscribeChats = null; 
            }
        }

        function subscribeToData() {
            if (!state.user || !db) return;
            
            // Prevent duplicate listeners
            if (unsubscribeServices || unsubscribeChats) return;

            console.log("Subscribing to Firestore data...");

            // Services Listener
            try {
                const servicesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'services');
                unsubscribeServices = onSnapshot(servicesRef, (snapshot) => {
                    state.services = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                }, (error) => {
                    console.error("Services listener error:", error);
                });
            } catch (e) {
                console.error("Error setting up services listener:", e);
            }

            // Chats Listener
            try {
                const chatsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats');
                unsubscribeChats = onSnapshot(chatsRef, (snapshot) => {
                    const chatData = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        // Security/Privacy filtering on client side
                        if (data.userId === state.user.uid || (state.isAdmin && data.participants?.includes(state.user.email))) {
                            chatData[data.serviceId] = { id: doc.id, ...data };
                        }
                    });
                    state.chats = chatData;
                    
                    if (state.view === 'chat') {
                        render(); 
                        scrollToBottom();
                    }
                }, (error) => {
                    console.error("Chats listener error:", error);
                });
            } catch (e) {
                console.error("Error setting up chats listener:", e);
            }
        }

        // --- Actions ---
        window.handleLogin = async () => {
            try { 
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider); 
            } 
            catch (e) { 
                console.warn("Google Sign-In failed or closed:", e);
                // Optional: Enable Anonymous fallback if you have it enabled in Firebase Console
                // await signInAnonymously(auth); 
            }
        };

        window.handleLogout = async () => {
            cleanupListeners();
            try {
                await signOut(auth);
            } catch (e) {
                console.error("Sign out error:", e);
            }
        };

        window.setView = (view) => {
            state.view = view;
            render();
        };

        window.selectCity = (city) => {
            state.selectedCity = city;
            state.view = 'services';
            render();
        };

        window.selectService = (serviceId) => {
            state.activeService = state.services.find(s => s.id === serviceId);
            state.view = 'chat';
            render();
            scrollToBottom();
        };

        window.updateInput = (val) => {
            state.inputText = val;
        };

        window.sendMessage = async () => {
            const text = state.inputText.trim();
            if (!text || !state.activeService) return;

            state.inputText = ''; // Clear local state immediately
            render(); // Re-render to clear input visually

            const chatId = `${state.user.uid}_${state.activeService.id}`;
            const message = {
                text: text,
                sender: state.user.uid,
                senderEmail: state.user.email || 'Anonymous',
                timestamp: Date.now(),
                type: 'text'
            };

            const existingChat = state.chats[state.activeService.id];

            try {
                if (existingChat) {
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', existingChat.id), {
                        messages: arrayUnion(message),
                        lastUpdated: serverTimestamp()
                    });
                } else {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', chatId), {
                        userId: state.user.uid,
                        userEmail: state.user.email,
                        serviceId: state.activeService.id,
                        serviceName: state.activeService.name,
                        city: state.activeService.city,
                        participants: [state.user.email, ADMIN_EMAIL],
                        messages: [message],
                        createdAt: serverTimestamp(),
                        lastUpdated: serverTimestamp()
                    });
                }
            } catch (e) {
                console.error("Send failed", e);
                alert("Could not send message. Check permissions.");
            }
        };

        window.addService = async (e) => {
            e.preventDefault();
            const name = document.getElementById('svcName').value;
            const city = document.getElementById('svcCity').value;
            const type = document.getElementById('svcType').value;

            if (!name || !city) return;

            try {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'services'), {
                    name, city, type,
                    createdAt: serverTimestamp(),
                    createdBy: state.user.email
                });
                alert('Service added!');
                state.view = 'cities'; // Go back to list
                render();
            } catch (error) {
                console.error("Error adding service:", error);
                alert("Failed to add service. Are you logged in as Admin?");
            }
        };

        function scrollToBottom() {
            setTimeout(() => {
                const c = document.getElementById('messagesContainer');
                if (c) c.scrollTop = c.scrollHeight;
            }, 50);
        }

        // --- Render ---
        function render() {
            // Initial spinner logic handled by HTML structure, state updates replace it
            
            let content = '';

            // 1. LOADING
            if (state.view === 'loading') {
                content = `
                    <div class="flex items-center justify-center h-full">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                    </div>`;
            }
            // 2. LOGIN
            else if (state.view === 'login') {
                content = `
                    <div class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-6 animate-enter">
                        <div class="bg-white p-8 rounded-2xl shadow-xl w-full text-center">
                            <div class="bg-blue-100 p-4 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                                <i data-lucide="truck" class="w-10 h-10 text-blue-600"></i>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-800 mb-2">City Delivery</h1>
                            <p class="text-gray-500 mb-8">Fast, reliable delivery in your city.</p>
                            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="user" class="w-5 h-5"></i> Sign in to Order
                            </button>
                        </div>
                    </div>`;
            } else {
                // 3. MAIN APP SHELL
                // Header
                let backBtn = state.view !== 'cities' ? 
                    `<button onclick="setView('${state.view === 'chat' ? 'services' : 'cities'}')" class="p-1 hover:bg-gray-100 rounded-full mr-2"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i></button>` : '';
                
                let title = 'Select City';
                if (state.view === 'services') title = state.selectedCity;
                if (state.view === 'chat') title = state.activeService?.name;
                if (state.view === 'admin') title = 'Admin Dashboard';

                let adminBtn = (state.view === 'cities' && state.isAdmin) ? 
                    `<button onclick="setView('admin')" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded font-medium mr-2">Admin</button>` : '';
                
                let header = `
                    <div class="bg-white px-4 py-3 shadow-sm z-10 flex items-center justify-between">
                        <div class="flex items-center">
                            ${backBtn}
                            <h1 class="font-bold text-lg text-gray-800 truncate max-w-[200px]">${title}</h1>
                        </div>
                        <div class="flex items-center">
                            ${adminBtn}
                            <button onclick="handleLogout()" class="text-gray-400 hover:text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                        </div>
                    </div>`;

                // Body Content
                let body = '';

                if (state.view === 'cities') {
                    const uniqueCities = [...new Set(state.services.map(s => s.city))].sort();
                    const list = uniqueCities.map(city => `
                        <button onclick="selectCity('${city}')" class="w-full text-left bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:border-blue-300 transition flex items-center justify-between group mb-3 animate-enter">
                            <span class="font-medium text-gray-700 text-lg">${city}</span>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300"></i>
                        </button>`).join('') || `<div class="text-center py-10 text-gray-400">No cities added yet.</div>`;
                    
                    body = `<div class="p-4">${list}</div>`;
                }
                else if (state.view === 'services') {
                    const svcs = state.services.filter(s => s.city === state.selectedCity);
                    const list = svcs.map(s => {
                        let icon = 'truck', color = 'text-blue-500';
                        if(s.type === 'food') { icon = 'utensils'; color = 'text-orange-500'; }
                        if(s.type === 'grocery') { icon = 'shopping-bag'; color = 'text-green-500'; }
                        return `
                        <div onclick="selectService('${s.id}')" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition cursor-pointer flex items-center gap-4 mb-3 animate-enter">
                            <div class="bg-gray-50 p-3 rounded-full"><i data-lucide="${icon}" class="w-6 h-6 ${color}"></i></div>
                            <div class="flex-1"><h3 class="font-bold text-gray-800">${s.name}</h3><p class="text-xs text-gray-500">Tap to order</p></div>
                        </div>`;
                    }).join('') || `<div class="text-center py-10 text-gray-400">No services in ${state.selectedCity}.</div>`;
                    
                    body = `<div class="p-4">${list}</div>`;
                }
                else if (state.view === 'admin') {
                    body = `
                    <div class="p-4 animate-enter">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-purple-100">
                            <h2 class="font-bold text-lg mb-4 text-purple-800 flex items-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i> New Service</h2>
                            <form onsubmit="addService(event)" class="space-y-4">
                                <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Name</label>
                                <input id="svcName" type="text" placeholder="e.g. Pizza Hut" class="w-full p-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500" required></div>
                                <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-1">City</label>
                                <input id="svcCity" type="text" placeholder="e.g. New York" class="w-full p-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500" required></div>
                                <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Type</label>
                                <select id="svcType" class="w-full p-3 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="generic">Generic</option><option value="food">Food</option><option value="grocery">Grocery</option>
                                </select></div>
                                <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition">Add</button>
                            </form>
                        </div>
                    </div>`;
                }
                else if (state.view === 'chat') {
                    const msgs = (state.activeService && state.chats[state.activeService.id]) ? state.chats[state.activeService.id].messages : [];
                    const msgList = msgs.map(m => {
                        const isMe = m.sender === state.user.uid;
                        return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'} mb-3">
                            <div class="max-w-[80%] p-3 rounded-2xl text-sm ${isMe ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-200 rounded-bl-none'}">${m.text}</div>
                        </div>`;
                    }).join('') || `<div class="text-center p-4 text-gray-400 text-sm">Start your order...</div>`;

                    body = `
                    <div class="flex flex-col h-full bg-gray-100">
                        <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            <div class="text-center text-xs text-gray-400 my-4">Ordering from ${state.activeService.name}</div>
                            ${msgList}
                        </div>
                        <div class="p-3 bg-white border-t border-gray-100 flex items-center gap-2">
                            <input id="chatInput" type="text" value="${state.inputText}" 
                                oninput="updateInput(this.value)" 
                                onkeydown="if(event.key==='Enter') sendMessage()"
                                placeholder="Type order..." 
                                class="flex-1 bg-gray-100 p-3 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            <button onclick="sendMessage()" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition shadow-md">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>`;
                }

                content = header + `<div class="flex-1 overflow-y-auto custom-scrollbar bg-gray-50 relative h-full">` + body + `</div>`;
            }

            // Simple Virtual DOM replacement
            appContainer.innerHTML = content;
            lucide.createIcons();
            
            // Restore focus if in chat
            if (state.view === 'chat') {
                const input = document.getElementById('chatInput');
                if(input) {
                    input.focus();
                    // Move cursor to end
                    const val = input.value;
                    input.value = '';
                    input.value = val;
                }
            }
        }
    </script>
</body>
</html>







