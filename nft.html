<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SJ NFT Marketplace Full</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<!-- Ethers.js -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.1/dist/ethers.min.js"></script>

<!-- Seaport SDK -->
<script type="module">
  import { Seaport } from "https://cdn.jsdelivr.net/npm/@opensea/seaport-js@1.3.0/dist/seaport.js";
  window.Seaport = Seaport;
</script>

<style>
body { font-family: Arial; background: #f0f0f0; padding: 20px; }
#nft-container { display: flex; flex-wrap: wrap; gap: 20px; }
.nft-card { background: #fff; border-radius: 10px; padding: 10px; width: 220px; text-align: center; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
.nft-card img { width: 100%; border-radius: 10px; }
button { padding: 5px 10px; margin-top: 5px; cursor: pointer; }
</style>
</head>

<body>
<h1>SJ NFT Marketplace Full</h1>
<div id="user-auth">
  <button onclick="login()">تسجيل الدخول بمحفظة جوجل</button>
  <button onclick="logout()">تسجيل الخروج</button>
  <div id="user-info"></div>
</div>

<h2>NFTs من OpenSea</h2>
<div id="nft-container"></div>

<script type="module">
// === Firebase Setup ===
const firebaseConfig = {
  apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
  authDomain: "sj-one.firebaseapp.com",
  databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
  projectId: "sj-one",
  storageBucket: "sj-one.appspot.com",
  messagingSenderId: "426335553508",
  appId: "1:426335553508:web:248f76772f6f78419ca9f1",
  measurementId: "G-YQTVZQWXGB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// === Login / Logout ===
function login() {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result => {
    document.getElementById('user-info').innerHTML = `مرحبًا ${result.user.displayName}`;
  });
}

function logout() {
  auth.signOut();
  document.getElementById('user-info').innerHTML = '';
}

// === Fetch NFTs from OpenSea ===
const apiKey = "edbeeb4f8e164fe09dba4058b03ed458";

async function fetchNFTs() {
  const res = await fetch(`https://api.opensea.io/api/v1/assets?order_direction=desc&limit=10&include_orders=true`, {
    headers: { "X-API-KEY": apiKey }
  });
  const data = await res.json();
  displayNFTs(data.assets);
}

function displayNFTs(nfts) {
  const container = document.getElementById('nft-container');
  container.innerHTML = '';
  nfts.forEach(nft => {
    const card = document.createElement('div');
    card.className = 'nft-card';
    card.innerHTML = `
      <img src="${nft.image_url || 'https://via.placeholder.com/200'}" alt="${nft.name}">
      <h3>${nft.name || 'بدون اسم'}</h3>
      <p>Collection: ${nft.collection.name}</p>
      <p>Price: ${nft.last_sale ? nft.last_sale.total_price/1e18 + ' ETH' : 'غير متوفر'}</p>
      <button onclick="buyNFT('${nft.token_id}', '${nft.asset_contract.address}', '${nft.name}', ${nft.last_sale ? nft.last_sale.total_price/1e18 : 0})">شراء + عمولة 5%</button>
    `;
    container.appendChild(card);
  });
}

// === Buy NFT using Seaport ===
async function buyNFT(tokenId, contractAddress, name, price) {
  if (!window.ethereum) return alert("يرجى تثبيت MetaMask أولاً!");
  const provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  const signer = await provider.getSigner();
  const userAddress = await signer.getAddress();

  const seaport = new Seaport(signer);

  // احتساب العمولة
  const commissionRate = 0.05; // 5%
  const totalPrice = price * (1 + commissionRate);

  alert(`السعر الأصلي: ${price} ETH\nالعمولة: 5%\nالسعر النهائي: ${totalPrice} ETH`);

  // === Create a simple Seaport order (محاكاة) ===
  // ملاحظة: لشراء فعلي تحتاج عقد Seaport Marketplace ونقل NFT
  console.log(`شراء NFT: ${name} (${tokenId}) من العقد ${contractAddress} بمبلغ ${totalPrice} ETH`);

  // تسجيل العملية في Firebase
  const user = auth.currentUser;
  if (!user) return alert('يجب تسجيل الدخول أولاً');
  db.ref('sales').push({
    user: user.displayName,
    uid: user.uid,
    nft: name,
    tokenId: tokenId,
    contract: contractAddress,
    price: price,
    total: totalPrice,
    buyerAddress: userAddress,
    timestamp: Date.now()
  });
}

fetchNFTs();
</script>
</body>
</html>
