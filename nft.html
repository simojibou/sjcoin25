<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SJ NFT Marketplace</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
        #nft-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .nft-card { background: #fff; border-radius: 10px; padding: 10px; width: 200px; text-align: center; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
        .nft-card img { width: 100%; border-radius: 10px; }
        button { padding: 5px 10px; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>SJ NFT Marketplace</h1>
    <div id="user-auth">
        <button onclick="login()">تسجيل الدخول بمحفظة جوجل</button>
        <button onclick="logout()">تسجيل الخروج</button>
        <div id="user-info"></div>
    </div>
    <h2>NFTs من OpenSea</h2>
    <div id="nft-container"></div>

    <script>
        // 1. إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
            authDomain: "sj-one.firebaseapp.com",
            databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
            projectId: "sj-one",
            storageBucket: "sj-one.appspot.com",
            messagingSenderId: "426335553508",
            appId: "1:426335553508:web:248f76772f6f78419ca9f1",
            measurementId: "G-YQTVZQWXGB"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // 2. تسجيل الدخول / الخروج
        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(result => {
                const user = result.user;
                document.getElementById('user-info').innerHTML = `مرحبًا ${user.displayName}`;
            });
        }

        function logout() {
            auth.signOut();
            document.getElementById('user-info').innerHTML = '';
        }

        // 3. جلب NFTs من OpenSea
        const apiKey = "edbeeb4f8e164fe09dba4058b03ed458"; // OpenSea API Key
        async function fetchNFTs() {
            const url = `https://api.opensea.io/api/v1/assets?order_direction=desc&limit=10&include_orders=false`;
            const res = await fetch(url, {
                headers: { "X-API-KEY": apiKey }
            });
            const data = await res.json();
            displayNFTs(data.assets);
        }

        function displayNFTs(nfts) {
            const container = document.getElementById('nft-container');
            container.innerHTML = '';
            nfts.forEach(nft => {
                const card = document.createElement('div');
                card.className = 'nft-card';
                card.innerHTML = `
                    <img src="${nft.image_url || 'https://via.placeholder.com/200'}" alt="${nft.name}">
                    <h3>${nft.name || 'بدون اسم'}</h3>
                    <p>Collection: ${nft.collection.name}</p>
                    <p>Price: ${nft.last_sale ? nft.last_sale.total_price/1e18 + ' ETH' : 'غير متوفر'}</p>
                    <button onclick="buyNFT('${nft.token_id}', '${nft.asset_contract.address}', '${nft.name}')">شراء + عمولة</button>
                `;
                container.appendChild(card);
            });
        }

        // 4. محاكاة شراء NFT مع احتساب العمولة
        function buyNFT(tokenId, contractAddress, name) {
            const commission = 0.05; // 5% عمولة
            const salePrice = prompt(`أدخل سعر الشراء (ETH) لـ ${name}:`);
            if (!salePrice) return;
            const total = parseFloat(salePrice) * (1 + commission);
            alert(`تم احتساب العمولة، السعر النهائي: ${total} ETH`);

            // تسجيل العملية في Firebase
            const user = auth.currentUser;
            if (!user) return alert('يجب تسجيل الدخول أولاً');
            db.ref('sales').push({
                user: user.displayName,
                uid: user.uid,
                nft: name,
                tokenId: tokenId,
                contract: contractAddress,
                price: salePrice,
                total: total,
                timestamp: Date.now()
            });
        }

        // تحميل NFTs عند فتح الصفحة
        fetchNFTs();
    </script>
</body>
</html>
