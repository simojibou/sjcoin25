<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SJ X N41 - Profile</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS (Netflix-inspired) -->
    <style>
        :root{
            --color-red: #e50914; /* Netflix red */
            --color-white: #ffffff;
            --color-dark: #141414; /* Netflix primary dark */
            --color-dark-light: #221f1f; /* Slightly lighter dark for accents */
            --color-grey: #8c8c8c; /* For secondary text */
            --space-unit: 16px; /* Larger spacing for Netflix feel */
            --space-1: calc(var(--space-unit) * 1);
            --space-2: calc(var(--space-unit) * 2);
            --space-3: calc(var(--space-unit) * 3);
            --instagram-blue: #0095f6; /* Instagram verified blue */
        }
        body{
            background: var(--color-dark);
            color: var(--color-white);
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; /* Netflix-like font stack */
            margin: 0;
            padding-top: 56px; /* Padding for fixed navbar */
            overflow-x: hidden;
        }
        .navbar{
            background-color: var(--color-dark) !important;
        }
        .navbar-brand{
            color: var(--color-red);
            font-weight: bold;
            font-size: 1.5rem;
        }
        .navbar-brand:hover{
            color: var(--color-red);
        }
        .nav-link{
            color: var(--color-white) !important;
            font-weight: 500;
        }
        .nav-link:hover{
            color: var(--color-grey) !important;
        }
        .nav-link.active{
            color: var(--color-white) !important;
            font-weight: bold;
        }
        .profile-hero{
            position: relative;
            height: 70vh; /* Taller hero for dramatic Netflix effect */
            width: 100%;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: flex-end; /* Align content to bottom like Netflix banners */
            justify-content: flex-start;
            text-align: left;
            margin-bottom: var(--space-3);
            padding: var(--space-3) var(--space-3) var(--space-2);
        }
        .profile-hero::before{
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(20,20,20,0) 0%, rgba(20,20,20,0.2) 50%, rgba(20,20,20,1) 100%);
            z-index: 1;
        }
        .profile-hero-content{
            position: relative;
            z-index: 2;
            max-width: 60%;
        }
        .profile-hero h1{
            font-size: 4rem; /* Larger, bold titles */
            font-weight: 700;
            letter-spacing: -1px;
            color: var(--color-white);
            margin-bottom: var(--space-1);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .profile-hero .social-links{
            font-size: 1.5rem;
        }
        .section-title {
            padding-left: var(--space-3);
            margin-bottom: var(--space-1);
            font-weight: 600;
            font-size: 1.5rem;
            color: #e5e5e5;
        }
        .profile-bio{
            max-width: 90%;
            margin: 0 auto var(--space-3);
            padding: var(--space-2);
            background: var(--color-dark-light);
            border-radius: 4px;
        }
        .profile-bio h3{
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: var(--space-1);
        }
        .profile-bio p{
            font-size: 1.1rem;
            line-height: 1.6;
            color: #d3d3d3;
        }
        .user-actions{
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 3;
        }
        .user-actions button{
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: var(--color-white);
            margin-left: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .user-actions button:hover{
            background: var(--color-white);
            color: var(--color-dark);
        }
        .social-links a{
            color: var(--color-white);
            margin-right: 20px;
            font-size: 1.8rem;
            transition: color .3s;
            text-decoration: none;
        }
        .social-links a:hover{
            color: var(--color-red);
        }
        /* Scrollable Sections */
        .scroll-section {
            margin-bottom: var(--space-3);
            padding: 0 var(--space-3);
        }
        .horizontal-scroll {
            display: flex;
            overflow-x: auto;
            padding-bottom: 20px;
            gap: 15px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .horizontal-scroll::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }
        .track-card, .product-card {
            min-width: 200px;
            max-width: 200px;
            flex: 0 0 auto;
            transition: transform 0.3s ease;
        }
        .track-card:hover, .product-card:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .card {
            background-color: #181818;
            border-radius: 4px;
            overflow: hidden;
        }
        .card-img-top {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
        }
        .card-body {
            padding: 10px;
        }
        .card-title {
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }
        .verified-badge {
            color: var(--instagram-blue);
            font-size: 0.6em;
            vertical-align: super;
            margin-left: 5px;
        }
        .dropdown-menu {
            background-color: var(--color-dark-light);
            border: 1px solid #333;
        }
        .dropdown-item {
            color: var(--color-white);
        }
        .dropdown-item:hover {
            background-color: #333;
            color: var(--color-white);
        }
        /* Fix for User Info visibility in Dropdown */
        .dropdown-header {
            color: var(--color-white) !important;
        }
        .dropdown-divider {
            border-top: 1px solid #333;
        }
        
        /* Mobile tweaks */
        @media (max-width: 768px){
            .profile-hero{
                height: 60vh;
                align-items: flex-end;
                padding-bottom: 60px;
            }
            .profile-hero-content{
                max-width: 100%;
            }
            .profile-hero h1{
                font-size: 2.5rem;
            }
            .section-title {
                padding-left: var(--space-2);
                font-size: 1.2rem;
            }
            .scroll-section {
                padding: 0 var(--space-2);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">SJ X N41</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown" id="profile-dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="profile-link" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle" id="profile-icon"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profile-link">
                            <li id="user-info" style="display: none;">
                                <div class="dropdown-header">
                                    <img id="user-pic" src="" alt="User" class="rounded-circle me-2" width="30" height="30" style="object-fit: cover;">
                                    <span id="user-name">User</span>
                                </div>
                            </li>
                            <li id="edit-item" style="display: none;"><a class="dropdown-item" href="#" id="btn-edit-profile">Edit Profile</a></li>
                            <li id="add-product-item" style="display: none;"><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addProductModal">Add Product</a></li>
                            <li style="display: none;" id="logout-divider"><hr class="dropdown-divider"></li>
                            <li id="logout-item" style="display: none;"><a class="dropdown-item" href="#" id="btn-logout">Logout</a></li>
                            <li id="login-item"><a class="dropdown-item" href="#" id="btn-login">Login with Google</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Search Modal -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Search Artists</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="searchInput" class="form-control bg-dark text-white border-secondary mb-2" placeholder="Enter Artist ID or Kick Slug...">
                    <select id="searchType" class="form-select bg-dark text-white border-secondary mb-3">
                        <option value="spotify">Spotify Artist (Enter ID)</option>
                        <option value="kick">Kick Channel (Enter Slug)</option>
                    </select>
                    <button class="btn btn-danger w-100" onclick="performSearch()">Search</button>
                    <div id="searchResults" class="row mt-3 gy-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="mb-3">
                            <label class="form-label">Display Name</label>
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="edit-name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Bio / Description</label>
                            <textarea class="form-control bg-dark text-white border-secondary" id="edit-desc" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cover Image URL</label>
                            <input type="url" class="form-control bg-dark text-white border-secondary" id="edit-image">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Spotify Artist ID</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" id="edit-spotify">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Kick Slug</label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" id="edit-kick">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Instagram URL</label>
                            <input type="url" class="form-control bg-dark text-white border-secondary" id="edit-instagram">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="edit-verified">
                            <label class="form-check-label" for="edit-verified">Verified Account</label>
                        </div>
                        <button type="submit" class="btn btn-danger">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Add Merch</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="mb-3">
                            <label class="form-label">Product Name</label>
                            <input type="text" class="form-control bg-dark text-white border-secondary" id="prod-title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price ($)</label>
                            <input type="number" class="form-control bg-dark text-white border-secondary" id="prod-price" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image URL</label>
                            <input type="url" class="form-control bg-dark text-white border-secondary" id="prod-img" placeholder="https://..." required>
                        </div>
                        <button type="submit" class="btn btn-danger w-100">Add Product</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div id="profile-container" class="container-fluid p-0">
        <!-- Dynamic content injected here -->
        <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
            <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, getDocs, addDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
            authDomain: "sj-one.firebaseapp.com",
            projectId: "sj-one",
            storageBucket: "sj-one.appspot.com",
            messagingSenderId: "426335553508",
            appId: "1:426335553508:web:248f76772f6f78419ca9f1"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sj-default';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // State
        let currentUser = null;
        let currentProfileData = null;
        let viewingProfileId = null; // Tracks whose profile is currently being displayed
        
        // Spotify Public Credentials (Demo purposes only)
        const spotifyClientId = '2e6b3a5e190c4e918bf4650bceac9af4';
        const spotifyClientSecret = '4d0370f7ea0148adb056c22fddd03341';

        // --- Auth Logic ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
               // Fallback to Anonymous auth so PUBLIC data can be read without permission errors
               try {
                   await signInAnonymously(auth);
               } catch (error) {
                   console.error("Anonymous auth failed", error);
               }
            }
        };
        initAuth();

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            updateNavUI(user);
            
            // Only attempt to load data if we have a user (Anonymous or Real)
            if (user) {
                const urlParams = new URLSearchParams(window.location.search);
                const urlUid = urlParams.get('uid');

                if (urlUid) {
                    // 1. Specific profile requested via URL
                    await loadProfile(urlUid);
                } else if (!user.isAnonymous) {
                    // 2. Logged in user, show their own profile
                    await loadProfile(user.uid);
                } else {
                    // 3. Anonymous user, no specific link -> Demo
                    loadDemoProfile();
                }
            }
        });

        function updateNavUI(user) {
            const loginItem = document.getElementById('login-item');
            const logoutItem = document.getElementById('logout-item');
            const logoutDivider = document.getElementById('logout-divider');
            const userInfo = document.getElementById('user-info');
            const editItem = document.getElementById('edit-item');
            const addProdItem = document.getElementById('add-product-item');
            
            // Only show "Logged In" UI if user is NOT anonymous
            if (user && !user.isAnonymous) {
                loginItem.style.display = 'none';
                logoutItem.style.display = 'block';
                logoutDivider.style.display = 'block';
                userInfo.style.display = 'block'; 
                editItem.style.display = 'block';
                addProdItem.style.display = 'block';
                
                document.getElementById('user-name').textContent = user.displayName || "User";
                document.getElementById('user-pic').src = user.photoURL || "https://via.placeholder.com/30";
            } else {
                loginItem.style.display = 'block';
                logoutItem.style.display = 'none';
                logoutDivider.style.display = 'none';
                userInfo.style.display = 'none';
                editItem.style.display = 'none';
                addProdItem.style.display = 'none';
            }
        }

        // --- Event Listeners ---
        document.getElementById('btn-login').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (e) {
                console.error(e);
                alert("Login failed: " + e.message);
            }
        });

        document.getElementById('btn-logout').addEventListener('click', async () => {
            await signOut(auth);
            window.location.reload();
        });

        document.getElementById('btn-edit-profile').addEventListener('click', async () => {
            if (!currentUser || currentUser.isAnonymous) return;
            
            let myData = currentProfileData;
            if (viewingProfileId !== currentUser.uid) {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', currentUser.uid);
                    const snap = await getDoc(docRef);
                    if (snap.exists()) myData = snap.data();
                } catch (e) {
                    console.error("Error loading own profile for edit", e);
                }
            }

            const formData = myData || {};

            document.getElementById('edit-name').value = formData.name || "";
            document.getElementById('edit-desc').value = formData.description || "";
            document.getElementById('edit-image').value = formData.imageUrl || "";
            document.getElementById('edit-spotify').value = formData.spotifyId || "";
            document.getElementById('edit-kick').value = formData.kickSlug || "";
            document.getElementById('edit-instagram').value = formData.instagram || "";
            document.getElementById('edit-verified').checked = formData.verified || false;
            
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        });

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) return;
            
            const newData = {
                name: document.getElementById('edit-name').value,
                description: document.getElementById('edit-desc').value,
                imageUrl: document.getElementById('edit-image').value,
                spotifyId: document.getElementById('edit-spotify').value,
                kickSlug: document.getElementById('edit-kick').value,
                instagram: document.getElementById('edit-instagram').value,
                verified: document.getElementById('edit-verified').checked,
                uid: currentUser.uid,
                updatedAt: new Date().toISOString()
            };

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', currentUser.uid), newData);
                const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                modal.hide();
                
                const urlParams = new URLSearchParams(window.location.search);
                const urlUid = urlParams.get('uid');
                
                if (!urlUid || urlUid === currentUser.uid) {
                    loadProfile(currentUser.uid);
                } else {
                    alert("Profile updated!");
                }
            } catch(err) {
                console.error("Error saving profile", err);
                alert("Error saving profile: " + err.message);
            }
        });

        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) return;

            const newProd = {
                title: document.getElementById('prod-title').value,
                price: parseFloat(document.getElementById('prod-price').value),
                image: document.getElementById('prod-img').value,
                uid: currentUser.uid, 
                createdAt: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), newProd);
                document.getElementById('addProductForm').reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
                modal.hide();
                
                if (viewingProfileId === currentUser.uid) {
                    loadUserProducts(currentUser.uid);
                }
            } catch(err) {
                console.error("Error adding product", err);
                alert("Error adding product");
            }
        });

        // --- Core Profile Logic ---

        async function loadProfile(uid) {
            viewingProfileId = uid;
            const container = document.getElementById('profile-container');
            
            container.innerHTML = `
                <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
                    <div class="spinner-border text-danger" role="status"></div>
                </div>
            `;

            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    currentProfileData = docSnap.data();
                    renderProfile(currentProfileData);
                    loadUserProducts(uid);
                    if (currentProfileData.spotifyId) loadTracks(currentProfileData.spotifyId);
                    if (currentProfileData.kickSlug) loadKickClips(currentProfileData.kickSlug);
                } else {
                    if (currentUser && !currentUser.isAnonymous && currentUser.uid === uid) {
                        const autoProfile = {
                            name: currentUser.displayName || "New Artist",
                            imageUrl: currentUser.photoURL || "https://images.unsplash.com/photo-1493225255756-d9584f8606e9?auto=format&fit=crop&w=1600&q=80",
                            description: "Welcome to my new profile.",
                            verified: false,
                            uid: uid,
                            createdAt: new Date().toISOString()
                        };
                        
                        await setDoc(docRef, autoProfile);
                        currentProfileData = autoProfile;
                        renderProfile(autoProfile);
                        loadUserProducts(uid);
                    } else {
                        container.innerHTML = `
                            <div class="d-flex flex-column justify-content-center align-items-center" style="height: 80vh;">
                                <h2 class="text-muted">Profile Not Found</h2>
                                <p class="text-secondary">The artist with ID ${uid} has not set up a profile yet.</p>
                                <button class="btn btn-danger mt-3" onclick="window.location.href=window.location.href.split('?')[0]">Go Home</button>
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error("Profile load error", e);
                container.innerHTML = `<div class="p-5 text-center text-danger">Error loading profile: ${e.message}</div>`;
            }
        }

        function loadDemoProfile() {
            const demoData = {
                name: "SJ X N41 (Demo)",
                imageUrl: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?auto=format&fit=crop&w=1600&q=80",
                description: "This is a demo. Login to create your OWN profile link.",
                verified: true,
                spotifyId: '1Xyo4u8uXC1ZmMpatF05PJ',
                instagram: '#',
                uid: 'demo'
            };
            currentProfileData = demoData;
            renderProfile(demoData);
            loadTracks(demoData.spotifyId);
        }

        function renderProfile(data) {
            const container = document.getElementById('profile-container');
            const verifiedBadge = data.verified ? '<i class="bi bi-patch-check-fill verified-badge"></i>' : '';
            
            let socialIcons = '';
            if(data.instagram) socialIcons += `<a href="${data.instagram}" target="_blank"><i class="bi bi-instagram"></i></a>`;
            if(data.spotifyId) socialIcons += `<a href="https://open.spotify.com/artist/${data.spotifyId}" target="_blank"><i class="bi bi-spotify"></i></a>`;
            
            const isOwner = currentUser && !currentUser.isAnonymous && currentUser.uid === data.uid;
            
            container.innerHTML = `
                <div class="profile-hero" style="background-image: url('${data.imageUrl || 'https://via.placeholder.com/1600x900'}');">
                    <div class="user-actions">
                        <button onclick="window.shareProfile('${data.uid}')" title="Share Link"><i class="bi bi-share"></i></button>
                        ${(!currentUser || currentUser.isAnonymous) ? '<button onclick="document.getElementById(\'btn-login\').click()" title="Login"><i class="bi bi-person-plus"></i></button>' : ''}
                    </div>
                    <div class="profile-hero-content">
                        <h1>${data.name} ${verifiedBadge}</h1>
                        <div class="social-links mt-3">
                            ${socialIcons}
                        </div>
                        ${isOwner ? '<div class="mt-3"><span class="badge bg-dark border border-secondary">This is your public profile</span></div>' : ''}
                    </div>
                </div>

                <div class="profile-bio">
                    <h3>About</h3>
                    <p>${data.description || "No bio available."}</p>
                </div>

                <div class="scroll-section">
                    <h3 class="section-title">Latest Tracks & Clips</h3>
                    <div id="tracks-row" class="horizontal-scroll">
                        <div class="text-muted ps-3 pt-2">Connect Spotify or Kick in 'Edit Profile' to see content.</div>
                    </div>
                </div>

                <div class="scroll-section">
                    <h3 class="section-title">Official Merch</h3>
                    <div id="products-row" class="horizontal-scroll">
                        <div class="text-muted ps-3 pt-2">No products listed yet.</div>
                    </div>
                </div>
            `;
        }

        async function loadUserProducts(uid) {
            const productsContainer = document.getElementById('products-row');
            if (!productsContainer) return;
            
            // CRITICAL FIX: REMOVED 'where' clause. 
            // Fetch all public products, then filter in memory.
            // This avoids "Missing or insufficient permissions" caused by missing indexes/rules.
            try {
                const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'products'));
                
                const products = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.uid === uid) {
                        products.push(data);
                    }
                });

                if (products.length === 0) {
                    productsContainer.innerHTML = '<p class="text-muted ps-2">No merch available yet.</p>';
                    return;
                }
                
                productsContainer.innerHTML = '';
                products.forEach(prod => {
                    const card = `
                        <div class="product-card">
                            <div class="card">
                                <img src="${prod.image || 'https://via.placeholder.com/200'}" class="card-img-top" alt="${prod.title}">
                                <div class="card-body">
                                    <h6 class="card-title text-white" title="${prod.title}">${prod.title}</h6>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-danger fw-bold">$${prod.price}</span>
                                        <button class="btn btn-sm btn-outline-light"><i class="bi bi-cart"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    productsContainer.innerHTML += card;
                });
            } catch (e) {
                console.error("Error loading products:", e);
                productsContainer.innerHTML = '<p class="text-danger ps-2">Error loading products.</p>';
            }
        }

        // --- Spotify & Kick API Utils ---
        async function getSpotifyToken() {
            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(spotifyClientId + ':' + spotifyClientSecret)
                    },
                    body: 'grant_type=client_credentials'
                });
                if (!response.ok) throw new Error('Failed to get Spotify token');
                const data = await response.json();
                return data.access_token;
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        window.loadTracks = async function(spotifyArtistId) {
            const tracksContainer = document.getElementById('tracks-row');
            if (!tracksContainer) return;
            
            tracksContainer.innerHTML = '<div class="spinner-border text-danger small ms-3" role="status"></div>';
            
            const token = await getSpotifyToken();
            if (!token) {
                tracksContainer.innerHTML = '<p class="text-danger ps-2">API Error</p>';
                return;
            }

            try {
                const url = `https://api.spotify.com/v1/artists/${spotifyArtistId}/top-tracks?market=US`;
                const response = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
                const data = await response.json();
                
                if (!data.tracks || data.tracks.length === 0) {
                    tracksContainer.innerHTML = '<p class="text-muted ps-2">No tracks found.</p>';
                    return;
                }

                tracksContainer.innerHTML = '';
                data.tracks.forEach(track => {
                    const img = track.album.images[0]?.url || 'https://via.placeholder.com/200';
                    const html = `
                        <div class="track-card">
                            <div class="card">
                                <img src="${img}" class="card-img-top" alt="${track.name}">
                                <div class="card-body">
                                    <h6 class="card-title text-white" title="${track.name}">${track.name}</h6>
                                    <p class="small text-muted mb-2">${track.album.name}</p>
                                    <a href="${track.external_urls.spotify}" target="_blank" class="btn btn-sm btn-danger w-100">Play</a>
                                </div>
                            </div>
                        </div>
                    `;
                    tracksContainer.innerHTML += html;
                });
            } catch (e) {
                console.error("Spotify Load Error", e);
                tracksContainer.innerHTML = '<p class="text-danger ps-2">Failed to load tracks.</p>';
            }
        };

        window.loadKickClips = async function(slug) {
            const tracksContainer = document.getElementById('tracks-row');
            try {
                const response = await fetch(`https://kick.com/api/v2/channels/${slug}/clips?limit=5`);
                if(!response.ok) return; 
                const data = await response.json();
                if(data.clips) {
                    data.clips.forEach(clip => {
                         const html = `
                            <div class="track-card">
                                <div class="card">
                                    <img src="${clip.thumbnail_url}" class="card-img-top" alt="Kick Clip">
                                    <div class="card-body">
                                        <h6 class="card-title text-white">Kick Clip</h6>
                                        <a href="https://kick.com/${slug}?clip=${clip.id}" target="_blank" class="btn btn-sm btn-success w-100">Watch</a>
                                    </div>
                                </div>
                            </div>
                        `;
                        tracksContainer.innerHTML += html;
                    });
                }
            } catch(e) {
                console.log("Kick API blocked by CORS or failed - typical for client-side fetch");
            }
        };

        window.shareProfile = function(uid) {
            let link = window.location.href.split('?')[0];
            if (uid && uid !== 'demo') {
                link += `?uid=${uid}`;
            }
            
            navigator.clipboard.writeText(link).then(() => {
                alert("Profile link copied to clipboard: " + link);
            }).catch(err => {
                prompt("Copy this link to share:", link);
            });
        };

        window.performSearch = function() {
            const type = document.getElementById('searchType').value;
            const input = document.getElementById('searchInput').value;
            const results = document.getElementById('searchResults');
            
            if(!input) return;

            results.innerHTML = '<div class="text-white">Search functionality is simulated for IDs. Try using the ID in Edit Profile to persist it.</div>';
            
            if(type === 'spotify') {
                loadTracks(input);
                const modal = bootstrap.Modal.getInstance(document.getElementById('searchModal'));
                modal.hide();
            }
        };

    </script>
