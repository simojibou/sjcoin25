<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Marketer Dashboard - SJ STORE</title>
  <!-- Google Fonts - Roboto as Helvetica alternative -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Firebase v12.3.0 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getDatabase, ref, onValue, set, push, get, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
      authDomain: "sj-one.firebaseapp.com",
      databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
      projectId: "sj-one",
      storageBucket: "sj-one.appspot.com",
      messagingSenderId: "426335553508",
      appId: "1:426335553508:web:248f76772f6f78419ca9f1",
      measurementId: "G-YQTVZQWXGB"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    
    document.addEventListener("DOMContentLoaded", () => {
      const affiliateList = document.getElementById("affiliate-list");
      const commissionsTotal = document.getElementById("commissions-total");
      const closeMarketerModal = document.getElementById("close-marketer-modal");
      const productSelect = document.getElementById("product-select");
      const generateLinkBtn = document.getElementById("generate-link-btn");
      const userProfile = document.getElementById("user-profile");
      
      let products = [];
      let userData = { language: 'English' };
      
      const translations = {
        English: {
          affiliateTitle: 'Affiliate Dashboard',
          selectProduct: 'Select a Product',
          generateLink: 'Generate Affiliate Link',
          copyLink: 'Copy Link',
          commissions: 'Total Commissions',
          close: 'Close',
          product: 'Product',
          clicks: 'Clicks',
          buyers: 'Buyers',
          profile: 'User Profile',
          email: 'Email'
        },
        French: {
          affiliateTitle: 'Tableau de bord affilié',
          selectProduct: 'Sélectionner un produit',
          generateLink: 'Générer un lien affilié',
          copyLink: 'Copier le lien',
          commissions: 'Commissions totales',
          close: 'Fermer',
          product: 'Produit',
          clicks: 'Clics',
          buyers: 'Acheteurs',
          profile: 'Profil utilisateur',
          email: 'Email'
        },
        Arabic: {
          affiliateTitle: 'لوحة تحكم التابع',
          selectProduct: 'اختر منتجًا',
          generateLink: 'إنشاء رابط تابع',
          copyLink: 'نسخ الرابط',
          commissions: 'إجمالي العمولات',
          close: 'إغلاق',
          product: 'المنتج',
          clicks: 'النقرات',
          buyers: 'المشترين',
          profile: 'ملف المستخدم',
          email: 'البريد الإلكتروني'
        }
      };
      
      function applyLanguage(lang) {
        const t = translations[lang] || translations.English;
        document.querySelector('h2').textContent = t.affiliateTitle;
        productSelect.firstChild.textContent = t.selectProduct;
        generateLinkBtn.textContent = t.generateLink;
        commissionsTotal.textContent = `${t.commissions}: 0 DH`;
        closeMarketerModal.textContent = t.close;
        document.getElementById("profile-title").textContent = t.profile;
        loadAffiliateDashboard(auth.currentUser?.uid);
      }
      
      const productRef = ref(db, "Product");
      onValue(productRef, (snapshot) => {
        products = [];
        productSelect.innerHTML = `<option value="" disabled selected>${translations[userData.language]?.selectProduct || 'Select a Product'}</option>`;
        const productMap = new Map();
        snapshot.forEach((childSnapshot) => {
          const productId = childSnapshot.key;
          if (!productMap.has(productId)) {
            const data = childSnapshot.val();
            const product = {
              id: productId,
              title: data.title,
              price: data.price,
              des: data.des,
              orderUrl: data.orderUrl,
              photo: data.photo,
              userId: data.id,
              category: data.category || "Uncategorized"
            };
            productMap.set(productId, product);
            products.push(product);
            const option = document.createElement("option");
            option.value = product.id;
            option.textContent = product.title;
            productSelect.appendChild(option);
          }
        });
      }, (error) => {
        console.error("Failed to load products:", error);
      });
      
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          alert("Please log in to access the dashboard.");
          window.location.href = "SJSTORE.html";
        } else {
          const userRef = ref(db, `users/${user.uid}`);
          get(userRef).then((snapshot) => {
            userData = snapshot.val() || { language: 'English' };
            applyLanguage(userData.language);
            userProfile.innerHTML = `
              <div class="user-profile-content">
                <img src="${user.photoURL || 'https://via.placeholder.com/50'}" alt="Profile Picture" class="profile-pic">
                <div>
                  <p><strong>${translations[userData.language]?.profile || 'User Profile'}:</strong> ${user.displayName || 'Anonymous'}</p>
                  <p><strong>${translations[userData.language]?.email || 'Email'}:</strong> ${user.email || 'N/A'}</p>
                </div>
              </div>
            `;
            loadAffiliateDashboard(user.uid);
          }).catch((error) => {
            console.error("Failed to load user data:", error);
            alert("Error loading user data. Please try again.");
          });
        }
      });
      
      closeMarketerModal.addEventListener("click", () => {
        window.location.href = "SJSTORE.html";
      });
      
      function generateUniqueCode() {
        return Math.random().toString(36).substr(2, 9);
      }
      
      generateLinkBtn.addEventListener("click", () => {
        const productId = productSelect.value;
        if (!productId) {
          alert("Please select a product.");
          return;
        }
        if (!auth.currentUser) {
          alert("Please log in to generate a link.");
          return;
        }
        const product = products.find(p => p.id === productId);
        if (!product) {
          alert("Selected product not found.");
          return;
        }
        const code = generateUniqueCode();
        const baseUrl = "https://simojibou.github.io/sjcoin25/sjstore13.html";
        const link = `${baseUrl}?ref=${code}&pid=${productId}`;
        const affiliateRef = push(ref(db, "affiliate_links"));
        set(affiliateRef, {
          code,
          productId,
          marketerId: auth.currentUser.uid,
          createdAt: Date.now(),
          clicks: 0,
          buyers: 0
        }).then(() => {
          loadAffiliateDashboard(auth.currentUser.uid);
          alert(`Affiliate link generated: ${link}`);
        }).catch(error => {
          console.error("Failed to generate affiliate link:", error);
          alert(`Failed to generate affiliate link: ${error.message}`);
        });
      });
      
      function loadAffiliateDashboard(uid) {
        affiliateList.innerHTML = "";
        const affiliateLinksRef = ref(db, "affiliate_links");
        onValue(affiliateLinksRef, (snapshot) => {
          affiliateList.innerHTML = "";
          const t = translations[userData.language] || translations.English;
          if (!snapshot.exists()) {
            console.warn("No affiliate links found for user:", uid);
            affiliateList.innerHTML = `<p>${t.noLinks || 'No affiliate links available.'}</p>`;
            return;
          }
          snapshot.forEach((childSnapshot) => {
            const data = childSnapshot.val();
            if (data.marketerId === uid) {
              const product = products.find(p => p.id === data.productId);
              const div = document.createElement("div");
              div.classList.add("affiliate-item");
              const link = `https://simojibou.github.io/sjcoin25/sjstore13.html?ref=${data.code}&pid=${data.productId}`;
              div.innerHTML = `
                <img src="${product ? product.photo : 'https://via.placeholder.com/80'}" alt="${product ? product.title : 'Product'}">
                <div class="affiliate-details">
                  <p><strong>${t.product}:</strong> ${product ? product.title : 'Unknown'}</p>
                  <p><strong>Price:</strong> ${product ? product.price : 'N/A'} DH</p>
                  <p><strong>Category:</strong> ${product ? product.category : 'N/A'}</p>
                  <p><strong>${t.clicks}:</strong> ${data.clicks || 0}</p>
                  <p><strong>${t.buyers}:</strong> ${data.buyers || 0}</p>
                  <p><strong>Link:</strong> <a href="${link}" target="_blank">${link}</a></p>
                  <button class="copy-link-btn">${t.copyLink}</button>
                </div>
              `;
              div.querySelector(".copy-link-btn").addEventListener("click", () => {
                navigator.clipboard.writeText(link).then(() => alert("Link copied!"));
              });
              affiliateList.appendChild(div);
            }
          });
        }, (error) => {
          console.error("Failed to load affiliate links:", error);
          affiliateList.innerHTML = `<p>Error loading affiliate links: ${error.message}</p>`;
        });
        const marketerRef = ref(db, `users/${uid}`);
        onValue(marketerRef, (snapshot) => {
          const data = snapshot.val();
          const commissions = data.commissions || 0;
          const t = translations[userData.language] || translations.English;
          commissionsTotal.textContent = `${t.commissions}: ${commissions.toFixed(2)} DH`;
        }, (error) => {
          console.error("Failed to load user data:", error);
        });
      }
    });
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: #000;
      color: #fff;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #111;
      margin: 5% auto;
      padding: 2rem;
      border-radius: 0;
      width: 90%;
      max-width: 800px;
      border: 1px solid #333;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }
    h2 {
      font-size: 1.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      margin-bottom: 1.5rem;
    }
    #user-profile {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #222;
      border: 1px solid #333;
      border-radius: 0;
    }
    .user-profile-content {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .profile-pic {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
    #affiliate-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .affiliate-item {
      background: #222;
      padding: 1rem;
      border-radius: 0;
      display: flex;
      align-items: center;
      gap: 1rem;
      border: 1px solid #333;
      transition: transform 0.3s;
    }
    .affiliate-item:hover {
      transform: translateY(-3px);
    }
    .affiliate-item img {
      width: 80px;
      height: 80px;
      border-radius: 0;
      object-fit: cover;
    }
    .affiliate-details {
      flex: 1;
    }
    .affiliate-details p {
      margin: 0.5rem 0;
      font-size: 0.875rem;
    }
    .affiliate-details strong {
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .copy-link-btn, #generate-link-btn {
      background: #fff;
      color: #000;
      border: none;
      padding: 0.5rem 1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      cursor: pointer;
      transition: background 0.3s;
    }
    .copy-link-btn:hover, #generate-link-btn:hover {
      background: #e0e0e0;
    }
    #commissions-total {
      font-size: 1.25rem;
      font-weight: 700;
      text-align: right;
      margin-top: 1rem;
    }
    #close-marketer-modal {
      background: transparent;
      color: #fff;
      border: 1px solid #fff;
      padding: 0.75rem;
      width: 100%;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      cursor: pointer;
      margin-top: 1rem;
      transition: border-color 0.3s;
    }
    #close-marketer-modal:hover {
      border-color: #ccc;
    }
    #product-select-form {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    #product-select {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid #333;
      background: #000;
      color: #fff;
      border-radius: 0;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    #product-select:focus {
      border-color: #fff;
      outline: none;
    }
    @media (max-width: 480px) {
      .modal-content {
        padding: 1.5rem;
        width: 95%;
      }
      .affiliate-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .affiliate-item img {
        width: 100%;
        height: auto;
      }
      .affiliate-details p {
        font-size: 0.75rem;
      }
      #product-select-form {
        flex-direction: column;
      }
      #generate-link-btn {
        width: 100%;
      }
      .user-profile-content {
        flex-direction: column;
        align-items: flex-start;
      }
      .profile-pic {
        margin-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="modal-content">
    <h2 id="profile-title">User Profile</h2>
    <div id="user-profile"></div>
    <h2>Affiliate Dashboard</h2>
    <div id="product-select-form">
      <select id="product-select">
        <option value="" disabled selected>Select a Product</option>
      </select>
      <button id="generate-link-btn">Generate Affiliate Link</button>
    </div>
    <div id="affiliate-list"></div>
    <p id="commissions-total">Total Commissions: 0 DH</p>
    <button id="close-marketer-modal">Close</button>
  </div>
</body>
</html>
