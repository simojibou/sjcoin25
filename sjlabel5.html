<!DOCTYPE html>
<html lang="en">
<head>
    <!-- … all your existing <head> … -->
    <style>
        /* ---- NEW: Stats panel (admin only) ---- */
        .artist-stats {
            background: rgba(255,255,255,0.07);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: var(--space-2);
            margin-top: var(--space-3);
            text-align: center;
            font-size: 1.1rem;
        }
        .artist-stats .stat {
            margin: 0 var(--space-2);
        }
        .artist-stats .value {
            font-weight: 700;
            color: var(--color-red);
        }
        @media (max-width: 768px) {
            .artist-stats { font-size: 0.95rem; }
        }
    </style>
</head>
<body>
    <!-- … all your existing HTML … -->

    <!-- --------------  JAVASCRIPT  -------------- -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, setDoc, serverTimestamp, query, orderBy, where, increment, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

        // ---------- Firebase config (unchanged) ----------
        const firebaseConfig = { /* … your config … */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const ADMIN_EMAIL = 'simo.jibou@gmail.com';
        let currentUser = null;
        let editingArtistId = null;
        let editingSliderId = null;

        /* ------------------------------------------------------------------ */
        /* -------------------  NEW: VIEW COUNTER LOGIC  -------------------- */
        /* ------------------------------------------------------------------ */

        /** Increment the view counter for an artist (non‑admin only) */
        async function incrementArtistView(artistId) {
            if (!currentUser || currentUser.email === ADMIN_EMAIL) return;   // admins don’t count

            const artistRef = doc(db, 'artists', artistId);
            try {
                await runTransaction(db, async (transaction) => {
                    const snap = await transaction.get(artistRef);
                    if (!snap.exists()) return;
                    const newViews = (snap.data().views || 0) + 1;
                    transaction.update(artistRef, { views: newViews });
                });
            } catch (e) { console.warn('View increment failed', e); }
        }

        /** Render the admin‑only stats panel */
        function renderArtistStats(artistId, views) {
            if (!currentUser || currentUser.email !== ADMIN_EMAIL) return '';

            const earnings = (views / 1000).toFixed(2);   // 1000 views = $1
            return `
                <div class="artist-stats glass-effect stagger-item">
                    <div class="d-flex justify-content-center flex-wrap">
                        <div class="stat">
                            <span class="value">${views.toLocaleString()}</span> Views
                        </div>
                        <div class="stat">
                            <span class="value">$${earnings}</span> Earnings
                        </div>
                    </div>
                    <small class="d-block mt-2 text-muted">* Earnings = Views ÷ 1000 × $1</small>
                </div>
            `;
        }

        /* ------------------------------------------------------------------ */
        /* -------------------  LOAD SINGLE ARTIST (UPDATED)  --------------- */
        /* ------------------------------------------------------------------ */
        async function loadSingleArtist(id) {
            const artistRef = doc(db, 'artists', id);
            const docSnap = await getDoc(artistRef);

            if (!docSnap.exists()) {
                artistsList.innerHTML = '<h2 class="text-center">Artist not found</h2>';
                return;
            }

            const artist = docSnap.data();
            const views = artist.views || 0;

            // ----------  Increment view for non‑admin  ----------
            incrementArtistView(id);

            // ----------  Hide sections that are not needed  ----------
            document.querySelector('.hero-section').style.display = 'none';
            document.getElementById('submission-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'none';
            document.getElementById('artist-management-section').style.display = 'none';
            artistsList.innerHTML = '';

            // ----------  Admin edit/delete buttons ----------
            let adminActions = '';
            if (currentUser && currentUser.email === ADMIN_EMAIL) {
                adminActions = `
                    <div class="admin-actions" style="position:absolute;top:10px;right:10px;opacity:1;">
                        <button onclick="editArtist('${id}')" title="Edit"><i class="bi bi-pencil"></i></button>
                        <button onclick="deleteArtist('${id}')" title="Delete"><i class="bi bi-trash"></i></button>
                    </div>
                `;
            }

            // ----------  Build the full artist page ----------
            const fullPage = document.createElement('div');
            fullPage.innerHTML = `
                <div class="artist-hero" style="background-image:url('${artist.imageUrl || 'https://via.placeholder.com/1920x1080/4a90e2/ffffff?text=Artist+Photo'}');">
                    <div class="artist-hero-content">
                        ${adminActions}
                        <h1><i class="bi bi-music-note-beamed icon"></i>${artist.name}</h1>
                        <div class="social-links">
                            ${artist.instagram ? `<a href="${artist.instagram}" target="_blank" rel="noopener noreferrer" title="Instagram"><i class="bi bi-instagram"></i></a>` : ''}
                            ${artist.spotify ? `<a href="${artist.spotify}" target="_blank" rel="noopener noreferrer" title="Spotify"><i class="bi bi-spotify"></i></a>` : ''}
                        </div>
                    </div>
                </div>

                <div class="ad-container-wrapper">
                    <div id="ad-container"></div>
                </div>

                <div class="container">
                    <div class="artist-bio glass-effect stagger-item">
                        <h3>Biography</h3>
                        <p>${artist.description || 'Emerging talent in the music scene.'}</p>
                    </div>

                    <!-- NEW: Admin stats panel -->
                    ${renderArtistStats(id, views)}

                    <div class="text-center mt-4">
                        <a href="https://simojibou.github.io/sjcoin25/sjlabel3.html" class="btn btn-secondary">Back to Home</a>
                    </div>
                </div>
            `;
            artistsList.appendChild(fullPage);

            // Stagger animation
            setTimeout(() => {
                document.querySelectorAll('.stagger-item').forEach((item, i) => {
                    setTimeout(() => item.classList.add('enhanced-appear'), i * 100);
                });
            }, 100);
        }

        /* ------------------------------------------------------------------ */
        /* -------------------  ARTIST CARD (link stays the same)  ---------- */
        /* ------------------------------------------------------------------ */
        function loadArtists() {
            artistsList.innerHTML = '<h2 class="text-center mb-4"><i class="bi bi-people icon"></i>Our Artists</h2>';
            const artistsCol = collection(db, 'artists');
            getDocs(artistsCol).then(snapshot => {
                if (snapshot.empty) {
                    artistsList.innerHTML += '<p class="text-center text-muted">No artists yet. Add some!</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const artist = doc.data();
                    const artistId = doc.id;
                    const card = document.createElement('div');
                    card.className = 'col-md-4 col-sm-6';
                    let adminActions = '';
                    if (currentUser && currentUser.email === ADMIN_EMAIL) {
                        adminActions = `
                            <div class="admin-actions">
                                <button onclick="editArtist('${artistId}')" title="Edit"><i class="bi bi-pencil"></i></button>
                                <button onclick="deleteArtist('${artistId}')" title="Delete"><i class="bi bi-trash"></i></button>
                            </div>
                        `;
                    }
                    card.innerHTML = `
                        <div class="artist-card stagger-item">
                            <img src="${artist.imageUrl || 'https://via.placeholder.com/300x200/4a90e2/ffffff?text=Artist+Photo'}" alt="${artist.name}">
                            ${adminActions}
                            <h5><i class="bi bi-music-note-beamed icon"></i>${artist.name}</h5>
                            <p>${artist.description || 'Emerging talent in the music scene.'}</p>
                            <div class="social-links">
                                ${artist.instagram ? `<a href="${artist.instagram}" target="_blank" rel="noopener noreferrer" title="Instagram"><i class="bi bi-instagram"></i></a>` : ''}
                                ${artist.spotify ? `<a href="${artist.spotify}" target="_blank" rel="noopener noreferrer" title="Spotify"><i class="bi bi-spotify"></i></a>` : ''}
                            </div>
                            <a href="?artist=${artistId}" class="stretched-link"></a>
                        </div>
                    `;
                    artistsList.appendChild(card);
                });
                setTimeout(() => {
                    document.querySelectorAll('.stagger-item').forEach((item, i) => {
                        setTimeout(() => item.classList.add('enhanced-appear'), i * 100);
                    });
                }, 100);
            }).catch(error => console.error(error));
        }

        /* ------------------------------------------------------------------ */
        /* -------------------  ADD / EDIT ARTIST (views init)  ------------- */
        /* ------------------------------------------------------------------ */

        // ---- ADD NEW ARTIST (initialize views = 0) ----
        addArtistForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('artist-name').value;
            const description = document.getElementById('artist-description').value;
            const instagram = document.getElementById('artist-instagram').value;
            const spotify = document.getElementById('artist-spotify').value;
            const imageFile = document.getElementById('artist-image').files[0];

            const artistData = {
                name,
                description: description || '',
                instagram: instagram || '',
                spotify: spotify || '',
                views: 0                                 // <-- NEW
            };

            try {
                if (imageFile) {
                    if (!imageFile.type.startsWith('image/')) { alert('Image only'); return; }
                    const compressed = await compressImage(imageFile);
                    const storageRef = ref(storage, `artists/${Date.now()}_${imageFile.name.replace(/\.[^/.]+$/, ".jpg")}`);
                    const snap = await uploadBytes(storageRef, compressed);
                    artistData.imageUrl = await getDownloadURL(snap.ref);
                }
                await addDoc(collection(db, 'artists'), artistData);
                alert('Artist added!');
                addArtistForm.reset();
                loadArtists();
            } catch (err) { console.error(err); alert('Error: ' + err.message); }
        });

        // ---- EDIT ARTIST (preserve existing views) ----
        document.getElementById('edit-artist-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('edit-artist-name').value;
            const description = document.getElementById('edit-artist-description').value;
            const instagram = document.getElementById('edit-artist-instagram').value;
            const spotify = document.getElementById('edit-artist-spotify').value;
            const imageFile = document.getElementById('edit-artist-image').files[0];

            const artistRef = doc(db, 'artists', editingArtistId);
            const updateData = {
                name,
                description: description || '',
                instagram: instagram || '',
                spotify: spotify || ''
                // **views** is **not** touched – it stays as‑is
            };

            try {
                if (imageFile) {
                    if (!imageFile.type.startsWith('image/')) { alert('Image only'); return; }
                    const compressed = await compressImage(imageFile);
                    const storageRef = ref(storage, `artists/${Date.now()}_${imageFile.name.replace(/\.[^/.]+$/, ".jpg")}`);
                    const snap = await uploadBytes(storageRef, compressed);
                    updateData.imageUrl = await getDownloadURL(snap.ref);
                }
                await updateDoc(artistRef, updateData);
                alert('Artist updated!');
                editModal.hide();
                const artistId = getQueryParam('artist');
                if (artistId) loadSingleArtist(artistId);
                else loadArtists();
            } catch (err) { console.error(err); alert('Error: ' + err.message); }
        });

        /* ------------------------------------------------------------------ */
        /* -------------------  REST OF YOUR ORIGINAL CODE  ----------------- */
        /* ------------------------------------------------------------------ */

        // (All the other functions you already had – login, slider, manager, etc.)
        // … keep everything else exactly as it was …

        // Auth state listener (unchanged, just calls loadSingleArtist when needed)
        onAuthStateChanged(auth, user => {
            currentUser = user;
            if (user) {
                loginBtn.classList.add('d-none');
                logoutBtn.classList.remove('d-none');
                userInfo.innerHTML = `<i class="bi bi-person-circle icon"></i>Logged in as: ${user.email}`;
                submissionSection.classList.remove('d-none');

                if (user.email === ADMIN_EMAIL) {
                    adminSection.classList.remove('d-none');
                    artistManagementSection.classList.remove('d-none');
                    loadManagers();
                    loadSubmissions();
                } else {
                    const q = query(collection(db, 'managers'), where('email', '==', user.email));
                    getDocs(q).then(snap => {
                        if (!snap.empty) artistManagementSection.classList.remove('d-none');
                    });
                }
            } else {
                loginBtn.classList.remove('d-none');
                logoutBtn.classList.add('d-none');
                userInfo.innerHTML = '';
                adminSection.classList.add('d-none');
                artistManagementSection.classList.add('d-none');
                submissionSection.classList.add('d-none');
            }

            const artistId = getQueryParam('artist');
            if (artistId) loadSingleArtist(artistId);
            else { loadArtists(); loadSlider(); }
        });

        // … (rest of your original script – loginBtn, logoutBtn, sliders, etc.) …
        // Keep **all** of it – only the sections above were added/modified.

    </script>
</body>
</html>
