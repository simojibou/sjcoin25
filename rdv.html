<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SJ Logo - Video to Transparent GIF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import gif.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <style>
        .checkerboard {
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #ccc 75%), 
                              linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #fff;
        }
        /* Custom scrollbar for cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-indigo-900 text-white p-6 shadow-md">
        <div class="max-w-5xl mx-auto flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">SJ Video Background Remover</h1>
                <p class="text-indigo-200 text-sm mt-1">Convert MP4 to Transparent GIF with Glow Preservation</p>
            </div>
            <!-- Status Badge -->
            <div id="statusBadge" class="hidden px-3 py-1 bg-indigo-700 rounded-full text-xs font-semibold animate-pulse">
                Processing...
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-5xl mx-auto w-full p-6 space-y-8">
        
        <!-- Step 1: Upload -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center transition-all hover:border-indigo-300 border-dashed border-2 cursor-pointer" id="dropZone">
            <input type="file" id="videoInput" accept="video/mp4,video/webm,video/ogg" class="hidden">
            <div class="space-y-2 py-8" onclick="document.getElementById('videoInput').click()">
                <div class="text-indigo-500 text-5xl mb-4">üìÇ</div>
                <h3 class="text-lg font-medium">Click to Upload Video</h3>
                <p class="text-gray-500 text-sm">or drag and drop MP4 file here</p>
            </div>
        </div>

        <!-- Editor Interface (Hidden initially) -->
        <div id="editorArea" class="hidden space-y-8">
            
            <!-- Controls -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-6">
                     <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                            <span>üéöÔ∏è Settings</span>
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                                    <span>Black Threshold</span>
                                    <span id="thresholdVal" class="text-indigo-600">10</span>
                                </label>
                                <input type="range" id="threshold" min="0" max="100" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                                <p class="text-xs text-gray-400 mt-1">Higher removes more dark colors (cleaner blacks).</p>
                            </div>

                            <div>
                                <label class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                                    <span>Glow Intensity (Alpha Boost)</span>
                                    <span id="alphaBoostVal" class="text-indigo-600">1.2</span>
                                </label>
                                <input type="range" id="alphaBoost" min="0.5" max="3" step="0.1" value="1.2" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                                <p class="text-xs text-gray-400 mt-1">Boosts visibility of the semi-transparent glow.</p>
                            </div>

                             <div>
                                <label class="flex justify-between text-sm font-medium text-gray-600 mb-1">
                                    <span>GIF Quality</span>
                                    <span class="text-xs bg-gray-100 px-2 py-0.5 rounded">High (10)</span>
                                </label>
                                <div class="flex items-center gap-2 text-sm text-gray-500">
                                    <span>FPS:</span>
                                    <select id="fpsSelect" class="bg-gray-100 border-none rounded p-1 text-gray-700 font-semibold focus:ring-0">
                                        <option value="10">10 (Fast)</option>
                                        <option value="15" selected>15 (Balanced)</option>
                                        <option value="24">24 (Smooth)</option>
                                        <option value="30">30 (High CPU)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button id="generateBtn" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                        <span>Record & Generate GIF</span>
                    </button>
                    
                    <div id="progressContainer" class="hidden">
                         <div class="flex justify-between text-xs font-semibold text-gray-500 mb-1">
                            <span id="progressText">Processing...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>

                </div>

                <!-- Previews -->
                <div class="space-y-4">
                    <h3 class="font-semibold text-gray-700">Preview</h3>
                    
                    <!-- Canvas Container -->
                    <div class="relative w-full aspect-square bg-gray-800 rounded-lg overflow-hidden flex items-center justify-center checkerboard border border-gray-300">
                        <!-- The processed output canvas -->
                        <canvas id="outputCanvas" class="max-w-full max-h-full object-contain z-10"></canvas>
                        <!-- Comparison label -->
                        <div class="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded backdrop-blur-sm z-20">Live Preview</div>
                    </div>

                    <!-- Hidden Video Element for processing -->
                    <video id="sourceVideo" class="hidden" muted playsinline loop></video>
                </div>
            </div>

            <!-- Result Area -->
            <div id="resultArea" class="hidden border-t pt-8 animate-fade-in-up">
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">üéâ Your GIF is Ready!</h3>
                <div class="flex flex-col items-center gap-4">
                    <img id="resultGif" class="max-w-xs md:max-w-md rounded-lg shadow-xl checkerboard border-4 border-white" alt="Generated GIF">
                    <a id="downloadBtn" download="sj-logo-transparent.gif" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-full shadow-lg flex items-center gap-2 transform transition hover:-translate-y-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download GIF
                    </a>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-100 border-t mt-12 py-6 text-center text-gray-500 text-sm">
        <p>Processed locally in your browser. No video data is sent to any server.</p>
    </footer>

    <script>
        // --- Elements ---
        const dropZone = document.getElementById('dropZone');
        const videoInput = document.getElementById('videoInput');
        const editorArea = document.getElementById('editorArea');
        const sourceVideo = document.getElementById('sourceVideo');
        const outputCanvas = document.getElementById('outputCanvas');
        const ctx = outputCanvas.getContext('2d', { willReadFrequently: true });
        
        // Controls
        const thresholdInput = document.getElementById('threshold');
        const thresholdVal = document.getElementById('thresholdVal');
        const alphaBoostInput = document.getElementById('alphaBoost');
        const alphaBoostVal = document.getElementById('alphaBoostVal');
        const generateBtn = document.getElementById('generateBtn');
        const fpsSelect = document.getElementById('fpsSelect');
        
        // Progress
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressText = document.getElementById('progressText');
        const statusBadge = document.getElementById('statusBadge');
        
        // Result
        const resultArea = document.getElementById('resultArea');
        const resultGif = document.getElementById('resultGif');
        const downloadBtn = document.getElementById('downloadBtn');

        // State
        let isProcessing = false;
        let animationFrameId;
        let gifWorkerBlobURL = null;

        // --- Setup GIF Worker (CORS Workaround) ---
        // We fetch the worker code and create a local blob URL so it works in iframes/sandboxes
        async function setupGifWorker() {
            try {
                const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                const workerCode = await response.text();
                const blob = new Blob([workerCode], { type: 'application/javascript' });
                gifWorkerBlobURL = URL.createObjectURL(blob);
            } catch (e) {
                console.error("Failed to load GIF worker", e);
                // Fallback: try to just assume it's available if fetch fails (rare)
                gifWorkerBlobURL = 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js';
            }
        }
        setupGifWorker();

        // --- Event Listeners ---
        
        // Drag & Drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        videoInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        // Sliders
        thresholdInput.addEventListener('input', (e) => thresholdVal.innerText = e.target.value);
        alphaBoostInput.addEventListener('input', (e) => alphaBoostVal.innerText = e.target.value);

        // --- Core Functions ---

        function handleFile(file) {
            if (!file.type.startsWith('video/')) {
                alert('Please upload a video file (MP4, WEBM).');
                return;
            }

            const url = URL.createObjectURL(file);
            sourceVideo.src = url;
            
            sourceVideo.onloadedmetadata = () => {
                // Resize logic: scale down if huge to save performance
                let w = sourceVideo.videoWidth;
                let h = sourceVideo.videoHeight;
                const MAX_WIDTH = 480; // Reasonable for GIF
                
                if (w > MAX_WIDTH) {
                    const ratio = MAX_WIDTH / w;
                    w = MAX_WIDTH;
                    h = Math.round(sourceVideo.videoHeight * ratio);
                }

                outputCanvas.width = w;
                outputCanvas.height = h;

                // UI updates
                editorArea.classList.remove('hidden');
                dropZone.classList.add('hidden');
                
                sourceVideo.play();
                drawFrame();
            };
        }

        function processFrame() {
            // Draw original frame
            ctx.drawImage(sourceVideo, 0, 0, outputCanvas.width, outputCanvas.height);
            
            // Get pixel data
            const frame = ctx.getImageData(0, 0, outputCanvas.width, outputCanvas.height);
            const l = frame.data.length;
            const data = frame.data;
            
            const threshold = parseInt(thresholdInput.value);
            const boost = parseFloat(alphaBoostInput.value);

            // MAGIC ALGORITHM: Luma to Alpha
            for (let i = 0; i < l; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // Calculate brightness (Luma)
                // Using standard weights for human perception, or simple max for "glow"
                // For a glowing logo, simple Max(r,g,b) is often best to preserve color intensity
                
                let brightness = Math.max(r, g, b);

                // Apply threshold: if brightness is very low, it's background
                if (brightness < threshold) {
                    data[i + 3] = 0; // Transparent
                } else {
                    // It's part of the logo/glow. 
                    // To make the background transparent but keep the glow:
                    // We set Alpha based on brightness.
                    // Darker pixels (outer glow) become more transparent.
                    // Brighter pixels (core logo) become opaque.
                    
                    let newAlpha = brightness * boost;
                    if (newAlpha > 255) newAlpha = 255;
                    
                    data[i + 3] = newAlpha;
                }
            }
            
            ctx.putImageData(frame, 0, 0);
        }

        function drawFrame() {
            if (sourceVideo.paused || sourceVideo.ended) {
                // Keep loop running to update if sliders change even when paused
                if (!isProcessing) requestAnimationFrame(drawFrame); 
                else return; // If processing, let the processing loop handle it
            }
            
            if (!isProcessing) {
                processFrame();
                requestAnimationFrame(drawFrame);
            }
        }

        // --- GIF Generation ---

        generateBtn.addEventListener('click', async () => {
            if (isProcessing) return;
            isProcessing = true;
            
            // UI Update
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            progressContainer.classList.remove('hidden');
            resultArea.classList.add('hidden');
            statusBadge.classList.remove('hidden');
            
            // Setup GIF
            const fps = parseInt(fpsSelect.value);
            const gif = new GIF({
                workers: 2,
                quality: 10,
                width: outputCanvas.width,
                height: outputCanvas.height,
                workerScript: gifWorkerBlobURL,
                transparent: 0x000000 // Help library identify transparent color
            });

            // Prepare Video for Recording
            sourceVideo.pause();
            sourceVideo.currentTime = 0;
            
            const duration = sourceVideo.duration;
            const totalFrames = Math.floor(duration * fps);
            const interval = 1 / fps;
            
            let currentFrame = 0;

            const recordLoop = () => {
                if (currentFrame >= totalFrames) {
                    // Finish
                    progressText.innerText = "Rendering GIF...";
                    gif.render();
                    return;
                }

                // Seek video
                sourceVideo.currentTime = currentFrame * interval;
                
                // Wait for seek (using 'seeked' event is safer but slower, simple timeout works for local usually)
                // Let's use a small one-off event listener for robustness
                const onSeeked = () => {
                    processFrame(); // Process the frame (remove background)
                    gif.addFrame(ctx, {copy: true, delay: 1000 / fps});
                    
                    // Update UI
                    currentFrame++;
                    const percent = Math.round((currentFrame / totalFrames) * 100);
                    progressBar.style.width = `${percent}%`;
                    progressPercent.innerText = `${percent}%`;

                    // Next frame
                    recordLoop(); 
                };

                // Trigger seek
                // Need to handle if seek doesn't actually need to change time (start)
                if (Math.abs(sourceVideo.currentTime - (currentFrame * interval)) < 0.01 && currentFrame > 0) {
                     // Already there? just fire (rare)
                     onSeeked();
                } else {
                     sourceVideo.oneTimeSeekHandler = onSeeked;
                }
            };
            
            // Hook into video seek event
            sourceVideo.addEventListener('seeked', function handler() {
                if (sourceVideo.oneTimeSeekHandler) {
                    sourceVideo.oneTimeSeekHandler();
                    sourceVideo.oneTimeSeekHandler = null;
                }
            });

            // GIF Events
            gif.on('finished', (blob) => {
                const gifUrl = URL.createObjectURL(blob);
                resultGif.src = gifUrl;
                downloadBtn.href = gifUrl;
                
                // Reset UI
                isProcessing = false;
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                statusBadge.classList.add('hidden');
                resultArea.classList.remove('hidden');
                progressText.innerText = "Complete!";
                
                // Scroll to result
                resultArea.scrollIntoView({ behavior: 'smooth' });
                
                // Restart preview
                sourceVideo.play();
                drawFrame();
            });

            // Start recording
            recordLoop();
        });

    </script>
</body>
</html>

