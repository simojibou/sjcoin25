<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SJ Store Profile</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@6.26.0/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-black text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
            authDomain: "sj-one.firebaseapp.com",
            databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
            projectId: "sj-one",
            storageBucket: "sj-one.appspot.com",
            messagingSenderId: "426335553508",
            appId: "1:426335553508:web:248f76772f6f78419ca9f1",
            measurementId: "G-YQTVZQWXGB"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function Profile() {
            const [user, setUser] = useState(null);
            const [products, setProducts] = useState([]);
            const [isEditing, setIsEditing] = useState(false);
            const [newName, setNewName] = useState('');
            const [newImage, setNewImage] = useState('');

            useEffect(() => {
                // Get current user
                const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {
                    if (currentUser) {
                        // Fetch user data
                        const userDoc = await db.collection('Users').doc(currentUser.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            setUser(userData);
                            setNewName(userData.username);
                            setNewImage(userData.imageURL);

                            // Fetch user's products
                            const productsSnapshot = await db.collection('Product')
                                .where('id', '==', currentUser.uid)
                                .get();
                            const userProducts = productsSnapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setProducts(userProducts);
                        }
                    }
                });

                // Get profile from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const username = urlParams.get('u');
                if (username) {
                    // Fetch user by username
                    db.collection('Users')
                        .where('username', '==', username)
                        .get()
                        .then(async (querySnapshot) => {
                            if (!querySnapshot.empty) {
                                const userData = querySnapshot.docs[0].data();
                                setUser(userData);

                                // Fetch products for this user
                                const productsSnapshot = await db.collection('Product')
                                    .where('id', '==', userData.id)
                                    .get();
                                const userProducts = productsSnapshot.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));
                                setProducts(userProducts);
                            }
                        });
                }

                return () => unsubscribe();
            }, []);

            const handleEditProfile = async () => {
                if (isEditing) {
                    try {
                        await db.collection('Users').doc(user.id).update({
                            username: newName,
                            imageURL: newImage
                        });
                        setUser({ ...user, username: newName, imageURL: newImage });
                        setIsEditing(false);
                    } catch (error) {
                        console.error('Error updating profile:', error);
                    }
                } else {
                    setIsEditing(true);
                }
            };

            const copyProfileLink = () => {
                const profileLink = `https://sjstore.com/u/${user.username}`;
                navigator.clipboard.writeText(profileLink);
                alert('Profile link copied to clipboard!');
            };

            if (!user) return <div className="text-center mt-10">Loading...</div>;

            return (
                <div className="max-w-4xl mx-auto p-4">
                    {/* Profile Header */}
                    <div className="flex items-center space-x-4 mb-6">
                        <img 
                            src={decodeURIComponent(user.imageURL)} 
                            alt="Profile" 
                            className="w-24 h-24 rounded-full object-cover"
                        />
                        <div>
                            {isEditing ? (
                                <div>
                                    <input 
                                        type="text" 
                                        value={newName} 
                                        onChange={(e) => setNewName(e.target.value)}
                                        className="border p-2 mb-2 w-full bg-gray-800 text-white border-gray-600"
                                        placeholder="Enter new name"
                                    />
                                    <input 
                                        type="text" 
                                        value={newImage} 
                                        onChange={(e) => setNewImage(e.target.value)}
                                        className="border p-2 mb-2 w-full bg-gray-800 text-white border-gray-600"
                                        placeholder="Enter new image URL"
                                    />
                                </div>
                            ) : (
                                <div>
                                    <h1 className="text-2xl font-bold">{user.username}</h1>
                                    <p className="text-gray-400">{products.length} products posted</p>
                                </div>
                            )}
                            <div className="flex space-x-2 mt-2">
                                <button 
                                    onClick={handleEditProfile}
                                    className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                >
                                    {isEditing ? 'Save Profile' : 'Edit Profile'}
                                </button>
                                <button 
                                    onClick={copyProfileLink}
                                    className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                                >
                                    Share Profile
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Product Grid */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {products.map(product => (
                            <div key={product.pId} className="border rounded-lg overflow-hidden bg-gray-800 border-gray-600">
                                <img 
                                    src={product.photo} 
                                    alt={product.title}
                                    className="w-full h-48 object-cover"
                                />
                                <div className="p-4">
                                    <h3 className="font-semibold">{product.title}</h3>
                                    <p className="text-gray-400">${product.price}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<Profile />, document.getElementById('root'));
    </script>
</body>
</html>
