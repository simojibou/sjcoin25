<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SJ STORE â€” Profile</title>
  <style>
    :root {
      --bg: #000;
      --card: #1f1f1f;
      --muted: #a0a0a0;
      --text: #fff;
      --error: #ff4d4d;
    }
    body {
      font-family: system-ui, Arial;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 12px;
    }
    header.top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }
    .brand {
      font-weight: 700;
    }
    .btn {
      background: #333;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      border: 0;
      cursor: pointer;
    }
    .btn:hover {
      background: #444;
    }
    .profile-card {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      display: flex;
      gap: 16px;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    .avatar {
      width: 84px;
      height: 84px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #333;
    }
    .profile-info {
      flex: 1;
    }
    .name {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
    }
    .meta {
      color: var(--muted);
      margin-top: 4px;
    }
    .actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-top: 12px;
    }
    .card {
      background: var(--card);
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid #333;
    }
    .card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }
    .card-body {
      padding: 6px;
      font-size: 13px;
    }
    .price {
      font-weight: 700;
      color: #fff;
    }
    .post-form {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      margin-top: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.2);
    }
    .post-form label {
      display: block;
      margin-bottom: 4px;
    }
    .post-form input, .post-form textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #333;
      color: #fff;
    }
    .post-form input[type="file"] {
      padding: 4px;
    }
    @media (max-width: 600px) {
      .grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .avatar {
        width: 66px;
        height: 66px;
      }
    }
    .hidden {
      display: none;
    }
    .small {
      font-size: 13px;
      color: var(--muted);
    }
    .error {
      color: var(--error);
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="top">
      <div class="brand">SJ STORE</div>
      <div>
        <button id="btnSign" class="btn">Sign In</button>
      </div>
    </header>
    <section id="profileSection" class="hidden">
      <div class="profile-card">
        <img id="profilePic" class="avatar" src="https://via.placeholder.com/150" alt="avatar">
        <div class="profile-info">
          <p id="displayName" class="name">Username</p>
          <p id="productCount" class="meta">0 products</p>
          <div class="actions">
            <button id="btnShare" class="btn">Share Link</button>
            <button id="btnPost" class="btn">Post Product</button>
          </div>
        </div>
      </div>
      <div id="postForm" class="post-form hidden">
        <h3>Post a Product</h3>
        <label>Title</label>
        <input id="productTitle" type="text" placeholder="Product Title">
        <label>Price ($)</label>
        <input id="productPrice" type="number" placeholder="Price in USD">
        <label>Description</label>
        <textarea id="productDesc" placeholder="Product Description"></textarea>
        <label>Product Photo</label>
        <input id="productPhoto" type="file" accept="image/*">
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button id="saveProduct" class="btn">Post</button>
          <button id="cancelPost" class="btn" style="background:#777">Cancel</button>
        </div>
        <p id="postMsg" class="small"></p>
      </div>
      <div id="productsGrid" class="grid"></div>
    </section>
    <section id="publicProfile" class="hidden">
      <p class="small">Viewing public profile</p>
      <div class="profile-card">
        <img id="publicPic" class="avatar" src="https://via.placeholder.com/150" alt="avatar">
        <div class="profile-info">
          <p id="publicName" class="name">Name</p>
          <p id="publicProductCount" class="meta">0 products</p>
          <div class="actions">
            <button id="btnSharePublic" class="btn">Share Link</button>
          </div>
        </div>
      </div>
      <div id="publicGrid" class="grid"></div>
    </section>
    <p id="status" class="small" style="margin-top:12px"></p>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, getDoc, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
      authDomain: "sj-one.firebaseapp.com",
      databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
      projectId: "sj-one",
      storageBucket: "sj-one.appspot.com",
      messagingSenderId: "426335553508",
      appId: "1:426335553508:web:248f76772f6f78419ca9f1",
      measurementId: "G-YQTVZQWXGB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);
    const storage = getStorage(app);

    const btnSign = document.getElementById('btnSign');
    const profileSection = document.getElementById('profileSection');
    const profilePic = document.getElementById('profilePic');
    const displayName = document.getElementById('displayName');
    const productCount = document.getElementById('productCount');
    const productsGrid = document.getElementById('productsGrid');
    const btnShare = document.getElementById('btnShare');
    const btnPost = document.getElementById('btnPost');
    const postForm = document.getElementById('postForm');
    const productTitle = document.getElementById('productTitle');
    const productPrice = document.getElementById('productPrice');
    const productDesc = document.getElementById('productDesc');
    const productPhoto = document.getElementById('productPhoto');
    const saveProduct = document.getElementById('saveProduct');
    const cancelPost = document.getElementById('cancelPost');
    const postMsg = document.getElementById('postMsg');
    const status = document.getElementById('status');
    const publicProfile = document.getElementById('publicProfile');
    const publicPic = document.getElementById('publicPic');
    const publicName = document.getElementById('publicName');
    const publicProductCount = document.getElementById('publicProductCount');
    const publicGrid = document.getElementById('publicGrid');
    const btnSharePublic = document.getElementById('btnSharePublic');

    let currentUser = null;
    let currentUserDoc = null;

    btnSign.addEventListener('click', async () => {
      if (!auth.currentUser) {
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          profilePic.src = user.photoURL || 'https://via.placeholder.com/150';
          displayName.textContent = user.displayName || user.email.split('@')[0];
          const usersRef = doc(db, 'Users', user.uid);
          try {
            await setDoc(usersRef, {
              id: user.uid,
              username: user.displayName || user.email.split('@')[0],
              email: user.email || '',
              imageURL: user.photoURL || '',
              createdAt: new Date().toISOString(),
              signup_type: 'Google',
              active: true,
              isOnline: 1,
              lastSeen: new Date().toISOString()
            }, { merge: true });
            console.log('User doc created/updated');
          } catch (firestoreError) {
            console.error('Firestore write error:', firestoreError);
            status.textContent = `Signed in, but profile save failed: ${firestoreError.message}. Check Firestore rules.`;
            status.classList.add('error');
          }
          currentUser = user;
          currentUserDoc = (await getDoc(usersRef)).data();
          showOwnProfile(user.uid);
        } catch (authError) {
          console.error('Auth error:', authError);
          status.textContent = `Sign-in failed: ${authError.message}. Check Firebase Authentication settings.`;
          status.classList.add('error');
        }
      } else {
        try {
          await signOut(auth);
        } catch (e) {
          console.error('Sign-out error:', e);
          status.textContent = `Sign-out failed: ${e.message}`;
          status.classList.add('error');
        }
      }
    });

    onAuthStateChanged(auth, async user => {
      if (user) {
        btnSign.textContent = 'Sign Out';
        postForm.classList.remove('hidden');
        currentUser = user;
        const usersRef = doc(db, 'Users', user.uid);
        try {
          const uSnap = await getDoc(usersRef);
          if (!uSnap.exists()) {
            await setDoc(usersRef, {
              id: user.uid,
              username: user.displayName || user.email.split('@')[0],
              email: user.email || '',
              imageURL: user.photoURL || '',
              createdAt: new Date().toISOString(),
              signup_type: 'Google',
              active: true,
              isOnline: 1,
              lastSeen: new Date().toISOString()
            });
          }
          currentUserDoc = uSnap.data();
          showOwnProfile(user.uid);
        } catch (e) {
          console.error('Firestore access error:', e);
          status.textContent = `Profile load failed: ${e.message}. Using Google data. Check Firestore rules.`;
          status.classList.add('error');
          profilePic.src = user.photoURL || 'https://via.placeholder.com/150';
          displayName.textContent = user.displayName || user.email.split('@')[0];
          showOwnProfile(user.uid);
        }
      } else {
        btnSign.textContent = 'Sign In';
        postForm.classList.add('hidden');
        currentUser = null;
        currentUserDoc = null;
        profileSection.classList.add('hidden');
        publicProfile.classList.add('hidden');
        status.textContent = 'Click "Sign In" to view or post products, or open a public profile link /u/username';
        status.classList.remove('error');
      }
    });

    btnPost.addEventListener('click', () => {
      postMsg.textContent = '';
      postForm.classList.toggle('hidden');
    });

    cancelPost.addEventListener('click', () => {
      postForm.classList.add('hidden');
      productTitle.value = '';
      productPrice.value = '';
      productDesc.value = '';
      productPhoto.value = '';
      postMsg.textContent = '';
    });

    saveProduct.addEventListener('click', async () => {
      if (!currentUser) {
        postMsg.textContent = 'Please sign in to post a product';
        postMsg.classList.add('error');
        return;
      }
      const title = productTitle.value.trim();
      const price = productPrice.value.trim();
      const desc = productDesc.value.trim();
      const file = productPhoto.files[0];
      if (!title || !price || !desc || !file) {
        postMsg.textContent = 'Please fill all fields and select a photo';
        postMsg.classList.add('error');
        return;
      }
      postMsg.textContent = 'Posting product...';
      try {
        const pId = Date.now().toString();
        let photoURL = '';
        if (file) {
          const path = `product_photos/${currentUser.uid}-${pId}`;
          const sRef = storageRef(storage, path);
          const uploadRes = await uploadBytes(sRef, file);
          photoURL = await getDownloadURL(uploadRes.ref);
        }
        await addDoc(collection(db, 'Product'), {
          id: currentUser.uid,
          pId: pId,
          title: title,
          price: price,
          des: desc,
          photo: photoURL
        });
        postMsg.textContent = 'Product posted successfully';
        postMsg.classList.remove('error');
        productTitle.value = '';
        productPrice.value = '';
        productDesc.value = '';
        productPhoto.value = '';
        postForm.classList.add('hidden');
        showOwnProfile(currentUser.uid); // Refresh product grid
      } catch (e) {
        console.error('Product post error:', e);
        postMsg.textContent = `Failed to post product: ${e.message}. Check Firestore/Storage rules.`;
        postMsg.classList.add('error');
      }
    });

    async function showOwnProfile(uid) {
      profileSection.classList.remove('hidden');
      publicProfile.classList.add('hidden');
      status.textContent = 'Loading profile...';
      try {
        const uRef = doc(db, 'Users', uid);
        const uSnap = await getDoc(uRef);
        if (uSnap.exists()) {
          const data = uSnap.data();
          profilePic.src = decodeURIComponent(currentUser.photoURL || data.imageURL || 'https://via.placeholder.com/150');
          displayName.textContent = currentUser.displayName || data.username || 'User';
          await loadProductsByUser(uid, productsGrid, productCount);
          status.textContent = '';
        } else {
          status.textContent = 'User profile not found.';
          status.classList.add('error');
        }
      } catch (e) {
        console.error('Profile load error:', e);
        status.textContent = `Failed to load profile: ${e.message}. Check Firestore rules.`;
        status.classList.add('error');
      }
    }

    async function loadProductsByUser(uid, containerEl, countEl) {
      containerEl.innerHTML = '';
      countEl.textContent = 'Loading...';
      try {
        const prodCol = collection(db, 'Product');
        const q = query(prodCol, where('id', '==', uid));
        const snap = await getDocs(q);
        const items = [];
        snap.forEach(d => items.push(d.data()));
        countEl.textContent = `${items.length} product${items.length === 1 ? '' : 's'}`;
        if (items.length === 0) {
          containerEl.innerHTML = `<div class="small" style="padding:12px">No products to display</div>`;
          return;
        }
        items.sort((a, b) => (b.pId || 0) - (a.pId || 0));
        for (const it of items) {
          const card = document.createElement('div'); card.className = 'card';
          const img = document.createElement('img'); img.src = it.photo || 'https://via.placeholder.com/300';
          const body = document.createElement('div'); body.className = 'card-body';
          body.innerHTML = `<div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(it.title || 'Untitled')}</div>
                            <div class="price">$${escapeHtml(it.price || '0')}</div>`;
          card.appendChild(img); card.appendChild(body);
          containerEl.appendChild(card);
        }
      } catch (e) {
        console.error('Product load error:', e);
        countEl.textContent = `Error loading products: ${e.message}`;
        countEl.classList.add('error');
      }
    }

    btnShare.addEventListener('click', async () => {
      if (!currentUserDoc) return;
      const username = (currentUser.displayName || currentUserDoc.username || currentUser.uid).replace(/\s+/g, '');
      const url = `${location.origin}/u/${encodeURIComponent(username)}`;
      try {
        await navigator.clipboard.writeText(url);
        alert('Profile link copied: ' + url);
      } catch (e) {
        prompt('Copy the link manually:', url);
      }
    });

    btnSharePublic.addEventListener('click', async () => {
      const username = publicName.dataset.username;
      const url = `${location.origin}/u/${encodeURIComponent(username)}`;
      try {
        await navigator.clipboard.writeText(url);
        alert('Link copied: ' + url);
      } catch (e) {
        prompt('Copy the link:', url);
      }
    });

    async function handleRouting() {
      const path = location.pathname || '/';
      if (path.startsWith('/u/')) {
        const usernameParam = decodeURIComponent(path.replace('/u/', ''));
        await showPublicByUsername(usernameParam);
      } else {
        const params = new URLSearchParams(location.search);
        if (params.has('uid')) {
          const uid = params.get('uid');
          await showPublicByUid(uid);
        } else {
          if (auth.currentUser) {
            showOwnProfile(auth.currentUser.uid);
          } else {
            profileSection.classList.add('hidden');
            publicProfile.classList.add('hidden');
            status.textContent = 'Click "Sign In" to view or post products, or open a public profile link /u/username';
            status.classList.remove('error');
          }
        }
      }
    }

    async function showPublicByUsername(usernameParam) {
      status.textContent = 'Loading public profile...';
      try {
        const usersCol = collection(db, 'Users');
        const q = query(usersCol, where('username', '==', usernameParam));
        const snap = await getDocs(q);
        if (snap.empty) {
          status.textContent = 'User not found: ' + usernameParam;
          status.classList.add('error');
          return;
        }
        const docu = snap.docs[0];
        const u = docu.data();
        displayPublicProfile(u);
      } catch (e) {
        console.error('Public profile load error:', e);
        status.textContent = `Error loading profile: ${e.message}. Check Firestore rules.`;
        status.classList.add('error');
      }
    }

    async function showPublicByUid(uid) {
      status.textContent = 'Loading public profile...';
      try {
        const uRef = doc(db, 'Users', uid);
        const uSnap = await getDoc(uRef);
        if (!uSnap.exists()) {
          status.textContent = 'User not found';
          status.classList.add('error');
          return;
        }
        const u = uSnap.data();
        displayPublicProfile(u);
      } catch (e) {
        console.error('Public profile load error:', e);
        status.textContent = `Error loading profile: ${e.message}. Check Firestore rules.`;
        status.classList.add('error');
      }
    }

    async function displayPublicProfile(u) {
      publicProfile.classList.remove('hidden');
      profileSection.classList.add('hidden');
      publicPic.src = decodeURIComponent(u.imageURL || 'https://via.placeholder.com/150');
      publicName.textContent = u.username || 'User';
      publicName.dataset.username = u.username || u.id;
      await loadProductsByUser(u.id, publicGrid, publicProductCount);
      status.textContent = '';
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;');
    }

    window.addEventListener('load', handleRouting);
    window.addEventListener('popstate', handleRouting);
  </script>
</body>
</html>
