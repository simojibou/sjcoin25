<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SJ Delivery - Professional Panel</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155' }, 
                        brand: { 500: '#6366f1', 600: '#4f46e5' } 
                    },
                    animation: {
                        'enter': 'enter 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'toast-in': 'toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'toast-out': 'toastOut 0.3s ease-in forwards',
                    },
                    keyframes: {
                        enter: { from: { opacity: 0, transform: 'scale(0.98)' }, to: { opacity: 1, transform: 'scale(1)' } },
                        slideUp: { from: { opacity: 0, transform: 'translateY(20px)' }, to: { opacity: 1, transform: 'translateY(0)' } },
                        toastIn: { from: { opacity: 0, transform: 'translateY(-20px) scale(0.9)' }, to: { opacity: 1, transform: 'translateY(0) scale(1)' } },
                        toastOut: { from: { opacity: 1, transform: 'scale(1)' }, to: { opacity: 0, transform: 'scale(0.9)' } }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { background-color: #020617; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px); }
        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus, input:-webkit-autofill:active{
            -webkit-box-shadow: 0 0 0 30px #1e293b inset !important; -webkit-text-fill-color: white !important; transition: background-color 5000s ease-in-out 0s;
        }
    </style>
</head>
<body class="text-slate-200 h-screen flex items-center justify-center selection:bg-brand-500 selection:text-white">

    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-max max-w-[90%] pointer-events-none"></div>

    <div class="fixed inset-0 z-0 overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-brand-600/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-purple-600/20 rounded-full blur-[100px]"></div>
    </div>

    <div id="root" class="w-full max-w-md h-full sm:h-[92vh] glass-panel sm:rounded-[2.5rem] shadow-2xl relative flex flex-col overflow-hidden ring-1 ring-white/10 z-10 transition-all duration-300"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
            authDomain: "sj-one.firebaseapp.com",
            databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
            projectId: "sj-one",
            storageBucket: "sj-one.appspot.com",
            messagingSenderId: "426335553508",
            appId: "1:426335553508:web:248f76772f6f78419ca9f1"
        };

        // --- âš ï¸ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø¶Ø¹ Ù…ÙØªØ§Ø­ VAPID Ù‡Ù†Ø§ Ù„ØªØ¹Ù…Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ---
        const VAPID_KEY = "Ø¶Ø¹_ÙƒÙˆØ¯_VAPID_Ù‡Ù†Ø§"; 

        const AUTHORIZED_STAFF = ['simo.jibou@gmail.com', 'manager@gmail.com', 'admin2@gmail.com'].map(e => e.toLowerCase());

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let messaging;
        try { messaging = getMessaging(app); } catch(e) { console.warn("FCM not supported"); }

        // --- ðŸ”Š Sound & Toast Logic ---
        const SOUND_URL = "https://cdn.freesound.org/previews/235/235911_2391840-lq.mp3"; 
        const audio = new Audio(SOUND_URL);
        
        const playDing = () => {
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio blocked"));
        };

        window.showToast = (title, msg) => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = "bg-slate-800/90 backdrop-blur-md border border-white/10 text-white px-4 py-3 rounded-2xl shadow-xl shadow-black/20 text-sm font-medium flex items-center gap-3 animate-toast-in pointer-events-auto min-w-[250px] cursor-pointer hover:bg-slate-700/90 transition";
            el.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-brand-500/20 text-brand-400 flex items-center justify-center shrink-0"><i data-lucide="bell" class="w-4 h-4"></i></div>
                <div>
                    <div class="font-bold text-xs uppercase tracking-wide opacity-70">${title}</div>
                    <div class="text-sm">${msg}</div>
                </div>`;
            el.onclick = () => el.remove();
            container.appendChild(el);
            lucide.createIcons();
            setTimeout(() => {
                el.classList.replace('animate-toast-in', 'animate-toast-out');
                setTimeout(() => el.remove(), 300);
            }, 4000);
        };

        // --- ðŸš€ FCM Registration Logic ---
        const initNotifications = async (user) => {
            if (!messaging) return;
            try {
                // 1. Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    
                    // 2. ØªØ³Ø¬ÙŠÙ„ Service Worker (Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©)
                    // ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ù„Ù firebase-messaging-sw.js Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¬Ø§Ù†Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù
                    const reg = await navigator.serviceWorker.register('firebase-messaging-sw.js');
                    
                    // 3. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… VAPID Key
                    const token = await getToken(messaging, { 
                        serviceWorkerRegistration: reg,
                        vapidKey: VAPID_KEY 
                    });
                    
                    if (token) {
                        console.log("ðŸ”¥ FCM Token:", token);
                        // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        await setDoc(doc(db, 'users', user.uid), {
                            fcmToken: token,
                            lastLogin: serverTimestamp(),
                            email: user.email
                        }, { merge: true });
                    }
                } else {
                    window.showToast("Alert", "Notifications blocked via browser settings.");
                }
            } catch (error) {
                console.error("FCM Init Error:", error);
            }
        };

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙØªÙˆØ­ (Foreground)
        if (messaging) {
            onMessage(messaging, (payload) => {
                console.log('FCM Message Received:', payload);
                playDing();
                window.showToast(payload.notification.title, payload.notification.body);
            });
        }

        // --- State ---
        const state = {
            user: null, role: 'loading', view: 'login',
            services: [], chats: [], activeChat: null, activeMessages: [], 
            editId: null, form: { email: '', pass: '' }, msgInput: '',
            providerService: null, providerEarnings: 0,
            showBillForm: false, billAmount: '', billDesc: '', deliveryFee: 5, promoActive: false,
            stats: { totalOrders: 0, totalRevenue: 0, affiliates: [], totalUsers: 0 }
        };

        // --- Logic ---
        onAuthStateChanged(auth, async (user) => {
            state.user = user;
            if(!user) { state.role = 'guest'; state.view = 'login'; render(); return; }
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
            initNotifications(user);

            if (AUTHORIZED_STAFF.includes(user.email.toLowerCase())) {
                state.role = 'admin'; state.view = 'admin_list';
                subscribeServices(); subscribeAdminStats();
            } else {
                state.role = 'provider'; 
                subscribeServices();
            }
        });

        // --- Fallback Notification Logic (For active tabs) ---
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù…ÙØªÙˆØ­Ø§Ù‹
        // Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ØºÙ„Ù‚ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ‚ÙˆÙ… Cloud Function Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØªÙˆÙƒÙ†
        function notify(title, body) {
            playDing();
            window.showToast(title, body);
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù…ØªØµÙØ­ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ¯Ø¹Ù… Ø°Ù„Ùƒ Ø¨Ø¯ÙˆÙ† SW Ù„Ù„Ø­Ø¸Ø©)
            if(Notification.permission === "granted" && document.hidden) {
                new Notification(title, { 
                    body, 
                    icon: "https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/shared-0-sheet4.png" 
                });
            }
        }

        let unsubServices, unsubChats, unsubActiveMsg, unsubStatsOrders, unsubStatsUsers;

        function subscribeServices() {
            if(unsubServices) unsubServices();
            unsubServices = onSnapshot(collection(db, 'delivery_services'), (snap) => {
                state.services = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (state.role === 'provider' && state.user) {
                    const myService = state.services.find(s => s.ownerEmail && s.ownerEmail.toLowerCase() === state.user.email.toLowerCase());
                    if (myService) {
                        state.providerService = myService;
                        if(state.view !== 'chat') state.view = 'provider_list';
                        subscribeChats(state.user.email.toLowerCase());
                    } else { state.view = 'no_service'; }
                }
                render();
            });
        }

        function subscribeAdminStats() {
            if(unsubStatsOrders) unsubStatsOrders();
            unsubStatsOrders = onSnapshot(collection(db, 'delivery_chats'), (snap) => {
                state.stats.totalOrders = snap.size;
                let rev = 0;
                snap.forEach(d => {
                    if(d.data().status === 'delivered' && d.data().orderTotal) rev += parseFloat(d.data().orderTotal);
                });
                state.stats.totalRevenue = rev;
                render();
            });
            if(unsubStatsUsers) unsubStatsUsers();
            unsubStatsUsers = onSnapshot(collection(db, 'users'), (snap) => {
                state.stats.totalUsers = snap.size;
                const referralCounts = {};
                snap.forEach(doc => {
                    const data = doc.data();
                    if(data.referredBy) {
                        const code = data.referredBy.toUpperCase();
                        referralCounts[code] = (referralCounts[code] || 0) + 1;
                    }
                });
                state.stats.affiliates = Object.entries(referralCounts).map(([code, count]) => ({ code, count })).sort((a, b) => b.count - a.count);
                render();
            });
        }

        function subscribeChats(ownerEmail) {
            if(unsubChats) unsubChats();
            const q = query(collection(db, 'delivery_chats'), where('serviceOwnerEmail', '==', ownerEmail));
            let isFirstLoad = true;
            unsubChats = onSnapshot(q, (snap) => {
                if(!isFirstLoad) {
                    snap.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            if(data.lastUpdated && (Date.now() - data.lastUpdated.toMillis()) < 60000) {
                                notify("New Order!", `From: ${data.userEmail}`);
                            }
                        }
                    });
                }
                state.chats = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0));
                state.providerEarnings = state.chats.reduce((sum, chat) => (chat.status === 'delivered' && chat.orderTotal) ? sum + parseFloat(chat.orderTotal) : sum, 0);
                if (state.view === 'provider_list') render();
                isFirstLoad = false;
            });
        }

        function subscribeActiveChat(chatId) {
            if(unsubActiveMsg) unsubActiveMsg();
            const q = query(collection(db, 'delivery_chats', chatId, 'messages'), orderBy('timestamp', 'asc'));
            let isFirstLoad = true;
            unsubActiveMsg = onSnapshot(q, (snap) => {
                if(!isFirstLoad) {
                    snap.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            if (data.sender !== state.user.uid) {
                                if(document.hidden) notify(state.activeChat?.userEmail.split('@')[0], data.text);
                                else playDing();
                            }
                        }
                    });
                }
                state.activeMessages = snap.docs.map(d => d.data());
                render();
                scrollChat();
                isFirstLoad = false;
            });
        }

        // --- Actions ---
        window.input = (f, v) => state.form[f] = v;
        window.loginEmail = async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, state.form.email, state.form.pass); } catch(err) { alert(err.message); } };
        window.register = async () => { if(!confirm("Register?")) return; try { await createUserWithEmailAndPassword(auth, state.form.email, state.form.pass); } catch(err) { alert(err.message); } };
        window.loginGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()); 
        window.logout = () => signOut(auth);
        window.saveService = async (e) => {
            e.preventDefault(); const form = new FormData(e.target);
            const data = { name: form.get('name'), city: form.get('city'), type: form.get('type'), ownerEmail: form.get('ownerEmail').toLowerCase().trim(), assignedPassword: form.get('assignedPassword'), logo: form.get('logo'), lastUpdated: serverTimestamp() };
            if(state.editId) await updateDoc(doc(db, 'delivery_services', state.editId), data);
            else { data.createdAt = serverTimestamp(); await addDoc(collection(db, 'delivery_services'), data); }
            state.editId = null; state.view = 'admin_list'; render();
        };
        window.delService = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, 'delivery_services', id)); };
        window.editService = (id) => { state.editId = id; state.view = 'admin_edit'; render(); };
        window.nav = (v) => { state.view = v; state.editId = null; state.showBillForm = false; if(v !== 'chat' && unsubActiveMsg) { unsubActiveMsg(); unsubActiveMsg = null; state.activeMessages = []; } render(); };
        window.openChat = (id) => { state.activeChat = state.chats.find(c => c.id === id); state.view = 'chat'; state.activeMessages = []; render(); subscribeActiveChat(id); };
        window.chatInput = (v) => state.msgInput = v;
        window.toggleBill = () => {
            if(state.activeChat?.status === 'delivered') return alert("Order is already delivered!");
            state.showBillForm = !state.showBillForm;
            if (state.showBillForm) {
                const hasPromo = state.activeMessages.some(m => m.text?.toUpperCase().trim() === 'SJ CODE' && m.sender !== state.user.uid);
                state.promoActive = hasPromo;
                state.deliveryFee = hasPromo ? 0 : 5;
                setTimeout(() => document.getElementById('billAmount')?.focus(), 50);
            }
            render();
        };
        window.setBillAmount = (v) => { state.billAmount = v; render(); };
        window.setDeliveryFee = (v) => { state.deliveryFee = v; render(); };
        window.setBillDesc = (v) => state.billDesc = v;
        window.sendBill = async () => {
            if(!state.activeChat) return;
            const amt = parseFloat(state.billAmount); const fee = parseFloat(state.deliveryFee);
            if(!amt || amt <= 0) return alert("Invalid amount");
            const total = amt + fee;
            const msg = { type: 'bill', text: `Bill: $${total.toFixed(2)}`, amount: amt, deliveryFee: fee, total: total, description: state.billDesc.trim() || 'Order Total', sender: state.user.uid, status: 'pending', timestamp: serverTimestamp() };
            const chatId = state.activeChat.id;
            await addDoc(collection(db, 'delivery_chats', chatId, 'messages'), msg);
            await updateDoc(doc(db, 'delivery_chats', chatId), { lastMessage: `ðŸ’µ Bill: $${total.toFixed(2)}`, orderTotal: total, lastUpdated: serverTimestamp() });
            state.billAmount = ''; state.billDesc = ''; state.showBillForm = false; render();
        };
        window.markDone = async () => {
            if(!state.activeChat) return;
            if(!confirm("Are you sure you delivered this order?")) return;
            await updateDoc(doc(db, 'delivery_chats', state.activeChat.id), { status: 'delivered', completedAt: serverTimestamp() });
            state.activeChat.status = 'delivered';
            state.view = 'provider_list';
            render();
        };
        window.reply = async () => {
            const txt = state.msgInput.trim(); if(!txt || !state.activeChat) return;
            await addDoc(collection(db, 'delivery_chats', state.activeChat.id, 'messages'), { type: 'text', text: txt, sender: state.user.uid, timestamp: serverTimestamp() });
            await updateDoc(doc(db, 'delivery_chats', state.activeChat.id), { lastMessage: txt, lastUpdated: serverTimestamp() });
            state.msgInput = '';
        };
        function scrollChat() { setTimeout(() => { const el = document.getElementById('msgs'); if(el) el.scrollTop = el.scrollHeight; }, 50); }

        // --- Render ---
        function render() {
            const root = document.getElementById('root');
            let content = '';

            if (state.view === 'login') {
                content = `
                    <div class="flex flex-col items-center justify-center h-full p-8 animate-enter relative">
                        <div class="glass p-8 rounded-3xl w-full shadow-2xl border-t border-white/10">
                            <div class="flex flex-col items-center mb-8">
                                <div class="w-20 h-20 bg-gradient-to-tr from-brand-600 to-purple-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-brand-600/30 transform rotate-3">
                                    <i data-lucide="layout-grid" class="w-10 h-10 text-white"></i>
                                </div>
                                <h2 class="text-3xl font-bold text-white tracking-tight">SJ Delivery</h2>
                                <p class="text-slate-400 text-sm font-medium mt-1">Staff Management Portal</p>
                            </div>
                            <form onsubmit="loginEmail(event)" class="space-y-4">
                                <div class="relative group">
                                    <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-slate-500 group-focus-within:text-brand-500 transition-colors"></i>
                                    <input onchange="input('email',this.value)" type="email" placeholder="Email Address" class="w-full bg-slate-800/50 border border-slate-700/50 rounded-xl py-3.5 pl-12 pr-4 text-white placeholder-slate-500 outline-none focus:border-brand-500 focus:bg-slate-800 transition-all font-medium" required>
                                </div>
                                <div class="relative group">
                                    <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-slate-500 group-focus-within:text-brand-500 transition-colors"></i>
                                    <input onchange="input('pass',this.value)" type="password" placeholder="Password" class="w-full bg-slate-800/50 border border-slate-700/50 rounded-xl py-3.5 pl-12 pr-4 text-white placeholder-slate-500 outline-none focus:border-brand-500 focus:bg-slate-800 transition-all font-medium" required>
                                </div>
                                <button type="submit" class="w-full bg-gradient-to-r from-brand-600 to-purple-600 hover:from-brand-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-brand-900/40 active:scale-[0.98] mt-2">Access Dashboard</button>
                            </form>
                            <div class="mt-6 flex items-center justify-center gap-4 border-t border-white/5 pt-6">
                                <button onclick="loginGoogle()" class="p-3 bg-white/5 hover:bg-white/10 rounded-xl transition text-white border border-white/5"><i data-lucide="shield" class="w-5 h-5"></i></button>
                                <button type="button" onclick="register()" class="text-sm font-semibold text-slate-400 hover:text-white transition">Create new account</button>
                            </div>
                        </div>
                    </div>`;
            } else if (state.view === 'no_service') {
                content = `<div class="flex flex-col items-center justify-center h-full p-8 text-center animate-enter"><h2 class="text-2xl font-bold text-white mb-2">Access Restricted</h2><button onclick="logout()" class="px-8 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold border border-slate-700 transition">Return to Login</button></div>`;
            } else if (state.view === 'admin_list') {
                content = `
                    <div class="h-20 flex items-center justify-between px-6 shrink-0 z-20 glass sticky top-0">
                        <h2 class="font-bold text-lg text-white">Admin Panel</h2>
                        <button onclick="logout()" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-5 hide-scrollbar space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="glass p-5 rounded-2xl"><div class="flex items-center gap-2 text-brand-400 mb-2"><i data-lucide="shopping-cart" class="w-4 h-4"></i><span class="text-xs font-bold uppercase">Orders</span></div><span class="text-3xl font-bold text-white">${state.stats.totalOrders}</span></div>
                            <div class="glass p-5 rounded-2xl"><div class="flex items-center gap-2 text-emerald-400 mb-2"><i data-lucide="dollar-sign" class="w-4 h-4"></i><span class="text-xs font-bold uppercase">Revenue</span></div><span class="text-3xl font-bold text-white">$${state.stats.totalRevenue.toFixed(0)}</span></div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-sm text-slate-300 uppercase">Services</h3><button onclick="nav('admin_edit')" class="w-8 h-8 flex items-center justify-center bg-brand-600 rounded-lg text-white"><i data-lucide="plus" class="w-5 h-5"></i></button></div>
                            <div class="space-y-3">${state.services.map(s => `<div class="glass p-4 rounded-2xl flex items-center justify-between"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-slate-800 rounded-xl flex items-center justify-center overflow-hidden">${s.logo ? `<img src="${s.logo}" class="w-full h-full object-cover">` : `<i data-lucide="store" class="w-6 h-6 text-slate-500"></i>`}</div><div><h3 class="font-bold text-white">${s.name}</h3><span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded border border-white/5">${s.city}</span></div></div><div class="flex gap-2"><button onclick="editService('${s.id}')" class="p-2 text-slate-400 hover:text-white"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="delService('${s.id}')" class="p-2 text-slate-400 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`).join('')}</div>
                        </div>
                    </div>`;
            } else if (state.view === 'admin_edit') {
                const s = state.editId ? state.services.find(i => i.id === state.editId) : {};
                content = `<div class="h-20 flex items-center gap-4 px-6 shrink-0 glass sticky top-0 z-20"><button onclick="nav('admin_list')" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700 transition text-white"><i data-lucide="arrow-left" class="w-5 h-5"></i></button><h2 class="font-bold text-xl text-white">Edit Service</h2></div><div class="flex-1 overflow-y-auto p-6 hide-scrollbar animate-enter"><form onsubmit="saveService(event)" class="space-y-6"><div><label class="text-xs uppercase font-bold text-slate-500 ml-1 mb-1 block">Service Name</label><input name="name" value="${s.name||''}" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-white outline-none" required></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs uppercase font-bold text-slate-500 ml-1 mb-1 block">City</label><input name="city" value="${s.city||''}" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-white outline-none" required></div><div><label class="text-xs uppercase font-bold text-slate-500 ml-1 mb-1 block">Type</label><select name="type" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-white outline-none h-[58px]"><option value="food" ${s.type==='food'?'selected':''}>Food</option><option value="grocery" ${s.type==='grocery'?'selected':''}>Grocery</option><option value="delivery" ${s.type==='delivery'?'selected':''}>Delivery</option></select></div></div><div><label class="text-xs uppercase font-bold text-slate-500 ml-1 mb-1 block">Email Login</label><input name="ownerEmail" type="email" value="${s.ownerEmail||''}" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white outline-none font-mono text-sm" required></div><div><label class="text-xs uppercase font-bold text-slate-500 ml-1 mb-1 block">Password</label><input name="assignedPassword" value="${s.assignedPassword||''}" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-white outline-none font-mono text-sm" required></div><div><label class="text-xs uppercase font-bold text-slate-500 ml-1 mb-1 block">Logo Image URL</label><input name="logo" value="${s.logo||''}" class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-white outline-none"></div><button class="w-full py-4 bg-brand-600 rounded-xl font-bold text-white hover:bg-brand-500 transition">Save Changes</button></form></div>`;
            } else if (state.view === 'provider_list') {
                content = `
                    <div class="h-24 flex items-center justify-between px-6 shrink-0 bg-gradient-to-b from-slate-900 to-transparent z-20"><div><h2 class="font-bold text-2xl text-white tracking-tight">Orders</h2><p class="text-sm text-brand-400 font-medium flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${state.providerService?.city}</p></div><div class="flex gap-2"><button onclick="initNotifications(state.user)" class="w-10 h-10 flex items-center justify-center bg-slate-800 rounded-full text-brand-400 hover:text-white border border-slate-700 shadow-lg"><i data-lucide="bell" class="w-5 h-5"></i></button><button onclick="logout()" class="w-10 h-10 flex items-center justify-center bg-slate-800 rounded-full text-slate-400 hover:text-white border border-slate-700 shadow-lg"><i data-lucide="log-out" class="w-5 h-5"></i></button></div></div>
                    <div class="px-5 mb-6"><div class="bg-gradient-to-r from-emerald-600 to-teal-600 p-5 rounded-3xl shadow-xl shadow-emerald-900/50 relative overflow-hidden ring-1 ring-white/20"><div class="relative z-10 flex items-center justify-between"><div><p class="text-xs text-emerald-100 font-bold uppercase tracking-wider mb-1 opacity-90">Total Earnings</p><h3 class="text-3xl font-bold text-white tracking-tight">$${state.providerEarnings.toFixed(2)}</h3></div><div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-md shadow-inner border border-white/20"><i data-lucide="wallet" class="w-6 h-6 text-white"></i></div></div></div></div>
                    <div class="flex-1 overflow-y-auto px-5 pb-5 hide-scrollbar space-y-3">${state.chats.length === 0 ? `<div class="flex flex-col items-center justify-center py-20 text-slate-600"><i data-lucide="coffee" class="w-10 h-10 opacity-50"></i><p>No active orders</p></div>` : state.chats.map(c => `<button onclick="openChat('${c.id}')" class="w-full text-left glass p-4 rounded-2xl transition-all duration-300 animate-slide-up hover:bg-slate-800 border-l-4 ${c.status === 'delivered' ? 'border-l-green-500' : 'border-l-brand-500'} group relative overflow-hidden shadow-lg"><div class="flex justify-between items-start mb-2 relative z-10"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full ${c.status === 'delivered' ? 'bg-green-500/10 text-green-500' : 'bg-brand-500/10 text-brand-400'} flex items-center justify-center font-bold border border-white/5">${c.status === 'delivered' ? '<i data-lucide="check" class="w-5 h-5"></i>' : c.userEmail.charAt(0).toUpperCase()}</div><div class="min-w-0"><span class="font-bold text-white text-sm block truncate w-32">${c.userEmail.split('@')[0]}</span><span class="text-[10px] text-slate-400 bg-slate-900/50 px-1.5 py-0.5 rounded border border-slate-700">${c.city}</span></div></div><span class="text-xs text-slate-500 font-mono">${c.lastUpdated ? new Date(c.lastUpdated.seconds * 1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : 'Just now'}</span></div><p class="text-sm text-slate-300 pl-14 truncate opacity-90 group-hover:text-white transition">${c.lastMessage || 'New Order Request'}</p></button>`).join('')}</div>`;
            } else if (state.view === 'chat') {
                const msgs = state.activeMessages || [];
                const isDelivered = state.activeChat.status === 'delivered';
                content = `
                    <div class="h-20 flex items-center gap-4 px-4 bg-slate-900/80 backdrop-blur-md border-b border-white/5 shrink-0 z-20"><button onclick="nav('provider_list')" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-200 transition"><i data-lucide="arrow-left" class="w-5 h-5"></i></button><div class="flex-1 min-w-0"><h2 class="font-bold text-white text-base truncate">${state.activeChat.userEmail.split('@')[0]}</h2><div class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-full ${isDelivered ? 'bg-green-500' : 'bg-brand-500 animate-pulse'}"></span><p class="text-xs text-slate-400 font-medium">${isDelivered ? 'Order Completed' : 'Live Order'}</p></div></div>${!isDelivered ? `<button onclick="markDone()" class="bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-4 py-2 rounded-xl flex items-center gap-2 transition shadow-lg shadow-green-900/40 border border-green-500/50 active:scale-95"><i data-lucide="check-circle-2" class="w-4 h-4"></i> Complete</button>` : ''}</div>
                    <div id="msgs" class="flex-1 overflow-y-auto p-4 hide-scrollbar space-y-4 bg-slate-950/50">${msgs.length === 0 ? `<div class="text-center text-slate-600 mt-10 text-sm">Beginning of chat history</div>` : msgs.map(m => {
                        const isMe = m.sender === state.user.uid;
                        if(m.type === 'bill') return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'} animate-slide-up"><div class="w-64 bg-slate-800 rounded-3xl p-1 border border-slate-700 shadow-xl overflow-hidden relative"><div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-brand-500"></div><div class="bg-slate-900/50 rounded-[1.2rem] p-4"><div class="flex items-center gap-2 text-purple-400 mb-4 pb-3 border-b border-slate-700/50"><div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center"><i data-lucide="receipt" class="w-4 h-4"></i></div><span class="font-bold text-xs uppercase tracking-widest">Receipt</span></div><div class="space-y-2 mb-4"><div class="flex justify-between text-xs text-slate-400"><span>Subtotal</span><span class="text-white font-mono">$${m.amount.toFixed(2)}</span></div><div class="flex justify-between text-xs text-slate-400"><span>Fee</span><span class="${m.deliveryFee === 0 ? 'text-green-400 font-bold' : 'text-white font-mono'}">${m.deliveryFee === 0 ? 'FREE' : '$'+m.deliveryFee.toFixed(2)}</span></div></div><div class="flex justify-between items-end pt-3 border-t border-slate-700/50"><span class="text-sm font-medium text-slate-300">Total</span><span class="text-2xl font-bold text-white tracking-tight">$${(m.total||m.amount).toFixed(2)}</span></div></div></div></div>`;
                        if(m.type === 'order') return `<div class="flex justify-start animate-slide-up"><div class="bg-slate-800 border border-slate-700 rounded-3xl overflow-hidden w-72 shadow-2xl"><div class="bg-slate-900 p-4 flex justify-between items-center border-b border-slate-700"><span class="font-bold text-xs uppercase text-brand-400 flex items-center gap-2"><i data-lucide="shopping-bag" class="w-4 h-4"></i> New Order</span><span class="text-[10px] bg-brand-500/20 text-brand-300 px-2 py-1 rounded-full font-bold border border-brand-500/30">${m.items?.length||0} Items</span></div><div class="divide-y divide-slate-700/50 max-h-64 overflow-y-auto">${(m.items||[]).map(item => `<div class="flex items-center gap-3 p-3 hover:bg-white/5 transition"><div class="w-12 h-12 bg-slate-700 rounded-xl overflow-hidden shrink-0 border border-slate-600">${item.image ? `<img src="${item.image}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full"><i data-lucide="package" class="w-5 h-5 text-slate-500"></i></div>`}</div><div class="min-w-0 flex-1"><div class="text-sm font-bold text-slate-200 truncate">${item.name}</div><div class="text-xs text-slate-500 font-mono">Qty: ${item.qty}</div></div></div>`).join('')}</div></div></div>`;
                        if(m.type === 'location' && m.location) return `<div class="flex justify-start animate-slide-up"><a href="https://www.google.com/maps/search/?api=1&query=${m.location.lat},${m.location.lng}" target="_blank" class="block w-64 bg-slate-800 border border-slate-700 rounded-3xl p-2 shadow-xl hover:border-brand-500 transition group cursor-pointer"><div class="h-32 bg-slate-900 rounded-2xl flex items-center justify-center relative overflow-hidden"><div class="absolute inset-0 bg-[url('https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg')] bg-cover opacity-20 group-hover:scale-110 transition duration-700"></div><div class="z-10 bg-slate-800 p-3 rounded-full shadow-2xl border border-slate-600 group-hover:-translate-y-1 transition duration-300"><i data-lucide="map-pin" class="w-6 h-6 text-red-500 fill-current"></i></div></div><div class="px-3 py-3 flex justify-between items-center"><div><div class="text-xs font-bold text-white">Customer Location</div><div class="text-[10px] text-slate-500 font-mono mt-0.5">Tap to navigate</div></div><div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center group-hover:bg-brand-600 group-hover:text-white transition text-slate-400"><i data-lucide="navigation" class="w-4 h-4"></i></div></div></a></div>`;
                        return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'} animate-enter"><div class="max-w-[80%] px-5 py-3 rounded-2xl text-sm leading-relaxed shadow-sm ${isMe ? 'bg-brand-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-200 border border-slate-700 rounded-bl-none'}">${m.text}</div></div>`;
                    }).join('')}</div>
                    ${state.showBillForm ? `
                    <div class="bg-slate-900 border-t border-brand-500/50 p-5 animate-slide-up shadow-[0_-10px_40px_rgba(0,0,0,0.5)] z-30 rounded-t-3xl"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-white flex items-center gap-2 text-sm"><div class="w-6 h-6 rounded bg-brand-500/20 flex items-center justify-center"><i data-lucide="receipt" class="w-3 h-3 text-brand-400"></i></div> Create Bill</h3><button onclick="toggleBill()" class="w-6 h-6 bg-slate-800 rounded-full flex items-center justify-center hover:bg-slate-700 text-slate-400"><i data-lucide="x" class="w-3 h-3"></i></button></div>${state.promoActive ? `<div class="mb-4 px-3 py-2 bg-emerald-500/10 border border-emerald-500/20 rounded-xl flex items-center gap-2 text-xs text-emerald-400 font-bold"><i data-lucide="tag" class="w-3 h-3"></i> SJ CODE APPLIED (Free Delivery)</div>` : ''}<div class="grid grid-cols-2 gap-3 mb-3"><div class="relative"><label class="text-[10px] uppercase text-slate-500 font-bold absolute top-2 left-3">Subtotal</label><input id="billAmount" type="number" step="0.01" value="${state.billAmount}" oninput="setBillAmount(this.value)" placeholder="0.00" class="w-full bg-slate-800 border border-slate-700 rounded-xl pt-6 pb-2 px-3 text-white outline-none focus:border-brand-500 font-mono text-sm"></div><div class="relative"><label class="text-[10px] uppercase text-slate-500 font-bold absolute top-2 left-3">Fee</label><input type="number" step="0.01" value="${state.deliveryFee}" oninput="setDeliveryFee(this.value)" class="w-full bg-slate-800 border ${state.promoActive ? 'border-emerald-500/30 text-emerald-400' : 'border-slate-700 text-white'} rounded-xl pt-6 pb-2 px-3 outline-none focus:border-brand-500 font-mono text-sm"></div></div><div class="mb-4"><input type="text" value="${state.billDesc}" oninput="setBillDesc(this.value)" placeholder="Optional note (e.g. Pizza & Drinks)" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white outline-none focus:border-brand-500 text-sm placeholder-slate-600"></div><button onclick="sendBill()" class="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-3.5 rounded-xl transition flex justify-between px-6 shadow-lg shadow-brand-900/40 items-center group"><span>Send Bill</span><span class="bg-brand-700 px-2 py-1 rounded text-xs group-hover:bg-brand-600 transition">$${((parseFloat(state.billAmount)||0)+(parseFloat(state.deliveryFee)||0)).toFixed(2)}</span></button></div>` : `
                    <div class="p-3 bg-slate-900/90 border-t border-white/5 flex gap-2 shrink-0 items-center backdrop-blur-md z-30 pb-safe">${!isDelivered ? `<button onclick="toggleBill()" class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-brand-400 bg-slate-800 hover:bg-slate-700 rounded-xl transition border border-white/5"><i data-lucide="receipt" class="w-5 h-5"></i></button>` : ''}<div class="flex-1 relative"><input ${isDelivered ? 'disabled placeholder="Order Delivered"' : 'placeholder="Type a message..."'} value="${state.msgInput}" oninput="chatInput(this.value)" onkeyup="if(event.key==='Enter') reply()" type="text" class="w-full bg-slate-800 border border-white/5 rounded-xl px-4 py-3 focus:border-brand-500 outline-none text-white disabled:opacity-50 text-sm placeholder-slate-500 shadow-inner"></div><button onclick="reply()" ${isDelivered ? 'disabled' : ''} class="w-11 h-11 bg-brand-600 rounded-xl hover:bg-brand-500 text-white disabled:opacity-50 flex items-center justify-center shadow-lg shadow-brand-500/20 transition active:scale-95"><i data-lucide="send" class="w-5 h-5 ml-0.5"></i></button></div>`}
                    `;
            }
            root.innerHTML = content;
            lucide.createIcons();
        }
    </script>
</body>
</html>
