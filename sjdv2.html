<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SJ Delivery</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/shared-0-sheet4.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    height: { 'screen-dvh': '100dvh' },
                    padding: { 'safe': 'env(safe-area-inset-bottom)' },
                    animation: {
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'fade-in': 'fade 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        fade: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade { animation: fade 0.3s ease-out forwards; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Prevent Input Zoom on iOS */
        input, textarea { font-size: 16px !important; } 
    </style>
</head>
<body class="bg-gray-100 dark:bg-black text-gray-800 dark:text-gray-100 h-screen-dvh overflow-hidden flex justify-center">

    <!-- App Container -->
    <div id="app" class="w-full max-w-md h-full bg-white dark:bg-gray-900 shadow-xl relative flex flex-col overflow-hidden">
        <!-- Views rendered here -->
    </div>

    <!-- MAIN SCRIPT -->
    <script type="module">
        // Using stable Firebase v10.12.2 to ensure compatibility
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, addDoc, serverTimestamp, query, where, orderBy, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
            authDomain: "sj-one.firebaseapp.com",
            databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
            projectId: "sj-one",
            storageBucket: "sj-one.appspot.com",
            messagingSenderId: "426335553508",
            appId: "1:426335553508:web:248f76772f6f78419ca9f1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State Management ---
        const state = {
            user: null,
            currentView: 'loading',
            services: [],
            chats: {},
            selectedCity: null,
            activeService: null,
            draftOrder: [], // Stores items being added
            darkMode: localStorage.getItem('darkMode') === 'true',
            listeners: {
                services: null,
                chatsList: null,
                activeChat: null
            }
        };

        if(state.darkMode) document.documentElement.classList.add('dark');

        // --- VIEW ROUTER ---
        function setView(viewName) {
            state.currentView = viewName;
            const appEl = document.getElementById('app');
            
            // Clean up chat listener if leaving chat
            if (state.listeners.activeChat && viewName !== 'chat') {
                state.listeners.activeChat();
                state.listeners.activeChat = null;
            }

            // Render View
            switch(viewName) {
                case 'loading': appEl.innerHTML = renderLoading(); break;
                case 'login': appEl.innerHTML = renderLogin(); break;
                case 'cities': appEl.innerHTML = renderCities(); break;
                case 'services': appEl.innerHTML = renderServices(); break;
                case 'chat': 
                    appEl.innerHTML = renderChatLayout(); 
                    mountChatLogic(); 
                    break;
            }
            // Initialize Icons
            if(window.lucide) window.lucide.createIcons();
        }

        // --- AUTH & DATA LISTENERS ---
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                if(!state.listeners.services) subscribeServices();
                if(!state.listeners.chatsList) subscribeChatsList();
                // Default to cities if logged in
                if(state.currentView === 'loading' || state.currentView === 'login') setView('cities');
            } else {
                unsubscribeAll();
                setView('login');
            }
        });

        function subscribeServices() {
            state.listeners.services = onSnapshot(collection(db, 'delivery_services'), (snap) => {
                state.services = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if (state.currentView === 'cities') setView('cities');
                if (state.currentView === 'services') setView('services');
            });
        }

        function subscribeChatsList() {
            const q = query(collection(db, 'delivery_chats'), where('userId', '==', state.user.uid));
            state.listeners.chatsList = onSnapshot(q, (snap) => {
                const map = {};
                snap.forEach(d => map[d.data().serviceId] = {id: d.id, ...d.data()});
                state.chats = map;
                if (state.currentView === 'services') setView('services');
            });
        }

        function unsubscribeAll() {
            if(state.listeners.services) state.listeners.services();
            if(state.listeners.chatsList) state.listeners.chatsList();
            if(state.listeners.activeChat) state.listeners.activeChat();
            state.listeners = { services: null, chatsList: null, activeChat: null };
            state.services = [];
            state.chats = {};
        }

        // --- CHAT LOGIC ---
        function mountChatLogic() {
            const chatId = getChatId(state.user.uid, state.activeService.id);
            const container = document.getElementById('chat-messages');
            const msgsRef = collection(db, 'delivery_chats', chatId, 'messages');
            const q = query(msgsRef, orderBy('timestamp', 'asc'));

            state.listeners.activeChat = onSnapshot(q, (snapshot) => {
                let shouldScroll = false;
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        shouldScroll = true;
                        const msg = change.doc.data();
                        const isMe = msg.sender === state.user.uid;
                        const div = document.createElement('div');
                        
                        // 1. BILL MESSAGE
                        if(msg.type === 'bill') {
                             div.className = `flex justify-start mb-4 animate-fade`;
                             const isPromo = msg.deliveryFee === 0;
                             div.innerHTML = `
                                <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl p-4 shadow-md w-64">
                                    <div class="flex items-center gap-2 mb-3 text-purple-600 dark:text-purple-400 font-bold text-xs uppercase tracking-wider border-b border-gray-100 dark:border-gray-700 pb-2">
                                        <i data-lucide="receipt" class="w-4 h-4"></i> Payment Request
                                    </div>
                                    <div class="flex justify-between items-end">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Total</span>
                                        <span class="text-xl font-bold text-gray-900 dark:text-white">$${(msg.total || msg.amount || 0).toFixed(2)}</span>
                                    </div>
                                    ${isPromo ? '<div class="mt-2 text-[10px] text-emerald-500 font-bold">SJ CODE APPLIED</div>' : ''}
                                </div>`;
                        } 
                        // 2. ORDER MESSAGE (NEW)
                        else if (msg.type === 'order') {
                            const items = msg.items || [];
                            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-4 animate-fade`;
                            div.innerHTML = `
                                <div class="bg-white dark:bg-gray-800 border ${isMe ? 'border-blue-200 dark:border-blue-900' : 'border-gray-100 dark:border-gray-700'} rounded-2xl overflow-hidden shadow-sm w-64">
                                    <div class="${isMe ? 'bg-blue-600' : 'bg-gray-700'} px-4 py-2 flex justify-between items-center text-white">
                                        <div class="flex items-center gap-2 text-xs font-bold uppercase tracking-wider">
                                            <i data-lucide="clipboard-list" class="w-3.5 h-3.5"></i> Order
                                        </div>
                                        <span class="text-[10px] bg-white/20 px-1.5 py-0.5 rounded text-white font-mono">${items.length} items</span>
                                    </div>
                                    <div class="divide-y divide-gray-100 dark:divide-gray-700 max-h-48 overflow-y-auto">
                                        ${items.map(item => `
                                            <div class="flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-800/50">
                                                <div class="w-8 h-8 rounded bg-gray-100 dark:bg-gray-700 shrink-0 overflow-hidden">
                                                    ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full"><i data-lucide="package" class="w-4 h-4 text-gray-400"></i></div>`}
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <div class="text-xs font-bold text-gray-800 dark:text-gray-200 truncate">${item.name || 'Item'}</div>
                                                    <div class="text-[10px] text-gray-500">Qty: ${item.qty}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>`;
                        }
                        // 3. TEXT MESSAGE
                        else {
                            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'} mb-2 animate-fade`;
                            div.innerHTML = `
                                <div class="max-w-[75%] px-4 py-2 rounded-2xl text-sm shadow-sm ${
                                    isMe 
                                    ? 'bg-blue-600 text-white rounded-br-sm' 
                                    : 'bg-white dark:bg-gray-800 border dark:border-gray-700 text-gray-800 dark:text-gray-200 rounded-bl-sm'
                                }">${escapeHtml(msg.text)}</div>`;
                        }
                        container.appendChild(div);
                    }
                });
                
                if(shouldScroll) {
                    // Re-render icons for new messages
                    if(window.lucide) window.lucide.createIcons();
                    scrollToBottom();
                }
            });
        }

        // --- GLOBAL FUNCTIONS (Attached to Window for HTML access) ---

        window.loginGoogle = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); }
            catch(e) { console.error("Login failed", e); alert("Login failed: " + e.message); }
        };

        window.logout = () => signOut(auth);
        
        window.setCity = (c) => { 
            state.selectedCity = c; 
            setView('services'); 
        };

        window.openService = (id) => {
            state.activeService = state.services.find(s => s.id === id);
            setView('chat');
        };

        window.goBack = () => {
            if(state.currentView === 'chat') setView('services');
            else if(state.currentView === 'services') setView('cities');
        };

        window.toggleTheme = () => {
            state.darkMode = !state.darkMode;
            localStorage.setItem('darkMode', state.darkMode);
            document.documentElement.classList.toggle('dark');
            const icon = document.getElementById('theme-icon');
            if(icon) {
                 icon.setAttribute('data-lucide', state.darkMode ? 'sun' : 'moon');
                 if(window.lucide) window.lucide.createIcons();
            }
        };

        // --- ORDER MODAL FUNCTIONS ---

        window.toggleOrderModal = (show) => {
            const el = document.getElementById('order-modal-overlay');
            if(!el) return;
            
            if(show) {
                state.draftOrder = []; // Reset order when opening
                renderDraftList();
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        };

        window.addDraftItem = () => {
            const nameEl = document.getElementById('new-item-name');
            const qtyEl = document.getElementById('new-item-qty');
            const imgEl = document.getElementById('new-item-img');

            const name = nameEl.value.trim();
            const qty = parseInt(qtyEl.value) || 1;
            const img = imgEl.value.trim();

            if (!name) return alert("Please enter item name");
            if (state.draftOrder.length >= 50) return alert("Max 50 items allowed");

            state.draftOrder.push({ id: Date.now(), name, qty, image: img });

            // Clear inputs
            nameEl.value = '';
            imgEl.value = '';
            qtyEl.value = 1;
            nameEl.focus();

            renderDraftList();
        };

        window.removeDraftItem = (id) => {
            state.draftOrder = state.draftOrder.filter(item => item.id !== id);
            renderDraftList();
        };

        window.renderDraftList = () => {
            const listEl = document.getElementById('order-items-list');
            const counterEl = document.getElementById('item-counter');
            if(!listEl) return;

            counterEl.innerText = `${state.draftOrder.length}/50 Items`;

            if (state.draftOrder.length === 0) {
                listEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-gray-400 opacity-60">
                        <i data-lucide="shopping-basket" class="w-12 h-12 mb-2"></i>
                        <p class="text-sm">Basket is empty</p>
                    </div>`;
            } else {
                listEl.innerHTML = state.draftOrder.map(item => `
                    <div class="flex items-center justify-between bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 animate-fade-in mb-2">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg shrink-0 overflow-hidden">
                                ${item.image ? `<img src="${item.image}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full"><i data-lucide="package" class="w-5 h-5 text-gray-400"></i></div>`}
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-bold text-sm truncate dark:text-white">${item.name}</h4>
                                <p class="text-xs text-gray-500">Qty: ${item.qty}</p>
                            </div>
                        </div>
                        <button onclick="removeDraftItem(${item.id})" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
            }
            if(window.lucide) window.lucide.createIcons();
            listEl.scrollTop = listEl.scrollHeight;
        };

        window.submitOrder = () => {
            if (state.draftOrder.length === 0) return alert("Please add at least one item.");
            sendMessage("Order Request", 'order', { items: state.draftOrder });
            window.toggleOrderModal(false);
        };

        // --- SEND MESSAGE LOGIC ---

        window.triggerSend = () => sendMessage();
        window.sendPromo = () => sendMessage("SJ CODE");
        window.handleChatKey = (e) => { if(e.key === 'Enter') sendMessage(); };

        async function sendMessage(textOverride = null, typeOverride = 'text', extraData = {}) {
            const input = document.getElementById('chat-input');
            const txt = textOverride !== null ? textOverride : input.value.trim();
            
            if(typeOverride === 'text' && !txt) return;
            if(!state.activeService) return;

            // Clear input if manual typing
            if(!textOverride && input) { input.value = ''; input.focus(); }

            const chatId = getChatId(state.user.uid, state.activeService.id);
            const chatDocRef = doc(db, 'delivery_chats', chatId);
            const messagesColRef = collection(db, 'delivery_chats', chatId, 'messages');
            const batch = writeBatch(db);

            try {
                // 1. Add Message
                const newMsgRef = doc(messagesColRef);
                batch.set(newMsgRef, {
                    type: typeOverride,
                    text: txt || '',
                    sender: state.user.uid,
                    timestamp: serverTimestamp(),
                    ...extraData 
                });

                // 2. Update Chat Meta
                const existingChat = state.chats[state.activeService.id];
                const metaData = {
                    lastMessage: typeOverride === 'order' ? 'ðŸ“¦ Order Sent' : txt,
                    lastUpdated: serverTimestamp(),
                    serviceOwnerEmail: state.activeService.ownerEmail || ''
                };

                if (!existingChat) {
                    batch.set(chatDocRef, {
                        userId: state.user.uid,
                        userEmail: state.user.email || 'anon',
                        serviceId: state.activeService.id,
                        serviceName: state.activeService.name,
                        city: state.activeService.city,
                        createdAt: serverTimestamp(),
                        ...metaData
                    });
                } else {
                    batch.update(chatDocRef, metaData);
                }

                await batch.commit();
            } catch (e) {
                console.error("Send Error:", e);
                alert("Could not send message. Check console.");
            }
        }

        // --- HELPERS ---
        function getChatId(uid, serviceId) { return `${uid}_${serviceId}`; }
        function scrollToBottom() {
            const el = document.getElementById('chat-messages');
            if(el) setTimeout(() => { el.scrollTop = el.scrollHeight; }, 100);
        }
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.innerText = text || '';
            return div.innerHTML;
        }

        // --- RENDERERS ---

        function renderLoading() {
            return `<div class="flex h-full items-center justify-center bg-white dark:bg-gray-900"><div class="animate-spin w-8 h-8 border-2 border-blue-600 rounded-full border-t-transparent"></div></div>`;
        }

        function renderLogin() {
            return `
                <div class="flex flex-col h-full items-center justify-center p-8 text-center animate-fade bg-white dark:bg-gray-900 overflow-y-auto">
                    <div class="w-32 h-32 mb-6 shrink-0 animate-fade">
                        <img src="https://raw.githubusercontent.com/simojibou/logo/refs/heads/main/shared-0-sheet4.png" alt="SJ Delivery Logo" class="w-full h-full object-contain drop-shadow-2xl hover:scale-105 transition-transform duration-500">
                    </div>
                    <h1 class="text-3xl font-bold mb-3 text-gray-800 dark:text-white tracking-tight">SJ Delivery</h1>
                    <p class="text-gray-500 dark:text-gray-400 mb-12 max-w-xs leading-relaxed">Your favorite local services, delivered instantly to your door.</p>
                    <button onclick="loginGoogle()" class="w-full max-w-xs py-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-2xl font-bold flex items-center justify-center gap-3 transition-all shadow-sm hover:shadow-md dark:text-white group relative overflow-hidden">
                        <i data-lucide="mail" class="w-5 h-5 text-red-500"></i> <span>Continue with Google</span>
                    </button>
                </div>`;
        }

        const header = (title, showBack) => {
            const user = state.user;
            const leftSection = (!showBack && user) ? `
                <a href="https://simojibou.github.io/sjcoin25/duserprofile.html" class="flex items-center gap-3 overflow-hidden hover:opacity-75 transition-opacity">
                    ${user.photoURL 
                        ? `<img src="${user.photoURL}" alt="Profile" class="w-9 h-9 rounded-full border border-gray-200 dark:border-gray-700 object-cover shrink-0">` 
                        : `<div class="w-9 h-9 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 shrink-0"><i data-lucide="user" class="w-5 h-5"></i></div>`
                    }
                    <div class="flex flex-col min-w-0">
                        <span class="text-[10px] uppercase font-bold text-gray-400 leading-tight">Welcome</span>
                        <span class="font-bold text-sm truncate text-gray-800 dark:text-white leading-tight">${(user.displayName || 'User').split(' ')[0]}</span>
                    </div>
                </a>
            ` : `
                <div class="flex items-center gap-3 min-w-0">
                    ${showBack ? `<button onclick="goBack()" class="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>` : ''}
                    <h1 class="font-bold text-lg truncate text-gray-800 dark:text-white">${title}</h1>
                </div>
            `;
            return `
            <div class="h-16 bg-white dark:bg-gray-800 flex items-center justify-between px-4 shadow-sm z-10 shrink-0 border-b dark:border-gray-700">
                ${leftSection}
                <div class="flex gap-2 shrink-0">
                    <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i id="theme-icon" data-lucide="${state.darkMode ? 'sun' : 'moon'}" class="w-5 h-5 text-gray-600 dark:text-gray-300"></i></button>
                    <button onclick="logout()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </div>`;
        };

        function renderCities() {
            const cities = [...new Set(state.services.map(s => s.city).filter(c => c))].sort();
            return `
                ${header('Select Location', false)}
                <div id="city-list" class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-5 dark:bg-gray-900">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 ml-1">Available Cities</h2>
                    ${cities.map(c => `
                        <button onclick="setCity('${c}')" class="w-full bg-white dark:bg-gray-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-500 mb-3 flex items-center justify-between group transition-all animate-fade text-left active:scale-[0.98]">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-50 dark:bg-blue-900/30 p-2 rounded-lg text-blue-600 dark:text-blue-400"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                                <span class="font-semibold text-lg text-gray-800 dark:text-gray-100">${c}</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 dark:text-gray-600 group-hover:text-blue-500 transition-colors"></i>
                        </button>
                    `).join('') || '<div class="text-center text-gray-400 mt-10">No cities configured.</div>'}
                </div>`;
        }

        function renderServices() {
            const list = state.services.filter(s => s.city === state.selectedCity);
            return `
                ${header(state.selectedCity, true)}
                <div id="service-list" class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-5 dark:bg-gray-900">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 ml-1">Services in ${state.selectedCity}</h2>
                    ${list.map(s => {
                        const hasChat = state.chats[s.id];
                        return `
                        <button onclick="openService('${s.id}')" class="w-full bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 mb-3 flex items-center gap-4 text-left transition-all active:scale-[0.98] animate-fade hover:shadow-md">
                            <div class="w-14 h-14 rounded-full bg-gray-100 dark:bg-gray-700 overflow-hidden flex-shrink-0 border dark:border-gray-600">
                                ${s.logo ? `<img src="${s.logo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-gray-400"><i data-lucide="store" class="w-6 h-6"></i></div>`}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-lg text-gray-800 dark:text-gray-100 truncate">${s.name}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="inline-block px-2 py-0.5 rounded-md bg-gray-100 dark:bg-gray-700 text-[10px] text-gray-500 dark:text-gray-400 uppercase font-bold tracking-wide">${s.type}</span>
                                    ${hasChat ? '<span class="w-2 h-2 rounded-full bg-green-500"></span>' : ''}
                                </div>
                            </div>
                            <div class="p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-full">
                                <i data-lucide="message-circle" class="w-5 h-5"></i>
                            </div>
                        </button>
                    `}).join('') || '<div class="text-center text-gray-400 mt-10">No services found in this city.</div>'}
                </div>`;
        }

        function renderChatLayout() {
            return `
                ${header(state.activeService.name, true)}
                
                <!-- Chat Area -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 hide-scrollbar bg-gray-5 dark:bg-gray-900 scroll-smooth">
                    <div class="flex flex-col items-center justify-center mt-10 text-gray-400 opacity-50 pointer-events-none">
                        <i data-lucide="message-square-dashed" class="w-10 h-10 mb-2"></i>
                        <p class="text-xs">Connecting to ${state.activeService.name}...</p>
                    </div>
                </div>

                <!-- Input Bar -->
                <div class="p-3 bg-white dark:bg-gray-800 border-t dark:border-gray-700 flex gap-2 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] pb-safe relative z-10">
                    <button onclick="sendPromo()" class="p-3 bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400 rounded-full hover:bg-emerald-200 dark:hover:bg-emerald-800/40 transition-colors hidden sm:block" title="Use SJ CODE">
                        <i data-lucide="ticket" class="w-5 h-5"></i>
                    </button>
                    <!-- ORDER BUTTON -->
                    <button onclick="toggleOrderModal(true)" class="p-3 bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400 rounded-full hover:bg-indigo-200 dark:hover:bg-indigo-800/40 transition-colors" title="Create Order">
                        <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                    </button>
                    <input id="chat-input" type="text" onkeyup="handleChatKey(event)" placeholder="Type message..." autocomplete="off" class="flex-1 bg-gray-100 dark:bg-gray-700 dark:text-white rounded-full px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                    <button onclick="triggerSend()" class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 active:scale-95 transition-transform shadow-lg shadow-blue-200 dark:shadow-none"><i data-lucide="send-horizontal" class="w-5 h-5"></i></button>
                </div>

                <!-- ORDER MODAL (Included here to ensure correct scope) -->
                <div id="order-modal-overlay" class="hidden absolute inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end animate-fade">
                    <div class="w-full bg-white dark:bg-gray-900 rounded-t-3xl shadow-2xl h-[85%] flex flex-col animate-slide-up ring-1 ring-white/10">
                        <!-- Modal Header -->
                        <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center shrink-0">
                            <div>
                                <h2 class="font-bold text-lg dark:text-white">New Order</h2>
                                <p class="text-xs text-gray-500" id="item-counter">0/50 Items</p>
                            </div>
                            <button onclick="toggleOrderModal(false)" class="p-2 bg-gray-100 dark:bg-gray-800 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <!-- Items List -->
                        <div id="order-items-list" class="flex-1 overflow-y-auto p-4 space-y-2 hide-scrollbar">
                            <!-- Injected via renderDraftList() -->
                        </div>

                        <!-- Add Item Form -->
                        <div class="p-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-800 shrink-0 space-y-3">
                            <div class="flex gap-2">
                                <input id="new-item-name" type="text" placeholder="Item name (e.g. Pizza)" class="flex-1 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white">
                                <input id="new-item-qty" type="number" value="1" min="1" max="99" class="w-16 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl px-2 py-3 text-sm text-center focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white">
                            </div>
                            <div class="flex gap-2">
                                <input id="new-item-img" type="text" placeholder="Image URL (Optional)" class="flex-1 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-white">
                                <button onclick="addDraftItem()" class="px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl flex items-center justify-center transition-colors">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="p-4 bg-white dark:bg-gray-900 border-t border-gray-100 dark:border-gray-800 shrink-0 pb-safe">
                            <button onclick="submitOrder()" class="w-full py-3.5 bg-black dark:bg-white text-white dark:text-black font-bold rounded-xl shadow-lg active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                                <span>Send Order Request</span>
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>



