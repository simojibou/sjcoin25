<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SJ Delivery</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<script>
tailwind.config = {
  darkMode: 'class'
}
</script>

<style>
body { font-family: system-ui, -apple-system; }
input { font-size: 16px }
</style>
</head>

<body class="bg-gray-100 dark:bg-black h-screen flex justify-center">

<div id="app" class="w-full max-w-md bg-white dark:bg-gray-900 flex flex-col"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, collection, writeBatch, serverTimestamp, onSnapshot, orderBy, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
 apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
 authDomain: "sj-one.firebaseapp.com",
 projectId: "sj-one",
 storageBucket: "sj-one.appspot.com",
 messagingSenderId: "426335553508",
 appId: "1:426335553508:web:248f76772f6f78419ca9f1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* State */
const state = {
 user: null,
 orderItems: []
};

/* Utils */
const $ = id => document.getElementById(id);
const chatId = () => `${state.user.uid}_demoService`;

/* Auth */
onAuthStateChanged(auth, u => {
 state.user = u;
 u ? renderChat() : renderLogin();
});

/* Views */
function renderLogin() {
 app.innerHTML = `
 <div class="h-full flex items-center justify-center">
   <button onclick="login()" class="bg-blue-600 text-white px-6 py-3 rounded-xl">
     Login with Google
   </button>
 </div>`;
}

window.login = async () => {
 await signInWithPopup(auth, new GoogleAuthProvider());
};

function renderChat() {
 app.innerHTML = `
 <div class="flex-1 overflow-y-auto p-4" id="messages"></div>

 <div class="border-t p-3 flex gap-2">
   <input id="msg" class="flex-1 bg-gray-100 rounded-full px-4 py-2" placeholder="Message">
   <button onclick="sendText()" class="bg-blue-600 text-white p-3 rounded-full">
     <i data-lucide="send"></i>
   </button>
   <button onclick="openOrder()" class="bg-emerald-600 text-white p-3 rounded-full">
     <i data-lucide="shopping-cart"></i>
   </button>
 </div>

 ${orderModal()}
 `;
 lucide.createIcons();
 subscribeMessages();
}

/* Messaging */
function subscribeMessages() {
 const q = query(collection(db, 'delivery_chats', chatId(), 'messages'), orderBy('timestamp'));
 onSnapshot(q, snap => {
   const box = $('messages');
   box.innerHTML = '';
   snap.forEach(d => renderMessage(d.data(), box));
   box.scrollTop = box.scrollHeight;
 });
}

function renderMessage(msg, box) {
 const div = document.createElement('div');
 div.className = "mb-3";

 if(msg.type === 'order') {
   div.innerHTML = `
   <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow">
     <div class="font-bold mb-2 text-emerald-600">Order</div>
     ${msg.items.map(i => `
       <div class="flex gap-3 mb-2">
         <img src="${i.image}" class="w-12 h-12 rounded object-cover">
         <div class="flex-1">
           <div class="font-semibold">${i.name}</div>
           <div class="text-sm text-gray-500">$${i.price}</div>
         </div>
       </div>
     `).join('')}
     <div class="border-t mt-2 pt-2 font-bold text-right">
       Total: $${msg.total}
     </div>
   </div>`;
 } else {
   div.innerHTML = `
   <div class="inline-block bg-blue-600 text-white px-4 py-2 rounded-xl">
     ${msg.text}
   </div>`;
 }

 box.appendChild(div);
}

/* Send */
async function sendText() {
 const txt = $('msg').value.trim();
 if(!txt) return;
 $('msg').value = '';

 const batch = writeBatch(db);
 const ref = doc(collection(db, 'delivery_chats', chatId(), 'messages'));
 batch.set(ref, { type:'text', text:txt, timestamp:serverTimestamp() });
 await batch.commit();
}

/* ORDER SYSTEM */
function openOrder() {
 state.orderItems = [];
 $('orderModal').classList.remove('hidden');
 renderOrderItems();
}

function closeOrder() {
 $('orderModal').classList.add('hidden');
}

function addItem() {
 const name = $('itemName').value;
 const price = Number($('itemPrice').value);
 const image = $('itemImage').value || 'https://via.placeholder.com/100';

 if(!name || !price) return;

 state.orderItems.push({ name, price, image });
 $('itemName').value = '';
 $('itemPrice').value = '';
 $('itemImage').value = '';
 renderOrderItems();
}

function removeItem(i) {
 state.orderItems.splice(i,1);
 renderOrderItems();
}

function renderOrderItems() {
 const box = $('orderItems');
 box.innerHTML = state.orderItems.map((i,idx)=>`
 <div class="flex gap-3 items-center mb-2">
   <img src="${i.image}" class="w-10 h-10 rounded">
   <div class="flex-1">
     <div class="font-semibold">${i.name}</div>
     <div class="text-sm">$${i.price}</div>
   </div>
   <button onclick="removeItem(${idx})" class="text-red-500">
     <i data-lucide="x"></i>
   </button>
 </div>
 `).join('');
 lucide.createIcons();
}

async function sendOrder() {
 if(state.orderItems.length === 0) return;

 const total = state.orderItems.reduce((a,b)=>a+b.price,0);
 const batch = writeBatch(db);
 const ref = doc(collection(db, 'delivery_chats', chatId(), 'messages'));

 batch.set(ref, {
   type: 'order',
   items: state.orderItems,
   total,
   timestamp: serverTimestamp()
 });

 await batch.commit();
 closeOrder();
}

/* Modal */
function orderModal() {
 return `
 <div id="orderModal" class="hidden fixed inset-0 bg-black/40 flex items-end">
   <div class="bg-white dark:bg-gray-900 w-full rounded-t-3xl p-4 max-h-[90%] overflow-y-auto">
     <div class="font-bold text-lg mb-3">Create Order</div>

     <input id="itemName" placeholder="Item name" class="w-full mb-2 px-4 py-2 bg-gray-100 rounded">
     <input id="itemPrice" type="number" placeholder="Price" class="w-full mb-2 px-4 py-2 bg-gray-100 rounded">
     <input id="itemImage" placeholder="Image URL (optional)" class="w-full mb-3 px-4 py-2 bg-gray-100 rounded">

     <button onclick="addItem()" class="w-full bg-blue-600 text-white py-2 rounded-xl mb-3">
       Add Item
     </button>

     <div id="orderItems"></div>

     <div class="flex gap-2 mt-4">
       <button onclick="closeOrder()" class="flex-1 py-2 rounded-xl border">Cancel</button>
       <button onclick="sendOrder()" class="flex-1 py-2 rounded-xl bg-emerald-600 text-white">
         Send Order
       </button>
     </div>
   </div>
 </div>`;
}
</script>

</body>
</html>
