<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Studio: Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;700;900&family=Permanent+Marker&family=Playfair+Display:ital,wght@1,700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #09090b;
            --panel-bg: rgba(24, 24, 27, 0.7);
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.5);
        }
        body { background-color: var(--bg-dark); color: #e4e4e7; font-family: 'Inter', sans-serif; }
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            border-radius: 1rem;
        }
        input[type="range"] { -webkit-appearance: none; background: transparent; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: white; box-shadow: 0 0 12px var(--accent-glow); cursor: pointer;
            margin-top: -6px; transition: transform 0.15s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.4); }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 5px; background: #27272a; border-radius: 3px;
        }
        input[type=range][orient=vertical] {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 10px; height: 130px;
        }
        @keyframes sound-wave {
            0%, 100% { height: 4px; }
            50% { height: 24px; }
        }
        .playing-indicator div {
            width: 4px; background: var(--accent);
            animation: sound-wave 1.2s infinite ease-in-out;
        }
        .playing-indicator div:nth-child(2) { animation-delay: 0.2s; }
        .playing-indicator div:nth-child(3) { animation-delay: 0.4s; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        input[type="color"] {
            -webkit-appearance: none; border: none; width: 32px; height: 32px;
            border-radius: 50%; overflow: hidden; padding: 0; cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
    </style>
</head>
<body class="flex flex-col min-h-screen selection:bg-blue-500 selection:text-white">

    <nav class="sticky top-0 z-50 glass-panel border-b border-white/10">
        <div class="max-w-[1400px] mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-600 to-violet-600 flex items-center justify-center shadow-lg">
                    <i data-lucide="waves" class="text-white w-6 h-6"></i>
                </div>
                <h1 class="font-bold text-xl tracking-tight text-white">ProStudio <span class="text-blue-400 font-light">Ultimate</span></h1>
            </div>
            <div class="flex bg-black/40 rounded-lg p-1 border border-white/5">
                <button onclick="switchView('studio')" id="btn-studio" class="px-5 py-2 rounded text-sm font-medium bg-white/10 text-white shadow-sm">Studio</button>
                <button onclick="switchView('art')" id="btn-art" class="px-5 py-2 rounded text-sm font-medium text-gray-400 hover:text-white">Cover Art</button>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-6 max-w-[1400px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- LEFT SIDEBAR -->
        <aside id="fx-rack" class="lg:col-span-3 space-y-5">
            <div class="glass-panel p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400">Spectrum</h3>
                    <div class="flex gap-1 playing-indicator opacity-0" id="play-indicator">
                        <div></div><div></div><div></div>
                    </div>
                </div>
                <canvas id="viz-canvas" class="w-full h-28 bg-black/50 rounded-lg"></canvas>
            </div>

            <div class="glass-panel p-5">
                <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-4">Vibe Presets</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="applyPreset('slowed')" class="p-3 text-xs bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 transition">ðŸ’œ Slowed+Reverb</button>
                    <button onclick="applyPreset('nightcore')" class="p-3 text-xs bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 transition">âš¡ Nightcore</button>
                    <button onclick="applyPreset('lofi')" class="p-3 text-xs bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 transition">â˜• Lo-Fi Radio</button>
                    <button onclick="applyPreset('bass')" class="p-3 text-xs bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 transition">ðŸ”Š Bass Boost</button>
                </div>
            </div>

            <div class="glass-panel p-6 space-y-7">
                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium">Playback Speed</label>
                        <span id="speed-val" class="text-xs font-mono text-blue-400 bg-blue-400/10 px-2 py-1 rounded">100%</span>
                    </div>
                    <input type="range" id="speed-slider" min="50" max="150" value="100" oninput="updateFX()">
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <label class="text-sm font-medium">Space / Reverb</label>
                        <span id="reverb-val" class="text-xs font-mono text-purple-400 bg-purple-400/10 px-2 py-1 rounded">0%</span>
                    </div>
                    <input type="range" id="reverb-slider" min="0" max="100" value="0" oninput="updateFX()">
                </div>

                <div class="pt-5 border-t border-white/10">
                    <div class="flex justify-between items-center mb-5">
                        <label class="text-sm font-medium">3-Band EQ</label>
                        <button onclick="resetEQ()" class="text-xs text-gray-500 hover:text-white uppercase tracking-wider">Reset</button>
                    </div>
                    <div class="flex justify-around items-end h-36">
                        <div class="flex flex-col items-center gap-3">
                            <input type="range" id="eq-high" min="-12" max="12" value="0" orient="vertical" oninput="updateFX()">
                            <span class="text-xs text-gray-400 uppercase">High</span>
                        </div>
                        <div class="flex flex-col items-center gap-3">
                            <input type="range" id="eq-mid" min="-12" max="12" value="0" orient="vertical" oninput="updateFX()">
                            <span class="text-xs text-gray-400 uppercase">Mid</span>
                        </div>
                        <div class="flex flex-col items-center gap-3">
                            <input type="range" id="eq-low" min="-12" max="12" value="0" orient="vertical" oninput="updateFX()">
                            <span class="text-xs text-gray-400 uppercase">Low</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-5">
                <h3 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-4">Export Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 uppercase">Format</label>
                        <select id="export-format" onchange="toggleExportOptions()" class="w-full mt-1 bg-black/40 border border-white/10 rounded-lg text-sm p-3">
                            <option value="mp3">MP3 (Compressed)</option>
                            <option value="wav">WAV (Lossless)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase">Sample Rate</label>
                        <select id="sample-rate" class="w-full mt-1 bg-black/40 border border-white/10 rounded-lg text-sm p-3">
                            <option value="44100" selected>44.1 kHz</option>
                            <option value="48000">48.0 kHz</option>
                        </select>
                    </div>
                    <div id="bitrate-container">
                        <label class="text-xs text-gray-500 uppercase">Bitrate</label>
                        <select id="bitrate" class="w-full mt-1 bg-black/40 border border-white/10 rounded-lg text-sm p-3">
                            <option value="320" selected>320 kbps</option>
                            <option value="256">256 kbps</option>
                            <option value="192">192 kbps</option>
                        </select>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CENTER: STUDIO VIEW -->
        <section id="studio-view" class="lg:col-span-9 flex flex-col gap-6">
            <div id="drop-zone" class="h-48 rounded-2xl border-2 border-dashed border-white/20 bg-white/5 hover:bg-white/10 hover:border-blue-500/60 transition-all flex flex-col items-center justify-center cursor-pointer">
                <input type="file" id="file-input" multiple accept="audio/*" class="hidden">
                <div class="w-16 h-16 bg-blue-600/30 rounded-full flex items-center justify-center mb-4 backdrop-blur">
                    <i data-lucide="plus" class="w-10 h-10 text-blue-400"></i>
                </div>
                <h3 class="text-lg font-semibold">Drop Audio Files Here</h3>
                <p class="text-sm text-gray-500">MP3, WAV, FLAC, OGG supported</p>
            </div>

            <div id="action-bar" class="hidden glass-panel p-4 rounded-xl flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-bold text-gray-400" id="queue-stats">0 Tracks</span>
                    <button onclick="clearQueue()" class="text-sm text-red-400 hover:text-red-300">Clear All</button>
                </div>
                <button onclick="startBatchProcessing()" id="btn-process" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 px-8 rounded-xl shadow-lg flex items-center gap-3 transition-all active:scale-95 disabled:opacity-60">
                    <i data-lucide="zap" class="w-5 h-5"></i>
                    Export All
                </button>
            </div>

            <div id="track-container" class="space-y-4"></div>
        </section>

        <!-- COVER ART VIEW -->
        <section id="art-view" class="hidden lg:col-span-12 grid lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 glass-panel p-7 space-y-6">
                <h2 class="text-xl font-bold flex items-center gap-3"><i data-lucide="palette" class="w-6 h-6 text-blue-400"></i> Cover Art Studio</h2>

                <div class="space-y-4 border-b border-white/10 pb-6">
                    <label class="text-xs font-bold uppercase text-gray-500">Background</label>
                    <button onclick="document.getElementById('art-upload').click()" class="w-full py-3 border border-dashed border-white/20 rounded-lg hover:border-blue-500 hover:bg-white/5 transition text-sm">
                        <i data-lucide="image" class="w-4 h-4 inline mr-2"></i> Upload Image
                    </button>
                    <input type="file" id="art-upload" class="hidden" accept="image/*">
                    <div class="grid grid-cols-2 gap-4 mt-3">
                        <div>
                            <span class="text-xs text-gray-400">Darken</span>
                            <input type="range" id="fx-darken" min="0" max="80" value="40" oninput="renderArt()">
                        </div>
                        <div>
                            <span class="text-xs text-gray-400">Blur</span>
                            <input type="range" id="fx-blur" min="0" max="30" value="10" oninput="renderArt()">
                        </div>
                    </div>
                </div>

                <div class="space-y-4 border-b border-white/10 pb-6">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold uppercase text-gray-500">Artist Name</label>
                        <input type="checkbox" id="show-artist" checked onchange="renderArt()">
                    </div>
                    <input type="text" id="art-artist" value="ARTIST" class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 text-lg" oninput="renderArt()">
                    <div class="grid grid-cols-2 gap-4">
                        <select id="font-artist" onchange="renderArt()" class="bg-black/40 border border-white/10 rounded-lg p-3 text-sm">
                            <option value="Permanent Marker">Handwritten</option>
                            <option value="Playfair Display">Elegant Serif</option>
                            <option value="Inter" selected>Modern Sans</option>
                            <option value="Roboto Mono">Tech</option>
                        </select>
                        <input type="color" id="color-artist" value="#ffffff" oninput="renderArt()">
                    </div>
                    <input type="range" id="size-artist" min="80" max="500" value="300" oninput="renderArt()" class="w-full">
                    <input type="range" id="pos-artist" min="200" max="2800" value="1200" oninput="renderArt()" class="w-full">
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold uppercase text-gray-500">Song Title</label>
                        <input type="checkbox" id="show-title" checked onchange="renderArt()">
                    </div>
                    <input type="text" id="art-song" value="Song Title" class="w-full bg-black/40 border border-white/10 rounded-lg px-4 py-3 text-lg" oninput="renderArt()">
                    <div class="grid grid-cols-2 gap-4">
                        <select id="font-title" onchange="renderArt()" class="bg-black/40 border border-white/10 rounded-lg p-3 text-sm">
                            <option value="Playfair Display" selected>Elegant</option>
                            <option value="Inter">Clean</option>
                            <option value="Permanent Marker">Hand</option>
                            <option value="Roboto Mono">Tech</option>
                        </select>
                        <input type="color" id="color-title" value="#e0e0e0" oninput="renderArt()">
                    </div>
                    <input type="range" id="size-title" min="60" max="300" value="160" oninput="renderArt()" class="w-full">
                    <input type="range" id="pos-title" min="200" max="2800" value="1600" oninput="renderArt()" class="w-full">
                </div>

                <div class="flex justify-between items-center pt-4 border-t border-white/10">
                    <label class="text-xs font-bold uppercase text-gray-500">Parental Advisory</label>
                    <input type="checkbox" id="show-advisory" onchange="renderArt()">
                </div>

                <button onclick="downloadArt()" class="w-full mt-6 py-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-3">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    Export 3000Ã—3000 JPG
                </button>
            </div>

            <div class="lg:col-span-8 flex items-center justify-center p-8">
                <canvas id="art-preview" width="600" height="600" class="rounded-2xl shadow-2xl border border-white/10"></canvas>
                <canvas id="art-hd" width="3000" height="3000" class="hidden"></canvas>
            </div>
        </section>
    </main>

    <script>
        lucide.createIcons();

        const state = {
            audioCtx: null,
            offlineCtx: null,
            tracks: [],
            currentTrackId: null,
            isPlaying: false,
            source: null,
            fx: { low: null, mid: null, high: null, dry: null, wet: null, convolver: null, compressor: null, analyser: null },
            impulseBuffer: null
        };

        async function initAudio() {
            if (state.audioCtx) return;
            state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            state.fx.low = state.audioCtx.createBiquadFilter(); state.fx.low.type = 'lowshelf'; state.fx.low.frequency.value = 320;
            state.fx.mid = state.audioCtx.createBiquadFilter(); state.fx.mid.type = 'peaking'; state.fx.mid.frequency.value = 1000;
            state.fx.high = state.audioCtx.createBiquadFilter(); state.fx.high.type = 'highshelf'; state.fx.high.frequency.value = 3200;

            state.fx.dry = state.audioCtx.createGain();
            state.fx.wet = state.audioCtx.createGain();
            state.fx.convolver = state.audioCtx.createConvolver();

            state.fx.compressor = state.audioCtx.createDynamicsCompressor();
            state.fx.compressor.threshold.value = -2; state.fx.compressor.ratio.value = 12; state.fx.compressor.attack.value = 0.003;

            state.fx.analyser = state.audioCtx.createAnalyser(); state.fx.analyser.fftSize = 512;

            state.impulseBuffer = await generateImpulse(state.audioCtx, 2.5);
            state.fx.convolver.buffer = state.impulseBuffer;
        }

        async function generateImpulse(ctx, sec) {
            const rate = ctx.sampleRate;
            const frames = rate * sec;
            const buffer = ctx.createBuffer(2, frames, rate);
            for (let ch = 0; ch < 2; ch++) {
                const data = buffer.getChannelData(ch);
                for (let i = 0; i < frames; i++) {
                    data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / frames, 4);
                }
            }
            return buffer;
        }

        function applyPreset(p) {
            const presets = {
                slowed: { speed: 85, reverb: 40, low: 4, mid: 0, high: -3 },
                nightcore: { speed: 130, reverb: 15, low: -3, mid: 2, high: 6 },
                lofi: { speed: 92, reverb: 25, low: 3, mid: 3, high: -15 },
                bass: { speed: 100, reverb: 8, low: 10, mid: 0, high: -2 }
            };
            const s = presets[p];
            document.getElementById('speed-slider').value = s.speed;
            document.getElementById('reverb-slider').value = s.reverb;
            document.getElementById('eq-low').value = s.low;
            document.getElementById('eq-mid').value = s.mid;
            document.getElementById('eq-high').value = s.high;
            updateFX();
        }

        async function togglePreview(id) {
            await initAudio();
            if (state.currentTrackId === id && state.isPlaying) { stopPlayback(); return; }
            if (state.isPlaying) stopPlayback();

            setPlayButtonState(id, 'loading');
            const track = state.tracks.find(t => t.id === id);
            if (!track.buffer) {
                track.buffer = await state.audioCtx.decodeAudioData(await track.file.arrayBuffer());
            }

            state.source = state.audioCtx.createBufferSource();
            state.source.buffer = track.buffer;
            state.source.loop = true;

            state.source.connect(state.fx.low);
            state.fx.low.connect(state.fx.mid);
            state.fx.mid.connect(state.fx.high);
            state.fx.high.connect(state.fx.dry);
            state.fx.high.connect(state.fx.convolver);
            state.fx.convolver.connect(state.fx.wet);
            state.fx.dry.connect(state.fx.compressor);
            state.fx.wet.connect(state.fx.compressor);
            state.fx.compressor.connect(state.fx.analyser);
            state.fx.analyser.connect(state.audioCtx.destination);

            updateFX();
            state.source.start();
            state.isPlaying = true;
            state.currentTrackId = id;

            setPlayButtonState(id, 'playing');
            document.getElementById('play-indicator').classList.remove('opacity-0');
            drawVisualizer();
        }

        function stopPlayback() {
            if (state.source) {
                state.source.stop();
                state.source.disconnect();
            }
            if (state.currentTrackId) setPlayButtonState(state.currentTrackId, 'idle');
            state.isPlaying = false;
            state.currentTrackId = null;
            document.getElementById('play-indicator').classList.add('opacity-0');
        }

        function updateFX() {
            if (!state.audioCtx || !state.source) return;
            const s = parseFloat(document.getElementById('speed-slider').value) / 100;
            const r = parseFloat(document.getElementById('reverb-slider').value) / 100;
            const low = parseInt(document.getElementById('eq-low').value);
            const mid = parseInt(document.getElementById('eq-mid').value);
            const high = parseInt(document.getElementById('eq-high').value);

            document.getElementById('speed-val').textContent = Math.round(s * 100) + '%';
            document.getElementById('reverb-val').textContent = Math.round(r * 100) + '%';

            state.source.playbackRate.value = s;
            state.fx.dry.gain.value = 1 - r * 0.5;
            state.fx.wet.gain.value = r * 0.8;
            state.fx.low.gain.value = low;
            state.fx.mid.gain.value = mid;
            state.fx.high.gain.value = high;
        }

        let vizRaf;
        function drawVisualizer() {
            if (!state.isPlaying) return;
            const canvas = document.getElementById('viz-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth * devicePixelRatio;
            canvas.height = canvas.offsetHeight * devicePixelRatio;

            const data = new Uint8Array(state.fx.analyser.frequencyBinCount);
            state.fx.analyser.getByteFrequencyData(data);

            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const bars = 60;
            const step = canvas.width / bars;
            for (let i = 0; i < bars; i++) {
                const idx = Math.floor(i * data.length / bars);
                const h = (data[idx] / 255) * canvas.height * 0.8;
                const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - h);
                gradient.addColorStop(0, '#3b82f6');
                gradient.addColorStop(1, '#a855f7');
                ctx.fillStyle = gradient;
                ctx.fillRect(i * step, canvas.height - h, step * 0.8, h);
            }
            vizRaf = requestAnimationFrame(drawVisualizer);
        }

        async function startBatchProcessing() {
            const btn = document.getElementById('btn-process');
            btn.disabled = true; btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Processing...';
            lucide.createIcons();
            stopPlayback();

            const settings = {
                speed: parseFloat(document.getElementById('speed-slider').value) / 100,
                reverb: parseFloat(document.getElementById('reverb-slider').value) / 100,
                low: parseInt(document.getElementById('eq-low').value),
                mid: parseInt(document.getElementById('eq-mid').value),
                high: parseInt(document.getElementById('eq-high').value),
                format: document.getElementById('export-format').value,
                rate: parseInt(document.getElementById('sample-rate').value),
                bitrate: parseInt(document.getElementById('bitrate').value)
            };

            for (const track of state.tracks.filter(t => t.status !== 'done')) {
                updateTrackStatus(track.id, 'processing');
                if (!track.buffer) track.buffer = await state.audioCtx.decodeAudioData(await track.file.arrayBuffer());

                const rendered = await renderOffline(track.buffer, settings);
                track.blob = settings.format === 'mp3'
                    ? await encodeMp3(rendered, settings.rate, settings.bitrate)
                    : bufferToWave(rendered);
                track.ext = settings.format;
                track.status = 'done';
                updateTrackStatus(track.id, 'done');
            }

            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="zap" class="w-5 h-5"></i> Export All';
            lucide.createIcons();
        }

        async function renderOffline(buffer, s) {
            const tail = s.reverb > 0.1 ? 3 : 0;
            const duration = buffer.duration / s.speed + tail;
            const offline = new OfflineAudioContext(2, duration * s.rate, s.rate);

            const src = offline.createBufferSource();
            src.buffer = buffer;
            src.playbackRate.value = s.speed;

            const low = offline.createBiquadFilter(); low.type = 'lowshelf'; low.frequency.value = 320; low.gain.value = s.low;
            const mid = offline.createBiquadFilter(); mid.type = 'peaking'; mid.frequency.value = 1000; mid.gain.value = s.mid;
            const high = offline.createBiquadFilter(); high.type = 'highshelf'; high.frequency.value = 3200; high.gain.value = s.high;

            src.connect(low); low.connect(mid); mid.connect(high);

            const comp = offline.createDynamicsCompressor();
            comp.threshold.value = -2; comp.ratio.value = 12;

            if (s.reverb > 0.1) {
                const conv = offline.createConvolver(); conv.buffer = state.impulseBuffer;
                const dry = offline.createGain(); dry.gain.value = 1 - s.reverb * 0.5;
                const wet = offline.createGain(); wet.gain.value = s.reverb * 0.8;
                high.connect(dry); high.connect(conv); conv.connect(wet);
                dry.connect(comp); wet.connect(comp);
            } else {
                high.connect(comp);
            }
            comp.connect(offline.destination);
            src.start();
            return await offline.startRendering();
        }

        function bufferToWave(buf) {
            const len = buf.length * buf.numberOfChannels * 2 + 44;
            const array = new ArrayBuffer(len);
            const view = new DataView(array);
            let pos = 0;

            function writeString(str) { for (let i = 0; i < str.length; i++) view.setUint8(pos++, str.charCodeAt(i)); }
            function writeUint32(val) { view.setUint32(pos, val, true); pos += 4; }
            function writeUint16(val) { view.setUint16(pos, val, true); pos += 2; }

            writeString('RIFF'); writeUint32(len - 8); writeString('WAVE');
            writeString('fmt '); writeUint32(16); writeUint16(1); writeUint16(buf.numberOfChannels);
            writeUint32(buf.sampleRate); writeUint32(buf.sampleRate * 2 * buf.numberOfChannels);
            writeUint16(buf.numberOfChannels * 2); writeUint16(16);
            writeString('data'); writeUint32(len - pos - 4);

            const channels = [];
            for (let i = 0; i < buf.numberOfChannels; i++) channels.push(buf.getChannelData(i));

            let offset = pos;
            for (let i = 0; i < buf.length; i++) {
                for (let ch = 0; ch < buf.numberOfChannels; ch++) {
                    const sample = Math.max(-1, Math.min(1, channels[ch][i]));
                    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                    offset += 2;
                }
            }
            return new Blob([array], { type: 'audio/wav' });
        }

        async function encodeMp3(buffer, rate, kbps) {
            const mp3Encoder = new lamejs.Mp3Encoder(2, rate, kbps);
            const left = buffer.getChannelData(0);
            const right = buffer.getChannelData(1);
            const sampleBlockSize = 1152;
            const mp3Data = [];

            const to16bit = (float) => float < 0 ? float * 32768 : float * 32767;

            for (let i = 0; i < left.length; i += sampleBlockSize) {
                const l = new Int16Array(sampleBlockSize);
                const r = new Int16Array(sampleBlockSize);
                for (let j = 0; j < sampleBlockSize; j++) {
                    if (i + j < left.length) {
                        l[j] = to16bit(left[i + j]);
                        r[j] = to16bit(right[i + j]);
                    }
                }
                const mp3buf = mp3Encoder.encodeBuffer(l, r);
                if (mp3buf.length > 0) mp3Data.push(mp3buf);
            }
            const end = mp3Encoder.flush();
            if (end.length > 0) mp3Data.push(end);

            return new Blob(mp3Data, { type: 'audio/mp3' });
        }

        // UI Helpers
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-500/10'); };
        dropZone.ondragleave = dropZone.ondrop = e => { e.preventDefault(); dropZone.classList.remove('border-blue-500', 'bg-blue-500/10'); };
        dropZone.ondrop = e => handleFiles(e.dataTransfer.files);
        fileInput.onchange = e => handleFiles(e.target.files);

        function handleFiles(files) {
            if (files.length > 0) document.getElementById('action-bar').classList.remove('hidden');
            for (const file of files) {
                if (!file.type.startsWith('audio/')) continue;
                const id = Math.random().toString(36).slice(2, 11);
                state.tracks.push({ id, file, buffer: null, status: 'pending', blob: null });
                const el = document.createElement('div');
                el.id = `t-${id}`;
                el.className = "glass-panel p-5 rounded-xl flex items-center gap-5";
                el.innerHTML = `
                    <button onclick="togglePreview('\( {id}')" id="btn- \){id}" class="w-12 h-12 rounded-full bg-white/10 hover:bg-blue-600 flex items-center justify-center transition">
                        <i data-lucide="play" class="w-5 h-5"></i>
                    </button>
                    <div class="flex-grow">
                        <div class="font-medium truncate">${file.name}</div>
                        <div class="text-xs text-gray-500 mt-1" id="status-${id}">Ready to process</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="downloadTrack('\( {id}')" id="dl- \){id}" class="hidden px-5 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-bold flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> Save
                        </button>
                        <button onclick="removeTrack('${id}')" class="p-2 text-gray-500 hover:text-red-400">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                `;
                document.getElementById('track-container').appendChild(el);
                lucide.createIcons();
            }
            updateQueueStats();
        }

        function setPlayButtonState(id, mode) {
            const btn = document.getElementById(`btn-${id}`);
            if (!btn) return;
            if (mode === 'loading') btn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
            else if (mode === 'playing') { btn.innerHTML = '<i data-lucide="pause" class="w-5 h-5"></i>'; btn.classList.add('bg-blue-600'); }
            else { btn.innerHTML = '<i data-lucide="play" class="w-5 h-5"></i>'; btn.classList.remove('bg-blue-600'); }
            lucide.createIcons();
        }

        function updateTrackStatus(id, status) {
            const el = document.getElementById(`status-${id}`);
            const dl = document.getElementById(`dl-${id}`);
            if (status === 'processing') el.textContent = 'Processing...';
            if (status === 'done') { el.textContent = 'Ready to download'; dl.classList.remove('hidden'); }
        }

        function downloadTrack(id) {
            const t = state.tracks.find(x => x.id === id);
            if (!t?.blob) return;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(t.blob);
            a.download = t.file.name.replace(/\.[^.]+$/, '') + '_mastered.' + t.ext;
            a.click();
        }

        function removeTrack(id) {
            if (state.currentTrackId === id) stopPlayback();
            state.tracks = state.tracks.filter(t => t.id !== id);
            document.getElementById(`t-${id}`)?.remove();
            updateQueueStats();
        }

        function clearQueue() {
            stopPlayback();
            state.tracks = [];
            document.getElementById('track-container').innerHTML = '';
            document.getElementById('action-bar').classList.add('hidden');
        }

        function updateQueueStats() {
            document.getElementById('queue-stats').textContent = state.tracks.length + ' Track' + (state.tracks.length === 1 ? '' : 's');
        }

        function toggleExportOptions() {
            const isWav = document.getElementById('export-format').value === 'wav';
            document.getElementById('bitrate-container').style.opacity = isWav ? '0.5' : '1';
            document.getElementById('bitrate-container').style.pointerEvents = isWav ? 'none' : 'auto';
        }

        // Cover Art
        let backgroundImg = null;
        document.getElementById('art-upload').onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const img = new Image();
                img.onload = () => { backgroundImg = img; renderArt(); };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        };

        function stackBlurCanvas(ctx, radius) {
            if (radius < 1) return;
            const w = ctx.canvas.width, h = ctx.canvas.height;
            const imgData = ctx.getImageData(0, 0, w, h);
            const pixels = imgData.data;
            // Simple fast box blur (3 passes)
            for (let pass = 0; pass < 3; pass++) {
                for (let i = 0; i < 2; i++) { // horizontal then vertical
                    for (let y = 0; y < h; y++) {
                        for (let x = 0; x < w; x++) {
                            let sum = [0,0,0,0];
                            let count = 0;
                            for (let r = -radius; r <= radius; r++) {
                                const nx = i ? x + r : x;
                                const ny = i ? y : y + r;
                                if (nx >= 0 && nx < w && ny >= 0 && ny < h) {
                                    const off = (ny * w + nx) * 4;
                                    sum[0] += pixels[off]; sum[1] += pixels[off+1]; sum[2] += pixels[off+2]; sum[3] += pixels[off+3];
                                    count++;
                                }
                            }
                            const off = (y * w + x) * 4;
                            pixels[off] = sum[0]/count; pixels[off+1] = sum[1]/count;
                            pixels[off+2] = sum[2]/count; pixels[off+3] = sum[3]/count;
                        }
                    }
                }
            }
            ctx.putImageData(imgData, 0, 0);
        }

        function renderArt() {
            const hd = document.getElementById('art-hd');
            const ctx = hd.getContext('2d');
            const w = 3000, h = 3000;

            ctx.fillStyle = '#0f0f0f';
            ctx.fillRect(0, 0, w, h);

            if (backgroundImg) {
                const ratio = Math.max(w / backgroundImg.width, h / backgroundImg.height);
                const dw = backgroundImg.width * ratio;
                const dh = backgroundImg.height * ratio;
                ctx.drawImage(backgroundImg, (w - dw)/2, (h - dh)/2, dw, dh);
            }

            const darken = parseInt(document.getElementById('fx-darken').value) / 100;
            ctx.fillStyle = `rgba(0,0,0,${darken})`;
            ctx.fillRect(0, 0, w, h);

            const blurVal = parseInt(document.getElementById('fx-blur').value);
            if (blurVal > 0) {
                stackBlurCanvas(ctx, blurVal);
            }

            if (document.getElementById('show-artist').checked) {
                const text = document.getElementById('art-artist').value.toUpperCase() || "ARTIST";
                const size = parseInt(document.getElementById('size-artist').value);
                const font = document.getElementById('font-artist').value;
                const color = document.getElementById('color-artist').value;
                const y = parseInt(document.getElementById('pos-artist').value);

                ctx.font = `bold \( {size}px " \){font}", sans-serif`;
                ctx.fillStyle = color;
                ctx.textAlign = 'center';
                ctx.shadowColor = 'rgba(0,0,0,0.9)';
                ctx.shadowBlur = 30;
                ctx.fillText(text, w/2, y);
            }

            if (document.getElementById('show-title').checked) {
                const text = document.getElementById('art-song').value || "Song Title";
                const size = parseInt(document.getElementById('size-title').value);
                const font = document.getElementById('font-title').value;
                const color = document.getElementById('color-title').value;
                const y = parseInt(document.getElementById('pos-title').value);

                ctx.font = `\( {size}px " \){font}", sans-serif`;
                ctx.fillStyle = color;
                ctx.textAlign = 'center';
                ctx.shadowColor = 'rgba(0,0,0,0.9)';
                ctx.shadowBlur = 30;
                ctx.fillText(text, w/2, y);
            }

            if (document.getElementById('show-advisory').checked) {
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 20;
                ctx.strokeRect(2500, 2600, 400, 300);
                ctx.fillStyle = 'rgba(0,0,0,0.6)';
                ctx.fillRect(2500, 2600, 400, 300);
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 100px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('PARENTAL', 2700, 2720);
                ctx.fillText('ADVISORY', 2700, 2850);
            }

            // Preview
            const prev = document.getElementById('art-preview');
            const pctx = prev.getContext('2d');
            pctx.drawImage(hd, 0, 0, 600, 600);
        }

        function downloadArt() {
            const a = document.createElement('a');
            a.href = document.getElementById('art-hd').toDataURL('image/jpeg', 0.95);
            a.download = 'cover_art_3000x3000.jpg';
            a.click();
        }

        function resetEQ() {
            ['eq-low', 'eq-mid', 'eq-high'].forEach(id => document.getElementById(id).value = 0);
            updateFX();
        }

        function switchView(view) {
            const isArt = view === 'art';
            document.getElementById('studio-view').classList.toggle('hidden', isArt);
            document.getElementById('fx-rack').classList.toggle('hidden', isArt);
            document.getElementById('art-view').classList.toggle('hidden', !isArt);
            document.getElementById('btn-studio').classList.toggle('bg-white/10', !isArt);
            document.getElementById('btn-studio').classList.toggle('text-white', !isArt);
            document.getElementById('btn-studio').classList.toggle('text-gray-400', isArt);
            document.getElementById('btn-art').classList.toggle('bg-white/10', isArt);
            document.getElementById('btn-art').classList.toggle('text-white', isArt);
            document.getElementById('btn-art').classList.toggle('text-gray-400', !isArt);
            if (isArt) renderArt();
        }

        // Init
        renderArt(); // Initial cover preview
    </script>
</body>
</html>
