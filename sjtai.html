<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Market Predictions SaaS</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; margin:0; padding:0; background:#121212; color:#fff; display:flex; justify-content:center; align-items:center; min-height:100vh; }
        .container { max-width:900px; width:100%; background:#1e1e1e; padding:40px; border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,0.5); margin:20px; }
        h1,h2 { text-align:center; color:#fff; }
        .hidden { display:none; }
        button { background:linear-gradient(135deg,#6200ea,#03dac6); color:#fff; border:none; padding:12px 24px; margin:10px 0; cursor:pointer; border-radius:8px; font-weight:500; transition: transform 0.2s, box-shadow 0.2s; }
        button:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(98,0,234,0.5); }
        input, textarea { background:#2c2c2c; color:#fff; border:1px solid #333; padding:12px; margin:10px 0; width:100%; box-sizing:border-box; border-radius:8px; }
        .prediction { background:#2c2c2c; border:1px solid #333; padding:16px; margin:16px 0; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.3); }
        #paypal-buttons { margin:20px 0; text-align:center; }
        #status { text-align:center; color:#ff5252; }
        .auth-button { display:flex; align-items:center; justify-content:center; background:#fff; color:#000; font-weight:bold; }
        .auth-button img { width:24px; margin-right:10px; }
        @media (max-width:600px) { .container { padding:20px; } }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, getDocs, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD-sneIBO65i9uQIh3n_jw4MI7GQtjZfV8",
            authDomain: "sj-one.firebaseapp.com",
            databaseURL: "https://sj-one-default-rtdb.firebaseio.com",
            projectId: "sj-one",
            storageBucket: "sj-one.appspot.com",
            messagingSenderId: "426335553508",
            appId: "1:426335553508:web:248f76772f6f78419ca9f1",
            measurementId: "G-YQTVZQWXGB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        const PAYPAL_CLIENT_ID = "YOUR_PAYPAL_CLIENT_ID"; // ضع هنا رقم العميل الصحيح
        let currentUser = null;

        // Auth State
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                checkAndSetUserRole(user.uid);
            } else {
                showAuth();
            }
        });

        function signInWithGoogle() {
            signInWithPopup(auth, googleProvider)
            .then(result => {
                updateStatus('Signed in successfully as ' + result.user.displayName);
            })
            .catch(err => updateStatus(err.message));
        }

        function logout() {
            signOut(auth).then(() => updateStatus('Logged out')).catch(err => updateStatus(err.message));
        }

        function showAuth() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
        }

        async function checkAndSetUserRole(uid) {
            const userRef = doc(db, 'users', uid);
            const docSnap = await getDoc(userRef);
            if (!docSnap.exists()) {
                await setDoc(userRef, { role: 'none' });
            }
            loadUserRole(uid);
        }

        async function loadUserRole(uid) {
            const docSnap = await getDoc(doc(db, 'users', uid));
            if (docSnap.exists()) {
                const role = docSnap.data().role;
                document.getElementById('user-role').innerText = `Role: ${role.charAt(0).toUpperCase() + role.slice(1)}`;
                if (role === 'admin') showAdmin();
                else if (role === 'regular' || role === 'vip') showDashboard(role);
                else showDashboard('none');
            }
        }

        function showDashboard(role) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            loadPredictions(role);
            initPayPalButtons(role);
            document.getElementById('upgrade-btn').classList.toggle('hidden', role !== 'regular');
        }

        function showAdmin() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('admin-section').classList.remove('hidden');
        }

        async function loadPredictions(role) {
            const predictionsDiv = document.getElementById('predictions');
            predictionsDiv.innerHTML = '';
            const q = query(collection(db, 'predictions'), orderBy('timestamp', 'desc'), limit(5));
            const querySnapshot = await getDocs(q);
            let hasPrediction = false;
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const isPremium = data.premium || false;
                if (role === 'vip' || !isPremium) {
                    const pred = document.createElement('div');
                    pred.classList.add('prediction');
                    pred.innerHTML = `<h3>${data.market}</h3><p>${data.prediction}</p><p>${data.details}</p><small>${data.timestamp?.toDate ? data.timestamp.toDate().toLocaleString() : ''}</small>`;
                    predictionsDiv.appendChild(pred);
                    hasPrediction = true;
                }
            });
            if (!hasPrediction) predictionsDiv.innerHTML = '<p>No predictions available for your role.</p>';
        }

        async function addPrediction() {
            const predictionText = document.getElementById('new-prediction').value;
            try {
                const prediction = JSON.parse(predictionText);
                prediction.timestamp = serverTimestamp();
                await addDoc(collection(db, 'predictions'), prediction);
                updateStatus('Prediction added');
            } catch (e) { updateStatus('Invalid JSON'); }
        }

        async function generateAIPrediction() {
            // Mock AI
            const mockAIResponse = { market: 'Crypto', prediction: 'Bullish next week', details: 'AI analysis: Bitcoin expected to rise 5%.', premium:false, timestamp: serverTimestamp() };
            try { await addDoc(collection(db, 'predictions'), mockAIResponse); updateStatus('AI Prediction added'); }
            catch(err){ updateStatus(err.message); }
        }

        function updateUserRole(role) {
            updateDoc(doc(db,'users',currentUser.uid), { role }).then(()=>loadUserRole(currentUser.uid));
        }

        function updateStatus(msg){ document.getElementById('status').innerText = msg; }

        function initPayPalButtons(role){
            const paypalDiv = document.getElementById('paypal-buttons');
            paypalDiv.innerHTML = '';
            if(role==='none'){
                paypal.Buttons({
                    createOrder: (data, actions)=> actions.order.create({ purchase_units:[{ amount:{ value:'50.00' } }] }),
                    onApprove: (data, actions)=> actions.order.capture().then(details=>{ updateUserRole('regular'); updateStatus('Payment successful!'); })
                }).render(paypalDiv);
            }
        }

        function showUpgrade(){
            const paypalDiv = document.getElementById('paypal-buttons');
            paypalDiv.innerHTML = '';
            paypal.Buttons({
                createOrder: (data, actions)=> actions.order.create({ purchase_units:[{ amount:{ value:'100.00' } }] }),
                onApprove: (data, actions)=> actions.order.capture().then(details=>{ updateUserRole('vip'); updateStatus('Upgrade successful!'); })
            }).render(paypalDiv);
        }
    </script>
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=USD"></script>
</head>
<body>
    <div class="container">
        <h1>AI Market Predictions</h1>

        <!-- Auth Section -->
        <div id="auth-section">
            <h2>Sign in with Google</h2>
            <button onclick="signInWithGoogle()" class="auth-button">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Sign in with Google
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="hidden">
            <h2>Dashboard</h2>
            <p id="user-role"></p>
            <div id="predictions"></div>
            <div id="paypal-buttons"></div>
            <button onclick="logout()">Logout</button>
            <button id="upgrade-btn" onclick="showUpgrade()" class="hidden">Upgrade to VIP</button>
        </div>

        <!-- Admin Panel Section -->
        <div id="admin-section" class="hidden">
            <h2>Admin Panel</h2>
            <textarea id="new-prediction" placeholder="Enter new prediction JSON"></textarea>
            <button onclick="addPrediction()">Add Prediction Manually</button>
            <button onclick="generateAIPrediction()">Generate AI Prediction</button>
            <button onclick="logout()">Logout</button>
        </div>

        <div id="status"></div>
    </div>
</body>
</html>
